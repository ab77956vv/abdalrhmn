<!DOCTYPE html>
<html lang="ar-SA" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>برنامج الجبرني المحاسبي - إدارة مغاسل السيارات</title>
<style>
  :root {
    --bg: #0f172a;
    --fg: #f8fafc;
    --muted: #cbd5e1;
    --card: #111827;
    --accent: #22c55e;
    --accent-2: #06b6d4;
    --danger: #ef4444;
    --warn: #f59e0b;
    --ok: #10b981;
    --info: #3b82f6;
    --line: #1f2937;
    --card-bg: linear-gradient(180deg, #0b1224, #0e162d);

    /* ألوان للمستخدمين المختلفين */
    --admin-accent: #10b981;
    --manager-accent: #3b82f6;
    --accountant-accent: #f59e0b;
    --viewer-accent: #8b5cf6;

    /* تأثيرات 3D */
    --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
    --btn-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  * {
    box-sizing: border-box;
    font-family: "Tajawal", system-ui, Segoe UI, Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  body {
    margin: 0;
    background: linear-gradient(135deg, #0b1224, #0f172a 50%, #0b1224);
    background-color: #0f172a;
    color: var(--fg);
    min-height: 100vh;
  }

  a {
    color: inherit;
    text-decoration: none;
  }

  .container {
    max-width: 1200px;
    margin: auto;
    padding: 16px;
  }

  header.top {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--line);
    position: sticky;
    top: 0;
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(6px);
    z-index: 10;
  }

  header .brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .brand .logo {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: grid;
    place-items: center;
    font-weight: 700;
    color: #001b12;
  }

  .tag {
    font-size: 12px;
    color: var(--muted);
  }

  .btn {
    border: 0;
    border-radius: 10px;
    padding: 10px 14px;
    background: #1f2937;
    color: #e5e7eb;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    box-shadow: var(--btn-shadow);
    transform: translateZ(0);
  }

  .btn:hover {
    transform: translateY(-2px) translateZ(0);
    box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
  }

  .btn.info {
    background: var(--info);
    color: white;
  }

  .btn.acc {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #001b12;
    font-weight: 700;
  }

  .btn.danger {
    background: var(--danger);
    color: white;
  }

  .btn.warn {
    background: var(--warn);
    color: #1f2937;
  }

  .btn.ghost {
    background: transparent;
    border: 1px solid var(--line);
  }

  .grid {
    display: grid;
    gap: 16px;
  }

  .grid.cards {
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 25px;
  }

  .card {
    background: var(--card-bg);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.3s ease;
    box-shadow: var(--card-shadow);
    transform: translateZ(0);
    perspective: 1000px;
  }

  .card:hover {
    transform: translateY(-8px) translateZ(0);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 15px 15px rgba(0, 0, 0, 0.25);
  }

  /* ========= Branch Card Styling ========= */
  .branch-card {
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.15), rgba(80, 200, 120, 0.15));
    border: 2px solid rgba(74, 144, 226, 0.3);
    min-height: 220px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .branch-card:hover {
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.25), rgba(80, 200, 120, 0.25));
    border-color: rgba(74, 144, 226, 0.5);
    transform: translateY(-10px) scale(1.02);
  }

  .branch-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
  }

  .branch-icon {
    font-size: 52px;
    background: linear-gradient(45deg, #4A90E2, #50C878);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  .branch-info h3 {
    margin: 0;
    font-size: 26px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .branch-details {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 15px 0;
  }

  .branch-detail {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 15px;
    color: rgba(255, 255, 255, 0.9);
  }

  .branch-detail-icon {
    font-size: 18px;
    width: 22px;
    text-align: center;
    color: rgba(74, 144, 226, 0.8);
  }

  .branch-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
  }

  .branch-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.8);
  }

  .status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #50C878;
    box-shadow: 0 0 12px rgba(80, 200, 120, 0.6);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 12px rgba(80, 200, 120, 0.6); }
    50% { box-shadow: 0 0 20px rgba(80, 200, 120, 0.8); }
    100% { box-shadow: 0 0 12px rgba(80, 200, 120, 0.6); }
  }

  .branch-arrow {
    font-size: 24px;
    color: rgba(255, 255, 255, 0.7);
    transition: transform 0.3s ease;
  }

  .branch-card:hover .branch-arrow {
    transform: translateX(8px);
    color: rgba(255, 255, 255, 0.9);
  }

  /* ========= Enhanced Branch Tabs ========= */
  .tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin: 20px 0;
    padding: 0;
  }

  .tab {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 20px 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-align: center;
    min-width: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
  }

  .tab:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
  }

  .tab::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s ease;
  }

  .tab:hover::before {
    transform: translateX(100%);
  }

  /* ========= Back Button ========= */
  .back-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: linear-gradient(135deg, #4A90E2, #50C878);
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .back-button:hover {
    transform: scale(1.1) translateY(-2px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
  }

  .back-button:active {
    transform: scale(0.95);
  }



  /* ========= Login Page ========= */
  #view-login {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  #view-login .card {
    max-width: 400px;
    width: 100%;
    margin: 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* إخفاء القائمة العلوية في صفحة تسجيل الدخول */
  body:has(#view-login:not(.hidden)) header.top,
  .view-login header.top {
    display: none !important;
  }

  .card h3 {
    margin: 0 0 8px;
  }

  .muted {
    color: var(--muted);
  }

  .input,
  select,
  textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #233047;
    background: #0b1224;
    color: var(--fg);
    font-size: 14px;
  }

  .input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  label {
    font-size: 13px;
    color: var(--muted);
    display: block;
    margin-bottom: 4px;
  }

  .row {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 12px;
  }

  .col-12 {
    grid-column: span 12;
  }
  .col-8 {
    grid-column: span 8;
  }
  .col-6 {
    grid-column: span 6;
  }
  .col-4 {
    grid-column: span 4;
  }
  .col-3 {
    grid-column: span 3;
  }
  .col-2 {
    grid-column: span 2;
  }

  @media (max-width: 800px) {
    .col-8,
    .col-6,
    .col-4,
    .col-3,
    .col-2 {
      grid-column: span 12;
    }
  }

  table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--line);
    border-radius: 10px;
    overflow: hidden;
  }

  th,
  td {
    padding: 10px;
    border-bottom: 1px solid var(--line);
    text-align: right;
  }

  th {
    background: #0b1224;
    color: #cbd5e1;
  }

  tr:nth-child(even) {
    background: #0d1428;
  }

  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    justify-content: flex-start;
    margin: 10px 0;
  }

  .hidden {
    display: none !important;
  }

  .tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .tab {
    padding: 10px 12px;
    border: 1px solid var(--line);
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .tab:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .tab.active {
    background: linear-gradient(135deg, #1f2937 0%, #0b1224 100%);
    border-color: #2b3a56;
  }

  .pill {
    padding: 6px 10px;
    border: 1px dashed #31405f;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
  }

  .title {
    font-size: 22px;
    margin: 6px 0;
  }

  .subtitle {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .sep {
    height: 1px;
    background: var(--line);
    margin: 12px 0;
  }

  /* Login */
  .login {
    display: grid;
    place-items: center;
    min-height: 70vh;
    text-align: center;
  }

  .login .panel {
    width: min(520px, 92vw);
    padding: 22px;
    border-radius: 16px;
    background: linear-gradient(180deg, #0b1224, #0e162d);
    border: 1px solid var(--line);
  }

  /* Print */
  @media print {
    body {
      background: white;
      color: black;
    }
    header.top,
    .no-print {
      display: none !important;
    }
    .card {
      border: 0;
    }
    .report-paper {
      border: 1px solid #999;
      padding: 12px;
    }
    table,
    tr,
    td,
    th {
      border: 1px solid #888;
    }
  }

  /* Report styles */
  .report-type-card {
    cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
  }

  .report-type-card:hover {
    transform: translateY(-3px);
    border-color: var(--accent);
  }

  .report-type-card.active {
    border-color: var(--accent);
    background: rgba(34, 197, 94, 0.1);
  }

  .report-separator {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    margin: 24px 0;
  }

  .report-footer {
    margin-top: 20px;
    padding-top: 12px;
    border-top: 1px solid var(--line);
  }

  .report-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .saved-reports-list {
    max-height: 400px;
    overflow-y: auto;
  }

  .saved-report-item {
    border-left: 3px solid var(--accent);
    margin-bottom: 8px;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .saved-report-item:hover {
    transform: translateX(4px);
  }

  .profit-loss-table {
    width: 100%;
    border-collapse: collapse;
  }

  .profit-loss-table th {
    background: var(--card);
    padding: 12px;
    text-align: center;
  }

  .profit-loss-table td {
    padding: 10px;
    border-bottom: 1px solid var(--line);
  }

  .profit-loss-total {
    font-weight: bold;
    background: rgba(16, 185, 129, 0.1);
  }

  /* Notification */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 8px;
    background: var(--accent);
    color: #001b12;
    font-weight: bold;
    z-index: 100;
    transform: translateY(100px);
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
  }

  .notification.show {
    transform: translateY(0);
    opacity: 1;
  }

  .notification.success {
    background: var(--accent);
  }

  .notification.error {
    background: var(--danger);
    color: white;
  }

  .notification.warning {
    background: var(--warn);
    color: #1f2937;
  }

  /* Loading overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.8);
    display: grid;
    place-items: center;
    z-index: 1000;
  }

  .loading-content {
    background: var(--card);
    padding: 24px;
    border-radius: 12px;
    text-align: center;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Branch management */
  .branch-management {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: var(--card);
    border-left: 1px solid var(--line);
    z-index: 50;
    transition: right 0.3s;
    padding: 16px;
    overflow-y: auto;
  }

  .branch-management.show {
    right: 0;
  }

  .branch-management h3 {
    margin-bottom: 16px;
  }

  /* Responsive adjustments */
  @media (max-width: 600px) {
    .branch-management {
      width: 100%;
      right: -100%;
    }
  }

  /* Dashboard Styles */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--card-bg);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 16px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: var(--card-shadow);
  }

  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
  }

  .stat-icon {
    font-size: 24px;
    margin-bottom: 8px;
  }

  .stat-value {
    font-size: 20px;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .stat-label {
    color: var(--muted);
    font-size: 14px;
  }

  .dashboard-card {
    margin-bottom: 20px;
  }

  /* Notification Styles */
  .notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .notification-container {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 2000;
    max-width: 350px;
  }

  .notification {
    background: var(--card-bg);
    border-left: 4px solid var(--accent);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease-out;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .notification.success {
    border-left-color: var(--accent);
  }

  .notification.warning {
    border-left-color: var(--warn);
  }

  .notification.error {
    border-left-color: var(--danger);
  }

  .notification.info {
    border-left-color: var(--info);
  }

  .notification-content {
    flex: 1;
    position: relative;
  }

  .notification-close {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 16px;
  }

  @keyframes slideIn {
    from {
      transform: translateX(-100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Chart Container */
  .chart-container {
    width: 100%;
    height: 300px;
    margin: 20px 0;
  }

  /* Backup Section */
  .backup-section {
    background: rgba(59, 130, 246, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
  }

  .backup-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    font-size: 14px;
  }

  .backup-success {
    color: var(--accent);
  }

  .backup-error {
    color: var(--danger);
  }

  /* Task Styles */
  .task-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--line);
  }

  .task-item:last-child {
    border-bottom: none;
  }

  .task-checkbox {
    margin: 0;
  }

  .task-completed {
    opacity: 0.7;
  }

  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  /* Loading */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Financial Reports Styles */
  .financial-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .tabs {
    display: flex;
    border-bottom: 2px solid var(--line);
    margin-bottom: 20px;
  }

  .tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .tab.active {
    border-bottom-color: var(--accent);
    color: var(--accent);
  }

  .tab:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .report-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    border-bottom: 2px solid var(--line);
  }

  .report-header h2 {
    margin: 0 0 10px 0;
    color: var(--accent);
  }

  /* Back Button */
  .back-button {
    display: inline-block;
    padding: 8px 16px;
    margin-bottom: 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--line);
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .back-button:hover {
    background: rgba(255, 255, 255, 0.15);
    color: var(--accent);
    transform: translateX(-2px);
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    background: var(--bg);
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--line);
  }

  .modal-header h3 {
    margin: 0;
    color: var(--accent);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--muted);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    color: var(--accent);
  }

  .modal-body {
    padding: 20px;
  }

  .modal-footer {
    padding: 20px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  /* User Role Colors */
  .user-card.admin {
    border-left: 4px solid #dc2626;
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
  }

  .user-card.manager {
    border-left: 4px solid #2563eb;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.05));
  }

  .user-card.accountant {
    border-left: 4px solid #059669;
    background: linear-gradient(135deg, rgba(5, 150, 105, 0.1), rgba(5, 150, 105, 0.05));
  }

  .user-card.employee {
    border-left: 4px solid #7c3aed;
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(124, 58, 237, 0.05));
  }

  .user-card.viewer {
    border-left: 4px solid #f59e0b;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
  }

  /* Permission Checkboxes */
  .permission-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    transition: background 0.3s ease;
  }

  .permission-item:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .permission-checkbox {
    margin-left: 10px;
    transform: scale(1.2);
  }

  .permission-label {
    flex: 1;
    color: var(--text);
  }

  /* Theme Colors for Different User Roles */
  body.theme-admin {
    --accent: #dc2626;
    --accent-light: rgba(220, 38, 38, 0.1);
  }

  body.theme-manager {
    --accent: #2563eb;
    --accent-light: rgba(37, 99, 235, 0.1);
  }

  body.theme-accountant {
    --accent: #059669;
    --accent-light: rgba(5, 150, 105, 0.1);
  }

  body.theme-employee {
    --accent: #7c3aed;
    --accent-light: rgba(124, 58, 237, 0.1);
  }

  body.theme-viewer {
    --accent: #f59e0b;
    --accent-light: rgba(245, 158, 11, 0.1);
  }

  /* Users Grid */
  .users-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .user-card {
    padding: 20px;
    border-radius: 12px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .user-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .user-info h4 {
    margin: 0 0 8px 0;
    color: var(--text);
    font-size: 18px;
  }

  .user-role {
    color: var(--accent);
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 4px;
  }

  .user-permissions {
    color: var(--muted);
    font-size: 12px;
  }

  .user-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .user-info-summary {
    text-align: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .user-info-summary h4 {
    margin: 0 0 8px 0;
    color: var(--accent);
  }

  .user-info-summary .user-role {
    color: var(--muted);
    font-size: 14px;
  }

  .user-branch {
    color: var(--accent);
    font-size: 12px;
    margin-bottom: 4px;
    font-weight: bold;
  }
</style>
</head>
<body>
<header class="top no-print">
  <div class="brand">
    <div class="logo">ج</div>
    <div>
      <div><strong>برنامج الجبرني المحاسبي</strong></div>
      <div class="tag">إدارة حسابات مغاسل السيارات - المملكة العربية السعودية</div>
    </div>
  </div>
  <div class="toolbar">
    <button class="btn ghost" id="btnHome" onclick="Router.go('home')">الرئيسية</button>
    <button class="btn ghost" id="btnDashboard" onclick="Router.go('dashboard')">لوحة التحكم</button>
    <button class="btn ghost" id="btnBranchManagement" onclick="Router.go('branch-management')">إدارة الفروع</button>
    <button class="btn ghost" id="btnMovement" onclick="Router.go('movement')">حركة الفروع</button>
    <button class="btn ghost" id="btnReports" onclick="Router.go('reports')">التقارير</button>
    <button class="btn ghost" id="btnFinancialReports" onclick="Router.go('financial-reports')">التقارير المالية</button>
    <button class="btn ghost" id="btnAccounts" onclick="Router.go('accounts')">مدير الحسابات</button>
    <button class="btn ghost" id="btnSettings" onclick="Router.go('settings')">الإعدادات</button>
    <button class="btn warn" id="btnCompany" onclick="Company.open()">بيانات الشركة</button>
    <span id="userBranchInfo" class="muted" style="margin: 0 10px; display: none;"></span>
    <button class="btn danger" id="btnLogout" onclick="Auth.logout()">تسجيل الخروج</button>

    <!-- Notification Bell -->
    <div style="position: relative;">
      <button class="btn ghost" id="btnNotifications" onclick="Notifications.toggleList()">
        🔔
        <span class="notification-badge hidden" id="notificationCount">0</span>
      </button>
      <div class="card hidden" id="notificationsList" style="position: absolute; top: 100%; left: 0; width: 300px; z-index: 100; margin-top: 8px;">
        <h3>الإشعارات</h3>
        <div id="notificationsContainer"></div>
      </div>
    </div>
  </div>
</header>



<!-- Notification -->
<div id="notification" class="notification"></div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div id="loadingText">جاري المعالجة...</div>
  </div>
</div>

<div class="container">
  <!-- Welcome / Login -->
  <section id="view-login" class="login">
    <div class="panel">
      <h1 style="margin:8px 0">مرحبًا بكم في برنامج الجبرني المحاسبي</h1>
      <div class="subtitle">الرجاء اختيار المستخدم لتسجيل الدخول</div>
      <div class="sep"></div>
      <div class="row">
        <div class="col-12">
          <label>المستخدم</label>
          <select id="loginUser" onkeydown="Auth.handleLoginEnterKey(event, 'loginPass')"></select>
        </div>
        <div class="col-12">
          <label>كلمة المرور</label>
          <input id="loginPass" type="password" class="input" placeholder="••••••" onkeydown="Auth.handleLoginEnterKey(event, 'loginBtn')" />
        </div>
      </div>
      <div class="toolbar" style="justify-content:center">
        <button id="loginBtn" class="btn acc" onclick="Auth.login()">دخول</button>
      </div>
    </div>
  </section>

  <!-- Home -->
  <section id="view-home" class="hidden">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="title">لوحة الفروع</div>
          <div class="subtitle">اضغط على أي فرع لفتح صفحته التي تحتوي جميع الكشوفات.</div>
          <div class="pill">بيانات الشركة تظهر في رأس كل تقرير.</div>
        </div>
      </div>
    </div>
    <div class="grid cards" id="branchesGrid"></div>
  </section>

  <!-- Dashboard -->
  <section id="view-dashboard" class="hidden">
    <div class="card">
      <div class="title">لوحة التحكم</div>
      <div class="subtitle">نظرة عامة على أداء النظام والاحصائيات المالية</div>

      <div class="branch-selector">
        <label>اختر الفرع:</label>
        <select id="dashboardBranch" class="input" onchange="Dashboard.load()" onkeydown="Dashboard.handleDashboardEnterKey(event)">
          <option value="all">جميع الفروع</option>
        </select>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">💰</div>
          <div class="stat-value" id="total-income">0.00 ر.س</div>
          <div class="stat-label">إجمالي الإيرادات</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">💸</div>
          <div class="stat-value" id="total-expenses">0.00 ر.س</div>
          <div class="stat-label">إجمالي المصروفات</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">📈</div>
          <div class="stat-value" id="net-profit">0.00 ر.س</div>
          <div class="stat-label">صافي الربح</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">🚗</div>
          <div class="stat-value" id="total-cars">0</div>
          <div class="stat-label">عدد السيارات</div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row">
        <div class="col-6">
          <div class="card dashboard-card">
            <h3>الإيرادات والمصروفات</h3>
            <div class="chart-container" id="incomeExpenseChart">
              <canvas id="incomeExpenseChartCanvas"></canvas>
            </div>
          </div>
        </div>

        <div class="col-6">
          <div class="card dashboard-card">
            <h3>توزيع المصروفات</h3>
            <div class="chart-container" id="expensesChart">
              <canvas id="expensesChartCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <div class="card dashboard-card">
            <h3>الفروع الأكثر ربحية</h3>
            <div id="top-branches-list">
              <div class="muted">جاري تحميل البيانات...</div>
            </div>
          </div>
        </div>

        <div class="col-6">
          <div class="card dashboard-card">
            <h3>أحدث الحركات المالية</h3>
            <div id="recent-transactions">
              <div class="muted">جاري تحميل البيانات...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card dashboard-card">
        <h3>التنبيهات المهمة</h3>
        <div id="important-alerts">
          <div class="muted">لا توجد تنبيهات حالية</div>
        </div>
      </div>

      <!-- Backup Section -->
      <div class="card dashboard-card">
        <h3>النسخ الاحتياطي</h3>
        <div class="backup-section">
          <p>احفظ نسخة احتياطية من جميع بيانات النظام لتجنب فقدان البيانات.</p>
          <div class="toolbar">
            <button class="btn acc" onclick="Backup.createBackup()">إنشاء نسخة احتياطية</button>
            <button class="btn info" onclick="Backup.restoreBackup()">استعادة نسخة</button>
            <button class="btn" onclick="Backup.downloadTemplate()">تحميل قالب البيانات</button>
          </div>
          <div class="backup-status" id="backupStatus"></div>
        </div>
      </div>

      <!-- Tasks Section -->
      <div class="card dashboard-card">
        <h3>المهام والتذكيرات</h3>
        <div class="row">
          <div class="col-8">
            <input type="text" id="newTask" class="input" placeholder="أضف مهمة جديدة...">
          </div>
          <div class="col-4">
            <button class="btn acc" onclick="Tasks.addTask()">إضافة</button>
          </div>
        </div>
        <div id="tasksList">
          <div class="muted">لا توجد مهام حالية</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Financial Reports -->
  <section id="view-financial-reports" class="hidden">
    <div class="card">
      <div class="title">التقارير المالية</div>
      <div class="subtitle">تقارير مالية شاملة عن أداء الشركة</div>

      <div class="tabs">
        <div class="tab active" onclick="FinancialReports.switchTab('trial-balance')">ميزان المراجعة</div>
        <div class="tab" onclick="FinancialReports.switchTab('income-statement')">قائمة الدخل</div>
        <div class="tab" onclick="FinancialReports.switchTab('balance-sheet')">الميزانية العمومية</div>
      </div>

      <div class="row">
        <div class="col-6">
          <label>من تاريخ</label>
          <input type="date" id="report-from" class="input" onkeydown="FinancialReports.handleReportEnterKey(event, 'report-to')">
        </div>
        <div class="col-6">
          <label>إلى تاريخ</label>
          <input type="date" id="report-to" class="input" onkeydown="FinancialReports.handleReportEnterKey(event, 'generateReportBtn')">
        </div>
        <div class="col-12 toolbar">
          <button id="generateReportBtn" class="btn acc" onclick="FinancialReports.generate()">إنشاء التقرير</button>
          <button class="btn info" onclick="FinancialReports.exportPDF()">تصدير PDF</button>
          <button class="btn" onclick="window.print()">طباعة</button>
        </div>
      </div>

      <div id="financial-report-result" class="report-paper"></div>
    </div>
  </section>

  <!-- Branch Management -->
  <section id="view-branch-management" class="hidden">
    <div class="card">
      <div class="title">إدارة الفروع</div>
      <div class="subtitle">إضافة وتعديل وحذف الفروع</div>

      <div class="row">
        <div class="col-4">
          <label>اسم الفرع</label>
          <input id="branchName" class="input" placeholder="مثال: فرع الشمال" onkeydown="BranchManagement.handleBranchEnterKey(event, 'branchManager')">
        </div>
        <div class="col-4">
          <label>مدير الفرع</label>
          <input id="branchManager" class="input" placeholder="اسم المدير" onkeydown="BranchManagement.handleBranchEnterKey(event, 'branchLocation')">
        </div>
        <div class="col-4">
          <label>الموقع</label>
          <input id="branchLocation" class="input" placeholder="المدينة / العنوان" onkeydown="BranchManagement.handleBranchEnterKey(event, 'addBranchBtn')">
        </div>
        <div class="col-12 toolbar">
          <button id="addBranchBtn" class="btn acc" onclick="BranchManagement.addBranch()">إضافة فرع</button>
        </div>
      </div>

      <div class="sep"></div>
      <h4>الفروع الحالية</h4>
      <div id="branchManagementList"></div>

      <div class="sep"></div>

      <!-- قسم مصروفات الفروع -->
      <div class="card" style="margin-top: 20px; background: rgba(255, 255, 255, 0.05);">
        <h4>إدارة مصروفات الفروع</h4>
        <div class="row">
          <div class="col-4">
            <label>اختر الفرع</label>
            <select id="expBranch" class="input" onchange="BranchManagement.loadBranchExpenses()">
              <option value="">اختر الفرع</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-4"><label>مصروف إيجار</label><input id="expRent" type="number" class="input" placeholder="المبلغ" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expSalaries')"></div>
          <div class="col-4"><label>مصروف رواتب</label><input id="expSalaries" type="number" class="input" placeholder="المبلغ" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expAdmin')"></div>
          <div class="col-4"><label>مصروف إدارة</label><input id="expAdmin" type="number" class="input" placeholder="المبلغ" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expBank')"></div>
          <div class="col-4"><label>مصروف رسوم بنكية</label><input id="expBank" type="number" class="input" placeholder="المبلغ" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expLoss')"></div>
          <div class="col-4"><label>مصروف خسارة سابقة</label><input id="expLoss" type="number" class="input" placeholder="المبلغ" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expOther')"></div>
          <div class="col-4"><label>مصروفات أخرى</label><input id="expOther" type="number" class="input" placeholder="المبلغ" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'saveExpensesBtn')"></div>
        </div>
        <div class="toolbar">
          <button id="saveExpensesBtn" class="btn acc" onclick="BranchManagement.saveExpenses()">حفظ المصروفات</button>
          <button class="btn ghost" onclick="BranchManagement.clearExpenseForm()">مسح الحقول</button>
        </div>
      </div>
    </div>
  </section>





  <!-- Accounts Management -->
  <section id="view-accounts" class="hidden">
    <div class="card">
      <div class="title">إدارة الحسابات المالية</div>
      <div class="subtitle">إدارة الحسابات والمعاملات المالية</div>

      <div class="tabs">
        <div class="tab active" onclick="Accounts.switchTab('accounts')">الحسابات</div>
        <div class="tab" onclick="Accounts.switchTab('transactions')">المعاملات</div>
      </div>

      <div id="accounts-content">
        <div class="row">
          <div class="col-6">
            <label>نوع الحساب</label>
            <select id="accountType" class="input" onkeydown="Accounts.handleAccountEnterKey(event, 'accountName')">
              <option value="assets">الأصول</option>
              <option value="liabilities">الخصوم</option>
              <option value="equity">حقوق الملكية</option>
              <option value="revenue">الإيرادات</option>
              <option value="expenses">المصروفات</option>
            </select>
          </div>
          <div class="col-6">
            <label>اسم الحساب</label>
            <input id="accountName" class="input" placeholder="اسم الحساب" onkeydown="Accounts.handleAccountEnterKey(event, 'accountBalance')">
          </div>
          <div class="col-6">
            <label>الرصيد الافتتاحي</label>
            <input id="accountBalance" type="number" class="input" placeholder="0.00" onkeydown="Accounts.handleAccountEnterKey(event, 'addAccountBtn')">
          </div>
          <div class="col-6 toolbar" style="align-items: flex-end;">
            <button id="addAccountBtn" class="btn acc" onclick="Accounts.addAccount()">إضافة حساب</button>
          </div>
        </div>

        <div id="accountsList"></div>
      </div>

      <div id="transactions-content" class="hidden">
        <div class="row">
          <div class="col-4">
            <label>الفرع</label>
            <select id="transactionBranch" class="input"></select>
          </div>
          <div class="col-4">
            <label>نوع المعاملة</label>
            <select id="transactionType" class="input">
              <option value="debit">مدين</option>
              <option value="credit">دائن</option>
            </select>
          </div>
          <div class="col-4">
            <label>الحساب</label>
            <select id="transactionAccount" class="input"></select>
          </div>
          <div class="col-6">
            <label>المبلغ</label>
            <input id="transactionAmount" type="number" class="input" placeholder="0.00">
          </div>
          <div class="col-6">
            <label>الوصف</label>
            <input id="transactionDescription" class="input" placeholder="وصف المعاملة">
          </div>
          <div class="col-12 toolbar">
            <button class="btn acc" onclick="Accounts.addTransaction()">إضافة معاملة</button>
          </div>
        </div>

        <div id="transactionsList"></div>
      </div>
    </div>
  </section>

  <!-- Branch -->
  <section id="view-branch" class="hidden">
    <div class="card">
      <div class="title" id="branchTitle">الفرع</div>
      <div class="subtitle" id="branchSub"></div>
      <div class="tabs no-print" id="branchTabs"></div>
      <div id="branchForms"></div>
    </div>
  </section>



  <!-- Form Page -->
  <section id="view-form" class="hidden">
    <div class="card">
      <div class="title" id="formTitle">كشف البيانات</div>
      <div class="subtitle" id="formSubtitle">إدارة البيانات للفرع</div>

      <div id="formContent">
        <!-- Form content will be populated by JavaScript -->
      </div>

      <div class="sep"></div>
      <h4 id="formRecordsTitle">سجل البيانات</h4>
      <div id="formRecordsList"></div>
    </div>

    <button class="back-button" onclick="UI.goBackToBranch()" title="العودة للفرع">
      ←
    </button>
  </section>

  <!-- Reports Main View -->
  <section id="view-reports" class="hidden">
    <div class="card">
      <div class="title">التقارير المحاسبية</div>
      <div class="subtitle">اختر نوع التقرير الذي تريد إنشاءه</div>
      
      <div class="grid cards" style="grid-template-columns:repeat(auto-fill,minmax(300px,1fr));margin-top:16px">
        <!-- Daily Report Card -->
        <div class="card report-type-card" onclick="Router.go('daily-reports')">
          <h3>📅 التقرير اليومي</h3>
          <div class="muted">إنشاء تقارير يومية متعددة للفرع المحدد</div>
        </div>
        
        <!-- Monthly Report Card -->
        <div class="card report-type-card" onclick="Router.go('monthly-reports')">
          <h3>📆 التقرير الشهري</h3>
          <div class="muted">إنشاء تقارير شهرية متعددة للفرع المحدد</div>
        </div>
        
        <!-- Custom Report Card -->
        <div class="card report-type-card" onclick="Router.go('custom-reports')">
          <h3>🗓️ التقرير العشوائي</h3>
          <div class="muted">إنشاء تقارير لأي فترة زمنية محددة</div>
        </div>
        
        <!-- Saved Reports Card -->
        <div class="card report-type-card" onclick="Router.go('saved-reports')">
          <h3>📂 التقارير الجاهزة</h3>
          <div class="muted">عرض جميع التقارير المحفوظة في النظام</div>
        </div>
        
        <!-- Profit/Loss Report Card -->
        <div class="card report-type-card" onclick="Router.go('profit-loss')">
          <h3>💰 تقرير الأرباح والخسائر</h3>
          <div class="muted">تقرير مفصل بالأرباح والخسائر للفرع المحدد</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Daily Reports -->
  <section id="view-daily-reports" class="hidden">
    <div class="card">
      <div class="title">📅 التقرير اليومي</div>
      <div class="subtitle">اختر الفرع ونوع التقرير والتاريخ لإنشاء تقرير يومي</div>
      
      <div class="row">
        <div class="col-4">
          <label>الفرع</label>
          <select id="dailyRepBranch" class="input"></select>
        </div>
        <div class="col-4">
          <label>التاريخ</label>
          <input type="date" id="dailyRepDate" class="input"/>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div class="title" style="font-size:18px">اختر نوع التقرير</div>
      <div class="subtitle">يمكن اختيار أكثر من تقرير في نفس الوقت</div>
      
      <div class="grid cards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr));margin-top:12px" id="dailyReportTypes">
        <!-- سيتم ملؤها بواسطة JavaScript -->
      </div>
      
      <div class="toolbar" style="justify-content:center;margin-top:16px">
        <button class="btn acc" onclick="Reports.generateDaily()">إنشاء التقرير</button>
        <button class="btn info" onclick="Reports.exportDailyToExcel()">📊 تصدير Excel</button>
        <button class="btn ghost" onclick="Router.go('reports')">رجوع</button>
      </div>
    </div>
  </section>

  <!-- Monthly Reports -->
  <section id="view-monthly-reports" class="hidden">
    <div class="card">
      <div class="title">📆 التقرير الشهري</div>
      <div class="subtitle">اختر الفرع ونوع التقرير والشهر لإنشاء تقرير شهري</div>
      
      <div class="row">
        <div class="col-4">
          <label>الفرع</label>
          <select id="monthlyRepBranch" class="input"></select>
        </div>
        <div class="col-4">
          <label>الشهر</label>
          <input type="month" id="monthlyRepMonth" class="input"/>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div class="title" style="font-size:18px">اختر نوع التقرير</div>
      <div class="subtitle">يمكن اختيار أكثر من تقرير في نفس الوقت</div>
      
      <div class="grid cards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr));margin-top:12px" id="monthlyReportTypes">
        <!-- سيتم ملؤها بواسطة JavaScript -->
      </div>
      
      <div class="toolbar" style="justify-content:center;margin-top:16px">
        <button class="btn acc" onclick="Reports.generateMonthly()">إنشاء التقرير</button>
        <button class="btn info" onclick="Reports.exportMonthlyToExcel()">📊 تصدير Excel</button>
        <button class="btn ghost" onclick="Router.go('reports')">رجوع</button>
      </div>
    </div>
  </section>

  <!-- Custom Reports -->
  <section id="view-custom-reports" class="hidden">
    <div class="card">
      <div class="title">🗓️ التقرير العشوائي</div>
      <div class="subtitle">اختر الفرع ونوع التقرير والفترة الزمنية لإنشاء تقرير مخصص</div>
      
      <div class="row">
        <div class="col-4">
          <label>الفرع</label>
          <select id="customRepBranch" class="input"></select>
        </div>
        <div class="col-2">
          <label>من تاريخ</label>
          <input type="date" id="customRepFrom" class="input"/>
        </div>
        <div class="col-2">
          <label>إلى تاريخ</label>
          <input type="date" id="customRepTo" class="input"/>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div class="title" style="font-size:18px">اختر نوع التقرير</div>
      <div class="subtitle">يمكن اختيار أكثر من تقرير في نفس الوقت</div>
      
      <div class="grid cards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr));margin-top:12px" id="customReportTypes">
        <!-- سيتم ملؤها بواسطة JavaScript -->
      </div>
      
      <div class="toolbar" style="justify-content:center;margin-top:16px">
        <button class="btn acc" onclick="Reports.generateCustom()">إنشاء التقرير</button>
        <button class="btn ghost" onclick="Router.go('reports')">رجوع</button>
      </div>
    </div>
  </section>

  <!-- Saved Reports -->
  <section id="view-saved-reports" class="hidden">
    <div class="card">
      <div class="title">📂 التقارير الجاهزة</div>
      <div class="subtitle">عرض جميع التقارير المحفوظة في النظام</div>
      
      <div class="tabs" style="margin-bottom:16px">
        <div class="tab active" onclick="Reports.showSavedType('all')">الكل</div>
        <div class="tab" onclick="Reports.showSavedType('daily')">يومية</div>
        <div class="tab" onclick="Reports.showSavedType('monthly')">شهرية</div>
        <div class="tab" onclick="Reports.showSavedType('custom')">عشوائية</div>
        <div class="tab" onclick="Reports.showSavedType('profit-loss')">أرباح/خسائر</div>
      </div>
      
      <div class="saved-reports-list" id="savedReportsList">
        <!-- سيتم ملؤها بالتقارير المحفوظة -->
      </div>
    </div>
  </section>

  <!-- Profit/Loss Reports -->
  <section id="view-profit-loss" class="hidden">
    <div class="card">
      <div class="title">💰 تقرير الأرباح والخسائر</div>
      <div class="subtitle">إعداد تقرير الأرباح والخسائر للفرع المحدد</div>
      
      <div class="row">
        <div class="col-4">
          <label>الفرع</label>
          <select id="plBranch" class="input"></select>
        </div>
        <div class="col-4">
          <label>الشهر</label>
          <input type="month" id="plMonth" class="input"/>
        </div>
      </div>
      
      <div class="toolbar" style="justify-content:center;margin-top:16px">
        <button class="btn acc" onclick="Reports.generateProfitLoss()">إنشاء التقرير</button>
        <button class="btn ghost" onclick="Router.go('reports')">رجوع</button>
      </div>
    </div>
  </section>

  <!-- Report Display View -->
  <section id="view-report-display" class="hidden">
    <div class="card">
      <div id="reportDisplayArea"></div>
    </div>
  </section>

  <!-- Movement -->
  <section id="view-movement" class="hidden">
    <div class="card">
      <div class="title">حركة الفروع اليومية</div>
      <div class="subtitle">اختر الفرع ثم نوع الحركة ثم حدد المدة. يمكن أيضًا استخراج إحصائية (الفرع الأكثر/الأقل).</div>

      <div class="row">
        <div class="col-4">
          <label>الفرع</label>
          <select id="mvBranch"></select>
        </div>
        <div class="col-4">
          <label>نوع الحركة</label>
          <select id="mvType"></select>
        </div>
        <div class="col-2">
          <label>من تاريخ</label>
          <input type="date" id="mvFrom" class="input"/>
        </div>
        <div class="col-2">
          <label>إلى تاريخ</label>
          <input type="date" id="mvTo" class="input"/>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn acc" onclick="Movement.generate()">موافق</button>
        <button class="btn ghost" onclick="Movement.clear()">مسح</button>
        <button class="btn" onclick="window.print()">طباعة / حفظ PDF</button>
      </div>

      <div class="sep"></div>

      <div class="title" style="font-size:18px">إحصائيات اختيارية</div>
      <div class="subtitle">حدد الحركة ونطاق التاريخ لجميع الفروع لمعرفة الفرع الأكثر/الأقل.</div>
      <div class="row">
        <div class="col-4">
          <label>حركة للإحصائية</label>
          <select id="mvAggType"></select>
        </div>
        <div class="col-2">
          <label>من تاريخ</label>
          <input type="date" id="mvAggFrom" class="input"/>
        </div>
        <div class="col-2">
          <label>إلى تاريخ</label>
          <input type="date" id="mvAggTo" class="input"/>
        </div>
        <div class="col-4" style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn warn" onclick="Movement.calcTop()">الأكثر</button>
          <button class="btn warn" onclick="Movement.calcBottom()">الأقل</button>
        </div>
      </div>

      <div id="movementArea" class="report-paper"></div>
      <div id="movementAggArea" class="report-paper" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- صفحة تعبئة الكشف -->
  <section id="view-form" class="hidden">
    <div class="card" id="formPageArea"></div>
  </section>

  <!-- Settings -->
  <section id="view-settings" class="hidden">
    <div class="grid">
      <div class="card">
        <h3>المستخدمون</h3>
        <div class="row">
          <div class="col-4"><label>اسم المستخدم</label><input id="setUserName" class="input" placeholder="username" onkeydown="Settings.handleEnterKey(event, 'setUserPass')"></div>
          <div class="col-4"><label>كلمة المرور</label><input id="setUserPass" class="input" placeholder="••••••" onkeydown="Settings.handleEnterKey(event, 'setUserRole')"></div>
          <div class="col-4"><label>نوع المستخدم</label>
            <select id="setUserRole" onchange="Settings.toggleBranchSelection()" onkeydown="Settings.handleEnterKey(event, 'setUserBranch')">
              <option value="admin">مدير نظام</option>
              <option value="manager">مدير</option>
              <option value="branch-manager">مدير فرع</option>
              <option value="accountant">محاسب</option>
              <option value="employee">موظف</option>
              <option value="viewer">عرض فقط</option>
            </select>
          </div>
          <div class="col-4" id="settingsBranchDiv" style="display: none;">
            <label>الفرع المخصص</label>
            <select id="setUserBranch" class="input" onkeydown="Settings.handleEnterKey(event, 'addUserBtn')">
              <option value="">اختر الفرع</option>
            </select>
          </div>
          <div class="col-12 toolbar">
            <button id="addUserBtn" class="btn acc" onclick="Settings.addUser()">إضافة مستخدم</button>
          </div>
        </div>
        <div id="settingsUsersList"></div>
      </div>

      <div class="card">
        <h3>بيانات الشركة (تظهر في الترويسة لكل تقرير)</h3>
        <div class="row">
          <div class="col-6"><label>اسم الشركة</label><input id="coName" class="input" placeholder="اسم الشركة" onkeydown="Settings.handleCompanyEnterKey(event, 'coPhone')"></div>
          <div class="col-3"><label>الهاتف</label><input id="coPhone" class="input" placeholder="05xxxxxxxx" onkeydown="Settings.handleCompanyEnterKey(event, 'coCR')"></div>
          <div class="col-3"><label>السجل التجاري</label><input id="coCR" class="input" placeholder="CR" onkeydown="Settings.handleCompanyEnterKey(event, 'coAddr')"></div>
          <div class="col-12"><label>العنوان</label><input id="coAddr" class="input" placeholder="المدينة - الحي - الشارع" onkeydown="Settings.handleCompanyEnterKey(event, 'saveCompany')"></div>
          <div class="col-12 toolbar">
            <button id="saveCompany" class="btn acc" onclick="Company.save()">حفظ البيانات</button>
          </div>
        </div>
      </div>


    </div>
  </section>

</div>

<!-- Simple modal for company quick edit -->
<div id="companyModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:grid;place-items:center;z-index:50">
  <div class="card" style="width:min(520px,94vw)">
    <h3>بيانات الشركة</h3>
    <div class="row">
      <div class="col-6"><label>اسم الشركة</label><input id="mcoName" class="input" onkeydown="Company.handleCompanyModalEnterKey(event, 'mcoPhone')"></div>
      <div class="col-3"><label>الهاتف</label><input id="mcoPhone" class="input" onkeydown="Company.handleCompanyModalEnterKey(event, 'mcoCR')"></div>
      <div class="col-3"><label>السجل التجاري</label><input id="mcoCR" class="input" onkeydown="Company.handleCompanyModalEnterKey(event, 'mcoAddr')"></div>
      <div class="col-12"><label>العنوان</label><input id="mcoAddr" class="input" onkeydown="Company.handleCompanyModalEnterKey(event, 'saveModalBtn')"></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <button class="btn ghost" onclick="Company.close()">إلغاء</button>
      <button id="saveModalBtn" class="btn acc" onclick="Company.saveModal()">حفظ</button>
    </div>
  </div>
</div>

<script>
/* ========= Utilities / Storage ========= */
/*
  هذا القسم يحتوي على:
  - دوال مساعدة عامة
  - إدارة البيانات المحلية
  - تعريف النماذج والأذونات
*/
const DB_KEY = "aljaberni_db_v2";
const todayStr = () => new Date().toISOString().slice(0,10);
const firstOfMonthStr = () => {
  const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;
};
const uid = () => {
  if (crypto.randomUUID) return crypto.randomUUID();
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
};
const PERMISSIONS = [
  {k:'branches',label:'إدارة الفروع'},
  {k:'reports',label:'عرض التقارير'},
  {k:'settings',label:'تعديل الإعدادات'},
  {k:'users',label:'إدارة المستخدمين'},
  {k:'company',label:'تعديل بيانات الشركة'},
  {k:'movement',label:'حركة الفروع'},
  {k:'editData',label:'إدخال وتعديل البيانات'},
  {k:'financial',label:'التقارير المالية'},
  {k:'dashboard',label:'لوحة التحكم'},
  {k:'accounts',label:'إدارة الحسابات'},
];

/* ========= Security Module ========= */
const Security = {
  // إزالة تشفير كلمة المرور - إرجاع كلمة المرور كما هي
  hashPassword(password) {
    return password;
  },

  // التحقق من كلمة المرور بدون تشفير
  verifyPassword(password, storedPassword) {
    return password === storedPassword;
  },

  // تنظيف المدخلات من XSS
  sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return DOMPurify.sanitize(input, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
  },

  // التحقق من صحة المدخلات
  validateInput(input, type = 'text') {
    const sanitized = this.sanitizeInput(input);

    switch(type) {
      case 'email':
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(sanitized);
      case 'phone':
        const phoneRegex = /^[\d\s\-\+\(\)]+$/;
        return phoneRegex.test(sanitized);
      case 'number':
        return !isNaN(Number(sanitized)) && sanitized.trim() !== '';
      default:
        return sanitized.length > 0;
    }
  },

  // تسجيل نشاط المستخدم
  logActivity(action, details = {}) {
    const activity = {
      id: uid(),
      userId: State.user ? State.user.id : 'system',
      userName: State.user ? State.user.name : 'System',
      action,
      details,
      timestamp: new Date().toISOString(),
      ip: 'client-side' // في التطبيق الحقيقي، يمكن الحصول على IP
    };

    if (!State.db.auditTrail) State.db.auditTrail = [];
    State.db.auditTrail.push(activity);

    // الاحتفاظ بآخر 1000 سجل فقط
    if (State.db.auditTrail.length > 1000) {
      State.db.auditTrail = State.db.auditTrail.slice(-1000);
    }

    DB.save();

    // تسجيل في console للتصحيح
    console.log(`[AUDIT] ${activity.timestamp} - ${activity.userName}: ${action}`, details);
  },

  // نظام logging بسيط
  log(level, message, data = {}) {
    const logEntry = {
      id: uid(),
      level,
      message,
      data,
      timestamp: new Date().toISOString(),
      user: State.user ? State.user.name : 'System'
    };

    // حفظ في localStorage
    const logs = JSON.parse(localStorage.getItem('aljaberni_logs') || '[]');
    logs.push(logEntry);

    // الاحتفاظ بآخر 500 سجل فقط
    if (logs.length > 500) {
      logs.shift();
    }

    localStorage.setItem('aljaberni_logs', JSON.stringify(logs));

    // تسجيل في console
    const colors = {
      error: '\x1b[31m',
      warn: '\x1b[33m',
      info: '\x1b[36m',
      debug: '\x1b[35m'
    };

    console.log(`${colors[level] || ''}[${level.toUpperCase()}] ${logEntry.timestamp} - ${message}`, data);
  },

  // عرض سجل الأنشطة
  getAuditTrail() {
    return State.db.auditTrail || [];
  },

  // عرض السجلات
  getLogs() {
    return JSON.parse(localStorage.getItem('aljaberni_logs') || '[]');
  },

  // تحويل كلمات المرور المشفرة إلى نص عادي (إزالة التشفير)
  downgradePasswords() {
    const raw = localStorage.getItem(DB_KEY);
    if (!raw) return false;

    try {
      const data = JSON.parse(raw);
      if (!data.users) return false;

      let downgraded = false;
      data.users.forEach(user => {
        // التحقق من أن كلمة المرور مشفرة (تحتوي على رموز تشفير)
        if (user.pass && (user.pass.includes('$') || user.pass.includes('=') || user.pass.length > 20)) {
          // هذه كلمة مرور مشفرة - نحولها إلى نص عادي
          // لا يمكن فك التشفير، لذا سنستبدلها بكلمة مرور افتراضية
          user.pass = 'admin123'; // كلمة مرور افتراضية للمستخدمين المشفرين
          downgraded = true;
          Security.log('info', `Password downgraded for user: ${user.name}`);
        }
      });

      if (downgraded) {
        localStorage.setItem(DB_KEY, JSON.stringify(data));
        State.db = data;
        Security.log('info', 'Password downgrade completed successfully');

        // إشعار للمستخدم
        setTimeout(() => {
          Notifications.add('إزالة التشفير', 'تم إزالة تشفير كلمات المرور - استخدم admin123 للدخول', 'warning');
        }, 1000);

        // إشعار في Console
        console.log('🔓 تم إزالة تشفير كلمات المرور - جميع كلمات المرور أصبحت admin123');

        return true;
      }

      return false;
    } catch (error) {
      Security.log('error', 'Password downgrade failed', { error: error.message });
      console.error('❌ فشل في إزالة تشفير كلمات المرور:', error);
      return false;
    }
  },

  // دالة للتحقق من حالة كلمات المرور (للتصحيح)
  checkPasswordStatus() {
    const raw = localStorage.getItem(DB_KEY);
    if (!raw) {
      console.log('📁 لا توجد بيانات محفوظة');
      return;
    }

    try {
      const data = JSON.parse(raw);
      if (!data.users) {
        console.log('👥 لا يوجد مستخدمون');
        return;
      }

      console.log('🔍 فحص حالة كلمات المرور:');
      data.users.forEach(user => {
        const isPlainText = user.pass && !user.pass.includes('$') && !user.pass.includes('=') && user.pass.length <= 20;
        console.log(`   ${user.name}: ${isPlainText ? '📝 نص عادي' : '🔐 مشفرة'}`);
      });
    } catch (error) {
      console.error('❌ خطأ في فحص البيانات:', error);
    }
  }
};

const q = (sel,root=document)=>root.querySelector(sel);
const qa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const fmt = n => (isNaN(+n)?0:+n).toLocaleString('ar-EG',{maximumFractionDigits:2});
const parseNum = v => Number(String(v||"").replace(/[^\d.\-]/g,""))||0;

const MODELS = {
  // تعريف جميع أنواع الكشوفات مع الحقول
  forms: {
    "dailyRevenue": {label:"كشف الإيرادات اليومية", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"network",label:"إيراد شبكة",type:"number"},
      {k:"cash",label:"إيراد كاش",type:"number"},
      {k:"credit",label:"إيراد آجل",type:"number"},
      {k:"cars",label:"عدد السيارات",type:"number"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    "bankRecon": {label:"كشف بيان الموازنات البنكية", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"mada",label:"مدى",type:"number"},
      {k:"visa",label:"فيزا",type:"number"},
      {k:"master",label:"ماستر كارد",type:"number"},
      {k:"other1",label:"أخرى 1",type:"number"},
      {k:"other2",label:"أخرى 2",type:"number"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    "cashPurch": {label:"كشف المشتريات النقدية (مدير الفرع)", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"item",label:"الصنف المشترى",type:"text"},
      {k:"price",label:"سعر الصنف",type:"number"},
      {k:"inv",label:"رقم الفاتورة",type:"text"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    "creditPurch": {label:"كشف المشتريات الآجلة (مواد)", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"item",label:"الصنف المشترى",type:"text"},
      {k:"price",label:"سعر الصنف",type:"number"},
      {k:"inv",label:"رقم الفاتورة",type:"text"},
      {k:"supplier",label:"اسم المورد",type:"text"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    "dailyMeals": {label:"كشف التغذية اليومية للموظفين", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"who",label:"المتغذي (مدير/مشرف/موظفين...)",type:"text"},
      {k:"amount",label:"مبلغ التغذية",type:"number"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    "empAdvance": {label:"سلف الموظفين/سحبيات", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"emp",label:"اسم الموظف",type:"picker-emp"},
      {k:"salary",label:"الراتب المستحق",type:"readonly"},
      {k:"take",label:"سحبية اليوم",type:"number"},
      {k:"prev",label:"سلفة سابقة (آلية العرض)",type:"readonly"},
      {k:"totalTaken",label:"إجمالي المسحوبات",type:"readonly"},
      {k:"remain",label:"المتبقي له/عليه",type:"readonly"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    // كشوفات خاصة بالمحاسب
    "supMaintenance": {label:"كشف صيانة المشرف", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"maint",label:"الصيانة",type:"text"},
      {k:"kind",label:"نوعها",type:"text"},
      {k:"amount",label:"مبلغ الصيانة",type:"number"},
      {k:"inv",label:"رقم الفاتورة (إن وجد)",type:"text"},
      {k:"by",label:"من قام بالصيانة",type:"text"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    "marketPurch": {label:"كشف المشتريات السوقية (موظف سوق)", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"item",label:"الصنف المشترى",type:"text"},
      {k:"amount",label:"مبلغ الصنف",type:"number"},
      {k:"inv",label:"رقم الفاتورة",type:"text"},
      {k:"qty",label:"الكمية",type:"number"},
      {k:"buyer",label:"اسم المشتري",type:"text"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    "mgrMaintenance": {label:"كشف صيانة المدير", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"type",label:"نوع الصيانة",type:"select",opts:["عادي","دوري"]},
      {k:"desc",label:"نوع الصيانة (وصف)",type:"text"},
      {k:"amount",label:"المبلغ",type:"number"},
      {k:"party",label:"الجهة التي قامت بالصيانة / المدفوع لها",type:"text"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    "mgrPurch": {label:"كشف مشتريات المدير", fields:[
      {k:"date",label:"التاريخ",type:"date",def:todayStr()},
      {k:"item",label:"الصنف المشترى",type:"text"},
      {k:"amount",label:"مبلغ الصنف",type:"number"},
      {k:"inv",label:"رقم الفاتورة",type:"text"},
      {k:"qty",label:"الكمية",type:"number"},
      {k:"note",label:"ملاحظة",type:"text"}
    ]},
    // إدارة الموظفين (في صفحة الفرع)
    "empAdd": {label:"إضافة موظّف", fields:[
      {k:"name",label:"اسم الموظف",type:"text"},
      {k:"salary",label:"الراتب المستحق",type:"number"},
      {k:"phone",label:"رقم الهاتف (اختياري)",type:"text"},
      {k:"role",label:"الرتبة الوظيفية",type:"select",opts:["مدير","مشرف","موظّف"]}
    ]}
  },
  // ترتيب التبويبات داخل صفحة الفرع
  branchTabs: [
    {k:"dailyRevenue",icon:"💵"},
    {k:"bankRecon",icon:"🏦"},
    {k:"cashPurch",icon:"🧾"},
    {k:"creditPurch",icon:"📦"},
    {k:"dailyMeals",icon:"🍽️"},
    {k:"empAdvance",icon:"👨‍👩‍👧‍👦"},
    {k:"supMaintenance",icon:"🛠️"},
    {k:"marketPurch",icon:"🛍️"},
    {k:"mgrMaintenance",icon:"⚙️"},
    {k:"mgrPurch",icon:"🧰"},
    {k:"empAdd",icon:"➕"},
    {k:"__monthlyTotal__",icon:"📊",label:"الإجمالي"}
  ],
  reportTypes: [
    {k:"dailyRevenue",label:"إيرادات يومية"},
    {k:"bankRecon",label:"موازنات بنكية"},
    {k:"cashPurch",label:"مشتريات نقدية"},
    {k:"creditPurch",label:"مشتريات آجلة"},
    {k:"dailyMeals",label:"التغذية اليومية"},
    {k:"empAdvance",label:"سلف/سحبيات الموظفين"},
    {k:"supMaintenance",label:"صيانة المشرف"},
    {k:"marketPurch",label:"مشتريات سوقية"},
    {k:"mgrMaintenance",label:"صيانة المدير"},
    {k:"mgrPurch",label:"مشتريات المدير"}
  ]
};

/*
  ملاحظة مهمة حول قاعدة البيانات:
  النظام الحالي يستخدم localStorage للبساطة، لكن للإنتاج يُفضل استخدام:

  1. قاعدة بيانات SQL (MySQL/PostgreSQL):
     - إنشاء جداول منفصلة للمستخدمين، الفروع، السجلات، إلخ
     - استخدام prepared statements لمنع SQL injection
     - إضافة indexes للأداء

  2. قاعدة بيانات NoSQL (MongoDB):
     - تخزين البيانات كـJSON documents
     - سهولة التوسع والتطوير
     - مناسب للبيانات المعقدة

  3. Backend API:
     - Node.js مع Express.js
     - PHP مع Laravel
     - Python مع Django/FastAPI
     - إضافة authentication بـJWT
     - إضافة rate limiting و validation

  4. Cloud Solutions:
     - Firebase (سهل التكامل)
     - Supabase (PostgreSQL كخدمة)
     - MongoDB Atlas
     - AWS RDS أو Google Cloud SQL

  للتحويل إلى backend حقيقي، استبدل دوال DB بـAPI calls.
*/

const DB = {
  load(){
    const raw = localStorage.getItem(DB_KEY);
    if(raw){ try { return JSON.parse(raw) } catch { /* ignore */ } }
    // seed default
    const seed = {
      company:{name:"شركة الجبرني",phone:"",cr:"",addr:""},
      users:[
        {id:uid(),name:"admin",pass:"admin123",role:"admin",perms:{
          branches: true, reports: true, settings: true, users: true,
          company: true, movement: true, editData: true, financial: true,
          dashboard: true, accounts: true
        }}
      ],
      branches:[
        {id:"branch-main",name:"الفرع الرئيسي",manager:"مدير افتراضي",loc:"الرياض"},
        {id:"branch-north",name:"فرع الشمال",manager:"أحمد محمد",loc:"الدمام"}
      ],
      employees:{}, // branchId => [ {name,salary,phone,role} ]
      records:{},    // branchId => { formKey: [rows] }
      expenses:{},   // branchId => { rent, salaries, admin, bank, loss, other }
      savedReports:[], // { id, type, branchId, date, title, reports:[] }
      accounts: {},
      financialData: {
        accounts: {
          assets: [
            {id: uid(), name: "النقدية", balance: 50000},
            {id: uid(), name: "البنك", balance: 150000},
            {id: uid(), name: "المخزون", balance: 30000}
          ],
          liabilities: [
            {id: uid(), name: "القروض", balance: 40000},
            {id: uid(), name: "الموردين", balance: 25000}
          ],
          equity: [
            {id: uid(), name: "رأس المال", balance: 100000},
            {id: uid(), name: "الأرباح المحتجزة", balance: 65000}
          ],
          revenue: [
            {id: uid(), name: "إيرادات المبيعات", balance: 200000},
            {id: uid(), name: "إيرادات أخرى", balance: 15000}
          ],
          expenses: [
            {id: uid(), name: "الرواتب", balance: 80000},
            {id: uid(), name: "الإيجار", balance: 24000},
            {id: uid(), name: "المرافق", balance: 5000},
            {id: uid(), name: "الصيانة", balance: 7000}
          ]
        }
      },
      // New data structures for notifications and tasks
      notifications: [],
      tasks: [],
      backupHistory: [],
      transactions: {}
    };

    // Initialize permissions for admin user
    PERMISSIONS.forEach(p => {
      seed.users[0].perms[p.k] = true;
    });

    // init containers for default branches
    seed.branches.forEach(branch => {
      seed.records[branch.id] = {};
      Object.keys(MODELS.forms).forEach(k=> seed.records[branch.id][k] = []);
      seed.employees[branch.id] = [];
      seed.expenses[branch.id] = {};
    });


    localStorage.setItem(DB_KEY, JSON.stringify(seed));
    return seed;
  },
  save(){
    localStorage.setItem(DB_KEY, JSON.stringify(State.db));

    // في التطبيق الحقيقي مع backend:
    // return fetch('/api/save', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify(State.db)
    // }).then(res => res.json());
  }
}
const State = { db: DB.load(), user:null, currentBranch:null, selectedReportTypes:[] };

function ensureBranchContainers(bid){
  if(!State.db.records[bid]) State.db.records[bid] = {};
  Object.keys(MODELS.forms).forEach(k=>{
    if(!State.db.records[bid][k]) State.db.records[bid][k] = [];
  });
  if(!State.db.employees[bid]) State.db.employees[bid] = [];
  if(!State.db.expenses[bid]) State.db.expenses[bid] = {};
}





/* ========= Notification System ========= */
/*
  نظام الإشعارات:
  - إشعارات محلية في التطبيق
  - إشعارات بريد إلكتروني محاكاة
  - تتبع الإشعارات المرسلة
*/
const Notification = {
  show(message, type = 'success', duration = 3000) {
    const notification = q('#notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.className = 'notification';
    notification.classList.add(type);
    notification.classList.add('show');
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, duration);
  }
};

/* ========= Loading Overlay ========= */
const Loading = {
  show(message = 'جاري المعالجة...') {
    const overlay = q('#loadingOverlay');
    const text = q('#loadingText');
    if (!overlay || !text) return;

    text.textContent = message;
    overlay.classList.remove('hidden');
  },

  hide() {
    const overlay = q('#loadingOverlay');
    if (overlay) overlay.classList.add('hidden');
  }
};

/* ========= New Notifications Module ========= */
const Notifications = {
  list: [],

  init() {
    this.list = State.db.notifications || [];
    this.updateBadge();
    this.renderList();
  },

  add(title, message, type = 'info', priority = 'normal') {
    const notification = {
      id: uid(),
      title,
      message,
      type,
      priority,
      date: new Date().toISOString(),
      read: false
    };

    this.list.unshift(notification);
    State.db.notifications = this.list;
    DB.save();

    this.updateBadge();
    this.showNotification(notification);
    this.renderList();
  },

  showNotification(notification) {
    const container = q('#notificationContainer');
    const notificationEl = document.createElement('div');
    notificationEl.className = `notification ${notification.type}`;
    notificationEl.innerHTML = `
      <div class="notification-content">
        <div style="font-weight: bold;">${notification.title}</div>
        <div>${notification.message}</div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 5px;">
          ${new Date(notification.date).toLocaleTimeString('ar-SA')}
        </div>
      </div>
      <button class="notification-close" onclick="Notifications.closeNotification('${notification.id}')">×</button>
    `;

    container.appendChild(notificationEl);

    // Auto remove after 5 seconds
    setTimeout(() => {
      if (notificationEl.parentNode) {
        notificationEl.style.opacity = '0';
        setTimeout(() => {
          if (notificationEl.parentNode) {
            container.removeChild(notificationEl);
          }
        }, 300);
      }
    }, 5000);
  },

  closeNotification(id) {
    const notificationEl = q(`[data-notification-id="${id}"]`);
    if (notificationEl) {
      notificationEl.style.opacity = '0';
      setTimeout(() => {
        if (notificationEl.parentNode) {
          notificationEl.parentNode.removeChild(notificationEl);
        }
      }, 300);
    }

    this.markAsRead(id);
  },

  markAsRead(id) {
    const notification = this.list.find(n => n.id === id);
    if (notification) {
      notification.read = true;
      State.db.notifications = this.list;
      DB.save();
      this.updateBadge();
      this.renderList();
    }
  },

  markAllAsRead() {
    this.list.forEach(notification => {
      notification.read = true;
    });
    State.db.notifications = this.list;
    DB.save();
    this.updateBadge();
    this.renderList();
  },

  updateBadge() {
    const unreadCount = this.list.filter(n => !n.read).length;
    const badge = q('#notificationCount');

    if (unreadCount > 0) {
      badge.textContent = unreadCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  },

  renderList() {
    const container = q('#notificationsContainer');
    if (!container) return;

    const unreadNotifications = this.list.filter(n => !n.read);
    const readNotifications = this.list.filter(n => n.read);

    let html = '';

    if (unreadNotifications.length === 0 && readNotifications.length === 0) {
      html = '<div class="muted" style="text-align: center; padding: 20px;">لا توجد إشعارات</div>';
    } else {
      if (unreadNotifications.length > 0) {
        html += '<div style="font-weight: bold; margin-bottom: 10px;">غير مقروء</div>';
        unreadNotifications.slice(0, 5).forEach(notification => {
          html += this.renderNotificationItem(notification);
        });
      }

      if (readNotifications.length > 0) {
        html += '<div style="font-weight: bold; margin: 15px 0 10px 0;">مقروء</div>';
        readNotifications.slice(0, 5).forEach(notification => {
          html += this.renderNotificationItem(notification);
        });
      }

      if (this.list.length > 5) {
        html += `<div style="text-align: center; margin-top: 10px;">
          <button class="btn ghost" onclick="Notifications.showAll()">عرض الكل</button>
        </div>`;
      }
    }

    container.innerHTML = html;
  },

  renderNotificationItem(notification) {
    return `
      <div class="notification-item" style="padding: 10px; border-bottom: 1px solid var(--line);">
        <div style="font-weight: ${notification.read ? 'normal' : 'bold'};">${notification.title}</div>
        <div style="font-size: 13px; color: var(--muted);">${notification.message}</div>
        <div style="font-size: 11px; color: var(--muted); margin-top: 5px;">
          ${new Date(notification.date).toLocaleString('ar-SA')}
        </div>
      </div>
    `;
  },

  toggleList() {
    const list = q('#notificationsList');
    list.classList.toggle('hidden');
  },

  showAll() {
    // Implement view all notifications page
    alert('عرض جميع الإشعارات - هذه الميزة قيد التطوير');
  },

  // نظام إشعارات بريد إلكتروني محاكى
  sendEmail(to, subject, body, type = 'info') {
    // في التطبيق الحقيقي، هنا سيتم إرسال البريد الإلكتروني
    // الآن سنحاكي الإرسال وسجل في السجلات

    const emailRecord = {
      id: uid(),
      to,
      subject,
      body,
      type,
      status: 'sent', // في الواقع سيكون 'pending' ثم 'sent' أو 'failed'
      timestamp: new Date().toISOString(),
      userId: State.user ? State.user.id : 'system'
    };

    if (!State.db.emailLogs) State.db.emailLogs = [];
    State.db.emailLogs.push(emailRecord);

    // الاحتفاظ بآخر 200 بريد إلكتروني
    if (State.db.emailLogs.length > 200) {
      State.db.emailLogs = State.db.emailLogs.slice(-200);
    }

    DB.save();

    Security.log('info', `Email sent to ${to}: ${subject}`, { emailId: emailRecord.id });

    // إضافة إشعار محلي
    this.add('إشعار بريد إلكتروني', `تم إرسال بريد إلكتروني إلى ${to}`, 'info');

    return emailRecord;
  },

  // إرسال إشعار عند إضافة مستخدم جديد
  notifyNewUser(userName, userRole) {
    const adminUsers = State.db.users.filter(u => u.role === 'admin');
    adminUsers.forEach(admin => {
      this.sendEmail(
        admin.name + '@company.com', // في الواقع سيتم استخدام البريد الحقيقي
        'مستخدم جديد في النظام',
        `تم إضافة مستخدم جديد: ${userName} بدور ${userRole}`,
        'info'
      );
    });
  },

  // إرسال إشعار عند تغيير كبير في البيانات
  notifyDataChange(changeType, details) {
    const adminUsers = State.db.users.filter(u => u.role === 'admin');
    adminUsers.forEach(admin => {
      this.sendEmail(
        admin.name + '@company.com',
        `تغيير في البيانات: ${changeType}`,
        `تم ${changeType}: ${details}`,
        'warning'
      );
    });
  },

  // عرض سجل البريد الإلكتروني
  getEmailLogs() {
    return State.db.emailLogs || [];
  }
};

/* ========= New Backup Module ========= */
const Backup = {
  createBackup() {
    try {
      const backupData = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        data: State.db
      };

      const backupStr = JSON.stringify(backupData);
      const blob = new Blob([backupStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `aljaberni_backup_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Add to backup history
      State.db.backupHistory = State.db.backupHistory || [];
      State.db.backupHistory.unshift({
        date: new Date().toISOString(),
        type: 'manual',
        size: backupStr.length
      });

      // Keep only last 10 backups in history
      if (State.db.backupHistory.length > 10) {
        State.db.backupHistory.pop();
      }

      DB.save();

      Notifications.add('نسخ احتياطي', 'تم إنشاء نسخة احتياطية بنجاح', 'success');
      this.updateStatus('تم إنشاء النسخة الاحتياطية بنجاح', 'backup-success');
    } catch (error) {
      console.error('Backup error:', error);
      Notifications.add('خطأ في النسخ الاحتياطي', 'فشل في إنشاء النسخة الاحتياطية', 'error');
      this.updateStatus('فشل في إنشاء النسخة الاحتياطية', 'backup-error');
    }
  },

  restoreBackup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const backupData = JSON.parse(event.target.result);

          if (confirm('هل أنت متأكد من استعادة النسخة الاحتياطية؟ سيتم استبدال جميع البيانات الحالية.')) {
            // Validate backup data structure
            if (backupData.data && backupData.data.company && backupData.data.users) {
              State.db = backupData.data;
              DB.save();

              // Reload the application
              location.reload();
            } else {
              throw new Error('ملف النسخة الاحتياطية غير صالح');
            }
          }
        } catch (error) {
          console.error('Restore error:', error);
          Notifications.add('خطأ في الاستعادة', 'فشل في استعادة النسخة الاحتياطية', 'error');
          this.updateStatus('فشل في استعادة النسخة الاحتياطية', 'backup-error');
        }
      };

      reader.readAsText(file);
    };

    input.click();
  },

  downloadTemplate() {
    const template = {
      company: {name: "", phone: "", cr: "", addr: ""},
      branches: [{name: "فرع تجريبي", manager: "مدير", loc: "المدينة"}],
      employees: {},
      records: {},
      expenses: {}
    };

    const templateStr = JSON.stringify(template, null, 2);
    const blob = new Blob([templateStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'aljaberni_template.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    Notifications.add('قالب البيانات', 'تم تحميل قالب البيانات بنجاح', 'info');
  },

  updateStatus(message, className) {
    const statusEl = q('#backupStatus');
    if (!statusEl) return;
    statusEl.textContent = message;
    statusEl.className = `backup-status ${className}`;

    setTimeout(() => {
      statusEl.textContent = '';
      statusEl.className = 'backup-status';
    }, 5000);
  },

  // نظام النسخ الاحتياطي التلقائي
  initAutoBackup() {
    // النسخ الاحتياطي التلقائي كل 24 ساعة
    setInterval(() => {
      this.performAutoBackup();
    }, 24 * 60 * 60 * 1000); // 24 ساعة

    // النسخ الاحتياطي عند إغلاق الصفحة
    window.addEventListener('beforeunload', () => {
      this.performAutoBackup();
    });
  },

  performAutoBackup() {
    try {
      const lastBackup = localStorage.getItem('lastAutoBackup');
      const now = new Date().getTime();

      // لا نفعل نسخ احتياطي إذا كان آخر واحد منذ أقل من 6 ساعات
      if (lastBackup && (now - parseInt(lastBackup)) < 6 * 60 * 60 * 1000) {
        return;
      }

      const backupData = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        data: State.db,
        type: 'auto'
      };

      const backupStr = JSON.stringify(backupData);
      const blob = new Blob([backupStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      // حفظ في localStorage كبديل
      localStorage.setItem('autoBackup_' + new Date().toISOString().slice(0, 10), backupStr);
      localStorage.setItem('lastAutoBackup', now.toString());

      // إضافة إلى تاريخ النسخ الاحتياطي
      State.db.backupHistory = State.db.backupHistory || [];
      State.db.backupHistory.unshift({
        date: new Date().toISOString(),
        type: 'auto',
        size: backupStr.length
      });

      // الاحتفاظ بآخر 30 نسخة احتياطية تلقائية
      if (State.db.backupHistory.length > 30) {
        State.db.backupHistory = State.db.backupHistory.slice(0, 30);
      }

      DB.save();

      Security.log('info', 'Auto backup performed successfully', { size: backupStr.length });

      URL.revokeObjectURL(url);

    } catch (error) {
      Security.log('error', 'Auto backup failed', { error: error.message });
    }
  },

  // استعادة من النسخة الاحتياطية التلقائية
  restoreAutoBackup(date) {
    try {
      const backupStr = localStorage.getItem('autoBackup_' + date);
      if (!backupStr) {
        Notifications.add('خطأ', 'النسخة الاحتياطية غير موجودة', 'error');
        return;
      }

      const backupData = JSON.parse(backupStr);

      if (confirm('هل أنت متأكد من استعادة النسخة الاحتياطية التلقائية؟ سيتم استبدال جميع البيانات الحالية.')) {
        State.db = backupData.data;
        DB.save();

        // إعادة تحميل الصفحة
        location.reload();
      }
    } catch (error) {
      Security.log('error', 'Auto backup restore failed', { error: error.message });
      Notifications.add('خطأ', 'فشل في استعادة النسخة الاحتياطية', 'error');
    }
  },

  // عرض النسخ الاحتياطية التلقائية المتاحة
  getAvailableAutoBackups() {
    const backups = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('autoBackup_')) {
        const date = key.replace('autoBackup_', '');
        backups.push({
          date,
          key,
          size: localStorage.getItem(key).length
        });
      }
    }
    return backups.sort((a, b) => b.date.localeCompare(a.date));
  }
};

/* ========= New Tasks Module ========= */
const Tasks = {
  init() {
    this.renderTasks();
  },

  addTask() {
    const taskInput = q('#newTask');
    const taskText = taskInput.value.trim();

    if (!taskText) return;

    State.db.tasks = State.db.tasks || [];
    State.db.tasks.push({
      id: uid(),
      text: taskText,
      completed: false,
      createdAt: new Date().toISOString(),
      createdBy: State.user ? State.user.name : 'System'
    });

    DB.save();
    taskInput.value = '';
    this.renderTasks();

    Notifications.add('مهمة جديدة', `تم إضافة مهمة: ${taskText}`, 'info');
  },

  toggleTask(id) {
    const task = State.db.tasks.find(t => t.id === id);
    if (task) {
      task.completed = !task.completed;
      DB.save();
      this.renderTasks();
    }
  },

  deleteTask(id) {
    State.db.tasks = State.db.tasks.filter(t => t.id !== id);
    DB.save();
    this.renderTasks();
  },

  renderTasks() {
    const container = q('#tasksList');
    if (!container) return;

    const tasks = State.db.tasks || [];

    if (tasks.length === 0) {
      container.innerHTML = '<div class="muted">لا توجد مهام حالية</div>';
      return;
    }

    let html = '';
    tasks.slice(0, 5).forEach(task => {
      html += `
        <div class="task-item ${task.completed ? 'task-completed' : ''}">
          <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}
                 onchange="Tasks.toggleTask('${task.id}')">
          <div style="flex: 1;">${task.text}</div>
          <button class="btn danger" style="padding: 4px 8px; font-size: 12px;"
                  onclick="Tasks.deleteTask('${task.id}')">حذف</button>
        </div>
      `;
    });

    if (tasks.length > 5) {
      html += `<div style="text-align: center; margin-top: 10px;">
        <button class="btn ghost">عرض المزيد</button>
      </div>`;
    }

    container.innerHTML = html;
  }
};

/* ========= Auth ========= */
const Auth = {
  populateUsers(){
    const sel = q("#loginUser");
    if (!sel) return;
    sel.innerHTML = State.db.users.map(u=>`<option value="${u.id}">${u.name} (${u.role})</option>`).join("");
  },

  handleLoginEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'loginBtn') {
        this.login();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },
  login(){
    const id = q("#loginUser")?.value;
    const pass = q("#loginPass")?.value.trim();
    if (!id || !pass) {
      Notification.show("يرجى إدخال اسم المستخدم وكلمة المرور", "error");
      Security.logActivity('login_failed', { reason: 'missing_credentials' });
      return;
    }

    const user = State.db.users.find(u=>u.id===id);
    if(!user || !Security.verifyPassword(pass, user.pass)){
      Notification.show("بيانات الدخول غير صحيحة", "error");
      Security.logActivity('login_failed', { userId: id, reason: 'invalid_credentials' });
      return;
    }

    // إذا كان مدير النظام، امنحه جميع الصلاحيات
    let userPerms = user.perms || {};
    if (user.role === 'admin') {
      userPerms = {};
      PERMISSIONS.forEach(perm => {
        userPerms[perm.k] = true;
      });
    }

    State.user = {
      id: user.id,
      name: user.name,
      role: user.role,
      perms: userPerms,
      branchId: user.branchId || null
    };

    Security.logActivity('login_success', { userId: user.id, userName: user.name, role: user.role });

    // تطبيق ثيم المستخدم
    Settings.applyUserTheme(user.role === 'branch-manager' ? 'manager' : user.role);

    // تحديث واجهة المستخدم حسب الصلاحيات
    setTimeout(() => {
      Settings.updateUIBasedOnPermissions();
    }, 100);

    // Initialize notifications and tasks
    Notifications.init();
    Tasks.init();

    // Initialize auto backup
    Backup.initAutoBackup();

    // Convert encrypted passwords to plain text if needed
    const downgraded = Security.downgradePasswords();

    // Check password status for debugging (only in development)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      Security.checkPasswordStatus();
    }

    // Show downgrade notification if passwords were converted
    if (downgraded) {
      setTimeout(() => {
        Notifications.add('🔓 إزالة التشفير', 'تم إزالة تشفير كلمات المرور - استخدم admin123 للدخول', 'warning');
      }, 2000);
    }

    // Send welcome notification
    const roleLabel = Settings.getRoleLabel(user.role);
    Notifications.add('مرحباً بعودتك', `أهلاً ${user.name} (${roleLabel})، تم تسجيل الدخول بنجاح`, 'success');

    // إذا كان مدير فرع، اذهب مباشرة لفرعه
    if (user.role === 'branch-manager' && user.branchId) {
      Router.go('branch', {branchId: user.branchId});
    } else {
      Router.go('home');
    }
  },
  logout(){
    Notifications.add('تسجيل الخروج', `تم تسجيل الخروج بنجاح، إلى اللقاء ${State.user.name}`, 'info');

    // إزالة الثيم
    Settings.applyUserTheme(null);

    State.user = null;
    Router.go('login');
  },
  hasPermission(permission) {
    if (!State.user) return false;
    if (State.user.role === 'admin') return true;
    return State.user.perms && State.user.perms[permission] === true;
  }
};




/* ========= Branch Management ========= */
const BranchManagement = {
  toggle() {
    const panel = q('#branchManagement');
    if (!panel) return;
    
    panel.classList.toggle('show');
    this.renderBranchesList();
  },
  
  renderBranchesList() {
    const list = q('#branchesList');
    if (!list) return;
    
    list.innerHTML = State.db.branches.map(b => `
      <div class="card" style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${b.name}</strong>
            <div class="muted">${b.manager || 'لا يوجد مدير'} - ${b.loc || 'لا يوجد موقع'}</div>
          </div>
          <button class="btn danger" onclick="BranchManagement.deleteBranch('${b.id}')">حذف</button>
        </div>
      </div>
    `).join('');
  },
  
  addBranch() {
    const nameInput = q('#branchName');
    const managerInput = q('#branchManager');
    const locationInput = q('#branchLocation');

    if (!nameInput || !managerInput || !locationInput) {
      Notifications.add("خطأ", "لم يتم العثور على حقول الإدخال", "error");
      return;
    }

    const name = nameInput.value.trim();
    const manager = managerInput.value.trim();
    const location = locationInput.value.trim();

    if (!name) {
      Notifications.add("خطأ", "يرجى إدخال اسم الفرع", "error");
      return;
    }

    try {
      const id = uid();
      const newBranch = {id, name, manager: manager || 'غير محدد', loc: location || 'غير محدد'};

      State.db.branches.push(newBranch);
      ensureBranchContainers(id);
      DB.save();

      // Clear inputs
      nameInput.value = '';
      managerInput.value = '';
      locationInput.value = '';

      this.renderBranchesList();
      this.renderBranchManagementList();
      UI.renderBranches();
      Dashboard.populateBranchSelector();

      Notifications.add("فرع جديد", `تم إضافة الفرع "${name}" بنجاح`, "success");

    } catch (error) {
      console.error('Error adding branch:', error);
      Notifications.add("خطأ", "حدث خطأ أثناء إضافة الفرع: " + error.message, "error");
    }
  },
  
  deleteBranch(id) {
    if (!confirm("هل أنت متأكد من حذف هذا الفرع؟ سيتم حذف جميع بياناته أيضاً.")) return;

    State.db.branches = State.db.branches.filter(b => b.id !== id);
    delete State.db.records[id];
    delete State.db.employees[id];
    delete State.db.expenses[id];

    DB.save();
    this.renderBranchesList();
    UI.renderBranches();
    Notification.show("تم حذف الفرع بنجاح", "success");
  },

  // New methods for the branch management page
  render() {
    this.renderBranchManagementList();
    this.populateExpenseBranchSelector();
  },

  renderBranchManagementList() {
    const container = q('#branchManagementList');
    if (!container) return;

    let html = '';

    if (State.db.branches.length === 0) {
      html = '<div class="muted">لا توجد فروع مضافة</div>';
    } else {
      html = '<table><thead><tr><th>اسم الفرع</th><th>المدير</th><th>الموقع</th><th>الإجراءات</th></tr></thead><tbody>';

      State.db.branches.forEach(branch => {
        html += `
          <tr>
            <td>${branch.name}</td>
            <td>${branch.manager || 'غير محدد'}</td>
            <td>${branch.loc || 'غير محدد'}</td>
            <td>
              <button class="btn info" onclick="BranchManagement.editBranch('${branch.id}')">تعديل</button>
              <button class="btn danger" onclick="BranchManagement.deleteBranch('${branch.id}')">حذف</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
    }

    container.innerHTML = html;
  },

  editBranch(branchId) {
    const branch = State.db.branches.find(b => b.id === branchId);
    if (!branch) return;

    const newName = prompt('اسم الفرع الجديد:', branch.name);
    if (newName === null) return;

    const newManager = prompt('مدير الفرع الجديد:', branch.manager);
    if (newManager === null) return;

    const newLocation = prompt('موقع الفرع الجديد:', branch.loc);
    if (newLocation === null) return;

    branch.name = newName.trim() || branch.name;
    branch.manager = newManager.trim() || branch.manager;
    branch.loc = newLocation.trim() || branch.loc;

    DB.save();

    this.renderBranchManagementList();
    this.renderBranchesList();
    UI.renderBranches();
    Dashboard.populateBranchSelector();

    Notifications.add("تعديل فرع", `تم تعديل بيانات الفرع "${branch.name}" بنجاح`, "success");
  },

  // دوال إدارة مصروفات الفروع
  populateExpenseBranchSelector() {
    const expSel = q("#expBranch");
    if (expSel) {
      let html = '<option value="">اختر الفرع</option>';
      State.db.branches.forEach(branch => {
        html += `<option value="${branch.id}">${branch.name}</option>`;
      });
      expSel.innerHTML = html;
    }
  },

  loadBranchExpenses() {
    const branchId = q("#expBranch").value;
    if (branchId && State.db.expenses[branchId]) {
      const exp = State.db.expenses[branchId];
      q("#expRent").value = exp.rent || "";
      q("#expSalaries").value = exp.salaries || "";
      q("#expAdmin").value = exp.admin || "";
      q("#expBank").value = exp.bank || "";
      q("#expLoss").value = exp.loss || "";
      q("#expOther").value = exp.other || "";
    } else {
      this.clearExpenseForm();
    }
  },

  clearExpenseForm() {
    q("#expRent").value = "";
    q("#expSalaries").value = "";
    q("#expAdmin").value = "";
    q("#expBank").value = "";
    q("#expLoss").value = "";
    q("#expOther").value = "";
  },

  handleExpenseEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'saveExpensesBtn') {
        this.saveExpenses();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },

  saveExpenses() {
    const branchId = q("#expBranch").value;
    if (!branchId) {
      Notification.show("يرجى اختيار فرع", "error");
      return;
    }

    const rent = q("#expRent").value.trim();
    const salaries = q("#expSalaries").value.trim();
    const admin = q("#expAdmin").value.trim();
    const bank = q("#expBank").value.trim();
    const loss = q("#expLoss").value.trim();
    const other = q("#expOther").value.trim();

    // التحقق من إدخال القيم الإجبارية
    if (!rent || !salaries) {
      Notification.show("يرجى إدخال مصروف الإيجار والرواتب (إجباري)", "error");
      return;
    }

    // التأكد من وجود كائن expenses
    if (!State.db.expenses) {
      State.db.expenses = {};
    }

    State.db.expenses[branchId] = {
      rent: parseNum(rent),
      salaries: parseNum(salaries),
      admin: parseNum(admin),
      bank: parseNum(bank),
      loss: parseNum(loss),
      other: parseNum(other)
    };

    DB.save();
    Notification.show("تم حفظ مصروفات الفرع بنجاح", "success");
  },

  handleBranchEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'addBranchBtn') {
        this.addBranch();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  }
};

/* ========= Router / Views ========= */
const Router = {
  go(view, params={}){
    if (!view) return;
    
    const viewElement = q(`#view-${view}`);
    if (!viewElement) {
      console.error(`View ${view} not found`);
      return;
    }
    
    qa("[id^=view-]").forEach(s=>s.classList.add("hidden"));
    
    switch(view) {
      case 'login':
        Auth.populateUsers();
        q("#view-login").classList.remove("hidden");
        q("header.top")?.classList.add("hidden");
        break;
      case 'home':
      case 'dashboard':
      case 'financial-reports':
      case 'branch-management':
      case 'accounts':
      case 'branch':
      case 'form':
      case 'reports':
      case 'daily-reports':
      case 'monthly-reports':
      case 'custom-reports':
      case 'saved-reports':
      case 'profit-loss':
      case 'report-display':
      case 'movement':
      case 'settings':
        viewElement.classList.remove("hidden");
        q("header.top")?.classList.remove("hidden");
        
        // استدعاء الدوال المطلوبة لكل عرض
        if (view === 'home') UI.renderBranches();
        if (view === 'dashboard') Dashboard.load();
        if (view === 'financial-reports') FinancialReports.init();
        if (view === 'branch-management') BranchManagement.render();
        if (view === 'accounts') Accounts.init();
        if (view === 'branch' && params.branchId) UI.openBranch(params.branchId);
        if (view === 'form' && params.formKey && params.branchId) UI.renderFormPage(params.formKey, params.branchId);
        if (view === 'daily-reports') Reports.populateDaily();
        if (view === 'monthly-reports') Reports.populateMonthly();
        if (view === 'custom-reports') Reports.populateCustom();
        if (view === 'saved-reports') Reports.showSavedReports();
        if (view === 'profit-loss') Reports.populateProfitLoss();
        if (view === 'movement') Movement.populate();
        if (view === 'settings') Settings.render();
        break;
      default:
        console.error(`Unknown view: ${view}`);
    }
    
    history.replaceState({view,params},"","#"+view);
  }
};

/* ========= Dashboard ========= */
const Dashboard = {
  load() {
    this.updateStats();
    this.loadTopBranches();
    this.loadRecentTransactions();
    this.loadAlerts();
    this.loadCharts();
  },

  updateStats() {
    const selectedBranch = q("#dashboardBranch").value;

    // حساب الإيرادات الإجمالية (الإيرادات اليومية فقط)
    let totalIncome = 0;
    let totalExpenses = 0;
    let totalCars = 0;

    Object.keys(State.db.records).forEach(branchId => {
      if (selectedBranch !== "all" && branchId !== selectedBranch) return;

      if (State.db.records[branchId].dailyRevenue) {
        State.db.records[branchId].dailyRevenue.forEach(record => {
          totalIncome += parseNum(record.network) + parseNum(record.cash) + parseNum(record.credit);
          totalCars += parseNum(record.cars);
        });
      }

      // حساب المصروفات من جميع الكشوفات
      ['cashPurch', 'creditPurch', 'dailyMeals', 'empAdvance', 'supMaintenance', 'marketPurch', 'mgrMaintenance', 'mgrPurch'].forEach(formKey => {
        if (State.db.records[branchId][formKey]) {
          State.db.records[branchId][formKey].forEach(record => {
            totalExpenses += parseNum(record.price) + parseNum(record.amount) + parseNum(record.take);
          });
        }
      });
    });

    const netProfit = totalIncome - totalExpenses;

    q('#total-income').textContent = fmt(totalIncome) + ' ر.س';
    q('#total-expenses').textContent = fmt(totalExpenses) + ' ر.س';
    q('#net-profit').textContent = fmt(netProfit) + ' ر.س';
    q('#total-cars').textContent = totalCars;

    // تغيير لون صافي الربح حسب القيمة
    const netProfitEl = q('#net-profit');
    if (netProfit > 0) {
      netProfitEl.style.color = 'var(--accent)';
    } else if (netProfit < 0) {
      netProfitEl.style.color = 'var(--danger)';
    } else {
      netProfitEl.style.color = 'var(--muted)';
    }
  },

  loadTopBranches() {
    const branchStats = [];

    State.db.branches.forEach(branch => {
      let branchIncome = 0;
      let branchExpenses = 0;

      if (State.db.records[branch.id] && State.db.records[branch.id].dailyRevenue) {
        State.db.records[branch.id].dailyRevenue.forEach(record => {
          branchIncome += parseNum(record.network) + parseNum(record.cash) + parseNum(record.credit);
        });
      }

      ['cashPurch', 'creditPurch', 'dailyMeals', 'empAdvance', 'supMaintenance', 'marketPurch', 'mgrMaintenance', 'mgrPurch'].forEach(formKey => {
        if (State.db.records[branch.id] && State.db.records[branch.id][formKey]) {
          State.db.records[branch.id][formKey].forEach(record => {
            branchExpenses += parseNum(record.price) + parseNum(record.amount) + parseNum(record.take);
          });
        }
      });

      branchStats.push({
        name: branch.name,
        income: branchIncome,
        expenses: branchExpenses,
        profit: branchIncome - branchExpenses
      });
    });

    branchStats.sort((a, b) => b.profit - a.profit);

    let html = '';
    branchStats.slice(0, 5).forEach((branch, index) => {
      html += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--line);">
          <div>
            <div style="font-weight: bold;">${index + 1}. ${branch.name}</div>
            <div style="font-size: 12px; color: var(--muted);">إيرادات: ${fmt(branch.income)} ر.س</div>
          </div>
          <div style="text-align: left;">
            <div style="font-weight: bold; color: ${branch.profit >= 0 ? 'var(--accent)' : 'var(--danger)'};">
              ${fmt(branch.profit)} ر.س
            </div>
          </div>
        </div>
      `;
    });

    q('#top-branches-list').innerHTML = html || '<div class="muted">لا توجد بيانات</div>';
  },

  loadRecentTransactions() {
    // عرض آخر المعاملات من جميع الكشوفات
    const recentTransactions = [];

    Object.keys(State.db.records).forEach(branchId => {
      const branchName = State.db.branches.find(b => b.id === branchId)?.name || 'فرع غير معروف';

      Object.keys(State.db.records[branchId]).forEach(formKey => {
        const formLabel = MODELS.forms[formKey]?.label || formKey;
        State.db.records[branchId][formKey].forEach(record => {
          if (record.date) {
            recentTransactions.push({
              date: record.date,
              branch: branchName,
              type: formLabel,
              amount: parseNum(record.network) + parseNum(record.cash) + parseNum(record.credit) + parseNum(record.price) + parseNum(record.amount) + parseNum(record.take),
              description: record.note || record.item || record.desc || 'معاملة'
            });
          }
        });
      });
    });

    recentTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = '';
    recentTransactions.slice(0, 5).forEach(transaction => {
      html += `
        <div style="padding: 8px 0; border-bottom: 1px solid var(--line);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: bold;">${transaction.type}</div>
              <div style="font-size: 12px; color: var(--muted);">${transaction.branch} - ${transaction.date}</div>
            </div>
            <div style="font-weight: bold; color: var(--accent);">
              ${fmt(transaction.amount)} ر.س
            </div>
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            ${transaction.description}
          </div>
        </div>
      `;
    });

    q('#recent-transactions').innerHTML = html || '<div class="muted">لا توجد معاملات حديثة</div>';
  },

  loadAlerts() {
    const alerts = [];

    // فحص الفروع التي لديها خسائر
    State.db.branches.forEach(branch => {
      let branchIncome = 0;
      let branchExpenses = 0;

      if (State.db.records[branch.id] && State.db.records[branch.id].dailyRevenue) {
        State.db.records[branch.id].dailyRevenue.forEach(record => {
          branchIncome += parseNum(record.network) + parseNum(record.cash) + parseNum(record.credit);
        });
      }

      ['cashPurch', 'creditPurch', 'dailyMeals', 'empAdvance', 'supMaintenance', 'marketPurch', 'mgrMaintenance', 'mgrPurch'].forEach(formKey => {
        if (State.db.records[branch.id] && State.db.records[branch.id][formKey]) {
          State.db.records[branch.id][formKey].forEach(record => {
            branchExpenses += parseNum(record.price) + parseNum(record.amount) + parseNum(record.take);
          });
        }
      });

      if (branchExpenses > branchIncome) {
        alerts.push({
          type: 'warning',
          message: `فرع ${branch.name} يحقق خسائر بقيمة ${fmt(branchExpenses - branchIncome)} ر.س`
        });
      }
    });

    let html = '';
    if (alerts.length === 0) {
      html = '<div class="muted">لا توجد تنبيهات حالية</div>';
    } else {
      alerts.forEach(alert => {
        html += `
          <div style="padding: 8px 12px; margin: 8px 0; border-left: 4px solid var(--warn); background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
            ⚠️ ${alert.message}
          </div>
        `;
      });
    }

    q('#important-alerts').innerHTML = html;
  },

  loadCharts() {
    // التحقق من وجود Chart.js
    if (typeof Chart === 'undefined') {
      console.warn('Chart.js not loaded');
      return;
    }

    // Income vs Expense Chart
    const incomeExpenseCtx = q('#incomeExpenseChartCanvas');
    const expensesCtx = q('#expensesChartCanvas');

    if (!incomeExpenseCtx || !expensesCtx) return;

    // Sample data for charts - يمكن تحسينها لاحقاً بالبيانات الحقيقية
    const chartData = {
      income: [12000, 15000, 18000, 14000, 16000, 19000],
      expenses: [8000, 9000, 11000, 9500, 10000, 10500],
      expenseCategories: ['رواتب', 'إيجار', 'مواد', 'صيانة', 'أخرى'],
      expenseValues: [5000, 3000, 2000, 1500, 1000]
    };

    // Income vs Expense Chart
    new Chart(incomeExpenseCtx, {
      type: 'line',
      data: {
        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
        datasets: [
          {
            label: 'الإيرادات',
            data: chartData.income,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true
          },
          {
            label: 'المصروفات',
            data: chartData.expenses,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb'
            }
          }
        },
        scales: {
          y: {
            ticks: {
              color: '#e5e7eb'
            },
            grid: {
              color: '#374151'
            }
          },
          x: {
            ticks: {
              color: '#e5e7eb'
            },
            grid: {
              color: '#374151'
            }
          }
        }
      }
    });

    // Expenses Distribution Chart
    new Chart(expensesCtx, {
      type: 'doughnut',
      data: {
        labels: chartData.expenseCategories,
        datasets: [{
          data: chartData.expenseValues,
          backgroundColor: [
            '#3b82f6',
            '#10b981',
            '#f59e0b',
            '#ef4444',
            '#8b5cf6'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb'
            }
          }
        }
      }
    });
  },

  populateBranchSelector() {
    const selector = q("#dashboardBranch");
    if (!selector) return;

    selector.innerHTML = '<option value="all">جميع الفروع</option>';

    State.db.branches.forEach(branch => {
      const option = document.createElement("option");
      option.value = branch.id;
      option.textContent = branch.name;
      selector.appendChild(option);
    });
  },

  handleDashboardEnterKey(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      this.load(); // إعادة تحميل البيانات
    }
  }
};

/* ========= Financial Reports ========= */
const FinancialReports = {
  currentTab: 'trial-balance',

  init() {
    this.setDefaultDates();
  },

  setDefaultDates() {
    q('#report-from').value = firstOfMonthStr();
    q('#report-to').value = todayStr();
  },

  handleReportEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'generateReportBtn') {
        this.generate();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },

  switchTab(tab) {
    this.currentTab = tab;
    qa('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
  },

  generate() {
    const fromDate = q('#report-from').value;
    const toDate = q('#report-to').value;

    if (!fromDate || !toDate) {
      Notifications.add('خطأ', 'يرجى تحديد تاريخ البداية والنهاية', 'error');
      return;
    }

    let reportHTML = '';

    switch (this.currentTab) {
      case 'trial-balance':
        reportHTML = this.generateTrialBalance(fromDate, toDate);
        break;
      case 'income-statement':
        reportHTML = this.generateIncomeStatement(fromDate, toDate);
        break;
      case 'balance-sheet':
        reportHTML = this.generateBalanceSheet(fromDate, toDate);
        break;
    }

    q('#financial-report-result').innerHTML = reportHTML;
  },

  generateTrialBalance(fromDate, toDate) {
    const accounts = State.db.financialData.accounts;
    let totalDebit = 0;
    let totalCredit = 0;

    let tableHTML = `
      <div class="report-header">
        <h2>ميزان المراجعة</h2>
        <div>للفترة من ${fromDate} إلى ${toDate}</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>اسم الحساب</th>
            <th>مدين</th>
            <th>دائن</th>
          </tr>
        </thead>
        <tbody>
    `;

    // الأصول
    accounts.assets.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>${fmt(account.balance)}</td>
          <td>-</td>
        </tr>
      `;
      totalDebit += account.balance;
    });

    // المصروفات
    accounts.expenses.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>${fmt(account.balance)}</td>
          <td>-</td>
        </tr>
      `;
      totalDebit += account.balance;
    });

    // الخصوم
    accounts.liabilities.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>-</td>
          <td>${fmt(account.balance)}</td>
        </tr>
      `;
      totalCredit += account.balance;
    });

    // حقوق الملكية
    accounts.equity.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>-</td>
          <td>${fmt(account.balance)}</td>
        </tr>
      `;
      totalCredit += account.balance;
    });

    // الإيرادات
    accounts.revenue.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>-</td>
          <td>${fmt(account.balance)}</td>
        </tr>
      `;
      totalCredit += account.balance;
    });

    tableHTML += `
        <tr style="font-weight: bold; background: rgba(16, 185, 129, 0.1);">
          <td>الإجمالي</td>
          <td>${fmt(totalDebit)}</td>
          <td>${fmt(totalCredit)}</td>
        </tr>
      </tbody>
    </table>
    `;

    return tableHTML;
  },

  generateIncomeStatement(fromDate, toDate) {
    const accounts = State.db.financialData.accounts;
    let totalRevenue = 0;
    let totalExpenses = 0;

    accounts.revenue.forEach(account => {
      totalRevenue += account.balance;
    });

    accounts.expenses.forEach(account => {
      totalExpenses += account.balance;
    });

    const netIncome = totalRevenue - totalExpenses;

    const header = `
      <div class="report-header">
        <h2>قائمة الدخل</h2>
        <div>للفترة من ${fromDate} إلى ${toDate}</div>
      </div>
    `;

    const content = `
      <div class="financial-summary">
        <div class="card">
          <h4>الإيرادات</h4>
          <div class="stat-value">${fmt(totalRevenue)} ر.س</div>
        </div>
        <div class="card">
          <h4>المصروفات</h4>
          <div class="stat-value">${fmt(totalExpenses)} ر.س</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th colspan="2">الإيرادات</th>
          </tr>
        </thead>
        <tbody>
          ${accounts.revenue.map(account => `
            <tr>
              <td>${account.name}</td>
              <td>${fmt(account.balance)} ر.س</td>
            </tr>
          `).join('')}
          <tr style="font-weight: bold;">
            <td>إجمالي الإيرادات</td>
            <td>${fmt(totalRevenue)} ر.س</td>
          </tr>
        </tbody>
      </table>

      <table style="margin-top: 20px;">
        <thead>
          <tr>
            <th colspan="2">المصروفات</th>
          </tr>
        </thead>
        <tbody>
          ${accounts.expenses.map(account => `
            <tr>
              <td>${account.name}</td>
              <td>${fmt(account.balance)} ر.س</td>
            </tr>
          `).join('')}
          <tr style="font-weight: bold;">
            <td>إجمالي المصروفات</td>
            <td>${fmt(totalExpenses)} ر.س</td>
          </tr>
          <tr style="font-weight: bold; background: ${netIncome >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};">
            <td>صافي ${netIncome >= 0 ? 'الربح' : 'الخسارة'}</td>
            <td>${fmt(Math.abs(netIncome))} ر.س</td>
          </tr>
        </tbody>
      </table>
    `;

    return header + content;
  },

  generateBalanceSheet(fromDate, toDate) {
    const accounts = State.db.financialData.accounts;

    let totalAssets = 0;
    let totalLiabilities = 0;
    let totalEquity = 0;

    accounts.assets.forEach(account => {
      totalAssets += account.balance;
    });

    accounts.liabilities.forEach(account => {
      totalLiabilities += account.balance;
    });

    accounts.equity.forEach(account => {
      totalEquity += account.balance;
    });

    const header = `
      <div class="report-header">
        <h2>الميزانية العمومية</h2>
        <div>كما في ${toDate}</div>
      </div>
    `;

    const content = `
      <div class="financial-summary">
        <div class="card">
          <h4>الأصول</h4>
          <div class="stat-value">${fmt(totalAssets)} ر.س</div>
        </div>
        <div class="card">
          <h4>الخصوم</h4>
          <div class="stat-value">${fmt(totalLiabilities)} ر.س</div>
        </div>
        <div class="card">
          <h4>حقوق الملكية</h4>
          <div class="stat-value">${fmt(totalEquity)} ر.س</div>
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <table>
            <thead>
              <tr>
                <th colspan="2">الأصول</th>
              </tr>
            </thead>
            <tbody>
              ${accounts.assets.map(account => `
                <tr>
                  <td>${account.name}</td>
                  <td>${fmt(account.balance)} ر.س</td>
                </tr>
              `).join('')}
              <tr style="font-weight: bold;">
                <td>إجمالي الأصول</td>
                <td>${fmt(totalAssets)} ر.س</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="col-6">
          <table>
            <thead>
              <tr>
                <th colspan="2">الخصوم وحقوق الملكية</th>
              </tr>
            </thead>
            <tbody>
              ${accounts.liabilities.map(account => `
                <tr>
                  <td>${account.name}</td>
                  <td>${fmt(account.balance)} ر.س</td>
                </tr>
              `).join('')}
              <tr style="font-weight: bold;">
                <td>إجمالي الخصوم</td>
                <td>${fmt(totalLiabilities)} ر.س</td>
              </tr>
              ${accounts.equity.map(account => `
                <tr>
                  <td>${account.name}</td>
                  <td>${fmt(account.balance)} ر.س</td>
                </tr>
              `).join('')}
              <tr style="font-weight: bold;">
                <td>إجمالي حقوق الملكية</td>
                <td>${fmt(totalEquity)} ر.س</td>
              </tr>
              <tr style="font-weight: bold; background: rgba(16, 185, 129, 0.1);">
                <td>إجمالي الخصوم وحقوق الملكية</td>
                <td>${fmt(totalLiabilities + totalEquity)} ر.س</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    `;

    return header + content;
  },

  exportPDF() {
    const reportContent = q('#financial-report-result').innerHTML;
    const printWindow = window.open('', '_blank');

    // استخراج الألوان والتنسيقات من التصميم الأصلي
    const originalStyles = `
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        * {
          box-sizing: border-box;
          font-family: 'Tajawal', system-ui, Segoe UI, Arial, sans-serif;
          margin: 0;
          padding: 0;
        }

        body {
          background: white !important;
          color: black !important;
          padding: 20px;
          direction: rtl;
          font-size: 14px;
          line-height: 1.6;
        }

        /* تنسيقات التقارير */
        .card {
          background: white !important;
          border: 2px solid #1f2937 !important;
          border-radius: 12px !important;
          padding: 20px !important;
          margin: 20px 0 !important;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
        }

        .title {
          font-size: 24px !important;
          font-weight: bold !important;
          color: #1f2937 !important;
          margin-bottom: 10px !important;
          text-align: center !important;
        }

        .subtitle {
          font-size: 16px !important;
          color: #6b7280 !important;
          margin-bottom: 20px !important;
          text-align: center !important;
        }

        /* تنسيقات الجداول */
        table {
          width: 100% !important;
          border-collapse: collapse !important;
          margin: 20px 0 !important;
          background: white !important;
          border: 2px solid #1f2937 !important;
          border-radius: 8px !important;
          overflow: hidden !important;
        }

        th, td {
          border: 1px solid #d1d5db !important;
          padding: 12px 8px !important;
          text-align: right !important;
          background: white !important;
          color: black !important;
        }

        th {
          background: #f3f4f6 !important;
          color: #1f2937 !important;
          font-weight: bold !important;
          font-size: 14px !important;
        }

        tr:nth-child(even) {
          background: #f9fafb !important;
        }

        tr:nth-child(odd) {
          background: white !important;
        }

        /* تنسيقات التلخيص المالي */
        .financial-summary {
          display: grid !important;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
          gap: 16px !important;
          margin: 20px 0 !important;
        }

        .financial-summary .card {
          background: white !important;
          border: 2px solid #22c55e !important;
          padding: 20px !important;
          text-align: center !important;
          border-radius: 12px !important;
        }

        .financial-summary .card h4 {
          color: #22c55e !important;
          font-size: 16px !important;
          margin-bottom: 8px !important;
        }

        .stat-value {
          font-size: 20px !important;
          font-weight: bold !important;
          color: #22c55e !important;
        }

        /* تنسيقات التقرير الرئيسي */
        .report-header {
          text-align: center !important;
          margin-bottom: 30px !important;
          padding: 20px !important;
          border-bottom: 2px solid #22c55e !important;
        }

        .report-header h2 {
          color: #22c55e !important;
          font-size: 28px !important;
          margin-bottom: 10px !important;
        }

        /* تنسيقات جدول الأرباح والخسائر */
        .profit-loss-table {
          width: 100% !important;
          border-collapse: collapse !important;
          margin: 20px 0 !important;
        }

        .profit-loss-table th {
          background: #f3f4f6 !important;
          padding: 12px !important;
          text-align: center !important;
          border: 1px solid #d1d5db !important;
          color: #1f2937 !important;
          font-weight: bold !important;
        }

        .profit-loss-table td {
          padding: 10px !important;
          border: 1px solid #d1d5db !important;
          text-align: center !important;
          background: white !important;
          color: black !important;
        }

        .profit-loss-total {
          font-weight: bold !important;
          background: rgba(16, 185, 129, 0.1) !important;
          color: #059669 !important;
        }

        /* إخفاء العناصر غير المرغوبة في الطباعة */
        .no-print {
          display: none !important;
        }

        /* إخفاء أزرار الطباعة والحفظ في ملفات PDF */
        .report-actions,
        .report-footer {
          display: none !important;
        }

        /* تنسيقات إضافية للطباعة */
        @media print {
          body {
            background: white !important;
            color: black !important;
            font-size: 12px !important;
          }

          .card {
            break-inside: avoid !important;
            page-break-inside: avoid !important;
          }

          table {
            page-break-inside: avoid !important;
          }

          /* إخفاء أزرار الطباعة والحفظ في الطباعة */
          .report-actions,
          .report-footer,
          button {
            display: none !important;
          }
        }

        /* تنسيقات النصوص */
        .muted {
          color: #6b7280 !important;
        }

        /* تنسيقات التذييل */
        .report-footer {
          margin-top: 40px !important;
          text-align: center !important;
          color: #6b7280 !important;
          font-size: 12px !important;
          border-top: 1px solid #d1d5db !important;
          padding-top: 20px !important;
        }
      </style>
    `;

    printWindow.document.write(`
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="utf-8">
        <title>تقرير مالي</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        ${originalStyles}
      </head>
      <body>
        ${reportContent}
      </body>
      </html>
    `);

    printWindow.document.close();

    // انتظار تحميل المحتوى قبل الطباعة
    printWindow.onload = function() {
      setTimeout(() => {
        printWindow.print();
      }, 500);
    };
  }
};

/* ========= Accounts Management ========= */
const Accounts = {
  currentTab: 'accounts',

  init() {
    this.populateBranchSelector();
    this.populateAccountSelector();
    this.renderAccounts();
  },

  switchTab(tab) {
    this.currentTab = tab;
    qa('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    if (tab === 'accounts') {
      q('#accounts-content').classList.remove('hidden');
      q('#transactions-content').classList.add('hidden');
      this.renderAccounts();
    } else {
      q('#accounts-content').classList.add('hidden');
      q('#transactions-content').classList.remove('hidden');
      this.loadTransactions();
    }
  },

  populateBranchSelector() {
    const selector = q('#transactionBranch');
    if (!selector) return;

    selector.innerHTML = State.db.branches.map(b =>
      `<option value="${b.id}">${b.name}</option>`
    ).join('');
  },

  populateAccountSelector() {
    const selector = q('#transactionAccount');
    if (!selector) return;

    let options = '';
    Object.keys(State.db.financialData.accounts).forEach(type => {
      State.db.financialData.accounts[type].forEach(account => {
        options += `<option value="${account.id}">${account.name}</option>`;
      });
    });

    selector.innerHTML = options;
  },

  addAccount() {
    const type = q('#accountType').value;
    const name = q('#accountName').value.trim();
    const balance = parseNum(q('#accountBalance').value);

    if (!name) {
      Notifications.add('خطأ', 'يرجى إدخال اسم الحساب', 'error');
      return;
    }

    const newAccount = {
      id: uid(),
      name,
      balance
    };

    State.db.financialData.accounts[type].push(newAccount);
    DB.save();

    // مسح الحقول
    q('#accountName').value = '';
    q('#accountBalance').value = '';

    this.renderAccounts();
    this.populateAccountSelector();

    Notifications.add('حساب جديد', `تم إضافة حساب ${name} بنجاح`, 'success');
  },

  renderAccounts() {
    const container = q('#accountsList');
    if (!container) return;

    let html = '<h3>الحسابات المالية</h3>';

    Object.keys(State.db.financialData.accounts).forEach(type => {
      const typeLabels = {
        assets: 'الأصول',
        liabilities: 'الخصوم',
        equity: 'حقوق الملكية',
        revenue: 'الإيرادات',
        expenses: 'المصروفات'
      };

      html += `<h4>${typeLabels[type]}</h4>`;
      html += '<table><thead><tr><th>اسم الحساب</th><th>الرصيد</th><th>الإجراءات</th></tr></thead><tbody>';

      State.db.financialData.accounts[type].forEach(account => {
        html += `
          <tr>
            <td>${account.name}</td>
            <td>${fmt(account.balance)} ر.س</td>
            <td>
              <button class="btn danger" onclick="Accounts.deleteAccount('${type}', '${account.id}')">حذف</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
    });

    container.innerHTML = html;
  },

  deleteAccount(type, accountId) {
    if (!confirm('هل أنت متأكد من حذف هذا الحساب؟')) return;

    State.db.financialData.accounts[type] = State.db.financialData.accounts[type].filter(a => a.id !== accountId);
    DB.save();

    this.renderAccounts();
    this.populateAccountSelector();

    Notifications.add('حذف حساب', 'تم حذف الحساب بنجاح', 'success');
  },

  addTransaction() {
    const branchId = q('#transactionBranch').value;
    const type = q('#transactionType').value;
    const accountId = q('#transactionAccount').value;
    const amount = parseNum(q('#transactionAmount').value);
    const description = q('#transactionDescription').value.trim();

    if (!amount || amount <= 0) {
      Notifications.add('خطأ', 'يرجى إدخال مبلغ صحيح', 'error');
      return;
    }

    if (!State.db.transactions[branchId]) {
      State.db.transactions[branchId] = [];
    }

    const transaction = {
      id: uid(),
      date: todayStr(),
      type,
      accountId,
      amount,
      description,
      createdBy: State.user ? State.user.name : 'System'
    };

    State.db.transactions[branchId].push(transaction);
    DB.save();

    // مسح الحقول
    q('#transactionAmount').value = '';
    q('#transactionDescription').value = '';

    Notifications.add('حركة مالية', `تم إضافة حركة مالية بقيمة ${fmt(amount)} ر.س`, 'success');
  },

  loadTransactions(branchId) {
    if (!State.db.transactions[branchId] || State.db.transactions[branchId].length === 0) {
      q('#transactionsList').innerHTML = '<div class="muted">لا توجد حركات مالية</div>';
      return;
    }

    const transactions = State.db.transactions[branchId];
    let html = '<h3>الحركات المالية</h3><table><thead><tr><th>التاريخ</th><th>النوع</th><th>الحساب</th><th>المبلغ</th><th>الوصف</th></tr></thead><tbody>';

    transactions.forEach(transaction => {
      // البحث عن اسم الحساب
      let accountName = 'حساب غير معروف';
      Object.keys(State.db.financialData.accounts).forEach(type => {
        const account = State.db.financialData.accounts[type].find(a => a.id === transaction.accountId);
        if (account) accountName = account.name;
      });

      html += `
        <tr>
          <td>${transaction.date}</td>
          <td>${transaction.type === 'debit' ? 'مدين' : 'دائن'}</td>
          <td>${accountName}</td>
          <td>${fmt(transaction.amount)} ر.س</td>
          <td>${transaction.description}</td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    q('#transactionsList').innerHTML = html;
  },

  handleAccountEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'addAccountBtn') {
        this.addAccount();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  }
};

/* ========= Excel Export Module ========= */
const ExcelExport = {

  createBranchWorkbook(branch) {
    if (typeof XLSX === 'undefined') {
      console.warn('XLSX library not loaded');
      Notifications.add('خطأ', 'مكتبة Excel غير متوفرة', 'error');
      return;
    }

    try {
      // إنشاء workbook جديد
      const wb = XLSX.utils.book_new();

      // إضافة ورقة معلومات الفرع مع تنسيق احترافي
      const branchInfo = [
        ['تقرير شامل للفرع - ' + branch.name],
        [],
        ['معلومات أساسية'],
        ['اسم الفرع:', branch.name],
        ['مدير الفرع:', branch.manager || 'غير محدد'],
        ['الموقع:', branch.loc || 'غير محدد'],
        ['تاريخ الإنشاء:', new Date().toLocaleDateString('ar-SA')],
        ['وقت الإنشاء:', new Date().toLocaleTimeString('ar-SA')],
        [],
        ['إحصائيات سريعة'],
        ['عدد الكشوفات المتاحة:', Object.keys(MODELS.forms).length],
        ['إجمالي السجلات:', this.getTotalRecords(branch.id)],
        [],
        ['ملاحظات مهمة'],
        ['• يتم تحديث هذا الملف تلقائياً عند إدخال البيانات في النظام'],
        ['• كل كشف في ورقة منفصلة مع تنسيق احترافي'],
        ['• البيانات مرتبة حسب التاريخ من الأحدث إلى الأقدم'],
        ['• يمكن استخدام هذا الملف للمراجعة والتدقيق']
      ];

      const branchWS = XLSX.utils.aoa_to_sheet(branchInfo);

      // تنسيق ورقة معلومات الفرع
      this.formatInfoSheet(branchWS);

      XLSX.utils.book_append_sheet(wb, branchWS, 'معلومات الفرع');

      // إضافة ورقة لكل نوع كشف مع تنسيق محسن
      Object.keys(MODELS.forms).forEach(formKey => {
        const form = MODELS.forms[formKey];
        const sheetName = this.getSheetName(formKey);

        // إنشاء ورقة العمل مع تنسيق احترافي
        const ws = this.createFormattedSheet(form, branch.id, formKey);

        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      });

      // حفظ الملف
      const fileName = `${branch.name.replace(/[^\w\s]/gi, '')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Notifications.add('تصدير Excel', `تم إنشاء ملف Excel للفرع: ${fileName}`, 'success');

    } catch (error) {
      console.error('Excel export error:', error);
      Notifications.add('خطأ في التصدير', 'فشل في إنشاء ملف Excel', 'error');
    }
  },

  getTotalRecords(branchId) {
    let total = 0;
    if (State.db.records[branchId]) {
      Object.keys(State.db.records[branchId]).forEach(formKey => {
        total += (State.db.records[branchId][formKey] || []).length;
      });
    }
    return total;
  },

  formatInfoSheet(ws) {
    if (!ws['!ref']) return;

    const range = XLSX.utils.decode_range(ws['!ref']);

    // تنسيق العنوان الرئيسي
    const titleCell = 'A1';
    if (ws[titleCell]) {
      ws[titleCell].s = {
        font: { bold: true, size: 16, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "2563EB" } },
        alignment: { horizontal: "center", vertical: "center" },
        border: {
          top: { style: "thick", color: { rgb: "000000" } },
          bottom: { style: "thick", color: { rgb: "000000" } },
          left: { style: "thick", color: { rgb: "000000" } },
          right: { style: "thick", color: { rgb: "000000" } }
        }
      };
    }

    // تنسيق العناوين الفرعية
    ['A3', 'A10', 'A14'].forEach(cell => {
      if (ws[cell]) {
        ws[cell].s = {
          font: { bold: true, size: 12, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "059669" } },
          alignment: { horizontal: "center" }
        };
      }
    });

    // تنسيق البيانات
    for (let row = 4; row <= 8; row++) {
      const labelCell = `A${row}`;
      const valueCell = `B${row}`;

      if (ws[labelCell]) {
        ws[labelCell].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "F3F4F6" } }
        };
      }

      if (ws[valueCell]) {
        ws[valueCell].s = {
          fill: { fgColor: { rgb: "FFFFFF" } },
          border: {
            top: { style: "thin", color: { rgb: "D1D5DB" } },
            bottom: { style: "thin", color: { rgb: "D1D5DB" } },
            left: { style: "thin", color: { rgb: "D1D5DB" } },
            right: { style: "thin", color: { rgb: "D1D5DB" } }
          }
        };
      }
    }

    // تعيين عرض الأعمدة
    ws['!cols'] = [
      { width: 25 },
      { width: 30 }
    ];
  },

  createFormattedSheet(form, branchId, formKey) {
    // الحصول على البيانات
    const existingData = State.db.records[branchId] && State.db.records[branchId][formKey]
      ? State.db.records[branchId][formKey]
      : [];

    // ترتيب البيانات حسب التاريخ (الأحدث أولاً)
    const sortedData = existingData.sort((a, b) => {
      const dateA = new Date(a.date || '1900-01-01');
      const dateB = new Date(b.date || '1900-01-01');
      return dateB - dateA;
    });

    // إنشاء البيانات للورقة
    const sheetData = [];

    // العنوان الرئيسي
    sheetData.push([form.label]);
    sheetData.push([]);

    // معلومات إضافية
    const branch = State.db.branches.find(b => b.id === branchId);
    sheetData.push(['الفرع:', branch ? branch.name : 'غير معروف']);
    sheetData.push(['عدد السجلات:', sortedData.length]);
    sheetData.push(['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')]);
    sheetData.push(['وقت التصدير:', new Date().toLocaleTimeString('ar-SA')]);
    sheetData.push([]);

    if (sortedData.length === 0) {
      sheetData.push(['لا توجد بيانات مسجلة في هذا الكشف']);
      sheetData.push([]);
      sheetData.push(['ملاحظة: سيتم تحديث هذا الملف تلقائياً عند إضافة بيانات جديدة']);
    } else {
      // رؤوس الأعمدة
      const headers = ['#', ...form.fields.map(f => f.label)];
      sheetData.push(headers);

      // البيانات
      sortedData.forEach((record, index) => {
        const row = [
          index + 1,
          ...form.fields.map(f => {
            let value = record[f.k] || '';
            // تنسيق الأرقام
            if (f.type === 'number' && value) {
              const num = parseFloat(value);
              return isNaN(num) ? value : num.toLocaleString('ar-SA');
            }
            // تنسيق التواريخ
            if (f.type === 'date' && value) {
              try {
                return new Date(value).toLocaleDateString('ar-SA');
              } catch (e) {
                return value;
              }
            }
            return value;
          })
        ];
        sheetData.push(row);
      });

      // إضافة صف الإجماليات للأرقام
      const totalsRow = ['الإجمالي'];
      form.fields.forEach(f => {
        if (f.type === 'number') {
          const total = sortedData.reduce((sum, record) => {
            return sum + (parseFloat(record[f.k]) || 0);
          }, 0);
          totalsRow.push(total.toLocaleString('ar-SA'));
        } else {
          totalsRow.push('');
        }
      });

      sheetData.push([]);
      sheetData.push(totalsRow);

      // إضافة إحصائيات إضافية
      sheetData.push([]);
      sheetData.push(['إحصائيات إضافية']);

      if (sortedData.length > 0) {
        const firstDate = sortedData[sortedData.length - 1].date;
        const lastDate = sortedData[0].date;
        sheetData.push(['أول تاريخ:', firstDate ? new Date(firstDate).toLocaleDateString('ar-SA') : 'غير محدد']);
        sheetData.push(['آخر تاريخ:', lastDate ? new Date(lastDate).toLocaleDateString('ar-SA') : 'غير محدد']);

        // حساب المتوسط للحقول الرقمية
        form.fields.forEach(f => {
          if (f.type === 'number') {
            const values = sortedData.map(r => parseFloat(r[f.k]) || 0).filter(v => v > 0);
            if (values.length > 0) {
              const average = values.reduce((a, b) => a + b, 0) / values.length;
              sheetData.push([`متوسط ${f.label}:`, average.toLocaleString('ar-SA')]);
            }
          }
        });
      }
    }

    // إنشاء ورقة العمل
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    // تطبيق التنسيق
    this.formatDataSheet(ws, form.fields.length + 1, sortedData.length);

    return ws;
  },

  formatDataSheet(ws, numCols, numDataRows) {
    if (!ws['!ref']) return;

    const range = XLSX.utils.decode_range(ws['!ref']);

    // تنسيق العنوان الرئيسي
    const titleCell = 'A1';
    if (ws[titleCell]) {
      ws[titleCell].s = {
        font: { bold: true, size: 14, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "1F2937" } },
        alignment: { horizontal: "center", vertical: "center" }
      };

      // دمج الخلايا للعنوان
      ws['!merges'] = ws['!merges'] || [];
      ws['!merges'].push({
        s: { r: 0, c: 0 },
        e: { r: 0, c: Math.max(numCols - 1, 3) }
      });
    }

    // تنسيق معلومات الفرع
    for (let row = 3; row <= 6; row++) {
      const labelCell = `A${row}`;
      const valueCell = `B${row}`;

      if (ws[labelCell]) {
        ws[labelCell].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "F9FAFB" } }
        };
      }

      if (ws[valueCell]) {
        ws[valueCell].s = {
          fill: { fgColor: { rgb: "FFFFFF" } }
        };
      }
    }

    // تنسيق رؤوس الأعمدة (الصف 8 عادة)
    const headerRow = 8;
    for (let col = 0; col < numCols; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: headerRow, c: col });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "059669" } },
          alignment: { horizontal: "center", vertical: "center" },
          border: {
            top: { style: "medium", color: { rgb: "000000" } },
            bottom: { style: "medium", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
          }
        };
      }
    }

    // تنسيق بيانات الجدول
    for (let row = headerRow + 1; row <= headerRow + numDataRows; row++) {
      for (let col = 0; col < numCols; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
        if (ws[cellAddress]) {
          const isEvenRow = (row - headerRow) % 2 === 0;
          ws[cellAddress].s = {
            fill: { fgColor: { rgb: isEvenRow ? "F9FAFB" : "FFFFFF" } },
            border: {
              top: { style: "thin", color: { rgb: "E5E7EB" } },
              bottom: { style: "thin", color: { rgb: "E5E7EB" } },
              left: { style: "thin", color: { rgb: "E5E7EB" } },
              right: { style: "thin", color: { rgb: "E5E7EB" } }
            },
            alignment: { horizontal: col === 0 ? "center" : "right" }
          };
        }
      }
    }

    // تنسيق صف الإجماليات
    const totalsRow = headerRow + numDataRows + 2;
    for (let col = 0; col < numCols; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: totalsRow, c: col });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "DC2626" } },
          alignment: { horizontal: col === 0 ? "center" : "right" },
          border: {
            top: { style: "medium", color: { rgb: "000000" } },
            bottom: { style: "medium", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
          }
        };
      }
    }

    // تعيين عرض الأعمدة
    const colWidths = [];
    colWidths.push({ width: 8 }); // عمود الرقم التسلسلي

    for (let i = 1; i < numCols; i++) {
      colWidths.push({ width: 15 });
    }

    ws['!cols'] = colWidths;

    // تجميد الصفوف والأعمدة
    ws['!freeze'] = { xSplit: 1, ySplit: headerRow + 1 };
  },

  exportFormData(formKey, branchId) {
    if (typeof XLSX === 'undefined') {
      console.warn('XLSX library not loaded');
      Notifications.add('خطأ', 'مكتبة Excel غير متوفرة', 'error');
      return;
    }

    try {
      const branch = State.db.branches.find(b => b.id === branchId);
      const form = MODELS.forms[formKey];
      const data = State.db.records[branchId] && State.db.records[branchId][formKey]
        ? State.db.records[branchId][formKey]
        : [];

      if (data.length === 0) {
        Notifications.add('تنبيه', 'لا توجد بيانات للتصدير', 'warning');
        return;
      }

      // إنشاء workbook
      const wb = XLSX.utils.book_new();

      // إنشاء ورقة عمل منسقة
      const ws = this.createFormattedSheet(form, branchId, formKey);

      XLSX.utils.book_append_sheet(wb, ws, this.getSheetName(formKey));

      // حفظ الملف
      const fileName = `${form.label.replace(/[^\w\s]/gi, '')}_${branch ? branch.name.replace(/[^\w\s]/gi, '') : 'فرع'}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Notifications.add('تصدير Excel', `تم تصدير البيانات إلى: ${fileName}`, 'success');

    } catch (error) {
      console.error('Excel export error:', error);
      Notifications.add('خطأ في التصدير', 'فشل في تصدير البيانات', 'error');
    }
  },

  updateFormData(formKey, branchId, newRecord) {
    // هذه الدالة يمكن تطويرها لاحقاً لتحديث ملف Excel موجود
    // حالياً ستقوم بإنشاء ملف جديد
    this.exportFormData(formKey, branchId);
  },

  exportAllBranchData(branchId) {
    if (typeof XLSX === 'undefined') {
      console.warn('XLSX library not loaded');
      Notifications.add('خطأ', 'مكتبة Excel غير متوفرة', 'error');
      return;
    }

    try {
      const branch = State.db.branches.find(b => b.id === branchId);
      if (!branch) {
        Notifications.add('خطأ', 'الفرع غير موجود', 'error');
        return;
      }

      const wb = XLSX.utils.book_new();

      // إضافة ورقة معلومات الفرع مع تنسيق احترافي
      const branchInfo = [
        ['التقرير الشامل - ' + branch.name],
        [],
        ['معلومات الفرع'],
        ['اسم الفرع:', branch.name],
        ['مدير الفرع:', branch.manager || 'غير محدد'],
        ['الموقع:', branch.loc || 'غير محدد'],
        ['تاريخ التقرير:', new Date().toLocaleDateString('ar-SA')],
        ['وقت التقرير:', new Date().toLocaleTimeString('ar-SA')],
        [],
        ['ملخص البيانات'],
        ['إجمالي الكشوفات:', Object.keys(MODELS.forms).length],
        ['الكشوفات التي تحتوي على بيانات:', this.getActiveFormsCount(branchId)],
        ['إجمالي السجلات:', this.getTotalRecords(branchId)],
        [],
        ['الكشوفات المتاحة:']
      ];

      // إضافة قائمة بجميع الكشوفات
      Object.keys(MODELS.forms).forEach(formKey => {
        const form = MODELS.forms[formKey];
        const recordCount = State.db.records[branchId] && State.db.records[branchId][formKey]
          ? State.db.records[branchId][formKey].length
          : 0;
        branchInfo.push([`• ${form.label}:`, `${recordCount} سجل`]);
      });

      const branchWS = XLSX.utils.aoa_to_sheet(branchInfo);
      this.formatInfoSheet(branchWS);
      XLSX.utils.book_append_sheet(wb, branchWS, 'معلومات الفرع');

      // إضافة ورقة لكل كشف (حتى لو كان فارغاً)
      Object.keys(MODELS.forms).forEach(formKey => {
        const form = MODELS.forms[formKey];
        const ws = this.createFormattedSheet(form, branchId, formKey);
        XLSX.utils.book_append_sheet(wb, ws, this.getSheetName(formKey));
      });

      // حفظ الملف
      const fileName = `تقرير_شامل_${branch.name.replace(/[^\w\s]/gi, '')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Notifications.add('تصدير Excel', `تم إنشاء التقرير الشامل: ${fileName}`, 'success');

    } catch (error) {
      console.error('Excel export error:', error);
      Notifications.add('خطأ في التصدير', 'فشل في إنشاء التقرير الشامل', 'error');
    }
  },

  getActiveFormsCount(branchId) {
    let count = 0;
    if (State.db.records[branchId]) {
      Object.keys(State.db.records[branchId]).forEach(formKey => {
        if ((State.db.records[branchId][formKey] || []).length > 0) {
          count++;
        }
      });
    }
    return count;
  },

  createFilteredReportSheet(form, filteredData, reportType, date, month, branch) {
    // ترتيب البيانات حسب التاريخ (الأحدث أولاً)
    const sortedData = filteredData.sort((a, b) => {
      const dateA = new Date(a.date || '1900-01-01');
      const dateB = new Date(b.date || '1900-01-01');
      return dateB - dateA;
    });

    // إنشاء البيانات للورقة
    const sheetData = [];

    // العنوان الرئيسي
    const periodText = reportType === 'daily' ? `ليوم ${date}` : `لشهر ${month}`;
    sheetData.push([`${form.label} ${periodText}`]);
    sheetData.push([]);

    // معلومات التقرير
    sheetData.push(['تفاصيل التقرير']);
    sheetData.push(['الكشف:', form.label]);
    sheetData.push(['الفرع:', branch ? branch.name : 'غير معروف']);
    sheetData.push(['الفترة:', periodText]);
    sheetData.push(['عدد السجلات:', sortedData.length]);
    sheetData.push(['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')]);
    sheetData.push(['وقت التصدير:', new Date().toLocaleTimeString('ar-SA')]);
    sheetData.push([]);

    if (sortedData.length === 0) {
      sheetData.push(['لا توجد بيانات للفترة المحددة']);
      sheetData.push([]);
      sheetData.push(['ملاحظة: تأكد من وجود بيانات مسجلة في هذه الفترة']);
    } else {
      // رؤوس الأعمدة
      const headers = ['#', ...form.fields.map(f => f.label)];
      sheetData.push(headers);

      // البيانات
      sortedData.forEach((record, index) => {
        const row = [
          index + 1,
          ...form.fields.map(f => {
            let value = record[f.k] || '';
            // تنسيق الأرقام
            if (f.type === 'number' && value) {
              const num = parseFloat(value);
              return isNaN(num) ? value : num.toLocaleString('ar-SA');
            }
            // تنسيق التواريخ
            if (f.type === 'date' && value) {
              try {
                return new Date(value).toLocaleDateString('ar-SA');
              } catch (e) {
                return value;
              }
            }
            return value;
          })
        ];
        sheetData.push(row);
      });

      // إضافة صف الإجماليات للأرقام
      const totalsRow = ['الإجمالي'];
      form.fields.forEach(f => {
        if (f.type === 'number') {
          const total = sortedData.reduce((sum, record) => {
            return sum + (parseFloat(record[f.k]) || 0);
          }, 0);
          totalsRow.push(total.toLocaleString('ar-SA'));
        } else {
          totalsRow.push('');
        }
      });

      sheetData.push([]);
      sheetData.push(totalsRow);

      // إضافة إحصائيات للفترة
      sheetData.push([]);
      sheetData.push(['إحصائيات الفترة']);

      if (reportType === 'daily') {
        sheetData.push(['التاريخ:', new Date(date).toLocaleDateString('ar-SA')]);
      } else {
        const monthDate = new Date(month + '-01');
        sheetData.push(['الشهر:', monthDate.toLocaleDateString('ar-SA', { year: 'numeric', month: 'long' })]);
      }

      // حساب المتوسط والحد الأدنى والأقصى للحقول الرقمية
      form.fields.forEach(f => {
        if (f.type === 'number') {
          const values = sortedData.map(r => parseFloat(r[f.k]) || 0).filter(v => v > 0);
          if (values.length > 0) {
            const average = values.reduce((a, b) => a + b, 0) / values.length;
            const min = Math.min(...values);
            const max = Math.max(...values);

            sheetData.push([`متوسط ${f.label}:`, average.toLocaleString('ar-SA')]);
            sheetData.push([`أقل ${f.label}:`, min.toLocaleString('ar-SA')]);
            sheetData.push([`أعلى ${f.label}:`, max.toLocaleString('ar-SA')]);
          }
        }
      });
    }

    // إنشاء ورقة العمل
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    // تطبيق التنسيق
    this.formatReportSheet(ws, form.fields.length + 1, sortedData.length);

    return ws;
  },

  formatReportSheet(ws, numCols, numDataRows) {
    if (!ws['!ref']) return;

    const range = XLSX.utils.decode_range(ws['!ref']);

    // تنسيق العنوان الرئيسي
    const titleCell = 'A1';
    if (ws[titleCell]) {
      ws[titleCell].s = {
        font: { bold: true, size: 16, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "7C3AED" } },
        alignment: { horizontal: "center", vertical: "center" }
      };

      // دمج الخلايا للعنوان
      ws['!merges'] = ws['!merges'] || [];
      ws['!merges'].push({
        s: { r: 0, c: 0 },
        e: { r: 0, c: Math.max(numCols - 1, 3) }
      });
    }

    // تنسيق عنوان "تفاصيل التقرير"
    const detailsTitle = 'A3';
    if (ws[detailsTitle]) {
      ws[detailsTitle].s = {
        font: { bold: true, size: 12, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "059669" } },
        alignment: { horizontal: "center" }
      };
    }

    // تنسيق معلومات التقرير
    for (let row = 4; row <= 9; row++) {
      const labelCell = `A${row}`;
      const valueCell = `B${row}`;

      if (ws[labelCell]) {
        ws[labelCell].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "F3F4F6" } }
        };
      }

      if (ws[valueCell]) {
        ws[valueCell].s = {
          fill: { fgColor: { rgb: "FFFFFF" } }
        };
      }
    }

    // تنسيق رؤوس الأعمدة (الصف 11 عادة)
    const headerRow = 11;
    for (let col = 0; col < numCols; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: headerRow, c: col });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "1F2937" } },
          alignment: { horizontal: "center", vertical: "center" },
          border: {
            top: { style: "medium", color: { rgb: "000000" } },
            bottom: { style: "medium", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
          }
        };
      }
    }

    // تنسيق بيانات الجدول
    for (let row = headerRow + 1; row <= headerRow + numDataRows; row++) {
      for (let col = 0; col < numCols; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
        if (ws[cellAddress]) {
          const isEvenRow = (row - headerRow) % 2 === 0;
          ws[cellAddress].s = {
            fill: { fgColor: { rgb: isEvenRow ? "F8FAFC" : "FFFFFF" } },
            border: {
              top: { style: "thin", color: { rgb: "E2E8F0" } },
              bottom: { style: "thin", color: { rgb: "E2E8F0" } },
              left: { style: "thin", color: { rgb: "E2E8F0" } },
              right: { style: "thin", color: { rgb: "E2E8F0" } }
            },
            alignment: { horizontal: col === 0 ? "center" : "right" }
          };
        }
      }
    }

    // تنسيق صف الإجماليات
    const totalsRow = headerRow + numDataRows + 2;
    for (let col = 0; col < numCols; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: totalsRow, c: col });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "EF4444" } },
          alignment: { horizontal: col === 0 ? "center" : "right" },
          border: {
            top: { style: "medium", color: { rgb: "000000" } },
            bottom: { style: "medium", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
          }
        };
      }
    }

    // تعيين عرض الأعمدة
    const colWidths = [];
    colWidths.push({ width: 8 }); // عمود الرقم التسلسلي

    for (let i = 1; i < numCols; i++) {
      colWidths.push({ width: 18 });
    }

    ws['!cols'] = colWidths;

    // تجميد الصفوف والأعمدة
    ws['!freeze'] = { xSplit: 1, ySplit: headerRow + 1 };
  },

  getSheetName(formKey) {
    const names = {
      dailyRevenue: 'الإيرادات اليومية',
      bankRecon: 'الموازنات البنكية',
      cashPurch: 'المشتريات النقدية',
      creditPurch: 'المشتريات الآجلة',
      dailyMeals: 'التغذية اليومية',
      empAdvance: 'سلف الموظفين',
      supMaintenance: 'صيانة المشرف',
      marketPurch: 'المشتريات السوقية',
      mgrMaintenance: 'صيانة المدير',
      mgrPurch: 'مشتريات المدير',
      empAdd: 'الموظفين'
    };

    return names[formKey] || formKey;
  }
};

/* ========= UI Builders ========= */
const UI = {
  renderBranches(){
    const grid = q("#branchesGrid");
    if (!grid) return;

    // إذا كان مدير فرع، اعرض فرعه فقط
    let branchesToShow = State.db.branches;
    if (State.user && State.user.role === 'branch-manager' && State.user.branchId) {
      branchesToShow = State.db.branches.filter(b => b.id === State.user.branchId);
    }

    if (branchesToShow.length === 0) {
      grid.innerHTML = '<div class="muted">لا توجد فروع متاحة</div>';
      return;
    }

    grid.innerHTML = branchesToShow.map(b=>`
      <div class="card">
        <h3>${b.name}</h3>
        <div class="muted">المدير: ${b.manager||"-"} · الموقع: ${b.loc||"-"}</div>
        <div class="toolbar">
          <button class="btn acc" onclick="Router.go('branch',{branchId:'${b.id}'})">فتح الفرع</button>
        </div>
      </div>
    `).join("");
  },
  
  openBranch(branchId){
    const b = State.db.branches.find(x=>x.id===branchId) || State.db.branches[0];
    State.currentBranch = b.id;
    ensureBranchContainers(b.id);

    q("#branchTitle").textContent = b.name;
    q("#branchSub").innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>مدير الفرع: ${b.manager||"-"} · الموقع: ${b.loc||"-"}</span>
        <button class="btn info" onclick="ExcelExport.exportAllBranchData('${b.id}')" style="font-size: 12px; padding: 6px 12px;">
          📊 تصدير Excel شامل
        </button>
      </div>
    `;

    // tabs
    const tabs = q("#branchTabs");
    if (!tabs) return;

    tabs.innerHTML = MODELS.branchTabs.map((t)=>{
      const key = t.k;
      const label = t.label || MODELS.forms[key]?.label || "الإجمالي";
      return `<div class="tab" onclick="Router.go('form', {formKey: '${key}', branchId: '${b.id}'})">${t.icon}<br>${label}</div>`;
    }).join("");
    
    // عند فتح الفرع، لا تعرض أي كشف مباشرة
    q('#branchForms').innerHTML = "<div class='muted'>يرجى اختيار كشف من القائمة أعلاه.</div>";
  },

  renderFormPage(formKey, branchId) {
    const branch = State.db.branches.find(b => b.id === branchId);
    const def = MODELS.forms[formKey];

    if (!branch || !def) {
      q('#formContent').innerHTML = '<div class="muted">خطأ: لم يتم العثور على البيانات المطلوبة</div>';
      return;
    }

    State.currentBranch = branchId;
    State.currentForm = formKey;

    // تحديث العناوين
    q('#formTitle').textContent = def.label;
    q('#formSubtitle').textContent = `إدارة ${def.label} لفرع ${branch.name}`;
    q('#formRecordsTitle').textContent = `سجل ${def.label}`;

    // إنشاء النموذج
    let html = `<div class='card' style='background:#18253a'><h3>${def.label}</h3><div class='row'>`;

    def.fields.forEach((f, index) => {
      const nextFieldId = index < def.fields.length - 1 ?
        `${formKey}_${def.fields[index + 1].k}` :
        `save_${formKey}_btn`;

      html += `<div class='col-4'><label>${f.label}</label>${this.fieldInput(f, formKey, nextFieldId)}</div>`;
    });

    html += `<div class='col-12 toolbar'>
      <button id="save_${formKey}_btn" class='btn acc' onclick='UI.saveFormData("${formKey}")'>حفظ البيانات</button>
      <button class='btn ghost' onclick='UI.clearFormData("${formKey}")'>مسح الحقول</button>
    </div></div></div>`;

    q('#formContent').innerHTML = html;

    // عرض السجلات
    this.renderFormRecords(formKey, branchId);
  },

  fieldInput(f, formKey, nextFieldId = null) {
    const fieldId = `${formKey}_${f.k}`;
    const enterHandler = nextFieldId ? `onkeydown="UI.handleFormEnterKey(event, '${nextFieldId}', '${formKey}')"` : '';

    if (f.type === "date") {
      return `<input type='date' id='${fieldId}' class='input' ${enterHandler}>`;
    } else if (f.type === "number") {
      return `<input type='number' id='${fieldId}' class='input' placeholder='0.00' ${enterHandler}>`;
    } else if (f.type === "select" && f.options) {
      let opts = f.options.map(opt => `<option value='${opt}'>${opt}</option>`).join('');
      return `<select id='${fieldId}' class='input' ${enterHandler}>${opts}</select>`;
    } else {
      return `<input type='text' id='${fieldId}' class='input' placeholder='${f.label}' ${enterHandler}>`;
    }
  },

  handleFormEnterKey(event, nextFieldId, formKey) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId.startsWith('save_')) {
        this.saveFormData(formKey);
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },

  saveFormData(formKey) {
    const branchId = State.currentBranch;
    const def = MODELS.forms[formKey];

    if (!branchId || !def) {
      Notification.show("خطأ في البيانات", "error");
      return;
    }

    ensureBranchContainers(branchId);

    const data = { id: uid() };
    let hasData = false;

    def.fields.forEach(f => {
      const fieldId = `${formKey}_${f.k}`;
      const value = q('#' + fieldId)?.value?.trim();

      if (value) {
        hasData = true;
        if (f.type === "number") {
          data[f.k] = parseNum(value);
        } else {
          data[f.k] = value;
        }
      }
    });

    if (!hasData) {
      Notification.show("يرجى ملء حقل واحد على الأقل", "error");
      return;
    }

    State.db.records[branchId][formKey].push(data);
    DB.save();

    this.clearFormData(formKey);
    this.renderFormRecords(formKey, branchId);
    Notification.show("تم حفظ البيانات بنجاح", "success");
  },

  clearFormData(formKey) {
    const def = MODELS.forms[formKey];
    if (!def) return;

    def.fields.forEach(f => {
      const fieldId = `${formKey}_${f.k}`;
      const field = q('#' + fieldId);
      if (field) {
        if (f.type === "date") {
          field.value = todayStr();
        } else {
          field.value = '';
        }
      }
    });
  },

  renderFormRecords(formKey, branchId) {
    const container = q('#formRecordsList');
    const def = MODELS.forms[formKey];

    if (!container || !def) return;

    const records = State.db.records[branchId]?.[formKey] || [];

    if (records.length === 0) {
      container.innerHTML = '<div class="muted">لا توجد بيانات مسجلة</div>';
      return;
    }

    let html = '<table><thead><tr>';
    def.fields.forEach(f => {
      html += `<th>${f.label}</th>`;
    });
    html += '<th class="no-print">إجراء</th></tr></thead><tbody>';

    records.forEach(record => {
      html += '<tr>';
      def.fields.forEach(f => {
        const value = record[f.k] || '';
        if (f.type === "number") {
          html += `<td>${fmt(value)}</td>`;
        } else {
          html += `<td>${value}</td>`;
        }
      });
      html += `<td class="no-print">
        <button class="btn danger" onclick="UI.deleteFormRecord('${formKey}', '${record.id}')">حذف</button>
      </td></tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  },

  deleteFormRecord(formKey, recordId) {
    if (!confirm('هل أنت متأكد من حذف هذا السجل؟')) return;

    const branchId = State.currentBranch;
    const records = State.db.records[branchId]?.[formKey] || [];
    const index = records.findIndex(r => r.id === recordId || r._id === recordId);

    if (index !== -1) {
      records.splice(index, 1);
      DB.save();
      this.renderFormRecords(formKey, branchId);
      Notification.show("تم حذف السجل بنجاح", "success");
    } else {
      Notification.show("لم يتم العثور على السجل المطلوب", "error");
    }
  },

  // Navigation Functions
  goBackToBranch() {
    if (State.currentBranch) {
      Router.go('branch', {branchId: State.currentBranch});
    } else {
      Router.go('home');
    }
  },

  goBackToBranch(branchId) {
    State.currentBranch = branchId;
    Router.go('branch', {branchId});
  },

  switchTab(key){
    let branchId = State.currentBranch;
    if(!branchId){
      branchId = (State.db && State.db.branches && State.db.branches[0]?.id) || '';
    }
    const def = MODELS.forms[key];
    if(!def || !def.fields || def.fields.length === 0){
      q('#branchForms').innerHTML = "<div class='muted'>لا توجد حقول لهذا الكشف.</div>";
      return;
    }
    
    let html = `<div class='sep' style='margin-bottom:18px;background:#22c55e;height:3px;border-radius:2px'></div>`;
    html += `<div class='card' style='background:#18253a'><h3>${def.label}</h3><div class='row'>`;
    
    def.fields.forEach(f=>{
      html += `<div class='col-4'><label>${f.label}</label>${this.fieldInput(f,key)}</div>`;
    });
    
    // إذا كان الكشف هو الإيرادات اليومية، أضف حقل الإجمالي وحقل عدد السيارات بعد الحقول
    if(key==='dailyRevenue'){
      html += `<div class='col-4'><label>الإجمالي</label><input type='text' id='totalField' class='input' readonly style='background:#222;color:#fff'></div>`;
      html += `<div class='col-4'><label>عدد السيارات</label><input type='number' id='carsField' class='input' readonly style='background:#222;color:#fff'></div>`;
    }
    
    html += `</div><div class='toolbar' style='justify-content:center'>
      <button class='btn acc' id='saveFormBtn'>حفظ السجل</button>
      <button class='btn info' onclick="ExcelExport.exportFormData('${key}', '${branchId}')">📊 تصدير Excel</button>
      <button class='btn ghost' onclick="UI.goBackToBranch('${branchId}')">رجوع للفرع</button>
    </div></div>`;
    
    // جدول السجلات
    html += `<div class='card' style='background:#1a2a3d'><h3>السجلات المحفوظة</h3><div class='subtitle'>يمكن حذف أي سطر.</div>
      <div style='overflow:auto'><table id='tbl-${key}' style='border:2px solid #22c55e;border-radius:8px'><thead></thead><tbody></tbody></table></div></div>`;
    
    q('#branchForms').innerHTML = html;
    
    // تفعيل عرض السجل
    this.renderTableForBranch(key, def, branchId);
    
    // تفعيل زر الحفظ
    const saveBtn = q('#saveFormBtn');
    if(saveBtn){
      saveBtn.onclick = ()=>this.saveForm(key, def);
    }
    
    // تفعيل حساب الإجمالي تلقائي لكشف الإيرادات اليومية
    if(key==='dailyRevenue'){
      const updateTotal = ()=>{
        const network = parseFloat(q("[data-key='network']")?.value||0);
        const cash = parseFloat(q("[data-key='cash']")?.value||0);
        const credit = parseFloat(q("[data-key='credit']")?.value||0);
        const total = network+cash+credit;
        q('#totalField').value = total;
        q('#carsField').value = q("[data-key='cars']")?.value||0;
      };
      ["network","cash","credit","cars"].forEach(k=>{
        const inp = q(`[data-key='${k}']`);
        if(inp){ inp.oninput = updateTotal; }
      });
      updateTotal();
    }
  },
  
  fieldInput(f, key) {
    const id = `${key}-${f.k}`;
    const defval = f.def || "";
    const base = `data-field="${key}" data-key="${f.k}" id="${id}" class="input" ${defval?`data-def="${defval}" value="${defval}"`:``}`;
    
    if(f.type==="date") return `<input type="date" ${base}>`;
    if(f.type==="number") return `<input type="number" step="0.01" ${base}>`;
    if(f.type==="text") return `<input type="text" ${base}>`;
    if(f.type==="readonly") return `<input type="text" ${base} readonly>`;
    if(f.type==="select") return `<select ${base}>${(f.opts||[]).map(o=>`<option>${o}</option>`).join("")}</select>`;
    if(f.type==="picker-emp"){
      return `<div style="display:flex;gap:6px">
        <input type="text" ${base} placeholder="اختر الموظف" readonly>
        <button class="btn" onclick="UI.pickEmp('${key}','${id}')">بحث</button>
      </div>
      <div class="muted" id="${id}-hint"></div>`;
    }
    return `<input type="text" ${base}>`;
  },
  
  pickEmp(key, inputId) {
    const list = State.db.employees[State.currentBranch]||[];
    const name = prompt("اكتب جزءًا من اسم الموظف للبحث:");
    if(name===null) return;
    
    const found = list.find(e=>e.name.includes(name.trim()));
    if(!found){ 
      Notification.show("لم يتم العثور على موظف مطابق.", "error");
      return; 
    }
    
    const inp = q("#"+inputId);
    inp.value = found.name;
    
    if(key==="empAdvance"){
      const rows = State.db.records[State.currentBranch]["empAdvance"]||[];
      const empRows = rows.filter(r=>r.emp===found.name);
      const totalTaken = empRows.reduce((s,r)=>s+parseNum(r.take),0);
      const prev = empRows.length? (empRows[empRows.length-1].take||0) : 0;
      
      q("#empAdvance-salary").value = found.salary||0;
      q("#empAdvance-prev").value = prev;
      q("#empAdvance-totalTaken").value = totalTaken;
      
      const remain = (found.salary||0) - totalTaken;
      q("#empAdvance-remain").value = remain;
      q("#"+inputId+"-hint").textContent = `الراتب: ${fmt(found.salary)} · إجمالي المسحوبات: ${fmt(totalTaken)} · المتبقي: ${fmt(remain)}`;
    }
    
    Notification.show(`تم اختيار الموظف: ${found.name}`, "success");
  },
  
  saveForm(key, def) {
    const data = {};
    def.fields.forEach(f=>{
      const el = q(`#${key}-${f.k}`);
      if(!el) return;
      let v = el.value;
      if(f.type==="number") v = parseNum(v);
      data[f.k] = v;
    });

    if(key==="empAdd"){
      const b = State.currentBranch;
      if(!data.name){ 
        Notification.show("يرجى إدخال اسم الموظف", "error");
        return; 
      }
      
      State.db.employees[b].push({
        id: uid(), 
        name: data.name, 
        salary: parseNum(data.salary), 
        phone: data.phone||"", 
        role: data.role||"موظّف"
      });
      
      DB.save();
      Notification.show("تمت إضافة الموظف بنجاح", "success");
      this.renderTable(key, MODELS.forms[key]);
      return;
    }

    if(key==="empAdvance"){
      const emp = (data.emp||"").trim();
      if(!emp){ 
        Notification.show("يرجى اختيار الموظف", "error");
        return; 
      }
      
      const empObj = (State.db.employees[State.currentBranch]||[]).find(e=>e.name===emp);
      data.salary = empObj? empObj.salary : parseNum(data.salary);
      const rows = State.db.records[State.currentBranch]["empAdvance"]||[];
      const empRows = rows.filter(r=>r.emp===emp);
      const totalTaken = empRows.reduce((s,r)=>s+parseNum(r.take),0) + parseNum(data.take);
      const prev = empRows.length? (empRows[empRows.length-1].take||0) : 0;
      const remain = data.salary - totalTaken;
      
      data.prev = prev;
      data.totalTaken = totalTaken;
      data.remain = remain;
    }

    data.id = uid();
    const b = State.currentBranch;
    State.db.records[b][key].push(data);
    DB.save();
    
    Notification.show("تم حفظ السجل بنجاح", "success");
    this.renderTable(key, def);
  },
  
  renderTableForBranch(key, def, branchId) {
    const thead = q(`#tbl-${key} thead`);
    const tbody = q(`#tbl-${key} tbody`);
    if (!thead || !tbody) return;
    
    const cols = def.fields.map(f=>`<th style='border:1px solid #38bdf8;background:#e0f2fe;color:#222'>${f.label}</th>`).join("") + `<th class="no-print" style='border:1px solid #38bdf8;background:#e0f2fe'></th>`;
    thead.innerHTML = `<tr>${cols}</tr>`;
    
    const rows = State.db.records[branchId]?.[key] || [];
    tbody.innerHTML = rows.map((r,idx)=>{
      const tds = def.fields.map(f=>{
        let v = r[f.k] ?? "";
        if(f.type==="number" || ["amount","price","take","salary","prev","totalTaken","remain","mada","visa","master","other1","other2","cars","credit","cash","network","qty"].includes(f.k)){
          v = fmt(v);
        }
        return `<td style='border:1px solid #38bdf8;background:${idx%2==0?"#f1f5f9":"#e0f2fe"};color:#222'>${v??""}</td>`;
      }).join("");
      return `<tr>${tds}<td class="no-print" style='border:1px solid #38bdf8;background:${idx%2==0?"#f1f5f9":"#e0f2fe"}'>
        <button class="btn danger" onclick="UI.delRowForBranch('${key}','${r._id||r.id}','${branchId}')">حذف</button>
      </td></tr>`;
    }).join("");
  },
  
  delRowForBranch(key, id, branchId) {
    if(!confirm("تأكيد حذف السجل؟")) return;

    const list = State.db.records[branchId][key];
    const i = list.findIndex(e=>e.id===id || e._id===id);
    if(i>-1) list.splice(i,1);

    DB.save();
    Notification.show("تم حذف السجل بنجاح", "success");
    this.renderTableForBranch(key, MODELS.forms[key], branchId);
  },
  
  renderFormPage(formKey, branchId) {
    const b = State.db.branches.find(x => x.id === branchId) || State.db.branches[0];
    State.currentBranch = b.id;
    ensureBranchContainers(b.id);

    const def = MODELS.forms[formKey];
    const title = def.label;
    const section = q('#view-form');
    section.innerHTML = `
        <div class="back-button" onclick="Router.go('branch', {branchId: State.currentBranch})">
            ← العودة إلى الفرع
        </div>
        <div class="card"><h3>${title} - ${b.name}</h3></div>
    `;

    // نموذج الإدخال
    const form = document.createElement('div');
    form.className = 'card';
    form.innerHTML = `<h3>إدخال بيانات</h3>`;

    const fields = document.createElement('div');
    fields.className = 'row';

    def.fields.forEach(f => {
        const col = document.createElement('div');
        col.className = 'col-4';
        col.innerHTML = `<label>${f.label}</label>${this.fieldInput(f, formKey)}`;
        fields.appendChild(col);
    });

    form.appendChild(fields);

    const bar = document.createElement('div');
    bar.className = 'toolbar';
    bar.innerHTML = `
        <button class="btn acc" onclick="UI.saveRecord('${formKey}')">حفظ السجل</button>
        <button class="btn ghost" onclick="UI.clearForm('${formKey}')">مسح الحقول</button>
        <button class="btn info" onclick="ExcelExport.exportFormData('${formKey}', '${branchId}')">تصدير Excel</button>
    `;

    form.appendChild(bar);
    section.appendChild(form);

    // جدول السجلات
    const tableCard = document.createElement('div');
    tableCard.className = 'card';
    tableCard.innerHTML = `
        <h3>السجلات المحفوظة</h3>
        <div class="subtitle">يمكن حذف أي سطر.</div>
        <div style="overflow:auto">
            <table id="tbl-${formKey}">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    `;

    section.appendChild(tableCard);

    // تحديث الجدول
    this.renderTableForBranch(formKey, def, branchId);
  },

  clearForm(formKey) {
    const def = MODELS.forms[formKey];
    def.fields.forEach(f => {
        const input = q(`#${f.k}`);
        if (input) {
            input.value = '';
        }
    });
  },

  saveRecord(formKey) {
    const def = MODELS.forms[formKey];
    const branchId = State.currentBranch;

    const record = { id: uid() }; // إضافة ID فريد للسجل
    let hasData = false;

    def.fields.forEach(f => {
        const input = q(`#${formKey}-${f.k}`);
        if (input) {
            record[f.k] = input.value;
            if (input.value.trim()) hasData = true;
        }
    });

    if (!hasData) {
        Notifications.add("خطأ", "يرجى إدخال بعض البيانات", "error");
        return;
    }

    // إضافة السجل
    if (!State.db.records[branchId]) State.db.records[branchId] = {};
    if (!State.db.records[branchId][formKey]) State.db.records[branchId][formKey] = [];

    State.db.records[branchId][formKey].push(record);
    DB.save();

    // مسح النموذج
    this.clearForm(formKey);

    // تحديث الجدول
    this.renderTableForBranch(formKey, def, branchId);

    Notifications.add("حفظ البيانات", "تم حفظ السجل بنجاح", "success");
  }
};

/* ========= Reports ========= */
const Reports = {
  selectedTypes: [],
  
  populateDaily() {
    const bSel = q("#dailyRepBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    q("#dailyRepDate").value = todayStr();
    this.selectedTypes = [];

    // ملء أنواع التقارير
    this.renderReportTypes('daily');
  },
  
  populateMonthly() {
    const bSel = q("#monthlyRepBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    q("#monthlyRepMonth").value = new Date().toISOString().slice(0,7);
    this.selectedTypes = [];

    // ملء أنواع التقارير
    this.renderReportTypes('monthly');

    console.log('Monthly reports populated successfully');
  },
  
  populateCustom() {
    const bSel = q("#customRepBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    q("#customRepFrom").value = firstOfMonthStr();
    q("#customRepTo").value = todayStr();
    this.selectedTypes = [];

    // ملء أنواع التقارير
    this.renderReportTypes('custom');
  },
  
  populateProfitLoss() {
    const bSel = q("#plBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    q("#plMonth").value = new Date().toISOString().slice(0,7);
  },

  renderReportTypes(reportType) {
    const containerId = `${reportType}ReportTypes`;
    const container = q(`#${containerId}`);
    if (!container) return;

    const html = MODELS.reportTypes.map(rt => `
      <div class="card report-type-card" id="${reportType}-type-${rt.k}" onclick="Reports.toggle${reportType.charAt(0).toUpperCase() + reportType.slice(1)}Type('${rt.k}')">
        <h4>${rt.label}</h4>
      </div>
    `).join('');

    container.innerHTML = html;

    // إزالة التحديد السابق
    this.selectedTypes = [];
    MODELS.reportTypes.forEach(rt => {
      const el = q(`#${reportType}-type-${rt.k}`);
      if (el) el.classList.remove("active");
    });
  },

  exportDailyToExcel() {
    const branchId = q("#dailyRepBranch").value;
    const date = q("#dailyRepDate").value;

    if(this.selectedTypes.length === 0){
      Notifications.add("خطأ", "يرجى اختيار نوع واحد على الأقل من التقارير", "error");
      return;
    }

    this.exportReportToExcel('daily', branchId, date, null, this.selectedTypes);
  },

  exportMonthlyToExcel() {
    const branchId = q("#monthlyRepBranch").value;
    const month = q("#monthlyRepMonth").value;

    if(this.selectedTypes.length === 0){
      Notifications.add("خطأ", "يرجى اختيار نوع واحد على الأقل من التقارير", "error");
      return;
    }

    this.exportReportToExcel('monthly', branchId, null, month, this.selectedTypes);
  },

  exportReportToExcel(reportType, branchId, date, month, selectedTypes) {
    if (typeof XLSX === 'undefined') {
      Notifications.add('خطأ', 'مكتبة Excel غير متوفرة', 'error');
      return;
    }

    try {
      const branch = State.db.branches.find(b => b.id === branchId);
      const wb = XLSX.utils.book_new();

      // إنشاء ورقة معلومات التقرير مع تنسيق احترافي
      const reportInfo = [
        [`التقرير ${reportType === 'daily' ? 'اليومي' : 'الشهري'} - ${branch ? branch.name : 'غير معروف'}`],
        [],
        ['تفاصيل التقرير'],
        ['نوع التقرير:', reportType === 'daily' ? 'تقرير يومي' : 'تقرير شهري'],
        ['الفرع:', branch ? branch.name : 'غير معروف'],
        [reportType === 'daily' ? 'التاريخ:' : 'الشهر:', reportType === 'daily' ? date : month],
        ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
        ['وقت التصدير:', new Date().toLocaleTimeString('ar-SA')],
        [],
        ['الكشوفات المختارة'],
        ...selectedTypes.map(type => [`• ${MODELS.forms[type] ? MODELS.forms[type].label : type}`]),
        [],
        ['ملاحظات'],
        ['• البيانات مرتبة حسب التاريخ من الأحدث إلى الأقدم'],
        ['• تم حساب الإجماليات تلقائياً للحقول الرقمية'],
        ['• يمكن استخدام هذا التقرير للمراجعة والتدقيق']
      ];

      const infoWS = XLSX.utils.aoa_to_sheet(reportInfo);
      this.formatInfoSheet(infoWS);
      XLSX.utils.book_append_sheet(wb, infoWS, 'معلومات التقرير');

      // إضافة ورقة لكل نوع تقرير محدد
      selectedTypes.forEach(type => {
        const def = MODELS.forms[type];
        if (!def) return;

        ensureBranchContainers(branchId);
        const allRows = State.db.records[branchId][type] || [];

        // تصفية البيانات حسب التاريخ/الشهر
        const filteredRows = allRows.filter(r => {
          if (reportType === 'daily') {
            return r.date === date;
          } else {
            return r.date && r.date.slice(0, 7) === month;
          }
        });

        // إنشاء ورقة عمل منسقة للتقرير المفلتر
        const ws = this.createFilteredReportSheet(def, filteredRows, reportType, date, month, branch);

        XLSX.utils.book_append_sheet(wb, ws, ExcelExport.getSheetName(type));
      });

      // حفظ الملف
      const fileName = `تقرير_${reportType === 'daily' ? 'يومي' : 'شهري'}_${branch ? branch.name.replace(/[^\w\s]/gi, '') : 'فرع'}_${reportType === 'daily' ? date : month}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Notifications.add('تصدير Excel', `تم تصدير التقرير إلى: ${fileName}`, 'success');

    } catch (error) {
      console.error('Excel export error:', error);
      Notifications.add('خطأ في التصدير', 'فشل في تصدير التقرير', 'error');
    }
  },
  
  toggleDailyType(type) {
    const el = q(`#daily-type-${type}`);
    if (!el) return;
    
    if(el.classList.contains("active")){
      el.classList.remove("active");
      this.selectedTypes = this.selectedTypes.filter(t => t !== type);
    } else {
      el.classList.add("active");
      this.selectedTypes.push(type);
    }
  },
  
  toggleMonthlyType(type) {
    const el = q(`#monthly-type-${type}`);
    if (!el) {
      console.warn('Element not found for type:', type);
      return;
    }

    if(el.classList.contains("active")){
      el.classList.remove("active");
      this.selectedTypes = this.selectedTypes.filter(t => t !== type);
      console.log('Removed type:', type, 'Selected types:', this.selectedTypes);
    } else {
      el.classList.add("active");
      this.selectedTypes.push(type);
      console.log('Added type:', type, 'Selected types:', this.selectedTypes);
    }
  },
  
  toggleCustomType(type) {
    const el = q(`#custom-type-${type}`);
    if (!el) return;
    
    if(el.classList.contains("active")){
      el.classList.remove("active");
      this.selectedTypes = this.selectedTypes.filter(t => t !== type);
    } else {
      el.classList.add("active");
      this.selectedTypes.push(type);
    }
  },
  
  generateDaily() {
    const branchId = q("#dailyRepBranch").value;
    const date = q("#dailyRepDate").value;
    
    if(this.selectedTypes.length === 0){
      Notification.show("يرجى اختيار نوع واحد على الأقل من التقارير", "error");
      return;
    }
    
    Loading.show("جاري إنشاء التقرير اليومي...");
    
    setTimeout(() => {
      const reports = [];
      
      this.selectedTypes.forEach(type => {
        const def = MODELS.forms[type];
        if(!def) return;
        
        const rows = (State.db.records[branchId][type] || []).filter(r => r.date?.startsWith(date));
        
        if(rows.length > 0){
          reports.push({
            type,
            label: def.label,
            rows
          });
        }
      });
      
      // حفظ التقرير في السجلات
      const branch = State.db.branches.find(b => b.id === branchId);
      const reportId = uid();
      const savedReport = {
        id: reportId,
        type: "daily",
        branchId,
        branchName: branch?.name || "غير معروف",
        date,
        title: `تقرير يومي - ${date}`,
        reports: reports
      };
      
      State.db.savedReports.push(savedReport);
      DB.save();
      
      // عرض التقرير المنشأ
      this.displayReport(savedReport);
      Loading.hide();
      Notification.show("تم إنشاء التقرير اليومي بنجاح", "success");

      // حفظ التقرير تلقائياً
      setTimeout(() => {
        this.saveCurrentReport(savedReport.id);
      }, 1000);
    }, 1000);
  },
  
  generateMonthly() {
    const branchId = q("#monthlyRepBranch").value;
    const month = q("#monthlyRepMonth").value;

    console.log('Starting monthly report generation...');
    console.log('Branch ID:', branchId);
    console.log('Month:', month);
    console.log('Selected types:', this.selectedTypes);

    if(!branchId){
      Notification.show("يرجى اختيار الفرع", "error");
      return;
    }

    if(!month){
      Notification.show("يرجى اختيار الشهر", "error");
      return;
    }

    if(this.selectedTypes.length === 0){
      Notification.show("يرجى اختيار نوع واحد على الأقل من التقارير", "error");
      return;
    }

    Loading.show("جاري إنشاء التقرير الشهري...");

    // تأكد من تهيئة البيانات
    ensureBranchContainers(branchId);

    setTimeout(() => {
      try {
        const reports = [];

        console.log('Processing selected types:', this.selectedTypes);

        this.selectedTypes.forEach(type => {
          console.log('Processing type:', type);
          const def = MODELS.forms[type];
          if(!def) {
            console.warn('Form definition not found for type:', type);
            return;
          }

          // التأكد من وجود البيانات
          if (!State.db.records[branchId]) {
            console.warn('No records found for branch:', branchId);
            return;
          }

          if (!State.db.records[branchId][type]) {
            console.warn('No records found for type:', type, 'in branch:', branchId);
            return;
          }

          const allRows = State.db.records[branchId][type] || [];
          console.log('All rows for', type, ':', allRows.length);

          const rows = allRows.filter(r => {
            if (!r.date) {
              console.warn('Row without date found:', r);
              return false;
            }
            const rowDate = r.date.slice(0,7);
            const matches = rowDate === month;
            console.log('Row date:', r.date, 'Month:', month, 'Matches:', matches);
            return matches;
          });

          console.log('Filtered rows for', type, ':', rows.length);

          if(rows.length > 0){
            reports.push({
              type,
              label: def.label,
              rows
            });
          }
        });

        console.log('Total reports generated:', reports.length);

        if(reports.length === 0){
          Loading.hide();
          Notification.show("لا توجد بيانات للشهر المحدد", "warning");
          return;
        }

        // حفظ التقرير في السجلات
        const branch = State.db.branches.find(b => b.id === branchId);
        const reportId = uid();
        const savedReport = {
          id: reportId,
          type: "monthly",
          branchId,
          branchName: branch?.name || "غير معروف",
          date: month,
          title: `تقرير شهري - ${month}`,
          reports: reports
        };

        // التأكد من وجود مصفوفة التقارير المحفوظة
        if (!State.db.savedReports) {
          State.db.savedReports = [];
        }

        State.db.savedReports.push(savedReport);
        DB.save();

        console.log('Report saved successfully');

        // عرض التقرير المنشأ
        this.displayReport(savedReport);
        Loading.hide();
        Notification.show("تم إنشاء التقرير الشهري بنجاح", "success");

        // حفظ التقرير تلقائياً
        setTimeout(() => {
          this.saveCurrentReport(savedReport.id);
        }, 1000);

      } catch (error) {
        console.error('Error generating monthly report:', error);
        Loading.hide();
        Notification.show("حدث خطأ أثناء إنشاء التقرير: " + error.message, "error");
      }
    }, 1000);
  },
  
  generateCustom() {
    const branchId = q("#customRepBranch").value;
    const from = q("#customRepFrom").value;
    const to = q("#customRepTo").value;
    
    if(this.selectedTypes.length === 0){
      Notification.show("يرجى اختيار نوع واحد على الأقل من التقارير", "error");
      return;
    }
    
    if(!from || !to){
      Notification.show("يرجى تحديد تاريخ البداية والنهاية", "error");
      return;
    }
    
    Loading.show("جاري إنشاء التقرير المخصص...");
    
    setTimeout(() => {
      const reports = [];
      
      this.selectedTypes.forEach(type => {
        const def = MODELS.forms[type];
        if(!def) return;
        
        const rows = (State.db.records[branchId][type] || []).filter(r => {
          const rowDate = r.date?.slice(0,10);
          return rowDate >= from && rowDate <= to;
        });
        
        if(rows.length > 0){
          reports.push({
            type,
            label: def.label,
            rows
          });
        }
      });
      
      // حفظ التقرير في السجلات
      const branch = State.db.branches.find(b => b.id === branchId);
      const reportId = uid();
      const savedReport = {
        id: reportId,
        type: "custom",
        branchId,
        branchName: branch?.name || "غير معروف",
        from,
        to,
        title: `تقرير من ${from} إلى ${to}`,
        reports: reports
      };
      
      State.db.savedReports.push(savedReport);
      DB.save();
      
      // عرض التقرير المنشأ
      this.displayReport(savedReport);
      Loading.hide();
      Notification.show("تم إنشاء التقرير المخصص بنجاح", "success");

      // حفظ التقرير تلقائياً
      setTimeout(() => {
        this.saveCurrentReport(savedReport.id);
      }, 1000);
    }, 1000);
  },
  
  generateProfitLoss() {
    const branchId = q("#plBranch").value;
    const month = q("#plMonth").value;
    
    Loading.show("جاري إنشاء تقرير الأرباح والخسائر...");
    
    setTimeout(() => {
      const branch = State.db.branches.find(b => b.id === branchId);
      const expenses = State.db.expenses[branchId] || {};
      
      // حساب الإيرادات (من كشف الإيرادات اليومية)
      const revenueRows = (State.db.records[branchId]["dailyRevenue"] || []).filter(r => {
        const rowDate = r.date?.slice(0,7);
        return rowDate === month;
      });
      
      const totalRevenue = revenueRows.reduce((sum, row) => {
        return sum + parseNum(row.network) + parseNum(row.cash) + parseNum(row.credit);
      }, 0);
      
      // حساب المصروفات (من جميع الكشوفات الأخرى + مصروفات الفرع)
      let totalExpenses = 0;
      const expenseDetails = [];
      
      // مصروفات الفرع الثابتة
      if(expenses.rent) {
        totalExpenses += parseNum(expenses.rent);
        expenseDetails.push({name: "إيجار", amount: parseNum(expenses.rent)});
      }
      if(expenses.salaries) {
        totalExpenses += parseNum(expenses.salaries);
        expenseDetails.push({name: "رواتب", amount: parseNum(expenses.salaries)});
      }
      if(expenses.admin) {
        totalExpenses += parseNum(expenses.admin);
        expenseDetails.push({name: "إدارة", amount: parseNum(expenses.admin)});
      }
      if(expenses.bank) {
        totalExpenses += parseNum(expenses.bank);
        expenseDetails.push({name: "رسوم بنكية", amount: parseNum(expenses.bank)});
      }
      if(expenses.loss) {
        totalExpenses += parseNum(expenses.loss);
        expenseDetails.push({name: "خسارة سابقة", amount: parseNum(expenses.loss)});
      }
      if(expenses.other) {
        totalExpenses += parseNum(expenses.other);
        expenseDetails.push({name: "مصروفات أخرى", amount: parseNum(expenses.other)});
      }
      
      // حساب المصروفات من الكشوفات
      const expenseTypes = [
        "cashPurch", "creditPurch", "dailyMeals", "empAdvance", 
        "supMaintenance", "marketPurch", "mgrMaintenance", "mgrPurch"
      ];
      
      expenseTypes.forEach(type => {
        const rows = (State.db.records[branchId][type] || []).filter(r => {
          const rowDate = r.date?.slice(0,7);
          return rowDate === month;
        });
        
        if(rows.length > 0){
          const total = rows.reduce((sum, row) => {
            return sum + parseNum(row.amount || row.price || row.take || 0);
          }, 0);
          
          if(total > 0){
            totalExpenses += total;
            expenseDetails.push({
              name: MODELS.forms[type].label,
              amount: total
            });
          }
        }
      });
      
      // حساب الربح/الخسارة
      const profitLoss = totalRevenue - totalExpenses;
      
      // حفظ التقرير في السجلات
      const reportId = uid();
      const savedReport = {
        id: reportId,
        type: "profit-loss",
        branchId,
        branchName: branch?.name || "غير معروف",
        date: month,
        title: `تقرير أرباح وخسائر - ${month}`,
        data: {
          totalRevenue,
          totalExpenses,
          profitLoss,
          expenseDetails
        }
      };
      
      State.db.savedReports.push(savedReport);
      DB.save();
      
      // عرض التقرير المنشأ
      this.displayReport(savedReport);
      Loading.hide();
      Notification.show("تم إنشاء تقرير الأرباح والخسائر بنجاح", "success");

      // حفظ التقرير تلقائياً
      setTimeout(() => {
        this.saveCurrentReport(savedReport.id);
      }, 1000);
    }, 1000);
  },
  
  displayReport(report) {
    try {
      let html = `<div class="card">`;

      // ترويسة التقرير
      html += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div>
            <div class="title">${report.title || 'تقرير محاسبي'}</div>
            <div class="subtitle">${report.branchName || 'فرع غير محدد'}</div>
          </div>
          <div class="muted">${report.date || (report.from && report.to ? `${report.from} إلى ${report.to}` : '')}</div>
        </div>
      `;

      if(report.type === "profit-loss"){
        // عرض تقرير الأرباح والخسائر
        html += this.renderProfitLossReport(report);
      } else {
        // عرض التقارير العادية
        html += this.renderNormalReport(report);
      }

      html += `</div>`;

      q("#reportDisplayArea").innerHTML = html;
      Router.go('report-display');

      console.log('Report displayed successfully');
    } catch (error) {
      console.error('Error displaying report:', error);
      Loading.hide();
      Notification.show("حدث خطأ في عرض التقرير: " + error.message, "error");
    }
  },
  
  renderNormalReport(report) {
    try {
      let html = "";

      if (!report.reports || report.reports.length === 0) {
        return "<div class='muted' style='text-align:center;padding:32px'>لا توجد بيانات في التقرير</div>";
      }

      report.reports.forEach((rpt, idx) => {
        if(idx > 0) html += `<div class="report-separator"></div>`;

        html += `<div class="report-section">`;
        html += `<h3 style="margin-bottom:12px">${rpt.label || 'تقرير'}</h3>`;

        const def = MODELS.forms[rpt.type];
        if(!def) {
          html += `<div class="muted">نوع التقرير غير مدعوم</div>`;
          html += `</div>`;
          return;
        }

        if (!rpt.rows || rpt.rows.length === 0) {
          html += `<div class="muted">لا توجد بيانات لهذا النوع من التقارير</div>`;
          html += `</div>`;
          return;
        }

        // رأس الجدول
        const heads = def.fields.map(f=>`<th style='border:1px solid #22c55e;background:#0e162d;color:#22c55e'>${f.label}</th>`).join("");

        // صفوف الجدول
        const trs = rpt.rows.map((r,idx)=>{
          const tds = def.fields.map(f=>{
            let v = r[f.k] ?? "";
            if(["number"].includes(f.type) || ["amount","price","take","salary","prev","totalTaken","remain","mada","visa","master","other1","other2","cars","credit","cash","network","qty"].includes(f.k)){
              v = fmt(v);
            }
            return `<td style='border:1px solid #22c55e;background:${idx%2==0?"#192a3a":"#0e162d"};color:#22c55e'>${v??""}</td>`;
          }).join("");
          return `<tr>${tds}</tr>`;
        }).join("");

        // صف الإجمالي
        let totalRow = "";
        if(def.fields.some(f=>f.type==="number")){
          totalRow = `<tr style='background:#22c55e;color:#0e162d;font-weight:bold'>`;
          let found = false;
          def.fields.forEach(f=>{
            if(f.type==="number" && !found){
              const sum = rpt.rows.reduce((s,r)=>s+parseNum(r[f.k]),0);
              totalRow += `<td style='border:2px solid #0e162d'>الإجمالي: ${fmt(sum)}</td>`;
              found = true;
            }else if(f.type==="number"){
              const sum = rpt.rows.reduce((s,r)=>s+parseNum(r[f.k]),0);
              totalRow += `<td style='border:2px solid #0e162d'>${fmt(sum)}</td>`;
            }else{
              totalRow += `<td style='border:2px solid #0e162d'></td>`;
            }
          });
          totalRow += `</tr>`;
        }

        html += `
          <div style="overflow:auto;margin-bottom:16px">
            <table class='report-table' style='border:2px solid #22c55e;border-radius:8px;background:#192a3a;width:100%'>
              <thead><tr>${heads}</tr></thead>
              <tbody>${trs||"<tr><td colspan='99'>لا توجد بيانات</td></tr>"}${totalRow}</tbody>
            </table>
          </div>
        `;

        // أزرار الطباعة والحفظ
        html += `
          <div class="report-footer">
            <div class="report-actions">
              <button class="btn" onclick="Reports.printReport()">طباعة / حفظ PDF</button>
              <button class="btn ghost" onclick="Reports.saveCurrentReport('${report.id}')">حفظ التقرير</button>
            </div>
          </div>
        `;

        html += `</div>`;
      });

      // تذييل الصفحة
      const now = new Date();
      html += `
        <div style="margin-top:32px;text-align:center;color:#888;font-size:14px">
          برنامج الجبرني المحاسبي - لإدارة مغاسل السيارات
          <span style="float:right">${now.toLocaleDateString()} ${now.toLocaleTimeString()}</span>
        </div>
      `;

      return html;
    } catch (error) {
      console.error('Error rendering normal report:', error);
      return `<div class="muted" style="text-align:center;padding:32px;color:#ef4444">حدث خطأ في عرض التقرير: ${error.message}</div>`;
    }
  },
  
  renderProfitLossReport(report) {
    let html = "";
    const data = report.data;

    // تقرير الأرباح والخسائر بتنسيق أكثر ترتيباً وكفاءة
    html += `
      <div class="card" style="background:#192a3a;margin-bottom:16px">
        <div style="text-align:center;margin-bottom:30px">
          <h2 style="color:#fff;font-size:24px;margin-bottom:10px">تقرير الأرباح والخسائر</h2>
          <h4 style="color:#fff;text-align:center;margin-bottom:20px">${report.title}</h4>
        </div>

        <!-- ملخص الأرباح والخسائر في صف واحد -->
        <div style="display:flex;gap:20px;margin-bottom:20px;justify-content:center">
          <div style="flex:1;text-align:center">
            <div style="background:#0e162d;padding:15px;border-radius:8px;border:2px solid #10b981">
              <div style="color:#10b981;font-size:14px;margin-bottom:5px">إجمالي الإيرادات</div>
              <div style="color:#10b981;font-size:18px;font-weight:bold">${fmt(data.totalRevenue)} ر.س</div>
            </div>
          </div>
          <div style="flex:1;text-align:center">
            <div style="background:#0e162d;padding:15px;border-radius:8px;border:2px solid #ef4444">
              <div style="color:#ef4444;font-size:14px;margin-bottom:5px">إجمالي المصروفات</div>
              <div style="color:#ef4444;font-size:18px;font-weight:bold">${fmt(data.totalExpenses)} ر.س</div>
            </div>
          </div>
          <div style="flex:1;text-align:center">
            <div style="background:#0e162d;padding:15px;border-radius:8px;border:2px solid ${data.profitLoss >= 0 ? '#10b981' : '#ef4444'}">
              <div style="color:${data.profitLoss >= 0 ? '#10b981' : '#ef4444'};font-size:14px;margin-bottom:5px">${data.profitLoss >= 0 ? 'صافي الربح' : 'صافي الخسارة'}</div>
              <div style="color:${data.profitLoss >= 0 ? '#10b981' : '#ef4444'};font-size:18px;font-weight:bold">${fmt(Math.abs(data.profitLoss))} ر.س</div>
            </div>
          </div>
        </div>
      </div>
    `;

    // تفاصيل المصروفات في جدول واحد مرتب
    html += `
      <div class="card" style="background:#192a3a;margin-bottom:16px">
        <h3 style="color:#22c55e;text-align:center;margin-bottom:15px">تفاصيل المصروفات</h3>

        <table class="profit-loss-table" style="width:100%;margin:0">
          <thead>
            <tr>
              <th style="border:1px solid #22c55e;text-align:center;padding:10px">نوع المصروف</th>
              <th style="border:1px solid #22c55e;text-align:center;padding:10px">المبلغ</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.expenseDetails.forEach(exp => {
      html += `
        <tr>
          <td style="border:1px solid #22c55e;text-align:right;padding:8px">${exp.name}</td>
          <td style="border:1px solid #22c55e;text-align:center;padding:8px">${fmt(exp.amount)} ر.س</td>
        </tr>
      `;
    });

    html += `
            <tr class="profit-loss-total">
              <td style="border:1px solid #22c55e;text-align:right;padding:10px;font-weight:bold">الإجمالي</td>
              <td style="border:1px solid #22c55e;text-align:center;padding:10px;font-weight:bold">${fmt(data.totalExpenses)} ر.س</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;

    // أزرار الطباعة والحفظ
    html += `
      <div class="report-footer">
        <div class="report-actions">
          <button class="btn" onclick="Reports.printReport()">طباعة / حفظ PDF</button>
          <button class="btn ghost" onclick="Reports.saveCurrentReport('${report.id}')">حفظ التقرير</button>
        </div>
      </div>
    `;

    return html;
  },
  
  saveCurrentReport(reportId) {
    // الحصول على محتوى التقرير الحالي من الصفحة
    const reportContent = q('#reportDisplayArea');
    if (!reportContent) {
      Notifications.add("خطأ", "لا يوجد تقرير للحفظ", "error");
      return;
    }

    // استخراج معلومات التقرير من العنوان
    const titleElement = reportContent.querySelector('.title');
    const subtitleElement = reportContent.querySelector('.subtitle');

    if (!titleElement) {
      Notifications.add("خطأ", "لا يمكن تحديد عنوان التقرير", "error");
      return;
    }

    const title = titleElement.textContent.trim();
    const branchName = subtitleElement ? subtitleElement.textContent.trim() : '';

    // تحديد نوع التقرير من العنوان
    let reportType = 'custom';
    if (title.includes('يومي')) {
      reportType = 'daily';
    } else if (title.includes('شهري')) {
      reportType = 'monthly';
    } else if (title.includes('أرباح') || title.includes('خسائر')) {
      reportType = 'profit-loss';
    }

    // استخراج التاريخ من التقرير
    let date = new Date().toISOString().slice(0, 10);
    const dateMatch = title.match(/(\d{4}-\d{2}-\d{2})/);
    if (dateMatch) {
      date = dateMatch[1];
    }

    // إنشاء كائن التقرير المحفوظ
    const savedReport = {
      id: uid(),
      type: reportType,
      branchId: State.currentBranch || '',
      branchName: branchName,
      date: date,
      title: title,
      content: reportContent.innerHTML,
      createdAt: new Date().toISOString(),
      createdBy: State.user ? State.user.name : 'System'
    };

    // حفظ التقرير في قاعدة البيانات
    if (!State.db.savedReports) {
      State.db.savedReports = [];
    }

    // التحقق من عدم وجود تقرير مكرر بنفس العنوان والتاريخ
    const existingReport = State.db.savedReports.find(r =>
      r.title === savedReport.title &&
      r.date === savedReport.date &&
      r.branchId === savedReport.branchId
    );

    if (existingReport) {
      Notifications.add("تنبيه", "التقرير موجود مسبقاً", "warning");
      return;
    }

    State.db.savedReports.push(savedReport);
    DB.save();

    // إضافة إشعار نجاح
    Notifications.add("حفظ التقرير", `تم حفظ التقرير "${title}" بنجاح`, "success");

    // تحديث عرض التقارير المحفوظة إذا كان المستخدم في صفحة التقارير الجاهزة
    if (q('#view-saved-reports') && !q('#view-saved-reports').classList.contains('hidden')) {
      this.showSavedReports();
    }

    // تسجيل النشاط
    Security.logActivity('report_saved', {
      reportId: savedReport.id,
      reportType: reportType,
      title: title
    });
  },

  // دالة لطباعة التقارير العادية بتصميم محسن
  printReport() {
    const reportContent = q('#reportDisplayArea');
    if (!reportContent) {
      Notifications.add("خطأ", "لا يوجد تقرير للطباعة", "error");
      return;
    }

    const printWindow = window.open('', '_blank');

    // الحصول على معلومات الشركة
    const company = State.db.company || {};
    const now = new Date();
    const printDate = now.toLocaleDateString('ar-SA');
    const printTime = now.toLocaleTimeString('ar-SA');

    // تنسيقات محسنة للطباعة مع إصلاح الألوان والخلفيات
    const printStyles = `
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        * {
          box-sizing: border-box;
          font-family: 'Tajawal', system-ui, Segoe UI, Arial, sans-serif;
          margin: 0;
          padding: 0;
        }

        body {
          background: white !important;
          color: black !important;
          padding: 20px;
          direction: rtl;
          font-size: 14px;
          line-height: 1.6;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        /* رأس التقرير المهيب المدمج */
        .report-professional-header {
          text-align: center !important;
          margin-bottom: 40px !important;
          padding: 30px 20px !important;
          border-bottom: 3px solid #22c55e !important;
          background: linear-gradient(135deg, #f8fafc, #e2e8f0) !important;
          border-radius: 10px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .report-professional-header .main-title {
          font-size: 36px !important;
          font-weight: bold !important;
          color: #1f2937 !important;
          margin-bottom: 8px !important;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.1) !important;
        }

        .report-professional-header .print-date {
          font-size: 16px !important;
          color: #6b7280 !important;
          margin-bottom: 12px !important;
          font-weight: 500 !important;
        }

        .report-professional-header .company-info {
          font-size: 14px !important;
          color: #374151 !important;
          margin-bottom: 8px !important;
          font-weight: 500 !important;
        }

        .report-professional-header .report-info {
          font-size: 18px !important;
          color: #22c55e !important;
          margin-bottom: 5px !important;
          font-weight: 600 !important;
        }

        .report-content {
          margin-top: 20px !important;
        }

        .report-content .title,
        .report-content .subtitle {
          display: none !important;
        }

        .card {
          background: white !important;
          border: 2px solid #1f2937 !important;
          border-radius: 12px !important;
          padding: 20px !important;
          margin: 20px 0 !important;
          box-shadow: none !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .title {
          font-size: 24px !important;
          font-weight: bold !important;
          color: #1f2937 !important;
          margin-bottom: 10px !important;
          text-align: center !important;
        }

        .subtitle {
          font-size: 16px !important;
          color: #6b7280 !important;
          margin-bottom: 20px !important;
          text-align: center !important;
        }

        table {
          width: 100% !important;
          border-collapse: collapse !important;
          margin: 20px 0 !important;
          background: white !important;
          border: 2px solid #1f2937 !important;
          border-radius: 8px !important;
          overflow: hidden !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        th, td {
          border: 1px solid #d1d5db !important;
          padding: 10px 8px !important;
          text-align: right !important;
          background: white !important;
          color: black !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        th {
          background: #f3f4f6 !important;
          color: #1f2937 !important;
          font-weight: bold !important;
          font-size: 13px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        tr:nth-child(even) {
          background: #f9fafb !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        tr:nth-child(odd) {
          background: white !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .report-header {
          text-align: center !important;
          margin-bottom: 30px !important;
          padding: 20px !important;
          border-bottom: 2px solid #22c55e !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .report-separator {
          height: 2px !important;
          background: linear-gradient(90deg, transparent, #22c55e, transparent) !important;
          margin: 30px 0 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .report-section h3 {
          color: #22c55e !important;
          font-size: 20px !important;
          margin-bottom: 15px !important;
          text-align: center !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .financial-summary {
          display: grid !important;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
          gap: 16px !important;
          margin: 20px 0 !important;
        }

        .financial-summary .card {
          background: white !important;
          border: 2px solid #22c55e !important;
          padding: 20px !important;
          text-align: center !important;
          border-radius: 12px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .financial-summary .card h4 {
          color: #22c55e !important;
          font-size: 16px !important;
          margin-bottom: 8px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .stat-value {
          font-size: 20px !important;
          font-weight: bold !important;
          color: #22c55e !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .profit-loss-table {
          width: 100% !important;
          border-collapse: collapse !important;
          margin: 20px 0 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .profit-loss-table th {
          background: #f3f4f6 !important;
          padding: 12px !important;
          text-align: center !important;
          border: 1px solid #d1d5db !important;
          color: #1f2937 !important;
          font-weight: bold !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .profit-loss-table td {
          padding: 10px !important;
          border: 1px solid #d1d5db !important;
          text-align: center !important;
          background: white !important;
          color: black !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .profit-loss-total {
          font-weight: bold !important;
          background: rgba(16, 185, 129, 0.1) !important;
          color: #059669 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .muted {
          color: #6b7280 !important;
        }

        /* إخفاء أزرار الطباعة والحفظ في التقرير المطبوع */
        .no-print, .report-footer, .btn {
          display: none !important;
        }

        /* إصلاح مشاكل الألوان في الطباعة */
        @media print {
          body {
            background: white !important;
            color: black !important;
            font-size: 12px !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }

          .card {
            break-inside: avoid !important;
            page-break-inside: avoid !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }

          table {
            page-break-inside: avoid !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }

          th, td {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }

          .financial-summary .card {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
        }
      </style>
    `;

    // استخراج معلومات التقرير من المحتوى الحالي مع معالجة أفضل للأخطاء
    let reportTitle = 'تقرير محاسبي';
    let reportSubtitle = '';

    try {
      // البحث عن العنوان في أماكن مختلفة
      const titleElement = reportContent.querySelector('.title') ||
                          reportContent.querySelector('h1') ||
                          reportContent.querySelector('h2') ||
                          reportContent.querySelector('h3');

      if (titleElement) {
        reportTitle = titleElement.textContent.trim();
      }

      // البحث عن الوصف الفرعي
      const subtitleElement = reportContent.querySelector('.subtitle') ||
                             reportContent.querySelector('.muted') ||
                             reportContent.querySelector('p');

      if (subtitleElement) {
        reportSubtitle = subtitleElement.textContent.trim();
      }

      // إذا لم نجد عنوان، نبحث في النص العام
      if (reportTitle === 'تقرير محاسبي') {
        const textContent = reportContent.textContent || '';
        const lines = textContent.split('\n').filter(line => line.trim().length > 0);
        if (lines.length > 0) {
          reportTitle = lines[0].trim();
        }
      }

    } catch (error) {
      console.warn('Error extracting report info:', error);
      // استخدام القيم الافتراضية في حالة الخطأ
    }

    // إنشاء محتوى التقرير مع الرأس المدمج المهيب
    const reportHTML = `
      <div class="report-professional-header">
        <div class="main-title">تقرير محاسبي</div>
        <div class="print-date">تاريخ الطباعة: ${printDate} - ${printTime}</div>
        <div class="company-info">${company.name || 'اسم الشركة'}</div>
        <div class="company-info">هاتف: ${company.phone || '-'} · س.ت: ${company.cr || '-'} · العنوان: ${company.addr || '-'}</div>
        <div class="report-info">${reportTitle}</div>
        ${reportSubtitle ? `<div class="report-info">${reportSubtitle}</div>` : ''}
      </div>

      <div class="report-content">
        ${reportContent.innerHTML}
      </div>
    `;

    printWindow.document.write(`
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="utf-8">
        <title>تقرير محاسبي</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        ${printStyles}
      </head>
      <body>
        ${reportHTML}
      </body>
      </html>
    `);

    printWindow.document.close();

    // انتظار تحميل المحتوى قبل الطباعة
    printWindow.onload = function() {
      setTimeout(() => {
        printWindow.print();
      }, 500);
    };
  },
  
  showSavedReports(type = 'all') {
    // تحديث التبويبات النشطة
    qa("#view-saved-reports .tab").forEach(tab => tab.classList.remove("active"));

    // العثور على التبويب المناسب وتفعيله
    const tabs = qa("#view-saved-reports .tab");
    const tabText = {
      'all': 'الكل',
      'daily': 'يومية',
      'monthly': 'شهرية',
      'custom': 'عشوائية',
      'profit-loss': 'أرباح/خسائر'
    };

    // البحث عن التبويب المناسب بناءً على النص
    for (let tab of tabs) {
      if (tab.textContent.trim() === tabText[type]) {
        tab.classList.add("active");
        break;
      }
    }

    // تصفية التقارير حسب النوع
    let reports = State.db.savedReports || [];
    if(type !== 'all'){
      reports = reports.filter(r => r.type === (type === 'profit-loss' ? 'profit-loss' : type));
    }

    // ترتيب التقارير من الأحدث إلى الأقدم
    reports.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));

    // عرض التقارير
    let html = "";

    if(reports.length === 0){
      html = `<div class="muted" style="text-align:center;padding:32px">لا توجد تقارير محفوظة من هذا النوع</div>`;
    } else {
      // عرض التقارير مباشرة بدون تجميع حسب التاريخ لتسهيل الوصول
      reports.forEach(report => {
        const typeLabel = report.type === 'daily' ? 'يومي' :
                          report.type === 'monthly' ? 'شهري' :
                          report.type === 'custom' ? 'عشوائي' :
                          report.type === 'profit-loss' ? 'أرباح/خسائر' : report.type;

        const dateStr = report.date || (report.createdAt ? report.createdAt.slice(0, 10) : '');
        const timeStr = report.createdAt ?
          new Date(report.createdAt).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) :
          '';

        const dateLabel = dateStr ? new Date(dateStr).toLocaleDateString('ar-SA') : 'غير محدد';

        html += `
          <div class="card saved-report-item" onclick="Reports.viewSavedReport('${report.id}')" style="margin-bottom:10px;cursor:pointer;border-left:4px solid #22c55e;background:linear-gradient(135deg, rgba(34,197,94,0.05), rgba(34,197,94,0.02));transition:transform 0.2s">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
              <div style="flex:1">
                <h4 style="margin:0 0 8px 0;color:#22c55e;font-size:16px">${report.title}</h4>
                <div style="color:#666;font-size:13px">
                  <div>📅 ${dateLabel} ${timeStr ? ` · 🕐 ${timeStr}` : ''}</div>
                  <div>🏢 ${report.branchName || 'فرع غير محدد'} · 📊 نوع: ${typeLabel}</div>
                  <div>👤 أنشأه: ${report.createdBy || 'النظام'}</div>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:5px">
                <div style="color:#22c55e;font-size:20px">📄</div>
                <button class="btn danger" style="font-size:11px;padding:4px 8px" onclick="event.stopPropagation(); Reports.deleteSavedReport('${report.id}')">حذف</button>
              </div>
            </div>
          </div>
        `;
      });
    }

    q("#savedReportsList").innerHTML = html;
  },
  
  viewSavedReport(reportId) {
    const report = State.db.savedReports.find(r => r.id === reportId);
    if(!report){
      Notifications.add("خطأ", "التقرير غير موجود", "error");
      return;
    }

    // إذا كان التقرير يحتوي على content محفوظ، استخدمه مباشرة
    if(report.content){
      q("#reportDisplayArea").innerHTML = report.content;
      Router.go('report-display');
      return;
    }

    // إلا فاستخدم displayReport العادية
    this.displayReport(report);
  },
  
  showSavedType(type) {
    this.showSavedReports(type);
  },

  // دالة لحذف تقرير محفوظ
  deleteSavedReport(reportId) {
    if (!confirm('هل أنت متأكد من حذف هذا التقرير؟')) return;

    const reports = State.db.savedReports || [];
    const index = reports.findIndex(r => r.id === reportId);

    if (index !== -1) {
      const deletedReport = reports.splice(index, 1)[0];
      DB.save();

      Notifications.add("حذف التقرير", `تم حذف التقرير "${deletedReport.title}" بنجاح`, "success");

      // تحديث العرض
      this.showSavedReports();

      // تسجيل النشاط
      Security.logActivity('report_deleted', {
        reportId: reportId,
        reportTitle: deletedReport.title
      });
    }
  }
};

/* ========= Movement (Daily Movements & Branch rankings) ========= */
const Movement = {
  populate() {
    const bSel = q("#mvBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");

    const tSel = q("#mvType");
    const tSel2 = q("#mvAggType");
    if (!tSel || !tSel2) return;

    tSel.innerHTML = MODELS.reportTypes.map(t=>`<option value="${t.k}">${t.label}</option>`).join("");
    tSel2.innerHTML = tSel.innerHTML;

    q("#mvFrom").value = todayStr();
    q("#mvTo").value = todayStr();
    q("#mvAggFrom").value = firstOfMonthStr();
    q("#mvAggTo").value = todayStr();
    this.clear();
    this.clearAgg();
  },

  clear(){
    const area = q("#movementArea");
    if (area) area.innerHTML="";
  },

  clearAgg(){
    const area = q("#movementAggArea");
    if (area) area.innerHTML="";
  },

  generate() {
    const bid = q("#mvBranch").value;
    const type = q("#mvType").value;
    const from = q("#mvFrom").value || "0000-01-01";
    const to = q("#mvTo").value || "9999-12-31";
    ensureBranchContainers(bid);

    // نجمع يوميًا حسب التاريخ
    const rows = (State.db.records[bid][type]||[]).filter(r=>{
      const d = (r.date||"").slice(0,10);
      return (!from || d>=from) && (!to || d<=to);
    });

    const grouped = this.groupByDate(type, rows);
    const tableHtml = this.tableForMovement(type, grouped);

    const co = State.db.company||{};
    const branch = State.db.branches.find(b=>b.id===bid);
    const header = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px">
        <div>
          <div style="font-weight:700"> ${co.name||"اسم الشركة"} </div>
          <div class="muted">هاتف: ${co.phone||"-"} · س.ت: ${co.cr||"-"} · العنوان: ${co.addr||"-"}</div>
        </div>
        <div style="text-align:left">
          <div style="font-weight:700">حركة الفروع - ${MODELS.reportTypes.find(t=>t.k===type).label}</div>
          <div class="muted">الفرع: ${branch.name} · المدة: ${from} إلى ${to}</div>
        </div>
      </div>
    `;

    q("#movementArea").innerHTML = `<div class="card report-paper">${header}${tableHtml}</div>`;
  },

  // جدول خاص بالحركة اليومية (تجميع يومي)
  tableForMovement(type, days) {
    // تعريف أعمدة العرض لكل حركة
    const colsMap = {
      dailyRevenue: ["date","network","cash","credit","cars","total"],
      bankRecon: ["date","mada","visa","master","other1","other2","total"],
      cashPurch: ["date","item","price"],
      creditPurch: ["date","item","price","supplier"],
      dailyMeals: ["date","who","amount"],
      empAdvance: ["date","emp","take","totalTaken","remain"],
      supMaintenance: ["date","maint","kind","amount","by"],
      marketPurch: ["date","item","qty","amount","buyer"],
      mgrMaintenance: ["date","type","desc","amount","party"],
      mgrPurch: ["date","item","qty","amount"]
    };
    const labels = {
      date:"التاريخ",
      network:"إيراد شبكة",
      cash:"إيراد كاش",
      credit:"إيراد آجل",
      cars:"عدد السيارات",
      total:"الإجمالي",
      mada:"مدى", visa:"فيزا", master:"ماستر كارد", other1:"أخرى 1", other2:"أخرى 2",
      item:"الصنف", price:"السعر", supplier:"المورد",
      who:"المتغذي", amount:"المبلغ",
      emp:"الموظف", take:"سحبية", totalTaken:"الإجمالي المسحوب", remain:"المتبقي",
      maint:"الصيانة", kind:"نوعها", by:"منفذ الصيانة",
      qty:"الكمية", buyer:"المشتري",
      type:"النوع", desc:"الوصف", party:"الجهة"
    };
    const cols = colsMap[type] || ["date"];
    // رأس الجدول
    const thead = `<thead><tr>${cols.map(c=>`<th>${labels[c]||c}</th>`).join("")}</tr></thead>`;
    // جسم الجدول
    const tbody = days.map(d=>{
      const tds = cols.map(c=>{
        let v = d[c];
        if(typeof v==="number") v = fmt(v);
        return `<td>${v==null?"":v}</td>`;
      }).join("");
      return `<tr>${tds}</tr>`;
    }).join("");
    return `<div style="overflow:auto"><table>${thead}<tbody>${tbody || "<tr><td colspan='99'>لا توجد بيانات</td></tr>"}</tbody></table></div>`;
  },

  // تجميع حسب التاريخ مع حساب الإجماليات المناسبة لكل حركة
  groupByDate(type, rows) {
    const map = {};
    rows.forEach(r=>{
      const d = (r.date||"").slice(0,10);
      if(!map[d]) map[d] = {date:d};
      const m = map[d];
      switch(type){
        case "dailyRevenue":
          m.network = (m.network||0)+parseNum(r.network);
          m.cash = (m.cash||0)+parseNum(r.cash);
          m.credit = (m.credit||0)+parseNum(r.credit);
          m.cars = (m.cars||0)+parseNum(r.cars);
          m.total = (m.network||0)+(m.cash||0)+(m.credit||0);
          break;
        case "bankRecon":
          m.mada = (m.mada||0)+parseNum(r.mada);
          m.visa = (m.visa||0)+parseNum(r.visa);
          m.master = (m.master||0)+parseNum(r.master);
          m.other1 = (m.other1||0)+parseNum(r.other1);
          m.other2 = (m.other2||0)+parseNum(r.other2);
          m.total = (m.mada||0)+(m.visa||0)+(m.master||0)+(m.other1||0)+(m.other2||0);
          break;
        case "cashPurch":
          // نعرض كل سجل (تفصيلي) لكن مطلوب ترتيب يومي؛ سنجمع السعر ونترك وصف آخر سجل لذلك اليوم
          m.price = (m.price||0)+parseNum(r.price);
          m.item = (m.item? m.item+"، ":"") + (r.item||"");
          break;
        case "creditPurch":
          m.price = (m.price||0)+parseNum(r.price);
          m.item = (m.item? m.item+"، ":"") + (r.item||"");
          m.supplier = (m.supplier? m.supplier+"، ":"") + (r.supplier||"");
          break;
        case "dailyMeals":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.who = (m.who? m.who+"، ":"") + (r.who||"");
          break;
        case "empAdvance":
          m.take = (m.take||0)+parseNum(r.take);
          // عرض آخر إجماليات لليوم لأغراض المعلومات
          m.totalTaken = (m.totalTaken||0)+parseNum(r.totalTaken||0);
          m.remain = (m.remain||0)+parseNum(r.remain||0);
          m.emp = (m.emp? m.emp+"، ":"") + (r.emp||"");
          break;
        case "supMaintenance":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.maint = (m.maint? m.maint+"، ":"") + (r.maint||"");
          m.kind = (m.kind? m.kind+"، ":"") + (r.kind||"");
          m.by = (m.by? m.by+"، ":"") + (r.by||"");
          break;
        case "marketPurch":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.qty = (m.qty||0)+parseNum(r.qty);
          m.item = (m.item? m.item+"، ":"") + (r.item||"");
          m.buyer = (m.buyer? m.buyer+"، ":"") + (r.buyer||"");
          break;
        case "mgrMaintenance":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.type = (m.type? m.type+"، ":"") + (r.type||"");
          m.desc = (m.desc? m.desc+"، ":"") + (r.desc||"");
          m.party = (m.party? m.party+"، ":"") + (r.party||"");
          break;
        case "mgrPurch":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.qty = (m.qty||0)+parseNum(r.qty);
          m.item = (m.item? m.item+"، ":"") + (r.item||"");
          break;
      }
    });
    return Object.values(map).sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  },

  // تجميع لكل الفروع لمعرفة الأكثر/الأقل
  calcAgg(type, from, to) {
    const res = [];
    State.db.branches.forEach(b=>{
      ensureBranchContainers(b.id);
      const rows = (State.db.records[b.id][type]||[]).filter(r=>{
        const d = (r.date||"").slice(0,10);
        return (!from || d>=from) && (!to || d<=to);
      });
      const sum = this.aggregateValue(type, rows);
      res.push({branch:b, value:sum});
    });
    return res;
  },
  
  aggregateValue(type, rows) {
    switch(type){
      case "dailyRevenue":
        return rows.reduce((s,r)=> s + parseNum(r.network) + parseNum(r.cash) + parseNum(r.credit), 0);
      case "bankRecon":
        return rows.reduce((s,r)=> s + parseNum(r.mada)+parseNum(r.visa)+parseNum(r.master)+parseNum(r.other1)+parseNum(r.other2), 0);
      case "cashPurch":
        return rows.reduce((s,r)=> s + parseNum(r.price), 0);
      case "creditPurch":
        return rows.reduce((s,r)=> s + parseNum(r.price), 0);
      case "dailyMeals":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      case "empAdvance":
        return rows.reduce((s,r)=> s + parseNum(r.take), 0);
      case "supMaintenance":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      case "marketPurch":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      case "mgrMaintenance":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      case "mgrPurch":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      default: return 0;
    }
  },
  
  calcTop() {
    const type = q("#mvAggType").value;
    const from = q("#mvAggFrom").value || "0000-01-01";
    const to = q("#mvAggTo").value || "9999-12-31";
    const data = this.calcAgg(type, from, to).sort((a,b)=>b.value-a.value);
    const top = data[0], bottom = data[data.length-1];
    this.renderAggResult(type, from, to, top, bottom);
  },
  
  calcBottom() {
    const type = q("#mvAggType").value;
    const from = q("#mvAggFrom").value || "0000-01-01";
    const to = q("#mvAggTo").value || "9999-12-31";
    const data = this.calcAgg(type, from, to).sort((a,b)=>a.value-b.value);
    const bottom = data[0], top = data[data.length-1];
    this.renderAggResult(type, from, to, top, bottom);
  },
  
  renderAggResult(type, from, to, top, bottom) {
    const label = MODELS.reportTypes.find(t=>t.k===type).label;
    const co = State.db.company||{};
    const head = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px">
        <div>
          <div style="font-weight:700">${co.name||"اسم الشركة"}</div>
          <div class="muted">إحصائية الفروع · المدة: ${from} إلى ${to}</div>
        </div>
        <div class="muted">الحركة: ${label}</div>
      </div>
    `;
    const body = `
      <div class="grid cards">
        <div class="card">
          <h3>الفرع الأكثر</h3>
          <div class="title" style="font-size:18px">${top?.branch?.name||"-"}</div>
          <div class="muted">الإجمالي: ${fmt(top?.value||0)}</div>
        </div>
        <div class="card">
          <h3>الفرع الأقل</h3>
          <div class="title" style="font-size:18px">${bottom?.branch?.name||"-"}</div>
          <div class="muted">الإجمالي: ${fmt(bottom?.value||0)}</div>
        </div>
      </div>
    `;
    q("#movementAggArea").innerHTML = `<div class="card report-paper">${head}${body}</div>`;
  }
};



/* ========= Settings ========= */
const Settings = {
  addUser() {
    const name = Security.sanitizeInput(q("#setUserName").value.trim());
    const pass = q("#setUserPass").value.trim();
    const role = q("#setUserRole").value;
    const branchId = q("#setUserBranch")?.value;

    if(!name || !pass){
      Notification.show("أدخل اسم المستخدم وكلمة المرور", "error");
      Security.logActivity('user_creation_failed', { reason: 'missing_credentials' });
      return;
    }

    if(!Security.validateInput(name) || !Security.validateInput(pass)){
      Notification.show("بيانات غير صالحة", "error");
      Security.logActivity('user_creation_failed', { reason: 'invalid_input' });
      return;
    }

    if (role === 'branch-manager' && !branchId) {
      Notification.show("يرجى اختيار الفرع لمدير الفرع", "error");
      return;
    }

    // التحقق من عدم وجود مستخدم بنفس الاسم
    const existingUser = State.db.users.find(u => u.name === name);
    if (existingUser) {
      Notification.show("يوجد مستخدم بنفس الاسم مسبقاً", "error");
      return;
    }

    // إنشاء صلاحيات افتراضية حسب النوع
    const defaultPerms = this.getDefaultPermissions(role);

    const newUser = {
      id: uid(),
      name,
      pass: pass, // تخزين كلمة المرور بدون تشفير
      role,
      perms: defaultPerms,
      branchId: role === 'branch-manager' ? branchId : null
    };

    State.db.users.push(newUser);
    DB.save();

    Security.logActivity('user_created', { newUserId: newUser.id, newUserName: newUser.name, role: newUser.role });

    q("#setUserName").value = "";
    q("#setUserPass").value = "";
    q("#setUserRole").value = "admin";
    if (q("#setUserBranch")) q("#setUserBranch").value = "";
    q("#settingsBranchDiv").style.display = "none";

    this.render();
    Notification.show("تمت إضافة المستخدم بنجاح", "success");

    // إرسال إشعار بريد إلكتروني للمدراء
    Notifications.notifyNewUser(newUser.name, newUser.role);
  },

  getDefaultPermissions(role) {
    const perms = {};

    switch(role) {
      case 'admin':
        PERMISSIONS.forEach(perm => {
          perms[perm.k] = true;
        });
        break;
      case 'manager':
        perms.branches = true;
        perms.reports = true;
        perms.editData = true;
        perms.dashboard = true;
        perms.movement = true;
        break;
      case 'branch-manager':
        perms.editData = true;
        perms.reports = true;
        break;
      case 'accountant':
        perms.reports = true;
        perms.financial = true;
        perms.accounts = true;
        perms.dashboard = true;
        break;
      case 'employee':
        perms.editData = true;
        break;
      case 'viewer':
        perms.reports = true;
        break;
    }

    return perms;
  },

  toggleBranchSelection() {
    const roleSelect = q('#setUserRole');
    const branchDiv = q('#settingsBranchDiv');

    if (roleSelect && branchDiv) {
      if (roleSelect.value === 'branch-manager') {
        branchDiv.style.display = 'block';
        this.populateBranchSelector();
      } else {
        branchDiv.style.display = 'none';
      }
    }
  },

  populateBranchSelector() {
    const branchSelect = q('#setUserBranch');
    if (!branchSelect) return;

    let html = '<option value="">اختر الفرع</option>';
    State.db.branches.forEach(branch => {
      html += `<option value="${branch.id}">${branch.name}</option>`;
    });
    branchSelect.innerHTML = html;
  },

  handleEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'addUserBtn') {
        // إذا كان الحقل التالي هو زر الإضافة، قم بتنفيذ الإضافة
        this.addUser();
      } else {
        // انتقل للحقل التالي
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          // إذا كان الحقل التالي مخفي (مثل حقل الفرع)، تخطاه
          if (nextFieldId === 'setUserBranch' && q('#settingsBranchDiv').style.display === 'none') {
            // انتقل مباشرة لزر الإضافة
            this.addUser();
          } else {
            nextField.focus();
          }
        }
      }
    }
  },

  handleCompanyEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'saveCompany') {
        // إذا كان الحقل التالي هو زر الحفظ، قم بحفظ البيانات
        Company.save();
      } else {
        // انتقل للحقل التالي
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },
  
  render() {
    // عرض قائمة المستخدمين
    const usersList = q("#settingsUsersList");
    if (usersList) {
      usersList.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>المستخدم</th>
              <th>الدور</th>
              <th>الفرع</th>
              <th class="no-print">إجراء</th>
            </tr>
          </thead>
          <tbody>
            ${State.db.users.map(u=>{
              const roleLabel = this.getRoleLabel(u.role);
              let branchName = '-';
              if (u.role === 'branch-manager' && u.branchId) {
                const branch = State.db.branches.find(b => b.id === u.branchId);
                branchName = branch ? branch.name : 'فرع محذوف';
              }

              return `
                <tr>
                  <td>${u.name}</td>
                  <td>${roleLabel}</td>
                  <td>${branchName}</td>
                  <td class="no-print">
                    <button class="btn danger" onclick="Settings.delUser('${u.id}')">حذف</button>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }
  },

  getRoleLabel(role) {
    const roles = {
      'admin': 'مدير النظام',
      'manager': 'مدير',
      'branch-manager': 'مدير فرع',
      'accountant': 'محاسب',
      'employee': 'موظف',
      'viewer': 'مشاهد'
    };
    return roles[role] || 'موظف';
  },

  updateUIBasedOnPermissions() {
    // تحديث ظهور الأزرار حسب الصلاحيات
    const buttons = [
      { id: 'btnHome', perm: 'dashboard' }, // زر الرئيسية يظهر لمن لديه صلاحية لوحة التحكم
      { id: 'btnBranchManagement', perm: 'branches' },
      { id: 'btnReports', perm: 'reports' },
      { id: 'btnFinancialReports', perm: 'financial' },
      { id: 'btnAccounts', perm: 'accounts' },
      { id: 'btnSettings', perm: 'settings' },
      { id: 'btnCompany', perm: 'company' },
      { id: 'btnMovement', perm: 'movement' },
      { id: 'btnDashboard', perm: 'dashboard' }
    ];

    buttons.forEach(btn => {
      const element = q(`#${btn.id}`);
      if (element) {
        if (State.user.role === 'admin' || (State.user.perms && State.user.perms[btn.perm])) {
          element.style.display = '';
        } else {
          element.style.display = 'none';
        }
      }
    });

    // إخفاء أزرار معينة لمدير الفرع
    if (State.user.role === 'branch-manager') {
      // إخفاء لوحة التحكم
      const dashboardBtn = q('#btnDashboard');
      if (dashboardBtn) dashboardBtn.style.display = 'none';

      // إخفاء التقارير
      const reportsBtn = q('#btnReports');
      if (reportsBtn) reportsBtn.style.display = 'none';

      const financialReportsBtn = q('#btnFinancialReports');
      if (financialReportsBtn) financialReportsBtn.style.display = 'none';
    }
  },

  applyUserTheme(role) {
    // إزالة جميع الثيمات السابقة
    document.body.classList.remove('theme-admin', 'theme-manager', 'theme-accountant', 'theme-employee', 'theme-viewer');

    // إضافة الثيم الجديد
    if (role) {
      document.body.classList.add(`theme-${role}`);
    }
  },

  init() {
    this.render();

    // تعبئة بيانات الشركة
    q("#coName").value = State.db.company.name||"";
    q("#coPhone").value = State.db.company.phone||"";
    q("#coCR").value = State.db.company.cr||"";
    q("#coAddr").value = State.db.company.addr||"";
    

  },
  
  delUser(id) {
    if(!confirm("حذف المستخدم؟")) return;
    
    // لا يمكن حذف آخر مستخدم مدير
    const adminUsers = State.db.users.filter(u => u.role === 'admin');
    const userToDelete = State.db.users.find(u => u.id === id);
    
    if (userToDelete?.role === 'admin' && adminUsers.length <= 1) {
      Notification.show("لا يمكن حذف آخر مستخدم مدير", "error");
      return;
    }
    
    State.db.users = State.db.users.filter(u=>u.id!==id);
    DB.save(); 
    this.render();
    Notification.show("تم حذف المستخدم بنجاح", "success");
  }
};

/* ========= Company quick edit ========= */
const Company = {
  open() {
    q("#mcoName").value = State.db.company.name||"";
    q("#mcoPhone").value = State.db.company.phone||"";
    q("#mcoCR").value = State.db.company.cr||"";
    q("#mcoAddr").value = State.db.company.addr||"";
    q("#companyModal").classList.remove("hidden");
  },
  
  close() { 
    q("#companyModal").classList.add("hidden"); 
  },
  
  save() {
    State.db.company = {
      name:q("#coName").value.trim(),
      phone:q("#coPhone").value.trim(),
      cr:q("#coCR").value.trim(),
      addr:q("#coAddr").value.trim()
    };
    DB.save(); 
    Notification.show("تم حفظ بيانات الشركة بنجاح", "success");
  },
  
  saveModal() {
    State.db.company = {
      name:q("#mcoName").value.trim(),
      phone:q("#mcoPhone").value.trim(),
      cr:q("#mcoCR").value.trim(),
      addr:q("#mcoAddr").value.trim()
    };
    DB.save();
    this.close();
    Notification.show("تم حفظ بيانات الشركة بنجاح", "success");
  },

  handleCompanyModalEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'saveModalBtn') {
        this.saveModal();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  }
};

/* ========= Init ========= */
window.addEventListener("DOMContentLoaded", ()=>{
  try {
    const hash = location.hash.replace("#","") || 'login';
    if(State.user){
      Router.go(hash || 'home');
      q("header.top")?.classList.remove("hidden");
    } else {
      Router.go('login');
      q("header.top")?.classList.add("hidden");
    }

    // إضافة مستخدم مدير افتراضي إذا لم يوجد أي مستخدم
    if(!State.db.users || State.db.users.length === 0){
      const adminPerms = {};
      PERMISSIONS.forEach(perm => {
        adminPerms[perm.k] = true;
      });
      State.db.users = [{id:uid(),name:"admin",pass:"admin123",role:"admin",perms:adminPerms}];
      DB.save();
    }

    // تهيئة Dashboard
    Dashboard.populateBranchSelector();

    // Initialize notifications
    Notifications.init();
  } catch (error) {
    console.error("Initialization error:", error);
    Notification.show("حدث خطأ أثناء تحميل التطبيق. يرجى تحديث الصفحة.", "error");
  }
});

/*
  ===========================================
  اقتراحات لقاعدة بيانات حقيقية
  ===========================================

  1. هيكل قاعدة البيانات المقترح (MySQL/PostgreSQL):

  -- جدول المستخدمين
  CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('admin', 'manager', 'accountant', 'employee', 'viewer') NOT NULL,
    branch_id VARCHAR(36),
    permissions JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  );

  -- جدول الفروع
  CREATE TABLE branches (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    manager VARCHAR(100),
    location VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );

  -- جدول السجلات المالية
  CREATE TABLE financial_records (
    id VARCHAR(36) PRIMARY KEY,
    branch_id VARCHAR(36) NOT NULL,
    form_type VARCHAR(50) NOT NULL,
    data JSON NOT NULL,
    created_by VARCHAR(36),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (branch_id) REFERENCES branches(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
  );

  -- جدول سجل الأنشطة
  CREATE TABLE audit_trail (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36),
    action VARCHAR(100) NOT NULL,
    details JSON,
    ip_address VARCHAR(45),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
  );

  2. Backend API Structure (Node.js/Express):

  // server.js
  const express = require('express');
  const mysql = require('mysql2');
  const jwt = require('jsonwebtoken');
  const bcrypt = require('bcrypt');

  const app = express();
  app.use(express.json());

  // Database connection
  const db = mysql.createConnection({
    host: 'localhost',
    user: 'username',
    password: 'password',
    database: 'aljaberni_db'
  });

  // Authentication middleware
  const authenticateToken = (req, res, next) => {
    const token = req.headers['authorization'];
    if (!token) return res.sendStatus(401);

    jwt.verify(token, 'your-secret-key', (err, user) => {
      if (err) return res.sendStatus(403);
      req.user = user;
      next();
    });
  };

  // API Routes
  app.post('/api/login', async (req, res) => {
    // Login logic with JWT
  });

  app.get('/api/branches', authenticateToken, (req, res) => {
    // Get branches with permissions check
  });

  app.post('/api/records', authenticateToken, (req, res) => {
    // Save financial records
  });

  3. أدوات مفيدة للإنتاج:
  - PM2 لإدارة العمليات
  - Nginx كـreverse proxy
  - SSL certificates
  - Database backups automation
  - Monitoring tools (PM2, Grafana)

  4. خطوات التحويل:
  1. إنشاء backend API
  2. تصميم قاعدة البيانات
  3. نقل البيانات من localStorage
  4. تحديث frontend لاستخدام API
  5. إضافة authentication
  6. اختبار شامل
  7. نشر على server

  هذا النظام المحسن أصبح أكثر أماناً وقابلية للصيانة والتوسع!

  ملاحظة للمستخدم:
  - تم إزالة تشفير كلمات المرور تماماً
  - ستظهر إشعار "إزالة التشفير" عند تحويل كلمات المرور المشفرة
  - كلمات المرور الافتراضية: admin/admin123
  - النظام يخزن كلمات المرور كنص عادي (غير مشفر)
*/
</script>

<!-- Notifications Container -->
<div class="notification-container" id="notificationContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<script src="upgrade_checker.js"></script>
</body>
</html>