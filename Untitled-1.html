<!DOCTYPE html>
<html lang="ar-SA" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¬Ø¨Ø±Ù†ÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ - Ø¥Ø¯Ø§Ø±Ø© Ù…ØºØ§Ø³Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
<style>
  :root {
    --bg: #0f172a;
    --fg: #f8fafc;
    --muted: #cbd5e1;
    --card: #111827;
    --accent: #22c55e;
    --accent-2: #06b6d4;
    --danger: #ef4444;
    --warn: #f59e0b;
    --ok: #10b981;
    --info: #3b82f6;
    --line: #1f2937;
    --card-bg: linear-gradient(180deg, #0b1224, #0e162d);

    /* Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø®ØªÙ„ÙÙŠÙ† */
    --admin-accent: #10b981;
    --manager-accent: #3b82f6;
    --accountant-accent: #f59e0b;
    --viewer-accent: #8b5cf6;

    /* ØªØ£Ø«ÙŠØ±Ø§Øª 3D */
    --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
    --btn-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  * {
    box-sizing: border-box;
    font-family: "Tajawal", system-ui, Segoe UI, Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  body {
    margin: 0;
    background: linear-gradient(135deg, #0b1224, #0f172a 50%, #0b1224);
    background-color: #0f172a;
    color: var(--fg);
    min-height: 100vh;
  }

  a {
    color: inherit;
    text-decoration: none;
  }

  .container {
    max-width: 1200px;
    margin: auto;
    padding: 16px;
  }

  header.top {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--line);
    position: sticky;
    top: 0;
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(6px);
    z-index: 10;
  }

  header .brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .brand .logo {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: grid;
    place-items: center;
    font-weight: 700;
    color: #001b12;
  }

  .tag {
    font-size: 12px;
    color: var(--muted);
  }

  .btn {
    border: 0;
    border-radius: 10px;
    padding: 10px 14px;
    background: #1f2937;
    color: #e5e7eb;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    box-shadow: var(--btn-shadow);
    transform: translateZ(0);
  }

  .btn:hover {
    transform: translateY(-2px) translateZ(0);
    box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
  }

  .btn.info {
    background: var(--info);
    color: white;
  }

  .btn.acc {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #001b12;
    font-weight: 700;
  }

  .btn.danger {
    background: var(--danger);
    color: white;
  }

  .btn.warn {
    background: var(--warn);
    color: #1f2937;
  }

  .btn.ghost {
    background: transparent;
    border: 1px solid var(--line);
  }

  .grid {
    display: grid;
    gap: 16px;
  }

  .grid.cards {
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 25px;
  }

  .card {
    background: var(--card-bg);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.3s ease;
    box-shadow: var(--card-shadow);
    transform: translateZ(0);
    perspective: 1000px;
  }

  .card:hover {
    transform: translateY(-8px) translateZ(0);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 15px 15px rgba(0, 0, 0, 0.25);
  }

  /* ========= Branch Card Styling ========= */
  .branch-card {
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.15), rgba(80, 200, 120, 0.15));
    border: 2px solid rgba(74, 144, 226, 0.3);
    min-height: 220px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .branch-card:hover {
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.25), rgba(80, 200, 120, 0.25));
    border-color: rgba(74, 144, 226, 0.5);
    transform: translateY(-10px) scale(1.02);
  }

  .branch-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
  }

  .branch-icon {
    font-size: 52px;
    background: linear-gradient(45deg, #4A90E2, #50C878);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  .branch-info h3 {
    margin: 0;
    font-size: 26px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .branch-details {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 15px 0;
  }

  .branch-detail {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 15px;
    color: rgba(255, 255, 255, 0.9);
  }

  .branch-detail-icon {
    font-size: 18px;
    width: 22px;
    text-align: center;
    color: rgba(74, 144, 226, 0.8);
  }

  .branch-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
  }

  .branch-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.8);
  }

  .status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #50C878;
    box-shadow: 0 0 12px rgba(80, 200, 120, 0.6);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 12px rgba(80, 200, 120, 0.6); }
    50% { box-shadow: 0 0 20px rgba(80, 200, 120, 0.8); }
    100% { box-shadow: 0 0 12px rgba(80, 200, 120, 0.6); }
  }

  .branch-arrow {
    font-size: 24px;
    color: rgba(255, 255, 255, 0.7);
    transition: transform 0.3s ease;
  }

  .branch-card:hover .branch-arrow {
    transform: translateX(8px);
    color: rgba(255, 255, 255, 0.9);
  }

  /* ========= Enhanced Branch Tabs ========= */
  .tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin: 20px 0;
    padding: 0;
  }

  .tab {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 20px 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-align: center;
    min-width: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
  }

  .tab:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
  }

  .tab::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s ease;
  }

  .tab:hover::before {
    transform: translateX(100%);
  }

  /* ========= Back Button ========= */
  .back-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: linear-gradient(135deg, #4A90E2, #50C878);
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .back-button:hover {
    transform: scale(1.1) translateY(-2px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
  }

  .back-button:active {
    transform: scale(0.95);
  }



  /* ========= Login Page ========= */
  #view-login {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  #view-login .card {
    max-width: 400px;
    width: 100%;
    margin: 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© ÙÙŠ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
  body:has(#view-login:not(.hidden)) header.top,
  .view-login header.top {
    display: none !important;
  }

  .card h3 {
    margin: 0 0 8px;
  }

  .muted {
    color: var(--muted);
  }

  .input,
  select,
  textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #233047;
    background: #0b1224;
    color: var(--fg);
    font-size: 14px;
  }

  .input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  label {
    font-size: 13px;
    color: var(--muted);
    display: block;
    margin-bottom: 4px;
  }

  .row {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 12px;
  }

  .col-12 {
    grid-column: span 12;
  }
  .col-8 {
    grid-column: span 8;
  }
  .col-6 {
    grid-column: span 6;
  }
  .col-4 {
    grid-column: span 4;
  }
  .col-3 {
    grid-column: span 3;
  }
  .col-2 {
    grid-column: span 2;
  }

  @media (max-width: 800px) {
    .col-8,
    .col-6,
    .col-4,
    .col-3,
    .col-2 {
      grid-column: span 12;
    }
  }

  table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--line);
    border-radius: 10px;
    overflow: hidden;
  }

  th,
  td {
    padding: 10px;
    border-bottom: 1px solid var(--line);
    text-align: right;
  }

  th {
    background: #0b1224;
    color: #cbd5e1;
  }

  tr:nth-child(even) {
    background: #0d1428;
  }

  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    justify-content: flex-start;
    margin: 10px 0;
  }

  .hidden {
    display: none !important;
  }

  .tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .tab {
    padding: 10px 12px;
    border: 1px solid var(--line);
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .tab:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .tab.active {
    background: linear-gradient(135deg, #1f2937 0%, #0b1224 100%);
    border-color: #2b3a56;
  }

  .pill {
    padding: 6px 10px;
    border: 1px dashed #31405f;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
  }

  .title {
    font-size: 22px;
    margin: 6px 0;
  }

  .subtitle {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .sep {
    height: 1px;
    background: var(--line);
    margin: 12px 0;
  }

  /* Login */
  .login {
    display: grid;
    place-items: center;
    min-height: 70vh;
    text-align: center;
  }

  .login .panel {
    width: min(520px, 92vw);
    padding: 22px;
    border-radius: 16px;
    background: linear-gradient(180deg, #0b1224, #0e162d);
    border: 1px solid var(--line);
  }

  /* Print */
  @media print {
    body {
      background: white;
      color: black;
    }
    header.top,
    .no-print {
      display: none !important;
    }
    .card {
      border: 0;
    }
    .report-paper {
      border: 1px solid #999;
      padding: 12px;
    }
    table,
    tr,
    td,
    th {
      border: 1px solid #888;
    }
  }

  /* Report styles */
  .report-type-card {
    cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
  }

  .report-type-card:hover {
    transform: translateY(-3px);
    border-color: var(--accent);
  }

  .report-type-card.active {
    border-color: var(--accent);
    background: rgba(34, 197, 94, 0.1);
  }

  .report-separator {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    margin: 24px 0;
  }

  .report-footer {
    margin-top: 20px;
    padding-top: 12px;
    border-top: 1px solid var(--line);
  }

  .report-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .saved-reports-list {
    max-height: 400px;
    overflow-y: auto;
  }

  .saved-report-item {
    border-left: 3px solid var(--accent);
    margin-bottom: 8px;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .saved-report-item:hover {
    transform: translateX(4px);
  }

  .profit-loss-table {
    width: 100%;
    border-collapse: collapse;
  }

  .profit-loss-table th {
    background: var(--card);
    padding: 12px;
    text-align: center;
  }

  .profit-loss-table td {
    padding: 10px;
    border-bottom: 1px solid var(--line);
  }

  .profit-loss-total {
    font-weight: bold;
    background: rgba(16, 185, 129, 0.1);
  }

  /* Notification */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 8px;
    background: var(--accent);
    color: #001b12;
    font-weight: bold;
    z-index: 100;
    transform: translateY(100px);
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
  }

  .notification.show {
    transform: translateY(0);
    opacity: 1;
  }

  .notification.success {
    background: var(--accent);
  }

  .notification.error {
    background: var(--danger);
    color: white;
  }

  .notification.warning {
    background: var(--warn);
    color: #1f2937;
  }

  /* Loading overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.8);
    display: grid;
    place-items: center;
    z-index: 1000;
  }

  .loading-content {
    background: var(--card);
    padding: 24px;
    border-radius: 12px;
    text-align: center;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Branch management */
  .branch-management {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: var(--card);
    border-left: 1px solid var(--line);
    z-index: 50;
    transition: right 0.3s;
    padding: 16px;
    overflow-y: auto;
  }

  .branch-management.show {
    right: 0;
  }

  .branch-management h3 {
    margin-bottom: 16px;
  }

  /* Responsive adjustments */
  @media (max-width: 600px) {
    .branch-management {
      width: 100%;
      right: -100%;
    }
  }

  /* Dashboard Styles */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--card-bg);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 16px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: var(--card-shadow);
  }

  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
  }

  .stat-icon {
    font-size: 24px;
    margin-bottom: 8px;
  }

  .stat-value {
    font-size: 20px;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .stat-label {
    color: var(--muted);
    font-size: 14px;
  }

  .dashboard-card {
    margin-bottom: 20px;
  }

  /* Notification Styles */
  .notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .notification-container {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 2000;
    max-width: 350px;
  }

  .notification {
    background: var(--card-bg);
    border-left: 4px solid var(--accent);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease-out;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .notification.success {
    border-left-color: var(--accent);
  }

  .notification.warning {
    border-left-color: var(--warn);
  }

  .notification.error {
    border-left-color: var(--danger);
  }

  .notification.info {
    border-left-color: var(--info);
  }

  .notification-content {
    flex: 1;
    position: relative;
  }

  .notification-close {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 16px;
  }

  @keyframes slideIn {
    from {
      transform: translateX(-100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Chart Container */
  .chart-container {
    width: 100%;
    height: 300px;
    margin: 20px 0;
  }

  /* Backup Section */
  .backup-section {
    background: rgba(59, 130, 246, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
  }

  .backup-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    font-size: 14px;
  }

  .backup-success {
    color: var(--accent);
  }

  .backup-error {
    color: var(--danger);
  }

  /* Task Styles */
  .task-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--line);
  }

  .task-item:last-child {
    border-bottom: none;
  }

  .task-checkbox {
    margin: 0;
  }

  .task-completed {
    opacity: 0.7;
  }

  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  /* Loading */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Financial Reports Styles */
  .financial-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .tabs {
    display: flex;
    border-bottom: 2px solid var(--line);
    margin-bottom: 20px;
  }

  .tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .tab.active {
    border-bottom-color: var(--accent);
    color: var(--accent);
  }

  .tab:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .report-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    border-bottom: 2px solid var(--line);
  }

  .report-header h2 {
    margin: 0 0 10px 0;
    color: var(--accent);
  }

  /* Back Button */
  .back-button {
    display: inline-block;
    padding: 8px 16px;
    margin-bottom: 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--line);
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .back-button:hover {
    background: rgba(255, 255, 255, 0.15);
    color: var(--accent);
    transform: translateX(-2px);
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    background: var(--bg);
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--line);
  }

  .modal-header h3 {
    margin: 0;
    color: var(--accent);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--muted);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    color: var(--accent);
  }

  .modal-body {
    padding: 20px;
  }

  .modal-footer {
    padding: 20px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  /* User Role Colors */
  .user-card.admin {
    border-left: 4px solid #dc2626;
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
  }

  .user-card.manager {
    border-left: 4px solid #2563eb;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.05));
  }

  .user-card.accountant {
    border-left: 4px solid #059669;
    background: linear-gradient(135deg, rgba(5, 150, 105, 0.1), rgba(5, 150, 105, 0.05));
  }

  .user-card.employee {
    border-left: 4px solid #7c3aed;
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(124, 58, 237, 0.05));
  }

  .user-card.viewer {
    border-left: 4px solid #f59e0b;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
  }

  /* Permission Checkboxes */
  .permission-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    transition: background 0.3s ease;
  }

  .permission-item:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .permission-checkbox {
    margin-left: 10px;
    transform: scale(1.2);
  }

  .permission-label {
    flex: 1;
    color: var(--text);
  }

  /* Theme Colors for Different User Roles */
  body.theme-admin {
    --accent: #dc2626;
    --accent-light: rgba(220, 38, 38, 0.1);
  }

  body.theme-manager {
    --accent: #2563eb;
    --accent-light: rgba(37, 99, 235, 0.1);
  }

  body.theme-accountant {
    --accent: #059669;
    --accent-light: rgba(5, 150, 105, 0.1);
  }

  body.theme-employee {
    --accent: #7c3aed;
    --accent-light: rgba(124, 58, 237, 0.1);
  }

  body.theme-viewer {
    --accent: #f59e0b;
    --accent-light: rgba(245, 158, 11, 0.1);
  }

  /* Users Grid */
  .users-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .user-card {
    padding: 20px;
    border-radius: 12px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .user-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .user-info h4 {
    margin: 0 0 8px 0;
    color: var(--text);
    font-size: 18px;
  }

  .user-role {
    color: var(--accent);
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 4px;
  }

  .user-permissions {
    color: var(--muted);
    font-size: 12px;
  }

  .user-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .user-info-summary {
    text-align: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .user-info-summary h4 {
    margin: 0 0 8px 0;
    color: var(--accent);
  }

  .user-info-summary .user-role {
    color: var(--muted);
    font-size: 14px;
  }

  .user-branch {
    color: var(--accent);
    font-size: 12px;
    margin-bottom: 4px;
    font-weight: bold;
  }
</style>
</head>
<body>
<header class="top no-print">
  <div class="brand">
    <div class="logo">Ø¬</div>
    <div>
      <div><strong>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¬Ø¨Ø±Ù†ÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</strong></div>
      <div class="tag">Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ù…ØºØ§Ø³Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª - Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
    </div>
  </div>
  <div class="toolbar">
    <button class="btn ghost" id="btnHome" onclick="Router.go('home')">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="btn ghost" id="btnDashboard" onclick="Router.go('dashboard')">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    <button class="btn ghost" id="btnBranchManagement" onclick="Router.go('branch-management')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹</button>
    <button class="btn ghost" id="btnMovement" onclick="Router.go('movement')">Ø­Ø±ÙƒØ© Ø§Ù„ÙØ±ÙˆØ¹</button>
    <button class="btn ghost" id="btnReports" onclick="Router.go('reports')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button class="btn ghost" id="btnFinancialReports" onclick="Router.go('financial-reports')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
    <button class="btn ghost" id="btnAccounts" onclick="Router.go('accounts')">Ù…Ø¯ÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
    <button class="btn ghost" id="btnSettings" onclick="Router.go('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    <button class="btn warn" id="btnCompany" onclick="Company.open()">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
    <span id="userBranchInfo" class="muted" style="margin: 0 10px; display: none;"></span>
    <button class="btn danger" id="btnLogout" onclick="Auth.logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

    <!-- Notification Bell -->
    <div style="position: relative;">
      <button class="btn ghost" id="btnNotifications" onclick="Notifications.toggleList()">
        ğŸ””
        <span class="notification-badge hidden" id="notificationCount">0</span>
      </button>
      <div class="card hidden" id="notificationsList" style="position: absolute; top: 100%; left: 0; width: 300px; z-index: 100; margin-top: 8px;">
        <h3>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
        <div id="notificationsContainer"></div>
      </div>
    </div>
  </div>
</header>



<!-- Notification -->
<div id="notification" class="notification"></div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div id="loadingText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
  </div>
</div>

<div class="container">
  <!-- Welcome / Login -->
  <section id="view-login" class="login">
    <div class="panel">
      <h1 style="margin:8px 0">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¬Ø¨Ø±Ù†ÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</h1>
      <div class="subtitle">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
      <div class="sep"></div>
      <div class="row">
        <div class="col-12">
          <label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <select id="loginUser" onkeydown="Auth.handleLoginEnterKey(event, 'loginPass')"></select>
        </div>
        <div class="col-12">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPass" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="Auth.handleLoginEnterKey(event, 'loginBtn')" />
        </div>
      </div>
      <div class="toolbar" style="justify-content:center">
        <button id="loginBtn" class="btn acc" onclick="Auth.login()">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </section>

  <!-- Home -->
  <section id="view-home" class="hidden">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„ÙØ±ÙˆØ¹</div>
          <div class="subtitle">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ÙØ±Ø¹ Ù„ÙØªØ­ ØµÙØ­ØªÙ‡ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª.</div>
          <div class="pill">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© ØªØ¸Ù‡Ø± ÙÙŠ Ø±Ø£Ø³ ÙƒÙ„ ØªÙ‚Ø±ÙŠØ±.</div>
        </div>
      </div>
    </div>
    <div class="grid cards" id="branchesGrid"></div>
  </section>

  <!-- Dashboard -->
  <section id="view-dashboard" class="hidden">
    <div class="card">
      <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div class="subtitle">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>

      <div class="branch-selector">
        <label>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹:</label>
        <select id="dashboardBranch" class="input" onchange="Dashboard.load()" onkeydown="Dashboard.handleDashboardEnterKey(event)">
          <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
        </select>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-value" id="total-income">0.00 Ø±.Ø³</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’¸</div>
          <div class="stat-value" id="total-expenses">0.00 Ø±.Ø³</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“ˆ</div>
          <div class="stat-value" id="net-profit">0.00 Ø±.Ø³</div>
          <div class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸš—</div>
          <div class="stat-value" id="total-cars">0</div>
          <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row">
        <div class="col-6">
          <div class="card dashboard-card">
            <h3>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
            <div class="chart-container" id="incomeExpenseChart">
              <canvas id="incomeExpenseChartCanvas"></canvas>
            </div>
          </div>
        </div>

        <div class="col-6">
          <div class="card dashboard-card">
            <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
            <div class="chart-container" id="expensesChart">
              <canvas id="expensesChartCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <div class="card dashboard-card">
            <h3>Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£ÙƒØ«Ø± Ø±Ø¨Ø­ÙŠØ©</h3>
            <div id="top-branches-list">
              <div class="muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            </div>
          </div>
        </div>

        <div class="col-6">
          <div class="card dashboard-card">
            <h3>Ø£Ø­Ø¯Ø« Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
            <div id="recent-transactions">
              <div class="muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card dashboard-card">
        <h3>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©</h3>
        <div id="important-alerts">
          <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>
        </div>
      </div>

      <!-- Backup Section -->
      <div class="card dashboard-card">
        <h3>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
        <div class="backup-section">
          <p>Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªØ¬Ù†Ø¨ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
          <div class="toolbar">
            <button class="btn acc" onclick="Backup.createBackup()">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
            <button class="btn info" onclick="Backup.restoreBackup()">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
            <button class="btn" onclick="Backup.downloadTemplate()">ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          </div>
          <div class="backup-status" id="backupStatus"></div>
        </div>
      </div>

      <!-- Tasks Section -->
      <div class="card dashboard-card">
        <h3>Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª</h3>
        <div class="row">
          <div class="col-8">
            <input type="text" id="newTask" class="input" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©...">
          </div>
          <div class="col-4">
            <button class="btn acc" onclick="Tasks.addTask()">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
        <div id="tasksList">
          <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ©</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Financial Reports -->
  <section id="view-financial-reports" class="hidden">
    <div class="card">
      <div class="title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
      <div class="subtitle">ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø§Ù„ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ø¹Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ©</div>

      <div class="tabs">
        <div class="tab active" onclick="FinancialReports.switchTab('trial-balance')">Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
        <div class="tab" onclick="FinancialReports.switchTab('income-statement')">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</div>
        <div class="tab" onclick="FinancialReports.switchTab('balance-sheet')">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</div>
      </div>

      <div class="row">
        <div class="col-6">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="report-from" class="input" onkeydown="FinancialReports.handleReportEnterKey(event, 'report-to')">
        </div>
        <div class="col-6">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="report-to" class="input" onkeydown="FinancialReports.handleReportEnterKey(event, 'generateReportBtn')">
        </div>
        <div class="col-12 toolbar">
          <button id="generateReportBtn" class="btn acc" onclick="FinancialReports.generate()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          <button class="btn info" onclick="FinancialReports.exportPDF()">ØªØµØ¯ÙŠØ± PDF</button>
          <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </div>

      <div id="financial-report-result" class="report-paper"></div>
    </div>
  </section>

  <!-- Branch Management -->
  <section id="view-branch-management" class="hidden">
    <div class="card">
      <div class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹</div>
      <div class="subtitle">Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„ÙØ±ÙˆØ¹</div>

      <div class="row">
        <div class="col-4">
          <label>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</label>
          <input id="branchName" class="input" placeholder="Ù…Ø«Ø§Ù„: ÙØ±Ø¹ Ø§Ù„Ø´Ù…Ø§Ù„" onkeydown="BranchManagement.handleBranchEnterKey(event, 'branchManager')">
        </div>
        <div class="col-4">
          <label>Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹</label>
          <input id="branchManager" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±" onkeydown="BranchManagement.handleBranchEnterKey(event, 'branchLocation')">
        </div>
        <div class="col-4">
          <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
          <input id="branchLocation" class="input" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" onkeydown="BranchManagement.handleBranchEnterKey(event, 'addBranchBtn')">
        </div>
        <div class="col-12 toolbar">
          <button id="addBranchBtn" class="btn acc" onclick="BranchManagement.addBranch()">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</button>
        </div>
      </div>

      <div class="sep"></div>
      <h4>Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
      <div id="branchManagementList"></div>

      <div class="sep"></div>

      <!-- Ù‚Ø³Ù… Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙØ±ÙˆØ¹ -->
      <div class="card" style="margin-top: 20px; background: rgba(255, 255, 255, 0.05);">
        <h4>Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙØ±ÙˆØ¹</h4>
        <div class="row">
          <div class="col-4">
            <label>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</label>
            <select id="expBranch" class="input" onchange="BranchManagement.loadBranchExpenses()">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-4"><label>Ù…ØµØ±ÙˆÙ Ø¥ÙŠØ¬Ø§Ø±</label><input id="expRent" type="number" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expSalaries')"></div>
          <div class="col-4"><label>Ù…ØµØ±ÙˆÙ Ø±ÙˆØ§ØªØ¨</label><input id="expSalaries" type="number" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expAdmin')"></div>
          <div class="col-4"><label>Ù…ØµØ±ÙˆÙ Ø¥Ø¯Ø§Ø±Ø©</label><input id="expAdmin" type="number" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expBank')"></div>
          <div class="col-4"><label>Ù…ØµØ±ÙˆÙ Ø±Ø³ÙˆÙ… Ø¨Ù†ÙƒÙŠØ©</label><input id="expBank" type="number" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expLoss')"></div>
          <div class="col-4"><label>Ù…ØµØ±ÙˆÙ Ø®Ø³Ø§Ø±Ø© Ø³Ø§Ø¨Ù‚Ø©</label><input id="expLoss" type="number" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'expOther')"></div>
          <div class="col-4"><label>Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰</label><input id="expOther" type="number" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" onkeydown="BranchManagement.handleExpenseEnterKey(event, 'saveExpensesBtn')"></div>
        </div>
        <div class="toolbar">
          <button id="saveExpensesBtn" class="btn acc" onclick="BranchManagement.saveExpenses()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
          <button class="btn ghost" onclick="BranchManagement.clearExpenseForm()">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </div>
    </div>
  </section>





  <!-- Accounts Management -->
  <section id="view-accounts" class="hidden">
    <div class="card">
      <div class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
      <div class="subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>

      <div class="tabs">
        <div class="tab active" onclick="Accounts.switchTab('accounts')">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
        <div class="tab" onclick="Accounts.switchTab('transactions')">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
      </div>

      <div id="accounts-content">
        <div class="row">
          <div class="col-6">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <select id="accountType" class="input" onkeydown="Accounts.handleAccountEnterKey(event, 'accountName')">
              <option value="assets">Ø§Ù„Ø£ØµÙˆÙ„</option>
              <option value="liabilities">Ø§Ù„Ø®ØµÙˆÙ…</option>
              <option value="equity">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</option>
              <option value="revenue">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
              <option value="expenses">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</option>
            </select>
          </div>
          <div class="col-6">
            <label>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input id="accountName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨" onkeydown="Accounts.handleAccountEnterKey(event, 'accountBalance')">
          </div>
          <div class="col-6">
            <label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</label>
            <input id="accountBalance" type="number" class="input" placeholder="0.00" onkeydown="Accounts.handleAccountEnterKey(event, 'addAccountBtn')">
          </div>
          <div class="col-6 toolbar" style="align-items: flex-end;">
            <button id="addAccountBtn" class="btn acc" onclick="Accounts.addAccount()">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button>
          </div>
        </div>

        <div id="accountsList"></div>
      </div>

      <div id="transactions-content" class="hidden">
        <div class="row">
          <div class="col-4">
            <label>Ø§Ù„ÙØ±Ø¹</label>
            <select id="transactionBranch" class="input"></select>
          </div>
          <div class="col-4">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
            <select id="transactionType" class="input">
              <option value="debit">Ù…Ø¯ÙŠÙ†</option>
              <option value="credit">Ø¯Ø§Ø¦Ù†</option>
            </select>
          </div>
          <div class="col-4">
            <label>Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <select id="transactionAccount" class="input"></select>
          </div>
          <div class="col-6">
            <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
            <input id="transactionAmount" type="number" class="input" placeholder="0.00">
          </div>
          <div class="col-6">
            <label>Ø§Ù„ÙˆØµÙ</label>
            <input id="transactionDescription" class="input" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
          </div>
          <div class="col-12 toolbar">
            <button class="btn acc" onclick="Accounts.addTransaction()">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©</button>
          </div>
        </div>

        <div id="transactionsList"></div>
      </div>
    </div>
  </section>

  <!-- Branch -->
  <section id="view-branch" class="hidden">
    <div class="card">
      <div class="title" id="branchTitle">Ø§Ù„ÙØ±Ø¹</div>
      <div class="subtitle" id="branchSub"></div>
      <div class="tabs no-print" id="branchTabs"></div>
      <div id="branchForms"></div>
    </div>
  </section>



  <!-- Form Page -->
  <section id="view-form" class="hidden">
    <div class="card">
      <div class="title" id="formTitle">ÙƒØ´Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
      <div class="subtitle" id="formSubtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØ±Ø¹</div>

      <div id="formContent">
        <!-- Form content will be populated by JavaScript -->
      </div>

      <div class="sep"></div>
      <h4 id="formRecordsTitle">Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
      <div id="formRecordsList"></div>
    </div>

    <button class="back-button" onclick="UI.goBackToBranch()" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØ±Ø¹">
      â†
    </button>
  </section>

  <!-- Reports Main View -->
  <section id="view-reports" class="hidden">
    <div class="card">
      <div class="title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</div>
      <div class="subtitle">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡Ù‡</div>
      
      <div class="grid cards" style="grid-template-columns:repeat(auto-fill,minmax(300px,1fr));margin-top:16px">
        <!-- Daily Report Card -->
        <div class="card report-type-card" onclick="Router.go('daily-reports')">
          <h3>ğŸ“… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
          <div class="muted">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
        </div>
        
        <!-- Monthly Report Card -->
        <div class="card report-type-card" onclick="Router.go('monthly-reports')">
          <h3>ğŸ“† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
          <div class="muted">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
        </div>
        
        <!-- Custom Report Card -->
        <div class="card report-type-card" onclick="Router.go('custom-reports')">
          <h3>ğŸ—“ï¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ</h3>
          <div class="muted">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ø£ÙŠ ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©</div>
        </div>
        
        <!-- Saved Reports Card -->
        <div class="card report-type-card" onclick="Router.go('saved-reports')">
          <h3>ğŸ“‚ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©</h3>
          <div class="muted">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
        </div>
        
        <!-- Profit/Loss Report Card -->
        <div class="card report-type-card" onclick="Router.go('profit-loss')">
          <h3>ğŸ’° ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±</h3>
          <div class="muted">ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ø¨Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø± Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Daily Reports -->
  <section id="view-daily-reports" class="hidden">
    <div class="card">
      <div class="title">ğŸ“… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
      <div class="subtitle">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</div>
      
      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„ÙØ±Ø¹</label>
          <select id="dailyRepBranch" class="input"></select>
        </div>
        <div class="col-4">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="dailyRepDate" class="input"/>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div class="title" style="font-size:18px">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
      <div class="subtitle">ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª</div>
      
      <div class="grid cards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr));margin-top:12px" id="dailyReportTypes">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
      </div>
      
      <div class="toolbar" style="justify-content:center;margin-top:16px">
        <button class="btn acc" onclick="Reports.generateDaily()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn info" onclick="Reports.exportDailyToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
        <button class="btn ghost" onclick="Router.go('reports')">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </section>

  <!-- Monthly Reports -->
  <section id="view-monthly-reports" class="hidden">
    <div class="card">
      <div class="title">ğŸ“† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
      <div class="subtitle">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„Ø´Ù‡Ø± Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</div>
      
      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„ÙØ±Ø¹</label>
          <select id="monthlyRepBranch" class="input"></select>
        </div>
        <div class="col-4">
          <label>Ø§Ù„Ø´Ù‡Ø±</label>
          <input type="month" id="monthlyRepMonth" class="input"/>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div class="title" style="font-size:18px">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
      <div class="subtitle">ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª</div>
      
      <div class="grid cards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr));margin-top:12px" id="monthlyReportTypes">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
      </div>
      
      <div class="toolbar" style="justify-content:center;margin-top:16px">
        <button class="btn acc" onclick="Reports.generateMonthly()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn info" onclick="Reports.exportMonthlyToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
        <button class="btn ghost" onclick="Router.go('reports')">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </section>

  <!-- Custom Reports -->
  <section id="view-custom-reports" class="hidden">
    <div class="card">
      <div class="title">ğŸ—“ï¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ</div>
      <div class="subtitle">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØµØµ</div>
      
      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„ÙØ±Ø¹</label>
          <select id="customRepBranch" class="input"></select>
        </div>
        <div class="col-2">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="customRepFrom" class="input"/>
        </div>
        <div class="col-2">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="customRepTo" class="input"/>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div class="title" style="font-size:18px">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
      <div class="subtitle">ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª</div>
      
      <div class="grid cards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr));margin-top:12px" id="customReportTypes">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
      </div>
      
      <div class="toolbar" style="justify-content:center;margin-top:16px">
        <button class="btn acc" onclick="Reports.generateCustom()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn ghost" onclick="Router.go('reports')">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </section>

  <!-- Saved Reports -->
  <section id="view-saved-reports" class="hidden">
    <div class="card">
      <div class="title">ğŸ“‚ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©</div>
      <div class="subtitle">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
      
      <div class="tabs" style="margin-bottom:16px">
        <div class="tab active" onclick="Reports.showSavedType('all')">Ø§Ù„ÙƒÙ„</div>
        <div class="tab" onclick="Reports.showSavedType('daily')">ÙŠÙˆÙ…ÙŠØ©</div>
        <div class="tab" onclick="Reports.showSavedType('monthly')">Ø´Ù‡Ø±ÙŠØ©</div>
        <div class="tab" onclick="Reports.showSavedType('custom')">Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</div>
        <div class="tab" onclick="Reports.showSavedType('profit-loss')">Ø£Ø±Ø¨Ø§Ø­/Ø®Ø³Ø§Ø¦Ø±</div>
      </div>
      
      <div class="saved-reports-list" id="savedReportsList">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© -->
      </div>
    </div>
  </section>

  <!-- Profit/Loss Reports -->
  <section id="view-profit-loss" class="hidden">
    <div class="card">
      <div class="title">ğŸ’° ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±</div>
      <div class="subtitle">Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø± Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
      
      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„ÙØ±Ø¹</label>
          <select id="plBranch" class="input"></select>
        </div>
        <div class="col-4">
          <label>Ø§Ù„Ø´Ù‡Ø±</label>
          <input type="month" id="plMonth" class="input"/>
        </div>
      </div>
      
      <div class="toolbar" style="justify-content:center;margin-top:16px">
        <button class="btn acc" onclick="Reports.generateProfitLoss()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn ghost" onclick="Router.go('reports')">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </section>

  <!-- Report Display View -->
  <section id="view-report-display" class="hidden">
    <div class="card">
      <div id="reportDisplayArea"></div>
    </div>
  </section>

  <!-- Movement -->
  <section id="view-movement" class="hidden">
    <div class="card">
      <div class="title">Ø­Ø±ÙƒØ© Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
      <div class="subtitle">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ Ø«Ù… Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø«Ù… Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø©. ÙŠÙ…ÙƒÙ† Ø£ÙŠØ¶Ù‹Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¥Ø­ØµØ§Ø¦ÙŠØ© (Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙƒØ«Ø±/Ø§Ù„Ø£Ù‚Ù„).</div>

      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„ÙØ±Ø¹</label>
          <select id="mvBranch"></select>
        </div>
        <div class="col-4">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
          <select id="mvType"></select>
        </div>
        <div class="col-2">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="mvFrom" class="input"/>
        </div>
        <div class="col-2">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="mvTo" class="input"/>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn acc" onclick="Movement.generate()">Ù…ÙˆØ§ÙÙ‚</button>
        <button class="btn ghost" onclick="Movement.clear()">Ù…Ø³Ø­</button>
        <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
      </div>

      <div class="sep"></div>

      <div class="title" style="font-size:18px">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©</div>
      <div class="subtitle">Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙƒØ© ÙˆÙ†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙƒØ«Ø±/Ø§Ù„Ø£Ù‚Ù„.</div>
      <div class="row">
        <div class="col-4">
          <label>Ø­Ø±ÙƒØ© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©</label>
          <select id="mvAggType"></select>
        </div>
        <div class="col-2">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="mvAggFrom" class="input"/>
        </div>
        <div class="col-2">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="mvAggTo" class="input"/>
        </div>
        <div class="col-4" style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn warn" onclick="Movement.calcTop()">Ø§Ù„Ø£ÙƒØ«Ø±</button>
          <button class="btn warn" onclick="Movement.calcBottom()">Ø§Ù„Ø£Ù‚Ù„</button>
        </div>
      </div>

      <div id="movementArea" class="report-paper"></div>
      <div id="movementAggArea" class="report-paper" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- ØµÙØ­Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒØ´Ù -->
  <section id="view-form" class="hidden">
    <div class="card" id="formPageArea"></div>
  </section>

  <!-- Settings -->
  <section id="view-settings" class="hidden">
    <div class="grid">
      <div class="card">
        <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>
        <div class="row">
          <div class="col-4"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="setUserName" class="input" placeholder="username" onkeydown="Settings.handleEnterKey(event, 'setUserPass')"></div>
          <div class="col-4"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="setUserPass" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="Settings.handleEnterKey(event, 'setUserRole')"></div>
          <div class="col-4"><label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <select id="setUserRole" onchange="Settings.toggleBranchSelection()" onkeydown="Settings.handleEnterKey(event, 'setUserBranch')">
              <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</option>
              <option value="manager">Ù…Ø¯ÙŠØ±</option>
              <option value="branch-manager">Ù…Ø¯ÙŠØ± ÙØ±Ø¹</option>
              <option value="accountant">Ù…Ø­Ø§Ø³Ø¨</option>
              <option value="employee">Ù…ÙˆØ¸Ù</option>
              <option value="viewer">Ø¹Ø±Ø¶ ÙÙ‚Ø·</option>
            </select>
          </div>
          <div class="col-4" id="settingsBranchDiv" style="display: none;">
            <label>Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØµØµ</label>
            <select id="setUserBranch" class="input" onkeydown="Settings.handleEnterKey(event, 'addUserBtn')">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
            </select>
          </div>
          <div class="col-12 toolbar">
            <button id="addUserBtn" class="btn acc" onclick="Settings.addUser()">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
          </div>
        </div>
        <div id="settingsUsersList"></div>
      </div>

      <div class="card">
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© (ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ù„ÙƒÙ„ ØªÙ‚Ø±ÙŠØ±)</h3>
        <div class="row">
          <div class="col-6"><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="coName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©" onkeydown="Settings.handleCompanyEnterKey(event, 'coPhone')"></div>
          <div class="col-3"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="coPhone" class="input" placeholder="05xxxxxxxx" onkeydown="Settings.handleCompanyEnterKey(event, 'coCR')"></div>
          <div class="col-3"><label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label><input id="coCR" class="input" placeholder="CR" onkeydown="Settings.handleCompanyEnterKey(event, 'coAddr')"></div>
          <div class="col-12"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="coAddr" class="input" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø§Ù„Ø­ÙŠ - Ø§Ù„Ø´Ø§Ø±Ø¹" onkeydown="Settings.handleCompanyEnterKey(event, 'saveCompany')"></div>
          <div class="col-12 toolbar">
            <button id="saveCompany" class="btn acc" onclick="Company.save()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          </div>
        </div>
      </div>


    </div>
  </section>

</div>

<!-- Simple modal for company quick edit -->
<div id="companyModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:grid;place-items:center;z-index:50">
  <div class="card" style="width:min(520px,94vw)">
    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</h3>
    <div class="row">
      <div class="col-6"><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="mcoName" class="input" onkeydown="Company.handleCompanyModalEnterKey(event, 'mcoPhone')"></div>
      <div class="col-3"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="mcoPhone" class="input" onkeydown="Company.handleCompanyModalEnterKey(event, 'mcoCR')"></div>
      <div class="col-3"><label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label><input id="mcoCR" class="input" onkeydown="Company.handleCompanyModalEnterKey(event, 'mcoAddr')"></div>
      <div class="col-12"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="mcoAddr" class="input" onkeydown="Company.handleCompanyModalEnterKey(event, 'saveModalBtn')"></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <button class="btn ghost" onclick="Company.close()">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="saveModalBtn" class="btn acc" onclick="Company.saveModal()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<script>
/* ========= Utilities / Storage ========= */
/*
  Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
  - Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø©
  - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  - ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
*/
const DB_KEY = "aljaberni_db_v2";
const todayStr = () => new Date().toISOString().slice(0,10);
const firstOfMonthStr = () => {
  const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;
};
const uid = () => {
  if (crypto.randomUUID) return crypto.randomUUID();
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
};
const PERMISSIONS = [
  {k:'branches',label:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹'},
  {k:'reports',label:'Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'},
  {k:'settings',label:'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'},
  {k:'users',label:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'},
  {k:'company',label:'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©'},
  {k:'movement',label:'Ø­Ø±ÙƒØ© Ø§Ù„ÙØ±ÙˆØ¹'},
  {k:'editData',label:'Ø¥Ø¯Ø®Ø§Ù„ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'},
  {k:'financial',label:'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©'},
  {k:'dashboard',label:'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'},
  {k:'accounts',label:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª'},
];

/* ========= Security Module ========= */
const Security = {
  // Ø¥Ø²Ø§Ù„Ø© ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± - Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙƒÙ…Ø§ Ù‡ÙŠ
  hashPassword(password) {
    return password;
  },

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±
  verifyPassword(password, storedPassword) {
    return password === storedPassword;
  },

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ù† XSS
  sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return DOMPurify.sanitize(input, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
  },

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
  validateInput(input, type = 'text') {
    const sanitized = this.sanitizeInput(input);

    switch(type) {
      case 'email':
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(sanitized);
      case 'phone':
        const phoneRegex = /^[\d\s\-\+\(\)]+$/;
        return phoneRegex.test(sanitized);
      case 'number':
        return !isNaN(Number(sanitized)) && sanitized.trim() !== '';
      default:
        return sanitized.length > 0;
    }
  },

  // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  logActivity(action, details = {}) {
    const activity = {
      id: uid(),
      userId: State.user ? State.user.id : 'system',
      userName: State.user ? State.user.name : 'System',
      action,
      details,
      timestamp: new Date().toISOString(),
      ip: 'client-side' // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
    };

    if (!State.db.auditTrail) State.db.auditTrail = [];
    State.db.auditTrail.push(activity);

    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 1000 Ø³Ø¬Ù„ ÙÙ‚Ø·
    if (State.db.auditTrail.length > 1000) {
      State.db.auditTrail = State.db.auditTrail.slice(-1000);
    }

    DB.save();

    // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ console Ù„Ù„ØªØµØ­ÙŠØ­
    console.log(`[AUDIT] ${activity.timestamp} - ${activity.userName}: ${action}`, details);
  },

  // Ù†Ø¸Ø§Ù… logging Ø¨Ø³ÙŠØ·
  log(level, message, data = {}) {
    const logEntry = {
      id: uid(),
      level,
      message,
      data,
      timestamp: new Date().toISOString(),
      user: State.user ? State.user.name : 'System'
    };

    // Ø­ÙØ¸ ÙÙŠ localStorage
    const logs = JSON.parse(localStorage.getItem('aljaberni_logs') || '[]');
    logs.push(logEntry);

    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 500 Ø³Ø¬Ù„ ÙÙ‚Ø·
    if (logs.length > 500) {
      logs.shift();
    }

    localStorage.setItem('aljaberni_logs', JSON.stringify(logs));

    // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ console
    const colors = {
      error: '\x1b[31m',
      warn: '\x1b[33m',
      info: '\x1b[36m',
      debug: '\x1b[35m'
    };

    console.log(`${colors[level] || ''}[${level.toUpperCase()}] ${logEntry.timestamp} - ${message}`, data);
  },

  // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©
  getAuditTrail() {
    return State.db.auditTrail || [];
  },

  // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
  getLogs() {
    return JSON.parse(localStorage.getItem('aljaberni_logs') || '[]');
  },

  // ØªØ­ÙˆÙŠÙ„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´ÙØ±Ø© Ø¥Ù„Ù‰ Ù†Øµ Ø¹Ø§Ø¯ÙŠ (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙÙŠØ±)
  downgradePasswords() {
    const raw = localStorage.getItem(DB_KEY);
    if (!raw) return false;

    try {
      const data = JSON.parse(raw);
      if (!data.users) return false;

      let downgraded = false;
      data.users.forEach(user => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø© (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…ÙˆØ² ØªØ´ÙÙŠØ±)
        if (user.pass && (user.pass.includes('$') || user.pass.includes('=') || user.pass.length > 20)) {
          // Ù‡Ø°Ù‡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø© - Ù†Ø­ÙˆÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ù†Øµ Ø¹Ø§Ø¯ÙŠ
          // Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±ØŒ Ù„Ø°Ø§ Ø³Ù†Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          user.pass = 'admin123'; // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø´ÙØ±ÙŠÙ†
          downgraded = true;
          Security.log('info', `Password downgraded for user: ${user.name}`);
        }
      });

      if (downgraded) {
        localStorage.setItem(DB_KEY, JSON.stringify(data));
        State.db = data;
        Security.log('info', 'Password downgrade completed successfully');

        // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        setTimeout(() => {
          Notifications.add('Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙÙŠØ±', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± - Ø§Ø³ØªØ®Ø¯Ù… admin123 Ù„Ù„Ø¯Ø®ÙˆÙ„', 'warning');
        }, 1000);

        // Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Console
        console.log('ğŸ”“ ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± - Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø£ØµØ¨Ø­Øª admin123');

        return true;
      }

      return false;
    } catch (error) {
      Security.log('error', 'Password downgrade failed', { error: error.message });
      console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±:', error);
      return false;
    }
  },

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ù„ØªØµØ­ÙŠØ­)
  checkPasswordStatus() {
    const raw = localStorage.getItem(DB_KEY);
    if (!raw) {
      console.log('ğŸ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©');
      return;
    }

    try {
      const data = JSON.parse(raw);
      if (!data.users) {
        console.log('ğŸ‘¥ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†');
        return;
      }

      console.log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±:');
      data.users.forEach(user => {
        const isPlainText = user.pass && !user.pass.includes('$') && !user.pass.includes('=') && user.pass.length <= 20;
        console.log(`   ${user.name}: ${isPlainText ? 'ğŸ“ Ù†Øµ Ø¹Ø§Ø¯ÙŠ' : 'ğŸ” Ù…Ø´ÙØ±Ø©'}`);
      });
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    }
  }
};

const q = (sel,root=document)=>root.querySelector(sel);
const qa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const fmt = n => (isNaN(+n)?0:+n).toLocaleString('ar-EG',{maximumFractionDigits:2});
const parseNum = v => Number(String(v||"").replace(/[^\d.\-]/g,""))||0;

const MODELS = {
  // ØªØ¹Ø±ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
  forms: {
    "dailyRevenue": {label:"ÙƒØ´Ù Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"network",label:"Ø¥ÙŠØ±Ø§Ø¯ Ø´Ø¨ÙƒØ©",type:"number"},
      {k:"cash",label:"Ø¥ÙŠØ±Ø§Ø¯ ÙƒØ§Ø´",type:"number"},
      {k:"credit",label:"Ø¥ÙŠØ±Ø§Ø¯ Ø¢Ø¬Ù„",type:"number"},
      {k:"cars",label:"Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª",type:"number"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    "bankRecon": {label:"ÙƒØ´Ù Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"mada",label:"Ù…Ø¯Ù‰",type:"number"},
      {k:"visa",label:"ÙÙŠØ²Ø§",type:"number"},
      {k:"master",label:"Ù…Ø§Ø³ØªØ± ÙƒØ§Ø±Ø¯",type:"number"},
      {k:"other1",label:"Ø£Ø®Ø±Ù‰ 1",type:"number"},
      {k:"other2",label:"Ø£Ø®Ø±Ù‰ 2",type:"number"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    "cashPurch": {label:"ÙƒØ´Ù Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹)", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"item",label:"Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø´ØªØ±Ù‰",type:"text"},
      {k:"price",label:"Ø³Ø¹Ø± Ø§Ù„ØµÙ†Ù",type:"number"},
      {k:"inv",label:"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©",type:"text"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    "creditPurch": {label:"ÙƒØ´Ù Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¢Ø¬Ù„Ø© (Ù…ÙˆØ§Ø¯)", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"item",label:"Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø´ØªØ±Ù‰",type:"text"},
      {k:"price",label:"Ø³Ø¹Ø± Ø§Ù„ØµÙ†Ù",type:"number"},
      {k:"inv",label:"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©",type:"text"},
      {k:"supplier",label:"Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯",type:"text"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    "dailyMeals": {label:"ÙƒØ´Ù Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"who",label:"Ø§Ù„Ù…ØªØºØ°ÙŠ (Ù…Ø¯ÙŠØ±/Ù…Ø´Ø±Ù/Ù…ÙˆØ¸ÙÙŠÙ†...)",type:"text"},
      {k:"amount",label:"Ù…Ø¨Ù„Øº Ø§Ù„ØªØºØ°ÙŠØ©",type:"number"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    "empAdvance": {label:"Ø³Ù„Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†/Ø³Ø­Ø¨ÙŠØ§Øª", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"emp",label:"Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",type:"picker-emp"},
      {k:"salary",label:"Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù…Ø³ØªØ­Ù‚",type:"readonly"},
      {k:"take",label:"Ø³Ø­Ø¨ÙŠØ© Ø§Ù„ÙŠÙˆÙ…",type:"number"},
      {k:"prev",label:"Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© (Ø¢Ù„ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶)",type:"readonly"},
      {k:"totalTaken",label:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª",type:"readonly"},
      {k:"remain",label:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡/Ø¹Ù„ÙŠÙ‡",type:"readonly"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    // ÙƒØ´ÙˆÙØ§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø­Ø§Ø³Ø¨
    "supMaintenance": {label:"ÙƒØ´Ù ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø´Ø±Ù", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"maint",label:"Ø§Ù„ØµÙŠØ§Ù†Ø©",type:"text"},
      {k:"kind",label:"Ù†ÙˆØ¹Ù‡Ø§",type:"text"},
      {k:"amount",label:"Ù…Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©",type:"number"},
      {k:"inv",label:"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¥Ù† ÙˆØ¬Ø¯)",type:"text"},
      {k:"by",label:"Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©",type:"text"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    "marketPurch": {label:"ÙƒØ´Ù Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© (Ù…ÙˆØ¸Ù Ø³ÙˆÙ‚)", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"item",label:"Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø´ØªØ±Ù‰",type:"text"},
      {k:"amount",label:"Ù…Ø¨Ù„Øº Ø§Ù„ØµÙ†Ù",type:"number"},
      {k:"inv",label:"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©",type:"text"},
      {k:"qty",label:"Ø§Ù„ÙƒÙ…ÙŠØ©",type:"number"},
      {k:"buyer",label:"Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ",type:"text"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    "mgrMaintenance": {label:"ÙƒØ´Ù ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø¯ÙŠØ±", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"type",label:"Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©",type:"select",opts:["Ø¹Ø§Ø¯ÙŠ","Ø¯ÙˆØ±ÙŠ"]},
      {k:"desc",label:"Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø© (ÙˆØµÙ)",type:"text"},
      {k:"amount",label:"Ø§Ù„Ù…Ø¨Ù„Øº",type:"number"},
      {k:"party",label:"Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ Ù‚Ø§Ù…Øª Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø© / Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ù‡Ø§",type:"text"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    "mgrPurch": {label:"ÙƒØ´Ù Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±", fields:[
      {k:"date",label:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date",def:todayStr()},
      {k:"item",label:"Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø´ØªØ±Ù‰",type:"text"},
      {k:"amount",label:"Ù…Ø¨Ù„Øº Ø§Ù„ØµÙ†Ù",type:"number"},
      {k:"inv",label:"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©",type:"text"},
      {k:"qty",label:"Ø§Ù„ÙƒÙ…ÙŠØ©",type:"number"},
      {k:"note",label:"Ù…Ù„Ø§Ø­Ø¸Ø©",type:"text"}
    ]},
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (ÙÙŠ ØµÙØ­Ø© Ø§Ù„ÙØ±Ø¹)
    "empAdd": {label:"Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù‘Ù", fields:[
      {k:"name",label:"Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",type:"text"},
      {k:"salary",label:"Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù…Ø³ØªØ­Ù‚",type:"number"},
      {k:"phone",label:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",type:"text"},
      {k:"role",label:"Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©",type:"select",opts:["Ù…Ø¯ÙŠØ±","Ù…Ø´Ø±Ù","Ù…ÙˆØ¸Ù‘Ù"]}
    ]}
  },
  // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„ÙØ±Ø¹
  branchTabs: [
    {k:"dailyRevenue",icon:"ğŸ’µ"},
    {k:"bankRecon",icon:"ğŸ¦"},
    {k:"cashPurch",icon:"ğŸ§¾"},
    {k:"creditPurch",icon:"ğŸ“¦"},
    {k:"dailyMeals",icon:"ğŸ½ï¸"},
    {k:"empAdvance",icon:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"},
    {k:"supMaintenance",icon:"ğŸ› ï¸"},
    {k:"marketPurch",icon:"ğŸ›ï¸"},
    {k:"mgrMaintenance",icon:"âš™ï¸"},
    {k:"mgrPurch",icon:"ğŸ§°"},
    {k:"empAdd",icon:"â•"},
    {k:"__monthlyTotal__",icon:"ğŸ“Š",label:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"}
  ],
  reportTypes: [
    {k:"dailyRevenue",label:"Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙŠÙˆÙ…ÙŠØ©"},
    {k:"bankRecon",label:"Ù…ÙˆØ§Ø²Ù†Ø§Øª Ø¨Ù†ÙƒÙŠØ©"},
    {k:"cashPurch",label:"Ù…Ø´ØªØ±ÙŠØ§Øª Ù†Ù‚Ø¯ÙŠØ©"},
    {k:"creditPurch",label:"Ù…Ø´ØªØ±ÙŠØ§Øª Ø¢Ø¬Ù„Ø©"},
    {k:"dailyMeals",label:"Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©"},
    {k:"empAdvance",label:"Ø³Ù„Ù/Ø³Ø­Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†"},
    {k:"supMaintenance",label:"ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø´Ø±Ù"},
    {k:"marketPurch",label:"Ù…Ø´ØªØ±ÙŠØ§Øª Ø³ÙˆÙ‚ÙŠØ©"},
    {k:"mgrMaintenance",label:"ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø¯ÙŠØ±"},
    {k:"mgrPurch",label:"Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±"}
  ]
};

/*
  Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø© Ø­ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
  Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØ³ØªØ®Ø¯Ù… localStorage Ù„Ù„Ø¨Ø³Ø§Ø·Ø©ØŒ Ù„ÙƒÙ† Ù„Ù„Ø¥Ù†ØªØ§Ø¬ ÙŠÙÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…:

  1. Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQL (MySQL/PostgreSQL):
     - Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ù†ÙØµÙ„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„ÙØ±ÙˆØ¹ØŒ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŒ Ø¥Ù„Ø®
     - Ø§Ø³ØªØ®Ø¯Ø§Ù… prepared statements Ù„Ù…Ù†Ø¹ SQL injection
     - Ø¥Ø¶Ø§ÙØ© indexes Ù„Ù„Ø£Ø¯Ø§Ø¡

  2. Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª NoSQL (MongoDB):
     - ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€JSON documents
     - Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªÙˆØ³Ø¹ ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±
     - Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©

  3. Backend API:
     - Node.js Ù…Ø¹ Express.js
     - PHP Ù…Ø¹ Laravel
     - Python Ù…Ø¹ Django/FastAPI
     - Ø¥Ø¶Ø§ÙØ© authentication Ø¨Ù€JWT
     - Ø¥Ø¶Ø§ÙØ© rate limiting Ùˆ validation

  4. Cloud Solutions:
     - Firebase (Ø³Ù‡Ù„ Ø§Ù„ØªÙƒØ§Ù…Ù„)
     - Supabase (PostgreSQL ÙƒØ®Ø¯Ù…Ø©)
     - MongoDB Atlas
     - AWS RDS Ø£Ùˆ Google Cloud SQL

  Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ backend Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯ÙˆØ§Ù„ DB Ø¨Ù€API calls.
*/

const DB = {
  load(){
    const raw = localStorage.getItem(DB_KEY);
    if(raw){ try { return JSON.parse(raw) } catch { /* ignore */ } }
    // seed default
    const seed = {
      company:{name:"Ø´Ø±ÙƒØ© Ø§Ù„Ø¬Ø¨Ø±Ù†ÙŠ",phone:"",cr:"",addr:""},
      users:[
        {id:uid(),name:"admin",pass:"admin123",role:"admin",perms:{
          branches: true, reports: true, settings: true, users: true,
          company: true, movement: true, editData: true, financial: true,
          dashboard: true, accounts: true
        }}
      ],
      branches:[
        {id:"branch-main",name:"Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ",manager:"Ù…Ø¯ÙŠØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ",loc:"Ø§Ù„Ø±ÙŠØ§Ø¶"},
        {id:"branch-north",name:"ÙØ±Ø¹ Ø§Ù„Ø´Ù…Ø§Ù„",manager:"Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯",loc:"Ø§Ù„Ø¯Ù…Ø§Ù…"}
      ],
      employees:{}, // branchId => [ {name,salary,phone,role} ]
      records:{},    // branchId => { formKey: [rows] }
      expenses:{},   // branchId => { rent, salaries, admin, bank, loss, other }
      savedReports:[], // { id, type, branchId, date, title, reports:[] }
      accounts: {},
      financialData: {
        accounts: {
          assets: [
            {id: uid(), name: "Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©", balance: 50000},
            {id: uid(), name: "Ø§Ù„Ø¨Ù†Ùƒ", balance: 150000},
            {id: uid(), name: "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", balance: 30000}
          ],
          liabilities: [
            {id: uid(), name: "Ø§Ù„Ù‚Ø±ÙˆØ¶", balance: 40000},
            {id: uid(), name: "Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", balance: 25000}
          ],
          equity: [
            {id: uid(), name: "Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„", balance: 100000},
            {id: uid(), name: "Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø­ØªØ¬Ø²Ø©", balance: 65000}
          ],
          revenue: [
            {id: uid(), name: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", balance: 200000},
            {id: uid(), name: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰", balance: 15000}
          ],
          expenses: [
            {id: uid(), name: "Ø§Ù„Ø±ÙˆØ§ØªØ¨", balance: 80000},
            {id: uid(), name: "Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±", balance: 24000},
            {id: uid(), name: "Ø§Ù„Ù…Ø±Ø§ÙÙ‚", balance: 5000},
            {id: uid(), name: "Ø§Ù„ØµÙŠØ§Ù†Ø©", balance: 7000}
          ]
        }
      },
      // New data structures for notifications and tasks
      notifications: [],
      tasks: [],
      backupHistory: [],
      transactions: {}
    };

    // Initialize permissions for admin user
    PERMISSIONS.forEach(p => {
      seed.users[0].perms[p.k] = true;
    });

    // init containers for default branches
    seed.branches.forEach(branch => {
      seed.records[branch.id] = {};
      Object.keys(MODELS.forms).forEach(k=> seed.records[branch.id][k] = []);
      seed.employees[branch.id] = [];
      seed.expenses[branch.id] = {};
    });


    localStorage.setItem(DB_KEY, JSON.stringify(seed));
    return seed;
  },
  save(){
    localStorage.setItem(DB_KEY, JSON.stringify(State.db));

    // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ø¹ backend:
    // return fetch('/api/save', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify(State.db)
    // }).then(res => res.json());
  }
}
const State = { db: DB.load(), user:null, currentBranch:null, selectedReportTypes:[] };

function ensureBranchContainers(bid){
  if(!State.db.records[bid]) State.db.records[bid] = {};
  Object.keys(MODELS.forms).forEach(k=>{
    if(!State.db.records[bid][k]) State.db.records[bid][k] = [];
  });
  if(!State.db.employees[bid]) State.db.employees[bid] = [];
  if(!State.db.expenses[bid]) State.db.expenses[bid] = {};
}





/* ========= Notification System ========= */
/*
  Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:
  - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø­Ø§ÙƒØ§Ø©
  - ØªØªØ¨Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
*/
const Notification = {
  show(message, type = 'success', duration = 3000) {
    const notification = q('#notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.className = 'notification';
    notification.classList.add(type);
    notification.classList.add('show');
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, duration);
  }
};

/* ========= Loading Overlay ========= */
const Loading = {
  show(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...') {
    const overlay = q('#loadingOverlay');
    const text = q('#loadingText');
    if (!overlay || !text) return;

    text.textContent = message;
    overlay.classList.remove('hidden');
  },

  hide() {
    const overlay = q('#loadingOverlay');
    if (overlay) overlay.classList.add('hidden');
  }
};

/* ========= New Notifications Module ========= */
const Notifications = {
  list: [],

  init() {
    this.list = State.db.notifications || [];
    this.updateBadge();
    this.renderList();
  },

  add(title, message, type = 'info', priority = 'normal') {
    const notification = {
      id: uid(),
      title,
      message,
      type,
      priority,
      date: new Date().toISOString(),
      read: false
    };

    this.list.unshift(notification);
    State.db.notifications = this.list;
    DB.save();

    this.updateBadge();
    this.showNotification(notification);
    this.renderList();
  },

  showNotification(notification) {
    const container = q('#notificationContainer');
    const notificationEl = document.createElement('div');
    notificationEl.className = `notification ${notification.type}`;
    notificationEl.innerHTML = `
      <div class="notification-content">
        <div style="font-weight: bold;">${notification.title}</div>
        <div>${notification.message}</div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 5px;">
          ${new Date(notification.date).toLocaleTimeString('ar-SA')}
        </div>
      </div>
      <button class="notification-close" onclick="Notifications.closeNotification('${notification.id}')">Ã—</button>
    `;

    container.appendChild(notificationEl);

    // Auto remove after 5 seconds
    setTimeout(() => {
      if (notificationEl.parentNode) {
        notificationEl.style.opacity = '0';
        setTimeout(() => {
          if (notificationEl.parentNode) {
            container.removeChild(notificationEl);
          }
        }, 300);
      }
    }, 5000);
  },

  closeNotification(id) {
    const notificationEl = q(`[data-notification-id="${id}"]`);
    if (notificationEl) {
      notificationEl.style.opacity = '0';
      setTimeout(() => {
        if (notificationEl.parentNode) {
          notificationEl.parentNode.removeChild(notificationEl);
        }
      }, 300);
    }

    this.markAsRead(id);
  },

  markAsRead(id) {
    const notification = this.list.find(n => n.id === id);
    if (notification) {
      notification.read = true;
      State.db.notifications = this.list;
      DB.save();
      this.updateBadge();
      this.renderList();
    }
  },

  markAllAsRead() {
    this.list.forEach(notification => {
      notification.read = true;
    });
    State.db.notifications = this.list;
    DB.save();
    this.updateBadge();
    this.renderList();
  },

  updateBadge() {
    const unreadCount = this.list.filter(n => !n.read).length;
    const badge = q('#notificationCount');

    if (unreadCount > 0) {
      badge.textContent = unreadCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  },

  renderList() {
    const container = q('#notificationsContainer');
    if (!container) return;

    const unreadNotifications = this.list.filter(n => !n.read);
    const readNotifications = this.list.filter(n => n.read);

    let html = '';

    if (unreadNotifications.length === 0 && readNotifications.length === 0) {
      html = '<div class="muted" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
    } else {
      if (unreadNotifications.length > 0) {
        html += '<div style="font-weight: bold; margin-bottom: 10px;">ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡</div>';
        unreadNotifications.slice(0, 5).forEach(notification => {
          html += this.renderNotificationItem(notification);
        });
      }

      if (readNotifications.length > 0) {
        html += '<div style="font-weight: bold; margin: 15px 0 10px 0;">Ù…Ù‚Ø±ÙˆØ¡</div>';
        readNotifications.slice(0, 5).forEach(notification => {
          html += this.renderNotificationItem(notification);
        });
      }

      if (this.list.length > 5) {
        html += `<div style="text-align: center; margin-top: 10px;">
          <button class="btn ghost" onclick="Notifications.showAll()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
        </div>`;
      }
    }

    container.innerHTML = html;
  },

  renderNotificationItem(notification) {
    return `
      <div class="notification-item" style="padding: 10px; border-bottom: 1px solid var(--line);">
        <div style="font-weight: ${notification.read ? 'normal' : 'bold'};">${notification.title}</div>
        <div style="font-size: 13px; color: var(--muted);">${notification.message}</div>
        <div style="font-size: 11px; color: var(--muted); margin-top: 5px;">
          ${new Date(notification.date).toLocaleString('ar-SA')}
        </div>
      </div>
    `;
  },

  toggleList() {
    const list = q('#notificationsList');
    list.classList.toggle('hidden');
  },

  showAll() {
    // Implement view all notifications page
    alert('Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
  },

  // Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø­Ø§ÙƒÙ‰
  sendEmail(to, subject, body, type = 'info') {
    // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ù†Ø§ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    // Ø§Ù„Ø¢Ù† Ø³Ù†Ø­Ø§ÙƒÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª

    const emailRecord = {
      id: uid(),
      to,
      subject,
      body,
      type,
      status: 'sent', // ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø³ÙŠÙƒÙˆÙ† 'pending' Ø«Ù… 'sent' Ø£Ùˆ 'failed'
      timestamp: new Date().toISOString(),
      userId: State.user ? State.user.id : 'system'
    };

    if (!State.db.emailLogs) State.db.emailLogs = [];
    State.db.emailLogs.push(emailRecord);

    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 200 Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    if (State.db.emailLogs.length > 200) {
      State.db.emailLogs = State.db.emailLogs.slice(-200);
    }

    DB.save();

    Security.log('info', `Email sent to ${to}: ${subject}`, { emailId: emailRecord.id });

    // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠ
    this.add('Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ù„Ù‰ ${to}`, 'info');

    return emailRecord;
  },

  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
  notifyNewUser(userName, userRole) {
    const adminUsers = State.db.users.filter(u => u.role === 'admin');
    adminUsers.forEach(admin => {
      this.sendEmail(
        admin.name + '@company.com', // ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…',
        `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: ${userName} Ø¨Ø¯ÙˆØ± ${userRole}`,
        'info'
      );
    });
  },

  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  notifyDataChange(changeType, details) {
    const adminUsers = State.db.users.filter(u => u.role === 'admin');
    adminUsers.forEach(admin => {
      this.sendEmail(
        admin.name + '@company.com',
        `ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${changeType}`,
        `ØªÙ… ${changeType}: ${details}`,
        'warning'
      );
    });
  },

  // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
  getEmailLogs() {
    return State.db.emailLogs || [];
  }
};

/* ========= New Backup Module ========= */
const Backup = {
  createBackup() {
    try {
      const backupData = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        data: State.db
      };

      const backupStr = JSON.stringify(backupData);
      const blob = new Blob([backupStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `aljaberni_backup_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Add to backup history
      State.db.backupHistory = State.db.backupHistory || [];
      State.db.backupHistory.unshift({
        date: new Date().toISOString(),
        type: 'manual',
        size: backupStr.length
      });

      // Keep only last 10 backups in history
      if (State.db.backupHistory.length > 10) {
        State.db.backupHistory.pop();
      }

      DB.save();

      Notifications.add('Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
      this.updateStatus('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'backup-success');
    } catch (error) {
      console.error('Backup error:', error);
      Notifications.add('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
      this.updateStatus('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'backup-error');
    }
  },

  restoreBackup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const backupData = JSON.parse(event.target.result);

          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
            // Validate backup data structure
            if (backupData.data && backupData.data.company && backupData.data.users) {
              State.db = backupData.data;
              DB.save();

              // Reload the application
              location.reload();
            } else {
              throw new Error('Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­');
            }
          }
        } catch (error) {
          console.error('Restore error:', error);
          Notifications.add('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
          this.updateStatus('ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'backup-error');
        }
      };

      reader.readAsText(file);
    };

    input.click();
  },

  downloadTemplate() {
    const template = {
      company: {name: "", phone: "", cr: "", addr: ""},
      branches: [{name: "ÙØ±Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ", manager: "Ù…Ø¯ÙŠØ±", loc: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"}],
      employees: {},
      records: {},
      expenses: {}
    };

    const templateStr = JSON.stringify(template, null, 2);
    const blob = new Blob([templateStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'aljaberni_template.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    Notifications.add('Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'info');
  },

  updateStatus(message, className) {
    const statusEl = q('#backupStatus');
    if (!statusEl) return;
    statusEl.textContent = message;
    statusEl.className = `backup-status ${className}`;

    setTimeout(() => {
      statusEl.textContent = '';
      statusEl.className = 'backup-status';
    }, 5000);
  },

  // Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  initAutoBackup() {
    // Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
    setInterval(() => {
      this.performAutoBackup();
    }, 24 * 60 * 60 * 1000); // 24 Ø³Ø§Ø¹Ø©

    // Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('beforeunload', () => {
      this.performAutoBackup();
    });
  },

  performAutoBackup() {
    try {
      const lastBackup = localStorage.getItem('lastAutoBackup');
      const now = new Date().getTime();

      // Ù„Ø§ Ù†ÙØ¹Ù„ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± ÙˆØ§Ø­Ø¯ Ù…Ù†Ø° Ø£Ù‚Ù„ Ù…Ù† 6 Ø³Ø§Ø¹Ø§Øª
      if (lastBackup && (now - parseInt(lastBackup)) < 6 * 60 * 60 * 1000) {
        return;
      }

      const backupData = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        data: State.db,
        type: 'auto'
      };

      const backupStr = JSON.stringify(backupData);
      const blob = new Blob([backupStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      // Ø­ÙØ¸ ÙÙŠ localStorage ÙƒØ¨Ø¯ÙŠÙ„
      localStorage.setItem('autoBackup_' + new Date().toISOString().slice(0, 10), backupStr);
      localStorage.setItem('lastAutoBackup', now.toString());

      // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
      State.db.backupHistory = State.db.backupHistory || [];
      State.db.backupHistory.unshift({
        date: new Date().toISOString(),
        type: 'auto',
        size: backupStr.length
      });

      // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 30 Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
      if (State.db.backupHistory.length > 30) {
        State.db.backupHistory = State.db.backupHistory.slice(0, 30);
      }

      DB.save();

      Security.log('info', 'Auto backup performed successfully', { size: backupStr.length });

      URL.revokeObjectURL(url);

    } catch (error) {
      Security.log('error', 'Auto backup failed', { error: error.message });
    }
  },

  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  restoreAutoBackup(date) {
    try {
      const backupStr = localStorage.getItem('autoBackup_' + date);
      if (!backupStr) {
        Notifications.add('Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
        return;
      }

      const backupData = JSON.parse(backupStr);

      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
        State.db = backupData.data;
        DB.save();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        location.reload();
      }
    } catch (error) {
      Security.log('error', 'Auto backup restore failed', { error: error.message });
      Notifications.add('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
    }
  },

  // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©
  getAvailableAutoBackups() {
    const backups = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('autoBackup_')) {
        const date = key.replace('autoBackup_', '');
        backups.push({
          date,
          key,
          size: localStorage.getItem(key).length
        });
      }
    }
    return backups.sort((a, b) => b.date.localeCompare(a.date));
  }
};

/* ========= New Tasks Module ========= */
const Tasks = {
  init() {
    this.renderTasks();
  },

  addTask() {
    const taskInput = q('#newTask');
    const taskText = taskInput.value.trim();

    if (!taskText) return;

    State.db.tasks = State.db.tasks || [];
    State.db.tasks.push({
      id: uid(),
      text: taskText,
      completed: false,
      createdAt: new Date().toISOString(),
      createdBy: State.user ? State.user.name : 'System'
    });

    DB.save();
    taskInput.value = '';
    this.renderTasks();

    Notifications.add('Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©: ${taskText}`, 'info');
  },

  toggleTask(id) {
    const task = State.db.tasks.find(t => t.id === id);
    if (task) {
      task.completed = !task.completed;
      DB.save();
      this.renderTasks();
    }
  },

  deleteTask(id) {
    State.db.tasks = State.db.tasks.filter(t => t.id !== id);
    DB.save();
    this.renderTasks();
  },

  renderTasks() {
    const container = q('#tasksList');
    if (!container) return;

    const tasks = State.db.tasks || [];

    if (tasks.length === 0) {
      container.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ©</div>';
      return;
    }

    let html = '';
    tasks.slice(0, 5).forEach(task => {
      html += `
        <div class="task-item ${task.completed ? 'task-completed' : ''}">
          <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}
                 onchange="Tasks.toggleTask('${task.id}')">
          <div style="flex: 1;">${task.text}</div>
          <button class="btn danger" style="padding: 4px 8px; font-size: 12px;"
                  onclick="Tasks.deleteTask('${task.id}')">Ø­Ø°Ù</button>
        </div>
      `;
    });

    if (tasks.length > 5) {
      html += `<div style="text-align: center; margin-top: 10px;">
        <button class="btn ghost">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
      </div>`;
    }

    container.innerHTML = html;
  }
};

/* ========= Auth ========= */
const Auth = {
  populateUsers(){
    const sel = q("#loginUser");
    if (!sel) return;
    sel.innerHTML = State.db.users.map(u=>`<option value="${u.id}">${u.name} (${u.role})</option>`).join("");
  },

  handleLoginEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'loginBtn') {
        this.login();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },
  login(){
    const id = q("#loginUser")?.value;
    const pass = q("#loginPass")?.value.trim();
    if (!id || !pass) {
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "error");
      Security.logActivity('login_failed', { reason: 'missing_credentials' });
      return;
    }

    const user = State.db.users.find(u=>u.id===id);
    if(!user || !Security.verifyPassword(pass, user.pass)){
      Notification.show("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©", "error");
      Security.logActivity('login_failed', { userId: id, reason: 'invalid_credentials' });
      return;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø§Ù…Ù†Ø­Ù‡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    let userPerms = user.perms || {};
    if (user.role === 'admin') {
      userPerms = {};
      PERMISSIONS.forEach(perm => {
        userPerms[perm.k] = true;
      });
    }

    State.user = {
      id: user.id,
      name: user.name,
      role: user.role,
      perms: userPerms,
      branchId: user.branchId || null
    };

    Security.logActivity('login_success', { userId: user.id, userName: user.name, role: user.role });

    // ØªØ·Ø¨ÙŠÙ‚ Ø«ÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    Settings.applyUserTheme(user.role === 'branch-manager' ? 'manager' : user.role);

    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    setTimeout(() => {
      Settings.updateUIBasedOnPermissions();
    }, 100);

    // Initialize notifications and tasks
    Notifications.init();
    Tasks.init();

    // Initialize auto backup
    Backup.initAutoBackup();

    // Convert encrypted passwords to plain text if needed
    const downgraded = Security.downgradePasswords();

    // Check password status for debugging (only in development)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      Security.checkPasswordStatus();
    }

    // Show downgrade notification if passwords were converted
    if (downgraded) {
      setTimeout(() => {
        Notifications.add('ğŸ”“ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙÙŠØ±', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± - Ø§Ø³ØªØ®Ø¯Ù… admin123 Ù„Ù„Ø¯Ø®ÙˆÙ„', 'warning');
      }, 2000);
    }

    // Send welcome notification
    const roleLabel = Settings.getRoleLabel(user.role);
    Notifications.add('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ', `Ø£Ù‡Ù„Ø§Ù‹ ${user.name} (${roleLabel})ØŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­`, 'success');

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ± ÙØ±Ø¹ØŒ Ø§Ø°Ù‡Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ÙØ±Ø¹Ù‡
    if (user.role === 'branch-manager' && user.branchId) {
      Router.go('branch', {branchId: user.branchId});
    } else {
      Router.go('home');
    }
  },
  logout(){
    Notifications.add('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‚Ø§Ø¡ ${State.user.name}`, 'info');

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø«ÙŠÙ…
    Settings.applyUserTheme(null);

    State.user = null;
    Router.go('login');
  },
  hasPermission(permission) {
    if (!State.user) return false;
    if (State.user.role === 'admin') return true;
    return State.user.perms && State.user.perms[permission] === true;
  }
};




/* ========= Branch Management ========= */
const BranchManagement = {
  toggle() {
    const panel = q('#branchManagement');
    if (!panel) return;
    
    panel.classList.toggle('show');
    this.renderBranchesList();
  },
  
  renderBranchesList() {
    const list = q('#branchesList');
    if (!list) return;
    
    list.innerHTML = State.db.branches.map(b => `
      <div class="card" style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${b.name}</strong>
            <div class="muted">${b.manager || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ±'} - ${b.loc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹'}</div>
          </div>
          <button class="btn danger" onclick="BranchManagement.deleteBranch('${b.id}')">Ø­Ø°Ù</button>
        </div>
      </div>
    `).join('');
  },
  
  addBranch() {
    const nameInput = q('#branchName');
    const managerInput = q('#branchManager');
    const locationInput = q('#branchLocation');

    if (!nameInput || !managerInput || !locationInput) {
      Notifications.add("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„", "error");
      return;
    }

    const name = nameInput.value.trim();
    const manager = managerInput.value.trim();
    const location = locationInput.value.trim();

    if (!name) {
      Notifications.add("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹", "error");
      return;
    }

    try {
      const id = uid();
      const newBranch = {id, name, manager: manager || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', loc: location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'};

      State.db.branches.push(newBranch);
      ensureBranchContainers(id);
      DB.save();

      // Clear inputs
      nameInput.value = '';
      managerInput.value = '';
      locationInput.value = '';

      this.renderBranchesList();
      this.renderBranchManagementList();
      UI.renderBranches();
      Dashboard.populateBranchSelector();

      Notifications.add("ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯", `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ "${name}" Ø¨Ù†Ø¬Ø§Ø­`, "success");

    } catch (error) {
      console.error('Error adding branch:', error);
      Notifications.add("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹: " + error.message, "error");
    }
  },
  
  deleteBranch(id) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø£ÙŠØ¶Ø§Ù‹.")) return;

    State.db.branches = State.db.branches.filter(b => b.id !== id);
    delete State.db.records[id];
    delete State.db.employees[id];
    delete State.db.expenses[id];

    DB.save();
    this.renderBranchesList();
    UI.renderBranches();
    Notification.show("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­", "success");
  },

  // New methods for the branch management page
  render() {
    this.renderBranchManagementList();
    this.populateExpenseBranchSelector();
  },

  renderBranchManagementList() {
    const container = q('#branchManagementList');
    if (!container) return;

    let html = '';

    if (State.db.branches.length === 0) {
      html = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ù…Ø¶Ø§ÙØ©</div>';
    } else {
      html = '<table><thead><tr><th>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</th><th>Ø§Ù„Ù…Ø¯ÙŠØ±</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';

      State.db.branches.forEach(branch => {
        html += `
          <tr>
            <td>${branch.name}</td>
            <td>${branch.manager || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
            <td>${branch.loc || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
            <td>
              <button class="btn info" onclick="BranchManagement.editBranch('${branch.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn danger" onclick="BranchManagement.deleteBranch('${branch.id}')">Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
    }

    container.innerHTML = html;
  },

  editBranch(branchId) {
    const branch = State.db.branches.find(b => b.id === branchId);
    if (!branch) return;

    const newName = prompt('Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', branch.name);
    if (newName === null) return;

    const newManager = prompt('Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', branch.manager);
    if (newManager === null) return;

    const newLocation = prompt('Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', branch.loc);
    if (newLocation === null) return;

    branch.name = newName.trim() || branch.name;
    branch.manager = newManager.trim() || branch.manager;
    branch.loc = newLocation.trim() || branch.loc;

    DB.save();

    this.renderBranchManagementList();
    this.renderBranchesList();
    UI.renderBranches();
    Dashboard.populateBranchSelector();

    Notifications.add("ØªØ¹Ø¯ÙŠÙ„ ÙØ±Ø¹", `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹ "${branch.name}" Ø¨Ù†Ø¬Ø§Ø­`, "success");
  },

  // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙØ±ÙˆØ¹
  populateExpenseBranchSelector() {
    const expSel = q("#expBranch");
    if (expSel) {
      let html = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>';
      State.db.branches.forEach(branch => {
        html += `<option value="${branch.id}">${branch.name}</option>`;
      });
      expSel.innerHTML = html;
    }
  },

  loadBranchExpenses() {
    const branchId = q("#expBranch").value;
    if (branchId && State.db.expenses[branchId]) {
      const exp = State.db.expenses[branchId];
      q("#expRent").value = exp.rent || "";
      q("#expSalaries").value = exp.salaries || "";
      q("#expAdmin").value = exp.admin || "";
      q("#expBank").value = exp.bank || "";
      q("#expLoss").value = exp.loss || "";
      q("#expOther").value = exp.other || "";
    } else {
      this.clearExpenseForm();
    }
  },

  clearExpenseForm() {
    q("#expRent").value = "";
    q("#expSalaries").value = "";
    q("#expAdmin").value = "";
    q("#expBank").value = "";
    q("#expLoss").value = "";
    q("#expOther").value = "";
  },

  handleExpenseEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'saveExpensesBtn') {
        this.saveExpenses();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },

  saveExpenses() {
    const branchId = q("#expBranch").value;
    if (!branchId) {
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹", "error");
      return;
    }

    const rent = q("#expRent").value.trim();
    const salaries = q("#expSalaries").value.trim();
    const admin = q("#expAdmin").value.trim();
    const bank = q("#expBank").value.trim();
    const loss = q("#expLoss").value.trim();
    const other = q("#expOther").value.trim();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
    if (!rent || !salaries) {
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)", "error");
      return;
    }

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒØ§Ø¦Ù† expenses
    if (!State.db.expenses) {
      State.db.expenses = {};
    }

    State.db.expenses[branchId] = {
      rent: parseNum(rent),
      salaries: parseNum(salaries),
      admin: parseNum(admin),
      bank: parseNum(bank),
      loss: parseNum(loss),
      other: parseNum(other)
    };

    DB.save();
    Notification.show("ØªÙ… Ø­ÙØ¸ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­", "success");
  },

  handleBranchEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'addBranchBtn') {
        this.addBranch();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  }
};

/* ========= Router / Views ========= */
const Router = {
  go(view, params={}){
    if (!view) return;
    
    const viewElement = q(`#view-${view}`);
    if (!viewElement) {
      console.error(`View ${view} not found`);
      return;
    }
    
    qa("[id^=view-]").forEach(s=>s.classList.add("hidden"));
    
    switch(view) {
      case 'login':
        Auth.populateUsers();
        q("#view-login").classList.remove("hidden");
        q("header.top")?.classList.add("hidden");
        break;
      case 'home':
      case 'dashboard':
      case 'financial-reports':
      case 'branch-management':
      case 'accounts':
      case 'branch':
      case 'form':
      case 'reports':
      case 'daily-reports':
      case 'monthly-reports':
      case 'custom-reports':
      case 'saved-reports':
      case 'profit-loss':
      case 'report-display':
      case 'movement':
      case 'settings':
        viewElement.classList.remove("hidden");
        q("header.top")?.classList.remove("hidden");
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ÙƒÙ„ Ø¹Ø±Ø¶
        if (view === 'home') UI.renderBranches();
        if (view === 'dashboard') Dashboard.load();
        if (view === 'financial-reports') FinancialReports.init();
        if (view === 'branch-management') BranchManagement.render();
        if (view === 'accounts') Accounts.init();
        if (view === 'branch' && params.branchId) UI.openBranch(params.branchId);
        if (view === 'form' && params.formKey && params.branchId) UI.renderFormPage(params.formKey, params.branchId);
        if (view === 'daily-reports') Reports.populateDaily();
        if (view === 'monthly-reports') Reports.populateMonthly();
        if (view === 'custom-reports') Reports.populateCustom();
        if (view === 'saved-reports') Reports.showSavedReports();
        if (view === 'profit-loss') Reports.populateProfitLoss();
        if (view === 'movement') Movement.populate();
        if (view === 'settings') Settings.render();
        break;
      default:
        console.error(`Unknown view: ${view}`);
    }
    
    history.replaceState({view,params},"","#"+view);
  }
};

/* ========= Dashboard ========= */
const Dashboard = {
  load() {
    this.updateStats();
    this.loadTopBranches();
    this.loadRecentTransactions();
    this.loadAlerts();
    this.loadCharts();
  },

  updateStats() {
    const selectedBranch = q("#dashboardBranch").value;

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙÙ‚Ø·)
    let totalIncome = 0;
    let totalExpenses = 0;
    let totalCars = 0;

    Object.keys(State.db.records).forEach(branchId => {
      if (selectedBranch !== "all" && branchId !== selectedBranch) return;

      if (State.db.records[branchId].dailyRevenue) {
        State.db.records[branchId].dailyRevenue.forEach(record => {
          totalIncome += parseNum(record.network) + parseNum(record.cash) + parseNum(record.credit);
          totalCars += parseNum(record.cars);
        });
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª
      ['cashPurch', 'creditPurch', 'dailyMeals', 'empAdvance', 'supMaintenance', 'marketPurch', 'mgrMaintenance', 'mgrPurch'].forEach(formKey => {
        if (State.db.records[branchId][formKey]) {
          State.db.records[branchId][formKey].forEach(record => {
            totalExpenses += parseNum(record.price) + parseNum(record.amount) + parseNum(record.take);
          });
        }
      });
    });

    const netProfit = totalIncome - totalExpenses;

    q('#total-income').textContent = fmt(totalIncome) + ' Ø±.Ø³';
    q('#total-expenses').textContent = fmt(totalExpenses) + ' Ø±.Ø³';
    q('#net-profit').textContent = fmt(netProfit) + ' Ø±.Ø³';
    q('#total-cars').textContent = totalCars;

    // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©
    const netProfitEl = q('#net-profit');
    if (netProfit > 0) {
      netProfitEl.style.color = 'var(--accent)';
    } else if (netProfit < 0) {
      netProfitEl.style.color = 'var(--danger)';
    } else {
      netProfitEl.style.color = 'var(--muted)';
    }
  },

  loadTopBranches() {
    const branchStats = [];

    State.db.branches.forEach(branch => {
      let branchIncome = 0;
      let branchExpenses = 0;

      if (State.db.records[branch.id] && State.db.records[branch.id].dailyRevenue) {
        State.db.records[branch.id].dailyRevenue.forEach(record => {
          branchIncome += parseNum(record.network) + parseNum(record.cash) + parseNum(record.credit);
        });
      }

      ['cashPurch', 'creditPurch', 'dailyMeals', 'empAdvance', 'supMaintenance', 'marketPurch', 'mgrMaintenance', 'mgrPurch'].forEach(formKey => {
        if (State.db.records[branch.id] && State.db.records[branch.id][formKey]) {
          State.db.records[branch.id][formKey].forEach(record => {
            branchExpenses += parseNum(record.price) + parseNum(record.amount) + parseNum(record.take);
          });
        }
      });

      branchStats.push({
        name: branch.name,
        income: branchIncome,
        expenses: branchExpenses,
        profit: branchIncome - branchExpenses
      });
    });

    branchStats.sort((a, b) => b.profit - a.profit);

    let html = '';
    branchStats.slice(0, 5).forEach((branch, index) => {
      html += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--line);">
          <div>
            <div style="font-weight: bold;">${index + 1}. ${branch.name}</div>
            <div style="font-size: 12px; color: var(--muted);">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${fmt(branch.income)} Ø±.Ø³</div>
          </div>
          <div style="text-align: left;">
            <div style="font-weight: bold; color: ${branch.profit >= 0 ? 'var(--accent)' : 'var(--danger)'};">
              ${fmt(branch.profit)} Ø±.Ø³
            </div>
          </div>
        </div>
      `;
    });

    q('#top-branches-list').innerHTML = html || '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
  },

  loadRecentTransactions() {
    // Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª
    const recentTransactions = [];

    Object.keys(State.db.records).forEach(branchId => {
      const branchName = State.db.branches.find(b => b.id === branchId)?.name || 'ÙØ±Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

      Object.keys(State.db.records[branchId]).forEach(formKey => {
        const formLabel = MODELS.forms[formKey]?.label || formKey;
        State.db.records[branchId][formKey].forEach(record => {
          if (record.date) {
            recentTransactions.push({
              date: record.date,
              branch: branchName,
              type: formLabel,
              amount: parseNum(record.network) + parseNum(record.cash) + parseNum(record.credit) + parseNum(record.price) + parseNum(record.amount) + parseNum(record.take),
              description: record.note || record.item || record.desc || 'Ù…Ø¹Ø§Ù…Ù„Ø©'
            });
          }
        });
      });
    });

    recentTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = '';
    recentTransactions.slice(0, 5).forEach(transaction => {
      html += `
        <div style="padding: 8px 0; border-bottom: 1px solid var(--line);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: bold;">${transaction.type}</div>
              <div style="font-size: 12px; color: var(--muted);">${transaction.branch} - ${transaction.date}</div>
            </div>
            <div style="font-weight: bold; color: var(--accent);">
              ${fmt(transaction.amount)} Ø±.Ø³
            </div>
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            ${transaction.description}
          </div>
        </div>
      `;
    });

    q('#recent-transactions').innerHTML = html || '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø¯ÙŠØ«Ø©</div>';
  },

  loadAlerts() {
    const alerts = [];

    // ÙØ­Øµ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙ‡Ø§ Ø®Ø³Ø§Ø¦Ø±
    State.db.branches.forEach(branch => {
      let branchIncome = 0;
      let branchExpenses = 0;

      if (State.db.records[branch.id] && State.db.records[branch.id].dailyRevenue) {
        State.db.records[branch.id].dailyRevenue.forEach(record => {
          branchIncome += parseNum(record.network) + parseNum(record.cash) + parseNum(record.credit);
        });
      }

      ['cashPurch', 'creditPurch', 'dailyMeals', 'empAdvance', 'supMaintenance', 'marketPurch', 'mgrMaintenance', 'mgrPurch'].forEach(formKey => {
        if (State.db.records[branch.id] && State.db.records[branch.id][formKey]) {
          State.db.records[branch.id][formKey].forEach(record => {
            branchExpenses += parseNum(record.price) + parseNum(record.amount) + parseNum(record.take);
          });
        }
      });

      if (branchExpenses > branchIncome) {
        alerts.push({
          type: 'warning',
          message: `ÙØ±Ø¹ ${branch.name} ÙŠØ­Ù‚Ù‚ Ø®Ø³Ø§Ø¦Ø± Ø¨Ù‚ÙŠÙ…Ø© ${fmt(branchExpenses - branchIncome)} Ø±.Ø³`
        });
      }
    });

    let html = '';
    if (alerts.length === 0) {
      html = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>';
    } else {
      alerts.forEach(alert => {
        html += `
          <div style="padding: 8px 12px; margin: 8px 0; border-left: 4px solid var(--warn); background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
            âš ï¸ ${alert.message}
          </div>
        `;
      });
    }

    q('#important-alerts').innerHTML = html;
  },

  loadCharts() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Chart.js
    if (typeof Chart === 'undefined') {
      console.warn('Chart.js not loaded');
      return;
    }

    // Income vs Expense Chart
    const incomeExpenseCtx = q('#incomeExpenseChartCanvas');
    const expensesCtx = q('#expensesChartCanvas');

    if (!incomeExpenseCtx || !expensesCtx) return;

    // Sample data for charts - ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    const chartData = {
      income: [12000, 15000, 18000, 14000, 16000, 19000],
      expenses: [8000, 9000, 11000, 9500, 10000, 10500],
      expenseCategories: ['Ø±ÙˆØ§ØªØ¨', 'Ø¥ÙŠØ¬Ø§Ø±', 'Ù…ÙˆØ§Ø¯', 'ØµÙŠØ§Ù†Ø©', 'Ø£Ø®Ø±Ù‰'],
      expenseValues: [5000, 3000, 2000, 1500, 1000]
    };

    // Income vs Expense Chart
    new Chart(incomeExpenseCtx, {
      type: 'line',
      data: {
        labels: ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ'],
        datasets: [
          {
            label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
            data: chartData.income,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true
          },
          {
            label: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
            data: chartData.expenses,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb'
            }
          }
        },
        scales: {
          y: {
            ticks: {
              color: '#e5e7eb'
            },
            grid: {
              color: '#374151'
            }
          },
          x: {
            ticks: {
              color: '#e5e7eb'
            },
            grid: {
              color: '#374151'
            }
          }
        }
      }
    });

    // Expenses Distribution Chart
    new Chart(expensesCtx, {
      type: 'doughnut',
      data: {
        labels: chartData.expenseCategories,
        datasets: [{
          data: chartData.expenseValues,
          backgroundColor: [
            '#3b82f6',
            '#10b981',
            '#f59e0b',
            '#ef4444',
            '#8b5cf6'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb'
            }
          }
        }
      }
    });
  },

  populateBranchSelector() {
    const selector = q("#dashboardBranch");
    if (!selector) return;

    selector.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>';

    State.db.branches.forEach(branch => {
      const option = document.createElement("option");
      option.value = branch.id;
      option.textContent = branch.name;
      selector.appendChild(option);
    });
  },

  handleDashboardEnterKey(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      this.load(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    }
  }
};

/* ========= Financial Reports ========= */
const FinancialReports = {
  currentTab: 'trial-balance',

  init() {
    this.setDefaultDates();
  },

  setDefaultDates() {
    q('#report-from').value = firstOfMonthStr();
    q('#report-to').value = todayStr();
  },

  handleReportEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'generateReportBtn') {
        this.generate();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },

  switchTab(tab) {
    this.currentTab = tab;
    qa('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
  },

  generate() {
    const fromDate = q('#report-from').value;
    const toDate = q('#report-to').value;

    if (!fromDate || !toDate) {
      Notifications.add('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©', 'error');
      return;
    }

    let reportHTML = '';

    switch (this.currentTab) {
      case 'trial-balance':
        reportHTML = this.generateTrialBalance(fromDate, toDate);
        break;
      case 'income-statement':
        reportHTML = this.generateIncomeStatement(fromDate, toDate);
        break;
      case 'balance-sheet':
        reportHTML = this.generateBalanceSheet(fromDate, toDate);
        break;
    }

    q('#financial-report-result').innerHTML = reportHTML;
  },

  generateTrialBalance(fromDate, toDate) {
    const accounts = State.db.financialData.accounts;
    let totalDebit = 0;
    let totalCredit = 0;

    let tableHTML = `
      <div class="report-header">
        <h2>Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
        <div>Ù„Ù„ÙØªØ±Ø© Ù…Ù† ${fromDate} Ø¥Ù„Ù‰ ${toDate}</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
            <th>Ù…Ø¯ÙŠÙ†</th>
            <th>Ø¯Ø§Ø¦Ù†</th>
          </tr>
        </thead>
        <tbody>
    `;

    // Ø§Ù„Ø£ØµÙˆÙ„
    accounts.assets.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>${fmt(account.balance)}</td>
          <td>-</td>
        </tr>
      `;
      totalDebit += account.balance;
    });

    // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    accounts.expenses.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>${fmt(account.balance)}</td>
          <td>-</td>
        </tr>
      `;
      totalDebit += account.balance;
    });

    // Ø§Ù„Ø®ØµÙˆÙ…
    accounts.liabilities.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>-</td>
          <td>${fmt(account.balance)}</td>
        </tr>
      `;
      totalCredit += account.balance;
    });

    // Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©
    accounts.equity.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>-</td>
          <td>${fmt(account.balance)}</td>
        </tr>
      `;
      totalCredit += account.balance;
    });

    // Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
    accounts.revenue.forEach(account => {
      tableHTML += `
        <tr>
          <td>${account.name}</td>
          <td>-</td>
          <td>${fmt(account.balance)}</td>
        </tr>
      `;
      totalCredit += account.balance;
    });

    tableHTML += `
        <tr style="font-weight: bold; background: rgba(16, 185, 129, 0.1);">
          <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
          <td>${fmt(totalDebit)}</td>
          <td>${fmt(totalCredit)}</td>
        </tr>
      </tbody>
    </table>
    `;

    return tableHTML;
  },

  generateIncomeStatement(fromDate, toDate) {
    const accounts = State.db.financialData.accounts;
    let totalRevenue = 0;
    let totalExpenses = 0;

    accounts.revenue.forEach(account => {
      totalRevenue += account.balance;
    });

    accounts.expenses.forEach(account => {
      totalExpenses += account.balance;
    });

    const netIncome = totalRevenue - totalExpenses;

    const header = `
      <div class="report-header">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h2>
        <div>Ù„Ù„ÙØªØ±Ø© Ù…Ù† ${fromDate} Ø¥Ù„Ù‰ ${toDate}</div>
      </div>
    `;

    const content = `
      <div class="financial-summary">
        <div class="card">
          <h4>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h4>
          <div class="stat-value">${fmt(totalRevenue)} Ø±.Ø³</div>
        </div>
        <div class="card">
          <h4>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4>
          <div class="stat-value">${fmt(totalExpenses)} Ø±.Ø³</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th colspan="2">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          ${accounts.revenue.map(account => `
            <tr>
              <td>${account.name}</td>
              <td>${fmt(account.balance)} Ø±.Ø³</td>
            </tr>
          `).join('')}
          <tr style="font-weight: bold;">
            <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</td>
            <td>${fmt(totalRevenue)} Ø±.Ø³</td>
          </tr>
        </tbody>
      </table>

      <table style="margin-top: 20px;">
        <thead>
          <tr>
            <th colspan="2">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th>
          </tr>
        </thead>
        <tbody>
          ${accounts.expenses.map(account => `
            <tr>
              <td>${account.name}</td>
              <td>${fmt(account.balance)} Ø±.Ø³</td>
            </tr>
          `).join('')}
          <tr style="font-weight: bold;">
            <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</td>
            <td>${fmt(totalExpenses)} Ø±.Ø³</td>
          </tr>
          <tr style="font-weight: bold; background: ${netIncome >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};">
            <td>ØµØ§ÙÙŠ ${netIncome >= 0 ? 'Ø§Ù„Ø±Ø¨Ø­' : 'Ø§Ù„Ø®Ø³Ø§Ø±Ø©'}</td>
            <td>${fmt(Math.abs(netIncome))} Ø±.Ø³</td>
          </tr>
        </tbody>
      </table>
    `;

    return header + content;
  },

  generateBalanceSheet(fromDate, toDate) {
    const accounts = State.db.financialData.accounts;

    let totalAssets = 0;
    let totalLiabilities = 0;
    let totalEquity = 0;

    accounts.assets.forEach(account => {
      totalAssets += account.balance;
    });

    accounts.liabilities.forEach(account => {
      totalLiabilities += account.balance;
    });

    accounts.equity.forEach(account => {
      totalEquity += account.balance;
    });

    const header = `
      <div class="report-header">
        <h2>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</h2>
        <div>ÙƒÙ…Ø§ ÙÙŠ ${toDate}</div>
      </div>
    `;

    const content = `
      <div class="financial-summary">
        <div class="card">
          <h4>Ø§Ù„Ø£ØµÙˆÙ„</h4>
          <div class="stat-value">${fmt(totalAssets)} Ø±.Ø³</div>
        </div>
        <div class="card">
          <h4>Ø§Ù„Ø®ØµÙˆÙ…</h4>
          <div class="stat-value">${fmt(totalLiabilities)} Ø±.Ø³</div>
        </div>
        <div class="card">
          <h4>Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h4>
          <div class="stat-value">${fmt(totalEquity)} Ø±.Ø³</div>
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <table>
            <thead>
              <tr>
                <th colspan="2">Ø§Ù„Ø£ØµÙˆÙ„</th>
              </tr>
            </thead>
            <tbody>
              ${accounts.assets.map(account => `
                <tr>
                  <td>${account.name}</td>
                  <td>${fmt(account.balance)} Ø±.Ø³</td>
                </tr>
              `).join('')}
              <tr style="font-weight: bold;">
                <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„</td>
                <td>${fmt(totalAssets)} Ø±.Ø³</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="col-6">
          <table>
            <thead>
              <tr>
                <th colspan="2">Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</th>
              </tr>
            </thead>
            <tbody>
              ${accounts.liabilities.map(account => `
                <tr>
                  <td>${account.name}</td>
                  <td>${fmt(account.balance)} Ø±.Ø³</td>
                </tr>
              `).join('')}
              <tr style="font-weight: bold;">
                <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…</td>
                <td>${fmt(totalLiabilities)} Ø±.Ø³</td>
              </tr>
              ${accounts.equity.map(account => `
                <tr>
                  <td>${account.name}</td>
                  <td>${fmt(account.balance)} Ø±.Ø³</td>
                </tr>
              `).join('')}
              <tr style="font-weight: bold;">
                <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</td>
                <td>${fmt(totalEquity)} Ø±.Ø³</td>
              </tr>
              <tr style="font-weight: bold; background: rgba(16, 185, 129, 0.1);">
                <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</td>
                <td>${fmt(totalLiabilities + totalEquity)} Ø±.Ø³</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    `;

    return header + content;
  },

  exportPDF() {
    const reportContent = q('#financial-report-result').innerHTML;
    const printWindow = window.open('', '_blank');

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£ØµÙ„ÙŠ
    const originalStyles = `
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        * {
          box-sizing: border-box;
          font-family: 'Tajawal', system-ui, Segoe UI, Arial, sans-serif;
          margin: 0;
          padding: 0;
        }

        body {
          background: white !important;
          color: black !important;
          padding: 20px;
          direction: rtl;
          font-size: 14px;
          line-height: 1.6;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
        .card {
          background: white !important;
          border: 2px solid #1f2937 !important;
          border-radius: 12px !important;
          padding: 20px !important;
          margin: 20px 0 !important;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
        }

        .title {
          font-size: 24px !important;
          font-weight: bold !important;
          color: #1f2937 !important;
          margin-bottom: 10px !important;
          text-align: center !important;
        }

        .subtitle {
          font-size: 16px !important;
          color: #6b7280 !important;
          margin-bottom: 20px !important;
          text-align: center !important;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table {
          width: 100% !important;
          border-collapse: collapse !important;
          margin: 20px 0 !important;
          background: white !important;
          border: 2px solid #1f2937 !important;
          border-radius: 8px !important;
          overflow: hidden !important;
        }

        th, td {
          border: 1px solid #d1d5db !important;
          padding: 12px 8px !important;
          text-align: right !important;
          background: white !important;
          color: black !important;
        }

        th {
          background: #f3f4f6 !important;
          color: #1f2937 !important;
          font-weight: bold !important;
          font-size: 14px !important;
        }

        tr:nth-child(even) {
          background: #f9fafb !important;
        }

        tr:nth-child(odd) {
          background: white !important;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø§Ù„ÙŠ */
        .financial-summary {
          display: grid !important;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
          gap: 16px !important;
          margin: 20px 0 !important;
        }

        .financial-summary .card {
          background: white !important;
          border: 2px solid #22c55e !important;
          padding: 20px !important;
          text-align: center !important;
          border-radius: 12px !important;
        }

        .financial-summary .card h4 {
          color: #22c55e !important;
          font-size: 16px !important;
          margin-bottom: 8px !important;
        }

        .stat-value {
          font-size: 20px !important;
          font-weight: bold !important;
          color: #22c55e !important;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .report-header {
          text-align: center !important;
          margin-bottom: 30px !important;
          padding: 20px !important;
          border-bottom: 2px solid #22c55e !important;
        }

        .report-header h2 {
          color: #22c55e !important;
          font-size: 28px !important;
          margin-bottom: 10px !important;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø± */
        .profit-loss-table {
          width: 100% !important;
          border-collapse: collapse !important;
          margin: 20px 0 !important;
        }

        .profit-loss-table th {
          background: #f3f4f6 !important;
          padding: 12px !important;
          text-align: center !important;
          border: 1px solid #d1d5db !important;
          color: #1f2937 !important;
          font-weight: bold !important;
        }

        .profit-loss-table td {
          padding: 10px !important;
          border: 1px solid #d1d5db !important;
          text-align: center !important;
          background: white !important;
          color: black !important;
        }

        .profit-loss-total {
          font-weight: bold !important;
          background: rgba(16, 185, 129, 0.1) !important;
          color: #059669 !important;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        .no-print {
          display: none !important;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸ ÙÙŠ Ù…Ù„ÙØ§Øª PDF */
        .report-actions,
        .report-footer {
          display: none !important;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
          body {
            background: white !important;
            color: black !important;
            font-size: 12px !important;
          }

          .card {
            break-inside: avoid !important;
            page-break-inside: avoid !important;
          }

          table {
            page-break-inside: avoid !important;
          }

          /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
          .report-actions,
          .report-footer,
          button {
            display: none !important;
          }
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù†ØµÙˆØµ */
        .muted {
          color: #6b7280 !important;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
        .report-footer {
          margin-top: 40px !important;
          text-align: center !important;
          color: #6b7280 !important;
          font-size: 12px !important;
          border-top: 1px solid #d1d5db !important;
          padding-top: 20px !important;
        }
      </style>
    `;

    printWindow.document.write(`
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="utf-8">
        <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        ${originalStyles}
      </head>
      <body>
        ${reportContent}
      </body>
      </html>
    `);

    printWindow.document.close();

    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    printWindow.onload = function() {
      setTimeout(() => {
        printWindow.print();
      }, 500);
    };
  }
};

/* ========= Accounts Management ========= */
const Accounts = {
  currentTab: 'accounts',

  init() {
    this.populateBranchSelector();
    this.populateAccountSelector();
    this.renderAccounts();
  },

  switchTab(tab) {
    this.currentTab = tab;
    qa('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    if (tab === 'accounts') {
      q('#accounts-content').classList.remove('hidden');
      q('#transactions-content').classList.add('hidden');
      this.renderAccounts();
    } else {
      q('#accounts-content').classList.add('hidden');
      q('#transactions-content').classList.remove('hidden');
      this.loadTransactions();
    }
  },

  populateBranchSelector() {
    const selector = q('#transactionBranch');
    if (!selector) return;

    selector.innerHTML = State.db.branches.map(b =>
      `<option value="${b.id}">${b.name}</option>`
    ).join('');
  },

  populateAccountSelector() {
    const selector = q('#transactionAccount');
    if (!selector) return;

    let options = '';
    Object.keys(State.db.financialData.accounts).forEach(type => {
      State.db.financialData.accounts[type].forEach(account => {
        options += `<option value="${account.id}">${account.name}</option>`;
      });
    });

    selector.innerHTML = options;
  },

  addAccount() {
    const type = q('#accountType').value;
    const name = q('#accountName').value.trim();
    const balance = parseNum(q('#accountBalance').value);

    if (!name) {
      Notifications.add('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨', 'error');
      return;
    }

    const newAccount = {
      id: uid(),
      name,
      balance
    };

    State.db.financialData.accounts[type].push(newAccount);
    DB.save();

    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
    q('#accountName').value = '';
    q('#accountBalance').value = '';

    this.renderAccounts();
    this.populateAccountSelector();

    Notifications.add('Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ ${name} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
  },

  renderAccounts() {
    const container = q('#accountsList');
    if (!container) return;

    let html = '<h3>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>';

    Object.keys(State.db.financialData.accounts).forEach(type => {
      const typeLabels = {
        assets: 'Ø§Ù„Ø£ØµÙˆÙ„',
        liabilities: 'Ø§Ù„Ø®ØµÙˆÙ…',
        equity: 'Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©',
        revenue: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
        expenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª'
      };

      html += `<h4>${typeLabels[type]}</h4>`;
      html += '<table><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';

      State.db.financialData.accounts[type].forEach(account => {
        html += `
          <tr>
            <td>${account.name}</td>
            <td>${fmt(account.balance)} Ø±.Ø³</td>
            <td>
              <button class="btn danger" onclick="Accounts.deleteAccount('${type}', '${account.id}')">Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
    });

    container.innerHTML = html;
  },

  deleteAccount(type, accountId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) return;

    State.db.financialData.accounts[type] = State.db.financialData.accounts[type].filter(a => a.id !== accountId);
    DB.save();

    this.renderAccounts();
    this.populateAccountSelector();

    Notifications.add('Ø­Ø°Ù Ø­Ø³Ø§Ø¨', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  },

  addTransaction() {
    const branchId = q('#transactionBranch').value;
    const type = q('#transactionType').value;
    const accountId = q('#transactionAccount').value;
    const amount = parseNum(q('#transactionAmount').value);
    const description = q('#transactionDescription').value.trim();

    if (!amount || amount <= 0) {
      Notifications.add('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');
      return;
    }

    if (!State.db.transactions[branchId]) {
      State.db.transactions[branchId] = [];
    }

    const transaction = {
      id: uid(),
      date: todayStr(),
      type,
      accountId,
      amount,
      description,
      createdBy: State.user ? State.user.name : 'System'
    };

    State.db.transactions[branchId].push(transaction);
    DB.save();

    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
    q('#transactionAmount').value = '';
    q('#transactionDescription').value = '';

    Notifications.add('Ø­Ø±ÙƒØ© Ù…Ø§Ù„ÙŠØ©', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ù…Ø§Ù„ÙŠØ© Ø¨Ù‚ÙŠÙ…Ø© ${fmt(amount)} Ø±.Ø³`, 'success');
  },

  loadTransactions(branchId) {
    if (!State.db.transactions[branchId] || State.db.transactions[branchId].length === 0) {
      q('#transactionsList').innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø§Ù„ÙŠØ©</div>';
      return;
    }

    const transactions = State.db.transactions[branchId];
    let html = '<h3>Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ÙˆØµÙ</th></tr></thead><tbody>';

    transactions.forEach(transaction => {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨
      let accountName = 'Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      Object.keys(State.db.financialData.accounts).forEach(type => {
        const account = State.db.financialData.accounts[type].find(a => a.id === transaction.accountId);
        if (account) accountName = account.name;
      });

      html += `
        <tr>
          <td>${transaction.date}</td>
          <td>${transaction.type === 'debit' ? 'Ù…Ø¯ÙŠÙ†' : 'Ø¯Ø§Ø¦Ù†'}</td>
          <td>${accountName}</td>
          <td>${fmt(transaction.amount)} Ø±.Ø³</td>
          <td>${transaction.description}</td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    q('#transactionsList').innerHTML = html;
  },

  handleAccountEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'addAccountBtn') {
        this.addAccount();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  }
};

/* ========= Excel Export Module ========= */
const ExcelExport = {

  createBranchWorkbook(branch) {
    if (typeof XLSX === 'undefined') {
      console.warn('XLSX library not loaded');
      Notifications.add('Ø®Ø·Ø£', 'Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'error');
      return;
    }

    try {
      // Ø¥Ù†Ø´Ø§Ø¡ workbook Ø¬Ø¯ÙŠØ¯
      const wb = XLSX.utils.book_new();

      // Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø¹ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ
      const branchInfo = [
        ['ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„ÙØ±Ø¹ - ' + branch.name],
        [],
        ['Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©'],
        ['Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹:', branch.name],
        ['Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹:', branch.manager || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'],
        ['Ø§Ù„Ù…ÙˆÙ‚Ø¹:', branch.loc || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'],
        ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:', new Date().toLocaleDateString('ar-SA')],
        ['ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:', new Date().toLocaleTimeString('ar-SA')],
        [],
        ['Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©'],
        ['Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', Object.keys(MODELS.forms).length],
        ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', this.getTotalRecords(branch.id)],
        [],
        ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©'],
        ['â€¢ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…'],
        ['â€¢ ÙƒÙ„ ÙƒØ´Ù ÙÙŠ ÙˆØ±Ù‚Ø© Ù…Ù†ÙØµÙ„Ø© Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ'],
        ['â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…'],
        ['â€¢ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚']
      ];

      const branchWS = XLSX.utils.aoa_to_sheet(branchInfo);

      // ØªÙ†Ø³ÙŠÙ‚ ÙˆØ±Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø¹
      this.formatInfoSheet(branchWS);

      XLSX.utils.book_append_sheet(wb, branchWS, 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø¹');

      // Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ù‚Ø© Ù„ÙƒÙ„ Ù†ÙˆØ¹ ÙƒØ´Ù Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­Ø³Ù†
      Object.keys(MODELS.forms).forEach(formKey => {
        const form = MODELS.forms[formKey];
        const sheetName = this.getSheetName(formKey);

        // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ
        const ws = this.createFormattedSheet(form, branch.id, formKey);

        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      });

      // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
      const fileName = `${branch.name.replace(/[^\w\s]/gi, '')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Notifications.add('ØªØµØ¯ÙŠØ± Excel', `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ù„Ù„ÙØ±Ø¹: ${fileName}`, 'success');

    } catch (error) {
      console.error('Excel export error:', error);
      Notifications.add('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel', 'error');
    }
  },

  getTotalRecords(branchId) {
    let total = 0;
    if (State.db.records[branchId]) {
      Object.keys(State.db.records[branchId]).forEach(formKey => {
        total += (State.db.records[branchId][formKey] || []).length;
      });
    }
    return total;
  },

  formatInfoSheet(ws) {
    if (!ws['!ref']) return;

    const range = XLSX.utils.decode_range(ws['!ref']);

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const titleCell = 'A1';
    if (ws[titleCell]) {
      ws[titleCell].s = {
        font: { bold: true, size: 16, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "2563EB" } },
        alignment: { horizontal: "center", vertical: "center" },
        border: {
          top: { style: "thick", color: { rgb: "000000" } },
          bottom: { style: "thick", color: { rgb: "000000" } },
          left: { style: "thick", color: { rgb: "000000" } },
          right: { style: "thick", color: { rgb: "000000" } }
        }
      };
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙØ±Ø¹ÙŠØ©
    ['A3', 'A10', 'A14'].forEach(cell => {
      if (ws[cell]) {
        ws[cell].s = {
          font: { bold: true, size: 12, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "059669" } },
          alignment: { horizontal: "center" }
        };
      }
    });

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    for (let row = 4; row <= 8; row++) {
      const labelCell = `A${row}`;
      const valueCell = `B${row}`;

      if (ws[labelCell]) {
        ws[labelCell].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "F3F4F6" } }
        };
      }

      if (ws[valueCell]) {
        ws[valueCell].s = {
          fill: { fgColor: { rgb: "FFFFFF" } },
          border: {
            top: { style: "thin", color: { rgb: "D1D5DB" } },
            bottom: { style: "thin", color: { rgb: "D1D5DB" } },
            left: { style: "thin", color: { rgb: "D1D5DB" } },
            right: { style: "thin", color: { rgb: "D1D5DB" } }
          }
        };
      }
    }

    // ØªØ¹ÙŠÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    ws['!cols'] = [
      { width: 25 },
      { width: 30 }
    ];
  },

  createFormattedSheet(form, branchId, formKey) {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const existingData = State.db.records[branchId] && State.db.records[branchId][formKey]
      ? State.db.records[branchId][formKey]
      : [];

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    const sortedData = existingData.sort((a, b) => {
      const dateA = new Date(a.date || '1900-01-01');
      const dateB = new Date(b.date || '1900-01-01');
      return dateB - dateA;
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆØ±Ù‚Ø©
    const sheetData = [];

    // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    sheetData.push([form.label]);
    sheetData.push([]);

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    const branch = State.db.branches.find(b => b.id === branchId);
    sheetData.push(['Ø§Ù„ÙØ±Ø¹:', branch ? branch.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ']);
    sheetData.push(['Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', sortedData.length]);
    sheetData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±:', new Date().toLocaleDateString('ar-SA')]);
    sheetData.push(['ÙˆÙ‚Øª Ø§Ù„ØªØµØ¯ÙŠØ±:', new Date().toLocaleTimeString('ar-SA')]);
    sheetData.push([]);

    if (sortedData.length === 0) {
      sheetData.push(['Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù']);
      sheetData.push([]);
      sheetData.push(['Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©']);
    } else {
      // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      const headers = ['#', ...form.fields.map(f => f.label)];
      sheetData.push(headers);

      // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      sortedData.forEach((record, index) => {
        const row = [
          index + 1,
          ...form.fields.map(f => {
            let value = record[f.k] || '';
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            if (f.type === 'number' && value) {
              const num = parseFloat(value);
              return isNaN(num) ? value : num.toLocaleString('ar-SA');
            }
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            if (f.type === 'date' && value) {
              try {
                return new Date(value).toLocaleDateString('ar-SA');
              } catch (e) {
                return value;
              }
            }
            return value;
          })
        ];
        sheetData.push(row);
      });

      // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ù„Ù„Ø£Ø±Ù‚Ø§Ù…
      const totalsRow = ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'];
      form.fields.forEach(f => {
        if (f.type === 'number') {
          const total = sortedData.reduce((sum, record) => {
            return sum + (parseFloat(record[f.k]) || 0);
          }, 0);
          totalsRow.push(total.toLocaleString('ar-SA'));
        } else {
          totalsRow.push('');
        }
      });

      sheetData.push([]);
      sheetData.push(totalsRow);

      // Ø¥Ø¶Ø§ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
      sheetData.push([]);
      sheetData.push(['Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©']);

      if (sortedData.length > 0) {
        const firstDate = sortedData[sortedData.length - 1].date;
        const lastDate = sortedData[0].date;
        sheetData.push(['Ø£ÙˆÙ„ ØªØ§Ø±ÙŠØ®:', firstDate ? new Date(firstDate).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯']);
        sheetData.push(['Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ®:', lastDate ? new Date(lastDate).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯']);

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
        form.fields.forEach(f => {
          if (f.type === 'number') {
            const values = sortedData.map(r => parseFloat(r[f.k]) || 0).filter(v => v > 0);
            if (values.length > 0) {
              const average = values.reduce((a, b) => a + b, 0) / values.length;
              sheetData.push([`Ù…ØªÙˆØ³Ø· ${f.label}:`, average.toLocaleString('ar-SA')]);
            }
          }
        });
      }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
    this.formatDataSheet(ws, form.fields.length + 1, sortedData.length);

    return ws;
  },

  formatDataSheet(ws, numCols, numDataRows) {
    if (!ws['!ref']) return;

    const range = XLSX.utils.decode_range(ws['!ref']);

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const titleCell = 'A1';
    if (ws[titleCell]) {
      ws[titleCell].s = {
        font: { bold: true, size: 14, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "1F2937" } },
        alignment: { horizontal: "center", vertical: "center" }
      };

      // Ø¯Ù…Ø¬ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ù„Ù„Ø¹Ù†ÙˆØ§Ù†
      ws['!merges'] = ws['!merges'] || [];
      ws['!merges'].push({
        s: { r: 0, c: 0 },
        e: { r: 0, c: Math.max(numCols - 1, 3) }
      });
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø¹
    for (let row = 3; row <= 6; row++) {
      const labelCell = `A${row}`;
      const valueCell = `B${row}`;

      if (ws[labelCell]) {
        ws[labelCell].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "F9FAFB" } }
        };
      }

      if (ws[valueCell]) {
        ws[valueCell].s = {
          fill: { fgColor: { rgb: "FFFFFF" } }
        };
      }
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„ØµÙ 8 Ø¹Ø§Ø¯Ø©)
    const headerRow = 8;
    for (let col = 0; col < numCols; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: headerRow, c: col });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "059669" } },
          alignment: { horizontal: "center", vertical: "center" },
          border: {
            top: { style: "medium", color: { rgb: "000000" } },
            bottom: { style: "medium", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
          }
        };
      }
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
    for (let row = headerRow + 1; row <= headerRow + numDataRows; row++) {
      for (let col = 0; col < numCols; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
        if (ws[cellAddress]) {
          const isEvenRow = (row - headerRow) % 2 === 0;
          ws[cellAddress].s = {
            fill: { fgColor: { rgb: isEvenRow ? "F9FAFB" : "FFFFFF" } },
            border: {
              top: { style: "thin", color: { rgb: "E5E7EB" } },
              bottom: { style: "thin", color: { rgb: "E5E7EB" } },
              left: { style: "thin", color: { rgb: "E5E7EB" } },
              right: { style: "thin", color: { rgb: "E5E7EB" } }
            },
            alignment: { horizontal: col === 0 ? "center" : "right" }
          };
        }
      }
    }

    // ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    const totalsRow = headerRow + numDataRows + 2;
    for (let col = 0; col < numCols; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: totalsRow, c: col });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "DC2626" } },
          alignment: { horizontal: col === 0 ? "center" : "right" },
          border: {
            top: { style: "medium", color: { rgb: "000000" } },
            bottom: { style: "medium", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
          }
        };
      }
    }

    // ØªØ¹ÙŠÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    const colWidths = [];
    colWidths.push({ width: 8 }); // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ

    for (let i = 1; i < numCols; i++) {
      colWidths.push({ width: 15 });
    }

    ws['!cols'] = colWidths;

    // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø©
    ws['!freeze'] = { xSplit: 1, ySplit: headerRow + 1 };
  },

  exportFormData(formKey, branchId) {
    if (typeof XLSX === 'undefined') {
      console.warn('XLSX library not loaded');
      Notifications.add('Ø®Ø·Ø£', 'Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'error');
      return;
    }

    try {
      const branch = State.db.branches.find(b => b.id === branchId);
      const form = MODELS.forms[formKey];
      const data = State.db.records[branchId] && State.db.records[branchId][formKey]
        ? State.db.records[branchId][formKey]
        : [];

      if (data.length === 0) {
        Notifications.add('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
        return;
      }

      // Ø¥Ù†Ø´Ø§Ø¡ workbook
      const wb = XLSX.utils.book_new();

      // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Ù…Ù†Ø³Ù‚Ø©
      const ws = this.createFormattedSheet(form, branchId, formKey);

      XLSX.utils.book_append_sheet(wb, ws, this.getSheetName(formKey));

      // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
      const fileName = `${form.label.replace(/[^\w\s]/gi, '')}_${branch ? branch.name.replace(/[^\w\s]/gi, '') : 'ÙØ±Ø¹'}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Notifications.add('ØªØµØ¯ÙŠØ± Excel', `ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰: ${fileName}`, 'success');

    } catch (error) {
      console.error('Excel export error:', error);
      Notifications.add('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
  },

  updateFormData(formKey, branchId, newRecord) {
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Excel Ù…ÙˆØ¬ÙˆØ¯
    // Ø­Ø§Ù„ÙŠØ§Ù‹ Ø³ØªÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
    this.exportFormData(formKey, branchId);
  },

  exportAllBranchData(branchId) {
    if (typeof XLSX === 'undefined') {
      console.warn('XLSX library not loaded');
      Notifications.add('Ø®Ø·Ø£', 'Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'error');
      return;
    }

    try {
      const branch = State.db.branches.find(b => b.id === branchId);
      if (!branch) {
        Notifications.add('Ø®Ø·Ø£', 'Ø§Ù„ÙØ±Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
      }

      const wb = XLSX.utils.book_new();

      // Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø¹ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ
      const branchInfo = [
        ['Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ - ' + branch.name],
        [],
        ['Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø¹'],
        ['Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹:', branch.name],
        ['Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹:', branch.manager || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'],
        ['Ø§Ù„Ù…ÙˆÙ‚Ø¹:', branch.loc || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'],
        ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', new Date().toLocaleDateString('ar-SA')],
        ['ÙˆÙ‚Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', new Date().toLocaleTimeString('ar-SA')],
        [],
        ['Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'],
        ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª:', Object.keys(MODELS.forms).length],
        ['Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª:', this.getActiveFormsCount(branchId)],
        ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', this.getTotalRecords(branchId)],
        [],
        ['Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:']
      ];

      // Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª
      Object.keys(MODELS.forms).forEach(formKey => {
        const form = MODELS.forms[formKey];
        const recordCount = State.db.records[branchId] && State.db.records[branchId][formKey]
          ? State.db.records[branchId][formKey].length
          : 0;
        branchInfo.push([`â€¢ ${form.label}:`, `${recordCount} Ø³Ø¬Ù„`]);
      });

      const branchWS = XLSX.utils.aoa_to_sheet(branchInfo);
      this.formatInfoSheet(branchWS);
      XLSX.utils.book_append_sheet(wb, branchWS, 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø¹');

      // Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ù‚Ø© Ù„ÙƒÙ„ ÙƒØ´Ù (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹)
      Object.keys(MODELS.forms).forEach(formKey => {
        const form = MODELS.forms[formKey];
        const ws = this.createFormattedSheet(form, branchId, formKey);
        XLSX.utils.book_append_sheet(wb, ws, this.getSheetName(formKey));
      });

      // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
      const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø´Ø§Ù…Ù„_${branch.name.replace(/[^\w\s]/gi, '')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Notifications.add('ØªØµØ¯ÙŠØ± Excel', `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„: ${fileName}`, 'success');

    } catch (error) {
      console.error('Excel export error:', error);
      Notifications.add('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„', 'error');
    }
  },

  getActiveFormsCount(branchId) {
    let count = 0;
    if (State.db.records[branchId]) {
      Object.keys(State.db.records[branchId]).forEach(formKey => {
        if ((State.db.records[branchId][formKey] || []).length > 0) {
          count++;
        }
      });
    }
    return count;
  },

  createFilteredReportSheet(form, filteredData, reportType, date, month, branch) {
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    const sortedData = filteredData.sort((a, b) => {
      const dateA = new Date(a.date || '1900-01-01');
      const dateB = new Date(b.date || '1900-01-01');
      return dateB - dateA;
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆØ±Ù‚Ø©
    const sheetData = [];

    // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const periodText = reportType === 'daily' ? `Ù„ÙŠÙˆÙ… ${date}` : `Ù„Ø´Ù‡Ø± ${month}`;
    sheetData.push([`${form.label} ${periodText}`]);
    sheetData.push([]);

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    sheetData.push(['ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±']);
    sheetData.push(['Ø§Ù„ÙƒØ´Ù:', form.label]);
    sheetData.push(['Ø§Ù„ÙØ±Ø¹:', branch ? branch.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ']);
    sheetData.push(['Ø§Ù„ÙØªØ±Ø©:', periodText]);
    sheetData.push(['Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', sortedData.length]);
    sheetData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±:', new Date().toLocaleDateString('ar-SA')]);
    sheetData.push(['ÙˆÙ‚Øª Ø§Ù„ØªØµØ¯ÙŠØ±:', new Date().toLocaleTimeString('ar-SA')]);
    sheetData.push([]);

    if (sortedData.length === 0) {
      sheetData.push(['Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©']);
      sheetData.push([]);
      sheetData.push(['Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©']);
    } else {
      // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      const headers = ['#', ...form.fields.map(f => f.label)];
      sheetData.push(headers);

      // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      sortedData.forEach((record, index) => {
        const row = [
          index + 1,
          ...form.fields.map(f => {
            let value = record[f.k] || '';
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            if (f.type === 'number' && value) {
              const num = parseFloat(value);
              return isNaN(num) ? value : num.toLocaleString('ar-SA');
            }
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            if (f.type === 'date' && value) {
              try {
                return new Date(value).toLocaleDateString('ar-SA');
              } catch (e) {
                return value;
              }
            }
            return value;
          })
        ];
        sheetData.push(row);
      });

      // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ù„Ù„Ø£Ø±Ù‚Ø§Ù…
      const totalsRow = ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'];
      form.fields.forEach(f => {
        if (f.type === 'number') {
          const total = sortedData.reduce((sum, record) => {
            return sum + (parseFloat(record[f.k]) || 0);
          }, 0);
          totalsRow.push(total.toLocaleString('ar-SA'));
        } else {
          totalsRow.push('');
        }
      });

      sheetData.push([]);
      sheetData.push(totalsRow);

      // Ø¥Ø¶Ø§ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„ÙØªØ±Ø©
      sheetData.push([]);
      sheetData.push(['Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø©']);

      if (reportType === 'daily') {
        sheetData.push(['Ø§Ù„ØªØ§Ø±ÙŠØ®:', new Date(date).toLocaleDateString('ar-SA')]);
      } else {
        const monthDate = new Date(month + '-01');
        sheetData.push(['Ø§Ù„Ø´Ù‡Ø±:', monthDate.toLocaleDateString('ar-SA', { year: 'numeric', month: 'long' })]);
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ÙˆØ§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
      form.fields.forEach(f => {
        if (f.type === 'number') {
          const values = sortedData.map(r => parseFloat(r[f.k]) || 0).filter(v => v > 0);
          if (values.length > 0) {
            const average = values.reduce((a, b) => a + b, 0) / values.length;
            const min = Math.min(...values);
            const max = Math.max(...values);

            sheetData.push([`Ù…ØªÙˆØ³Ø· ${f.label}:`, average.toLocaleString('ar-SA')]);
            sheetData.push([`Ø£Ù‚Ù„ ${f.label}:`, min.toLocaleString('ar-SA')]);
            sheetData.push([`Ø£Ø¹Ù„Ù‰ ${f.label}:`, max.toLocaleString('ar-SA')]);
          }
        }
      });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
    this.formatReportSheet(ws, form.fields.length + 1, sortedData.length);

    return ws;
  },

  formatReportSheet(ws, numCols, numDataRows) {
    if (!ws['!ref']) return;

    const range = XLSX.utils.decode_range(ws['!ref']);

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const titleCell = 'A1';
    if (ws[titleCell]) {
      ws[titleCell].s = {
        font: { bold: true, size: 16, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "7C3AED" } },
        alignment: { horizontal: "center", vertical: "center" }
      };

      // Ø¯Ù…Ø¬ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ù„Ù„Ø¹Ù†ÙˆØ§Ù†
      ws['!merges'] = ws['!merges'] || [];
      ws['!merges'].push({
        s: { r: 0, c: 0 },
        e: { r: 0, c: Math.max(numCols - 1, 3) }
      });
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†ÙˆØ§Ù† "ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
    const detailsTitle = 'A3';
    if (ws[detailsTitle]) {
      ws[detailsTitle].s = {
        font: { bold: true, size: 12, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "059669" } },
        alignment: { horizontal: "center" }
      };
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    for (let row = 4; row <= 9; row++) {
      const labelCell = `A${row}`;
      const valueCell = `B${row}`;

      if (ws[labelCell]) {
        ws[labelCell].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "F3F4F6" } }
        };
      }

      if (ws[valueCell]) {
        ws[valueCell].s = {
          fill: { fgColor: { rgb: "FFFFFF" } }
        };
      }
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„ØµÙ 11 Ø¹Ø§Ø¯Ø©)
    const headerRow = 11;
    for (let col = 0; col < numCols; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: headerRow, c: col });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "1F2937" } },
          alignment: { horizontal: "center", vertical: "center" },
          border: {
            top: { style: "medium", color: { rgb: "000000" } },
            bottom: { style: "medium", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
          }
        };
      }
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
    for (let row = headerRow + 1; row <= headerRow + numDataRows; row++) {
      for (let col = 0; col < numCols; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
        if (ws[cellAddress]) {
          const isEvenRow = (row - headerRow) % 2 === 0;
          ws[cellAddress].s = {
            fill: { fgColor: { rgb: isEvenRow ? "F8FAFC" : "FFFFFF" } },
            border: {
              top: { style: "thin", color: { rgb: "E2E8F0" } },
              bottom: { style: "thin", color: { rgb: "E2E8F0" } },
              left: { style: "thin", color: { rgb: "E2E8F0" } },
              right: { style: "thin", color: { rgb: "E2E8F0" } }
            },
            alignment: { horizontal: col === 0 ? "center" : "right" }
          };
        }
      }
    }

    // ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    const totalsRow = headerRow + numDataRows + 2;
    for (let col = 0; col < numCols; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: totalsRow, c: col });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "EF4444" } },
          alignment: { horizontal: col === 0 ? "center" : "right" },
          border: {
            top: { style: "medium", color: { rgb: "000000" } },
            bottom: { style: "medium", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
          }
        };
      }
    }

    // ØªØ¹ÙŠÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    const colWidths = [];
    colWidths.push({ width: 8 }); // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ

    for (let i = 1; i < numCols; i++) {
      colWidths.push({ width: 18 });
    }

    ws['!cols'] = colWidths;

    // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø©
    ws['!freeze'] = { xSplit: 1, ySplit: headerRow + 1 };
  },

  getSheetName(formKey) {
    const names = {
      dailyRevenue: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',
      bankRecon: 'Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©',
      cashPurch: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',
      creditPurch: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¢Ø¬Ù„Ø©',
      dailyMeals: 'Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',
      empAdvance: 'Ø³Ù„Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
      supMaintenance: 'ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø´Ø±Ù',
      marketPurch: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©',
      mgrMaintenance: 'ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø¯ÙŠØ±',
      mgrPurch: 'Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±',
      empAdd: 'Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†'
    };

    return names[formKey] || formKey;
  }
};

/* ========= UI Builders ========= */
const UI = {
  renderBranches(){
    const grid = q("#branchesGrid");
    if (!grid) return;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ± ÙØ±Ø¹ØŒ Ø§Ø¹Ø±Ø¶ ÙØ±Ø¹Ù‡ ÙÙ‚Ø·
    let branchesToShow = State.db.branches;
    if (State.user && State.user.role === 'branch-manager' && State.user.branchId) {
      branchesToShow = State.db.branches.filter(b => b.id === State.user.branchId);
    }

    if (branchesToShow.length === 0) {
      grid.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ù…ØªØ§Ø­Ø©</div>';
      return;
    }

    grid.innerHTML = branchesToShow.map(b=>`
      <div class="card">
        <h3>${b.name}</h3>
        <div class="muted">Ø§Ù„Ù…Ø¯ÙŠØ±: ${b.manager||"-"} Â· Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${b.loc||"-"}</div>
        <div class="toolbar">
          <button class="btn acc" onclick="Router.go('branch',{branchId:'${b.id}'})">ÙØªØ­ Ø§Ù„ÙØ±Ø¹</button>
        </div>
      </div>
    `).join("");
  },
  
  openBranch(branchId){
    const b = State.db.branches.find(x=>x.id===branchId) || State.db.branches[0];
    State.currentBranch = b.id;
    ensureBranchContainers(b.id);

    q("#branchTitle").textContent = b.name;
    q("#branchSub").innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹: ${b.manager||"-"} Â· Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${b.loc||"-"}</span>
        <button class="btn info" onclick="ExcelExport.exportAllBranchData('${b.id}')" style="font-size: 12px; padding: 6px 12px;">
          ğŸ“Š ØªØµØ¯ÙŠØ± Excel Ø´Ø§Ù…Ù„
        </button>
      </div>
    `;

    // tabs
    const tabs = q("#branchTabs");
    if (!tabs) return;

    tabs.innerHTML = MODELS.branchTabs.map((t)=>{
      const key = t.k;
      const label = t.label || MODELS.forms[key]?.label || "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ";
      return `<div class="tab" onclick="Router.go('form', {formKey: '${key}', branchId: '${b.id}'})">${t.icon}<br>${label}</div>`;
    }).join("");
    
    // Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ÙØ±Ø¹ØŒ Ù„Ø§ ØªØ¹Ø±Ø¶ Ø£ÙŠ ÙƒØ´Ù Ù…Ø¨Ø§Ø´Ø±Ø©
    q('#branchForms').innerHTML = "<div class='muted'>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙƒØ´Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡.</div>";
  },

  renderFormPage(formKey, branchId) {
    const branch = State.db.branches.find(b => b.id === branchId);
    const def = MODELS.forms[formKey];

    if (!branch || !def) {
      q('#formContent').innerHTML = '<div class="muted">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>';
      return;
    }

    State.currentBranch = branchId;
    State.currentForm = formKey;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    q('#formTitle').textContent = def.label;
    q('#formSubtitle').textContent = `Ø¥Ø¯Ø§Ø±Ø© ${def.label} Ù„ÙØ±Ø¹ ${branch.name}`;
    q('#formRecordsTitle').textContent = `Ø³Ø¬Ù„ ${def.label}`;

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    let html = `<div class='card' style='background:#18253a'><h3>${def.label}</h3><div class='row'>`;

    def.fields.forEach((f, index) => {
      const nextFieldId = index < def.fields.length - 1 ?
        `${formKey}_${def.fields[index + 1].k}` :
        `save_${formKey}_btn`;

      html += `<div class='col-4'><label>${f.label}</label>${this.fieldInput(f, formKey, nextFieldId)}</div>`;
    });

    html += `<div class='col-12 toolbar'>
      <button id="save_${formKey}_btn" class='btn acc' onclick='UI.saveFormData("${formKey}")'>Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button class='btn ghost' onclick='UI.clearFormData("${formKey}")'>Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
    </div></div></div>`;

    q('#formContent').innerHTML = html;

    // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    this.renderFormRecords(formKey, branchId);
  },

  fieldInput(f, formKey, nextFieldId = null) {
    const fieldId = `${formKey}_${f.k}`;
    const enterHandler = nextFieldId ? `onkeydown="UI.handleFormEnterKey(event, '${nextFieldId}', '${formKey}')"` : '';

    if (f.type === "date") {
      return `<input type='date' id='${fieldId}' class='input' ${enterHandler}>`;
    } else if (f.type === "number") {
      return `<input type='number' id='${fieldId}' class='input' placeholder='0.00' ${enterHandler}>`;
    } else if (f.type === "select" && f.options) {
      let opts = f.options.map(opt => `<option value='${opt}'>${opt}</option>`).join('');
      return `<select id='${fieldId}' class='input' ${enterHandler}>${opts}</select>`;
    } else {
      return `<input type='text' id='${fieldId}' class='input' placeholder='${f.label}' ${enterHandler}>`;
    }
  },

  handleFormEnterKey(event, nextFieldId, formKey) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId.startsWith('save_')) {
        this.saveFormData(formKey);
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },

  saveFormData(formKey) {
    const branchId = State.currentBranch;
    const def = MODELS.forms[formKey];

    if (!branchId || !def) {
      Notification.show("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
      return;
    }

    ensureBranchContainers(branchId);

    const data = { id: uid() };
    let hasData = false;

    def.fields.forEach(f => {
      const fieldId = `${formKey}_${f.k}`;
      const value = q('#' + fieldId)?.value?.trim();

      if (value) {
        hasData = true;
        if (f.type === "number") {
          data[f.k] = parseNum(value);
        } else {
          data[f.k] = value;
        }
      }
    });

    if (!hasData) {
      Notification.show("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø­Ù‚Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error");
      return;
    }

    State.db.records[branchId][formKey].push(data);
    DB.save();

    this.clearFormData(formKey);
    this.renderFormRecords(formKey, branchId);
    Notification.show("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "success");
  },

  clearFormData(formKey) {
    const def = MODELS.forms[formKey];
    if (!def) return;

    def.fields.forEach(f => {
      const fieldId = `${formKey}_${f.k}`;
      const field = q('#' + fieldId);
      if (field) {
        if (f.type === "date") {
          field.value = todayStr();
        } else {
          field.value = '';
        }
      }
    });
  },

  renderFormRecords(formKey, branchId) {
    const container = q('#formRecordsList');
    const def = MODELS.forms[formKey];

    if (!container || !def) return;

    const records = State.db.records[branchId]?.[formKey] || [];

    if (records.length === 0) {
      container.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
      return;
    }

    let html = '<table><thead><tr>';
    def.fields.forEach(f => {
      html += `<th>${f.label}</th>`;
    });
    html += '<th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>';

    records.forEach(record => {
      html += '<tr>';
      def.fields.forEach(f => {
        const value = record[f.k] || '';
        if (f.type === "number") {
          html += `<td>${fmt(value)}</td>`;
        } else {
          html += `<td>${value}</td>`;
        }
      });
      html += `<td class="no-print">
        <button class="btn danger" onclick="UI.deleteFormRecord('${formKey}', '${record.id}')">Ø­Ø°Ù</button>
      </td></tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  },

  deleteFormRecord(formKey, recordId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;

    const branchId = State.currentBranch;
    const records = State.db.records[branchId]?.[formKey] || [];
    const index = records.findIndex(r => r.id === recordId || r._id === recordId);

    if (index !== -1) {
      records.splice(index, 1);
      DB.save();
      this.renderFormRecords(formKey, branchId);
      Notification.show("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­", "success");
    } else {
      Notification.show("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨", "error");
    }
  },

  // Navigation Functions
  goBackToBranch() {
    if (State.currentBranch) {
      Router.go('branch', {branchId: State.currentBranch});
    } else {
      Router.go('home');
    }
  },

  goBackToBranch(branchId) {
    State.currentBranch = branchId;
    Router.go('branch', {branchId});
  },

  switchTab(key){
    let branchId = State.currentBranch;
    if(!branchId){
      branchId = (State.db && State.db.branches && State.db.branches[0]?.id) || '';
    }
    const def = MODELS.forms[key];
    if(!def || !def.fields || def.fields.length === 0){
      q('#branchForms').innerHTML = "<div class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù.</div>";
      return;
    }
    
    let html = `<div class='sep' style='margin-bottom:18px;background:#22c55e;height:3px;border-radius:2px'></div>`;
    html += `<div class='card' style='background:#18253a'><h3>${def.label}</h3><div class='row'>`;
    
    def.fields.forEach(f=>{
      html += `<div class='col-4'><label>${f.label}</label>${this.fieldInput(f,key)}</div>`;
    });
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒØ´Ù Ù‡Ùˆ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©ØŒ Ø£Ø¶Ù Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ­Ù‚Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ù‚ÙˆÙ„
    if(key==='dailyRevenue'){
      html += `<div class='col-4'><label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label><input type='text' id='totalField' class='input' readonly style='background:#222;color:#fff'></div>`;
      html += `<div class='col-4'><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</label><input type='number' id='carsField' class='input' readonly style='background:#222;color:#fff'></div>`;
    }
    
    html += `</div><div class='toolbar' style='justify-content:center'>
      <button class='btn acc' id='saveFormBtn'>Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
      <button class='btn info' onclick="ExcelExport.exportFormData('${key}', '${branchId}')">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
      <button class='btn ghost' onclick="UI.goBackToBranch('${branchId}')">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙØ±Ø¹</button>
    </div></div>`;
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    html += `<div class='card' style='background:#1a2a3d'><h3>Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3><div class='subtitle'>ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø£ÙŠ Ø³Ø·Ø±.</div>
      <div style='overflow:auto'><table id='tbl-${key}' style='border:2px solid #22c55e;border-radius:8px'><thead></thead><tbody></tbody></table></div></div>`;
    
    q('#branchForms').innerHTML = html;
    
    // ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
    this.renderTableForBranch(key, def, branchId);
    
    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸
    const saveBtn = q('#saveFormBtn');
    if(saveBtn){
      saveBtn.onclick = ()=>this.saveForm(key, def);
    }
    
    // ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ÙƒØ´Ù Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    if(key==='dailyRevenue'){
      const updateTotal = ()=>{
        const network = parseFloat(q("[data-key='network']")?.value||0);
        const cash = parseFloat(q("[data-key='cash']")?.value||0);
        const credit = parseFloat(q("[data-key='credit']")?.value||0);
        const total = network+cash+credit;
        q('#totalField').value = total;
        q('#carsField').value = q("[data-key='cars']")?.value||0;
      };
      ["network","cash","credit","cars"].forEach(k=>{
        const inp = q(`[data-key='${k}']`);
        if(inp){ inp.oninput = updateTotal; }
      });
      updateTotal();
    }
  },
  
  fieldInput(f, key) {
    const id = `${key}-${f.k}`;
    const defval = f.def || "";
    const base = `data-field="${key}" data-key="${f.k}" id="${id}" class="input" ${defval?`data-def="${defval}" value="${defval}"`:``}`;
    
    if(f.type==="date") return `<input type="date" ${base}>`;
    if(f.type==="number") return `<input type="number" step="0.01" ${base}>`;
    if(f.type==="text") return `<input type="text" ${base}>`;
    if(f.type==="readonly") return `<input type="text" ${base} readonly>`;
    if(f.type==="select") return `<select ${base}>${(f.opts||[]).map(o=>`<option>${o}</option>`).join("")}</select>`;
    if(f.type==="picker-emp"){
      return `<div style="display:flex;gap:6px">
        <input type="text" ${base} placeholder="Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù" readonly>
        <button class="btn" onclick="UI.pickEmp('${key}','${id}')">Ø¨Ø­Ø«</button>
      </div>
      <div class="muted" id="${id}-hint"></div>`;
    }
    return `<input type="text" ${base}>`;
  },
  
  pickEmp(key, inputId) {
    const list = State.db.employees[State.currentBranch]||[];
    const name = prompt("Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡Ù‹Ø§ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ø¨Ø­Ø«:");
    if(name===null) return;
    
    const found = list.find(e=>e.name.includes(name.trim()));
    if(!found){ 
      Notification.show("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù Ù…Ø·Ø§Ø¨Ù‚.", "error");
      return; 
    }
    
    const inp = q("#"+inputId);
    inp.value = found.name;
    
    if(key==="empAdvance"){
      const rows = State.db.records[State.currentBranch]["empAdvance"]||[];
      const empRows = rows.filter(r=>r.emp===found.name);
      const totalTaken = empRows.reduce((s,r)=>s+parseNum(r.take),0);
      const prev = empRows.length? (empRows[empRows.length-1].take||0) : 0;
      
      q("#empAdvance-salary").value = found.salary||0;
      q("#empAdvance-prev").value = prev;
      q("#empAdvance-totalTaken").value = totalTaken;
      
      const remain = (found.salary||0) - totalTaken;
      q("#empAdvance-remain").value = remain;
      q("#"+inputId+"-hint").textContent = `Ø§Ù„Ø±Ø§ØªØ¨: ${fmt(found.salary)} Â· Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª: ${fmt(totalTaken)} Â· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${fmt(remain)}`;
    }
    
    Notification.show(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù: ${found.name}`, "success");
  },
  
  saveForm(key, def) {
    const data = {};
    def.fields.forEach(f=>{
      const el = q(`#${key}-${f.k}`);
      if(!el) return;
      let v = el.value;
      if(f.type==="number") v = parseNum(v);
      data[f.k] = v;
    });

    if(key==="empAdd"){
      const b = State.currentBranch;
      if(!data.name){ 
        Notification.show("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù", "error");
        return; 
      }
      
      State.db.employees[b].push({
        id: uid(), 
        name: data.name, 
        salary: parseNum(data.salary), 
        phone: data.phone||"", 
        role: data.role||"Ù…ÙˆØ¸Ù‘Ù"
      });
      
      DB.save();
      Notification.show("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
      this.renderTable(key, MODELS.forms[key]);
      return;
    }

    if(key==="empAdvance"){
      const emp = (data.emp||"").trim();
      if(!emp){ 
        Notification.show("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù", "error");
        return; 
      }
      
      const empObj = (State.db.employees[State.currentBranch]||[]).find(e=>e.name===emp);
      data.salary = empObj? empObj.salary : parseNum(data.salary);
      const rows = State.db.records[State.currentBranch]["empAdvance"]||[];
      const empRows = rows.filter(r=>r.emp===emp);
      const totalTaken = empRows.reduce((s,r)=>s+parseNum(r.take),0) + parseNum(data.take);
      const prev = empRows.length? (empRows[empRows.length-1].take||0) : 0;
      const remain = data.salary - totalTaken;
      
      data.prev = prev;
      data.totalTaken = totalTaken;
      data.remain = remain;
    }

    data.id = uid();
    const b = State.currentBranch;
    State.db.records[b][key].push(data);
    DB.save();
    
    Notification.show("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­", "success");
    this.renderTable(key, def);
  },
  
  renderTableForBranch(key, def, branchId) {
    const thead = q(`#tbl-${key} thead`);
    const tbody = q(`#tbl-${key} tbody`);
    if (!thead || !tbody) return;
    
    const cols = def.fields.map(f=>`<th style='border:1px solid #38bdf8;background:#e0f2fe;color:#222'>${f.label}</th>`).join("") + `<th class="no-print" style='border:1px solid #38bdf8;background:#e0f2fe'></th>`;
    thead.innerHTML = `<tr>${cols}</tr>`;
    
    const rows = State.db.records[branchId]?.[key] || [];
    tbody.innerHTML = rows.map((r,idx)=>{
      const tds = def.fields.map(f=>{
        let v = r[f.k] ?? "";
        if(f.type==="number" || ["amount","price","take","salary","prev","totalTaken","remain","mada","visa","master","other1","other2","cars","credit","cash","network","qty"].includes(f.k)){
          v = fmt(v);
        }
        return `<td style='border:1px solid #38bdf8;background:${idx%2==0?"#f1f5f9":"#e0f2fe"};color:#222'>${v??""}</td>`;
      }).join("");
      return `<tr>${tds}<td class="no-print" style='border:1px solid #38bdf8;background:${idx%2==0?"#f1f5f9":"#e0f2fe"}'>
        <button class="btn danger" onclick="UI.delRowForBranch('${key}','${r._id||r.id}','${branchId}')">Ø­Ø°Ù</button>
      </td></tr>`;
    }).join("");
  },
  
  delRowForBranch(key, id, branchId) {
    if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;

    const list = State.db.records[branchId][key];
    const i = list.findIndex(e=>e.id===id || e._id===id);
    if(i>-1) list.splice(i,1);

    DB.save();
    Notification.show("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­", "success");
    this.renderTableForBranch(key, MODELS.forms[key], branchId);
  },
  
  renderFormPage(formKey, branchId) {
    const b = State.db.branches.find(x => x.id === branchId) || State.db.branches[0];
    State.currentBranch = b.id;
    ensureBranchContainers(b.id);

    const def = MODELS.forms[formKey];
    const title = def.label;
    const section = q('#view-form');
    section.innerHTML = `
        <div class="back-button" onclick="Router.go('branch', {branchId: State.currentBranch})">
            â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙØ±Ø¹
        </div>
        <div class="card"><h3>${title} - ${b.name}</h3></div>
    `;

    // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const form = document.createElement('div');
    form.className = 'card';
    form.innerHTML = `<h3>Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª</h3>`;

    const fields = document.createElement('div');
    fields.className = 'row';

    def.fields.forEach(f => {
        const col = document.createElement('div');
        col.className = 'col-4';
        col.innerHTML = `<label>${f.label}</label>${this.fieldInput(f, formKey)}`;
        fields.appendChild(col);
    });

    form.appendChild(fields);

    const bar = document.createElement('div');
    bar.className = 'toolbar';
    bar.innerHTML = `
        <button class="btn acc" onclick="UI.saveRecord('${formKey}')">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
        <button class="btn ghost" onclick="UI.clearForm('${formKey}')">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        <button class="btn info" onclick="ExcelExport.exportFormData('${formKey}', '${branchId}')">ØªØµØ¯ÙŠØ± Excel</button>
    `;

    form.appendChild(bar);
    section.appendChild(form);

    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const tableCard = document.createElement('div');
    tableCard.className = 'card';
    tableCard.innerHTML = `
        <h3>Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
        <div class="subtitle">ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø£ÙŠ Ø³Ø·Ø±.</div>
        <div style="overflow:auto">
            <table id="tbl-${formKey}">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    `;

    section.appendChild(tableCard);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
    this.renderTableForBranch(formKey, def, branchId);
  },

  clearForm(formKey) {
    const def = MODELS.forms[formKey];
    def.fields.forEach(f => {
        const input = q(`#${f.k}`);
        if (input) {
            input.value = '';
        }
    });
  },

  saveRecord(formKey) {
    const def = MODELS.forms[formKey];
    const branchId = State.currentBranch;

    const record = { id: uid() }; // Ø¥Ø¶Ø§ÙØ© ID ÙØ±ÙŠØ¯ Ù„Ù„Ø³Ø¬Ù„
    let hasData = false;

    def.fields.forEach(f => {
        const input = q(`#${formKey}-${f.k}`);
        if (input) {
            record[f.k] = input.value;
            if (input.value.trim()) hasData = true;
        }
    });

    if (!hasData) {
        Notifications.add("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
        return;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„
    if (!State.db.records[branchId]) State.db.records[branchId] = {};
    if (!State.db.records[branchId][formKey]) State.db.records[branchId][formKey] = [];

    State.db.records[branchId][formKey].push(record);
    DB.save();

    // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    this.clearForm(formKey);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
    this.renderTableForBranch(formKey, def, branchId);

    Notifications.add("Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­", "success");
  }
};

/* ========= Reports ========= */
const Reports = {
  selectedTypes: [],
  
  populateDaily() {
    const bSel = q("#dailyRepBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    q("#dailyRepDate").value = todayStr();
    this.selectedTypes = [];

    // Ù…Ù„Ø¡ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    this.renderReportTypes('daily');
  },
  
  populateMonthly() {
    const bSel = q("#monthlyRepBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    q("#monthlyRepMonth").value = new Date().toISOString().slice(0,7);
    this.selectedTypes = [];

    // Ù…Ù„Ø¡ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    this.renderReportTypes('monthly');

    console.log('Monthly reports populated successfully');
  },
  
  populateCustom() {
    const bSel = q("#customRepBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    q("#customRepFrom").value = firstOfMonthStr();
    q("#customRepTo").value = todayStr();
    this.selectedTypes = [];

    // Ù…Ù„Ø¡ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    this.renderReportTypes('custom');
  },
  
  populateProfitLoss() {
    const bSel = q("#plBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    q("#plMonth").value = new Date().toISOString().slice(0,7);
  },

  renderReportTypes(reportType) {
    const containerId = `${reportType}ReportTypes`;
    const container = q(`#${containerId}`);
    if (!container) return;

    const html = MODELS.reportTypes.map(rt => `
      <div class="card report-type-card" id="${reportType}-type-${rt.k}" onclick="Reports.toggle${reportType.charAt(0).toUpperCase() + reportType.slice(1)}Type('${rt.k}')">
        <h4>${rt.label}</h4>
      </div>
    `).join('');

    container.innerHTML = html;

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
    this.selectedTypes = [];
    MODELS.reportTypes.forEach(rt => {
      const el = q(`#${reportType}-type-${rt.k}`);
      if (el) el.classList.remove("active");
    });
  },

  exportDailyToExcel() {
    const branchId = q("#dailyRepBranch").value;
    const date = q("#dailyRepDate").value;

    if(this.selectedTypes.length === 0){
      Notifications.add("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", "error");
      return;
    }

    this.exportReportToExcel('daily', branchId, date, null, this.selectedTypes);
  },

  exportMonthlyToExcel() {
    const branchId = q("#monthlyRepBranch").value;
    const month = q("#monthlyRepMonth").value;

    if(this.selectedTypes.length === 0){
      Notifications.add("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", "error");
      return;
    }

    this.exportReportToExcel('monthly', branchId, null, month, this.selectedTypes);
  },

  exportReportToExcel(reportType, branchId, date, month, selectedTypes) {
    if (typeof XLSX === 'undefined') {
      Notifications.add('Ø®Ø·Ø£', 'Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'error');
      return;
    }

    try {
      const branch = State.db.branches.find(b => b.id === branchId);
      const wb = XLSX.utils.book_new();

      // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ
      const reportInfo = [
        [`Ø§Ù„ØªÙ‚Ø±ÙŠØ± ${reportType === 'daily' ? 'Ø§Ù„ÙŠÙˆÙ…ÙŠ' : 'Ø§Ù„Ø´Ù‡Ø±ÙŠ'} - ${branch ? branch.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`],
        [],
        ['ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±'],
        ['Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', reportType === 'daily' ? 'ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ' : 'ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ'],
        ['Ø§Ù„ÙØ±Ø¹:', branch ? branch.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'],
        [reportType === 'daily' ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®:' : 'Ø§Ù„Ø´Ù‡Ø±:', reportType === 'daily' ? date : month],
        ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±:', new Date().toLocaleDateString('ar-SA')],
        ['ÙˆÙ‚Øª Ø§Ù„ØªØµØ¯ÙŠØ±:', new Date().toLocaleTimeString('ar-SA')],
        [],
        ['Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©'],
        ...selectedTypes.map(type => [`â€¢ ${MODELS.forms[type] ? MODELS.forms[type].label : type}`]),
        [],
        ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'],
        ['â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…'],
        ['â€¢ ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©'],
        ['â€¢ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚']
      ];

      const infoWS = XLSX.utils.aoa_to_sheet(reportInfo);
      this.formatInfoSheet(infoWS);
      XLSX.utils.book_append_sheet(wb, infoWS, 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±');

      // Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ù‚Ø© Ù„ÙƒÙ„ Ù†ÙˆØ¹ ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø¯Ø¯
      selectedTypes.forEach(type => {
        const def = MODELS.forms[type];
        if (!def) return;

        ensureBranchContainers(branchId);
        const allRows = State.db.records[branchId][type] || [];

        // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„Ø´Ù‡Ø±
        const filteredRows = allRows.filter(r => {
          if (reportType === 'daily') {
            return r.date === date;
          } else {
            return r.date && r.date.slice(0, 7) === month;
          }
        });

        // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Ù…Ù†Ø³Ù‚Ø© Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙÙ„ØªØ±
        const ws = this.createFilteredReportSheet(def, filteredRows, reportType, date, month, branch);

        XLSX.utils.book_append_sheet(wb, ws, ExcelExport.getSheetName(type));
      });

      // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
      const fileName = `ØªÙ‚Ø±ÙŠØ±_${reportType === 'daily' ? 'ÙŠÙˆÙ…ÙŠ' : 'Ø´Ù‡Ø±ÙŠ'}_${branch ? branch.name.replace(/[^\w\s]/gi, '') : 'ÙØ±Ø¹'}_${reportType === 'daily' ? date : month}.xlsx`;
      XLSX.writeFile(wb, fileName);

      Notifications.add('ØªØµØ¯ÙŠØ± Excel', `ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰: ${fileName}`, 'success');

    } catch (error) {
      console.error('Excel export error:', error);
      Notifications.add('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error');
    }
  },
  
  toggleDailyType(type) {
    const el = q(`#daily-type-${type}`);
    if (!el) return;
    
    if(el.classList.contains("active")){
      el.classList.remove("active");
      this.selectedTypes = this.selectedTypes.filter(t => t !== type);
    } else {
      el.classList.add("active");
      this.selectedTypes.push(type);
    }
  },
  
  toggleMonthlyType(type) {
    const el = q(`#monthly-type-${type}`);
    if (!el) {
      console.warn('Element not found for type:', type);
      return;
    }

    if(el.classList.contains("active")){
      el.classList.remove("active");
      this.selectedTypes = this.selectedTypes.filter(t => t !== type);
      console.log('Removed type:', type, 'Selected types:', this.selectedTypes);
    } else {
      el.classList.add("active");
      this.selectedTypes.push(type);
      console.log('Added type:', type, 'Selected types:', this.selectedTypes);
    }
  },
  
  toggleCustomType(type) {
    const el = q(`#custom-type-${type}`);
    if (!el) return;
    
    if(el.classList.contains("active")){
      el.classList.remove("active");
      this.selectedTypes = this.selectedTypes.filter(t => t !== type);
    } else {
      el.classList.add("active");
      this.selectedTypes.push(type);
    }
  },
  
  generateDaily() {
    const branchId = q("#dailyRepBranch").value;
    const date = q("#dailyRepDate").value;
    
    if(this.selectedTypes.length === 0){
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", "error");
      return;
    }
    
    Loading.show("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ...");
    
    setTimeout(() => {
      const reports = [];
      
      this.selectedTypes.forEach(type => {
        const def = MODELS.forms[type];
        if(!def) return;
        
        const rows = (State.db.records[branchId][type] || []).filter(r => r.date?.startsWith(date));
        
        if(rows.length > 0){
          reports.push({
            type,
            label: def.label,
            rows
          });
        }
      });
      
      // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
      const branch = State.db.branches.find(b => b.id === branchId);
      const reportId = uid();
      const savedReport = {
        id: reportId,
        type: "daily",
        branchId,
        branchName: branch?.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
        date,
        title: `ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ - ${date}`,
        reports: reports
      };
      
      State.db.savedReports.push(savedReport);
      DB.save();
      
      // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´Ø£
      this.displayReport(savedReport);
      Loading.hide();
      Notification.show("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ù†Ø¬Ø§Ø­", "success");

      // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      setTimeout(() => {
        this.saveCurrentReport(savedReport.id);
      }, 1000);
    }, 1000);
  },
  
  generateMonthly() {
    const branchId = q("#monthlyRepBranch").value;
    const month = q("#monthlyRepMonth").value;

    console.log('Starting monthly report generation...');
    console.log('Branch ID:', branchId);
    console.log('Month:', month);
    console.log('Selected types:', this.selectedTypes);

    if(!branchId){
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹", "error");
      return;
    }

    if(!month){
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±", "error");
      return;
    }

    if(this.selectedTypes.length === 0){
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", "error");
      return;
    }

    Loading.show("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ...");

    // ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    ensureBranchContainers(branchId);

    setTimeout(() => {
      try {
        const reports = [];

        console.log('Processing selected types:', this.selectedTypes);

        this.selectedTypes.forEach(type => {
          console.log('Processing type:', type);
          const def = MODELS.forms[type];
          if(!def) {
            console.warn('Form definition not found for type:', type);
            return;
          }

          // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          if (!State.db.records[branchId]) {
            console.warn('No records found for branch:', branchId);
            return;
          }

          if (!State.db.records[branchId][type]) {
            console.warn('No records found for type:', type, 'in branch:', branchId);
            return;
          }

          const allRows = State.db.records[branchId][type] || [];
          console.log('All rows for', type, ':', allRows.length);

          const rows = allRows.filter(r => {
            if (!r.date) {
              console.warn('Row without date found:', r);
              return false;
            }
            const rowDate = r.date.slice(0,7);
            const matches = rowDate === month;
            console.log('Row date:', r.date, 'Month:', month, 'Matches:', matches);
            return matches;
          });

          console.log('Filtered rows for', type, ':', rows.length);

          if(rows.length > 0){
            reports.push({
              type,
              label: def.label,
              rows
            });
          }
        });

        console.log('Total reports generated:', reports.length);

        if(reports.length === 0){
          Loading.hide();
          Notification.show("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯", "warning");
          return;
        }

        // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        const branch = State.db.branches.find(b => b.id === branchId);
        const reportId = uid();
        const savedReport = {
          id: reportId,
          type: "monthly",
          branchId,
          branchName: branch?.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
          date: month,
          title: `ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ - ${month}`,
          reports: reports
        };

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ØµÙÙˆÙØ© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        if (!State.db.savedReports) {
          State.db.savedReports = [];
        }

        State.db.savedReports.push(savedReport);
        DB.save();

        console.log('Report saved successfully');

        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´Ø£
        this.displayReport(savedReport);
        Loading.hide();
        Notification.show("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­", "success");

        // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        setTimeout(() => {
          this.saveCurrentReport(savedReport.id);
        }, 1000);

      } catch (error) {
        console.error('Error generating monthly report:', error);
        Loading.hide();
        Notification.show("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: " + error.message, "error");
      }
    }, 1000);
  },
  
  generateCustom() {
    const branchId = q("#customRepBranch").value;
    const from = q("#customRepFrom").value;
    const to = q("#customRepTo").value;
    
    if(this.selectedTypes.length === 0){
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", "error");
      return;
    }
    
    if(!from || !to){
      Notification.show("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©", "error");
      return;
    }
    
    Loading.show("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØµØµ...");
    
    setTimeout(() => {
      const reports = [];
      
      this.selectedTypes.forEach(type => {
        const def = MODELS.forms[type];
        if(!def) return;
        
        const rows = (State.db.records[branchId][type] || []).filter(r => {
          const rowDate = r.date?.slice(0,10);
          return rowDate >= from && rowDate <= to;
        });
        
        if(rows.length > 0){
          reports.push({
            type,
            label: def.label,
            rows
          });
        }
      });
      
      // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
      const branch = State.db.branches.find(b => b.id === branchId);
      const reportId = uid();
      const savedReport = {
        id: reportId,
        type: "custom",
        branchId,
        branchName: branch?.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
        from,
        to,
        title: `ØªÙ‚Ø±ÙŠØ± Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to}`,
        reports: reports
      };
      
      State.db.savedReports.push(savedReport);
      DB.save();
      
      // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´Ø£
      this.displayReport(savedReport);
      Loading.hide();
      Notification.show("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØµØµ Ø¨Ù†Ø¬Ø§Ø­", "success");

      // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      setTimeout(() => {
        this.saveCurrentReport(savedReport.id);
      }, 1000);
    }, 1000);
  },
  
  generateProfitLoss() {
    const branchId = q("#plBranch").value;
    const month = q("#plMonth").value;
    
    Loading.show("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±...");
    
    setTimeout(() => {
      const branch = State.db.branches.find(b => b.id === branchId);
      const expenses = State.db.expenses[branchId] || {};
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ù…Ù† ÙƒØ´Ù Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©)
      const revenueRows = (State.db.records[branchId]["dailyRevenue"] || []).filter(r => {
        const rowDate = r.date?.slice(0,7);
        return rowDate === month;
      });
      
      const totalRevenue = revenueRows.reduce((sum, row) => {
        return sum + parseNum(row.network) + parseNum(row.cash) + parseNum(row.credit);
      }, 0);
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ + Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙØ±Ø¹)
      let totalExpenses = 0;
      const expenseDetails = [];
      
      // Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ø¨ØªØ©
      if(expenses.rent) {
        totalExpenses += parseNum(expenses.rent);
        expenseDetails.push({name: "Ø¥ÙŠØ¬Ø§Ø±", amount: parseNum(expenses.rent)});
      }
      if(expenses.salaries) {
        totalExpenses += parseNum(expenses.salaries);
        expenseDetails.push({name: "Ø±ÙˆØ§ØªØ¨", amount: parseNum(expenses.salaries)});
      }
      if(expenses.admin) {
        totalExpenses += parseNum(expenses.admin);
        expenseDetails.push({name: "Ø¥Ø¯Ø§Ø±Ø©", amount: parseNum(expenses.admin)});
      }
      if(expenses.bank) {
        totalExpenses += parseNum(expenses.bank);
        expenseDetails.push({name: "Ø±Ø³ÙˆÙ… Ø¨Ù†ÙƒÙŠØ©", amount: parseNum(expenses.bank)});
      }
      if(expenses.loss) {
        totalExpenses += parseNum(expenses.loss);
        expenseDetails.push({name: "Ø®Ø³Ø§Ø±Ø© Ø³Ø§Ø¨Ù‚Ø©", amount: parseNum(expenses.loss)});
      }
      if(expenses.other) {
        totalExpenses += parseNum(expenses.other);
        expenseDetails.push({name: "Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰", amount: parseNum(expenses.other)});
      }
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Ø§Ù„ÙƒØ´ÙˆÙØ§Øª
      const expenseTypes = [
        "cashPurch", "creditPurch", "dailyMeals", "empAdvance", 
        "supMaintenance", "marketPurch", "mgrMaintenance", "mgrPurch"
      ];
      
      expenseTypes.forEach(type => {
        const rows = (State.db.records[branchId][type] || []).filter(r => {
          const rowDate = r.date?.slice(0,7);
          return rowDate === month;
        });
        
        if(rows.length > 0){
          const total = rows.reduce((sum, row) => {
            return sum + parseNum(row.amount || row.price || row.take || 0);
          }, 0);
          
          if(total > 0){
            totalExpenses += total;
            expenseDetails.push({
              name: MODELS.forms[type].label,
              amount: total
            });
          }
        }
      });
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©
      const profitLoss = totalRevenue - totalExpenses;
      
      // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
      const reportId = uid();
      const savedReport = {
        id: reportId,
        type: "profit-loss",
        branchId,
        branchName: branch?.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
        date: month,
        title: `ØªÙ‚Ø±ÙŠØ± Ø£Ø±Ø¨Ø§Ø­ ÙˆØ®Ø³Ø§Ø¦Ø± - ${month}`,
        data: {
          totalRevenue,
          totalExpenses,
          profitLoss,
          expenseDetails
        }
      };
      
      State.db.savedReports.push(savedReport);
      DB.save();
      
      // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´Ø£
      this.displayReport(savedReport);
      Loading.hide();
      Notification.show("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø± Ø¨Ù†Ø¬Ø§Ø­", "success");

      // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      setTimeout(() => {
        this.saveCurrentReport(savedReport.id);
      }, 1000);
    }, 1000);
  },
  
  displayReport(report) {
    try {
      let html = `<div class="card">`;

      // ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      html += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div>
            <div class="title">${report.title || 'ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø³Ø¨ÙŠ'}</div>
            <div class="subtitle">${report.branchName || 'ÙØ±Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
          </div>
          <div class="muted">${report.date || (report.from && report.to ? `${report.from} Ø¥Ù„Ù‰ ${report.to}` : '')}</div>
        </div>
      `;

      if(report.type === "profit-loss"){
        // Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±
        html += this.renderProfitLossReport(report);
      } else {
        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        html += this.renderNormalReport(report);
      }

      html += `</div>`;

      q("#reportDisplayArea").innerHTML = html;
      Router.go('report-display');

      console.log('Report displayed successfully');
    } catch (error) {
      console.error('Error displaying report:', error);
      Loading.hide();
      Notification.show("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: " + error.message, "error");
    }
  },
  
  renderNormalReport(report) {
    try {
      let html = "";

      if (!report.reports || report.reports.length === 0) {
        return "<div class='muted' style='text-align:center;padding:32px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>";
      }

      report.reports.forEach((rpt, idx) => {
        if(idx > 0) html += `<div class="report-separator"></div>`;

        html += `<div class="report-section">`;
        html += `<h3 style="margin-bottom:12px">${rpt.label || 'ØªÙ‚Ø±ÙŠØ±'}</h3>`;

        const def = MODELS.forms[rpt.type];
        if(!def) {
          html += `<div class="muted">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</div>`;
          html += `</div>`;
          return;
        }

        if (!rpt.rows || rpt.rows.length === 0) {
          html += `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>`;
          html += `</div>`;
          return;
        }

        // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const heads = def.fields.map(f=>`<th style='border:1px solid #22c55e;background:#0e162d;color:#22c55e'>${f.label}</th>`).join("");

        // ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const trs = rpt.rows.map((r,idx)=>{
          const tds = def.fields.map(f=>{
            let v = r[f.k] ?? "";
            if(["number"].includes(f.type) || ["amount","price","take","salary","prev","totalTaken","remain","mada","visa","master","other1","other2","cars","credit","cash","network","qty"].includes(f.k)){
              v = fmt(v);
            }
            return `<td style='border:1px solid #22c55e;background:${idx%2==0?"#192a3a":"#0e162d"};color:#22c55e'>${v??""}</td>`;
          }).join("");
          return `<tr>${tds}</tr>`;
        }).join("");

        // ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        let totalRow = "";
        if(def.fields.some(f=>f.type==="number")){
          totalRow = `<tr style='background:#22c55e;color:#0e162d;font-weight:bold'>`;
          let found = false;
          def.fields.forEach(f=>{
            if(f.type==="number" && !found){
              const sum = rpt.rows.reduce((s,r)=>s+parseNum(r[f.k]),0);
              totalRow += `<td style='border:2px solid #0e162d'>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(sum)}</td>`;
              found = true;
            }else if(f.type==="number"){
              const sum = rpt.rows.reduce((s,r)=>s+parseNum(r[f.k]),0);
              totalRow += `<td style='border:2px solid #0e162d'>${fmt(sum)}</td>`;
            }else{
              totalRow += `<td style='border:2px solid #0e162d'></td>`;
            }
          });
          totalRow += `</tr>`;
        }

        html += `
          <div style="overflow:auto;margin-bottom:16px">
            <table class='report-table' style='border:2px solid #22c55e;border-radius:8px;background:#192a3a;width:100%'>
              <thead><tr>${heads}</tr></thead>
              <tbody>${trs||"<tr><td colspan='99'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>"}${totalRow}</tbody>
            </table>
          </div>
        `;

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸
        html += `
          <div class="report-footer">
            <div class="report-actions">
              <button class="btn" onclick="Reports.printReport()">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
              <button class="btn ghost" onclick="Reports.saveCurrentReport('${report.id}')">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
          </div>
        `;

        html += `</div>`;
      });

      // ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      const now = new Date();
      html += `
        <div style="margin-top:32px;text-align:center;color:#888;font-size:14px">
          Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¬Ø¨Ø±Ù†ÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ - Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ØºØ§Ø³Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
          <span style="float:right">${now.toLocaleDateString()} ${now.toLocaleTimeString()}</span>
        </div>
      `;

      return html;
    } catch (error) {
      console.error('Error rendering normal report:', error);
      return `<div class="muted" style="text-align:center;padding:32px;color:#ef4444">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${error.message}</div>`;
    }
  },
  
  renderProfitLossReport(report) {
    let html = "";
    const data = report.data;

    // ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø± Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø£ÙƒØ«Ø± ØªØ±ØªÙŠØ¨Ø§Ù‹ ÙˆÙƒÙØ§Ø¡Ø©
    html += `
      <div class="card" style="background:#192a3a;margin-bottom:16px">
        <div style="text-align:center;margin-bottom:30px">
          <h2 style="color:#fff;font-size:24px;margin-bottom:10px">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±</h2>
          <h4 style="color:#fff;text-align:center;margin-bottom:20px">${report.title}</h4>
        </div>

        <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø± ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ -->
        <div style="display:flex;gap:20px;margin-bottom:20px;justify-content:center">
          <div style="flex:1;text-align:center">
            <div style="background:#0e162d;padding:15px;border-radius:8px;border:2px solid #10b981">
              <div style="color:#10b981;font-size:14px;margin-bottom:5px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
              <div style="color:#10b981;font-size:18px;font-weight:bold">${fmt(data.totalRevenue)} Ø±.Ø³</div>
            </div>
          </div>
          <div style="flex:1;text-align:center">
            <div style="background:#0e162d;padding:15px;border-radius:8px;border:2px solid #ef4444">
              <div style="color:#ef4444;font-size:14px;margin-bottom:5px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
              <div style="color:#ef4444;font-size:18px;font-weight:bold">${fmt(data.totalExpenses)} Ø±.Ø³</div>
            </div>
          </div>
          <div style="flex:1;text-align:center">
            <div style="background:#0e162d;padding:15px;border-radius:8px;border:2px solid ${data.profitLoss >= 0 ? '#10b981' : '#ef4444'}">
              <div style="color:${data.profitLoss >= 0 ? '#10b981' : '#ef4444'};font-size:14px;margin-bottom:5px">${data.profitLoss >= 0 ? 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­' : 'ØµØ§ÙÙŠ Ø§Ù„Ø®Ø³Ø§Ø±Ø©'}</div>
              <div style="color:${data.profitLoss >= 0 ? '#10b981' : '#ef4444'};font-size:18px;font-weight:bold">${fmt(Math.abs(data.profitLoss))} Ø±.Ø³</div>
            </div>
          </div>
        </div>
      </div>
    `;

    // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ù…Ø±ØªØ¨
    html += `
      <div class="card" style="background:#192a3a;margin-bottom:16px">
        <h3 style="color:#22c55e;text-align:center;margin-bottom:15px">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>

        <table class="profit-loss-table" style="width:100%;margin:0">
          <thead>
            <tr>
              <th style="border:1px solid #22c55e;text-align:center;padding:10px">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
              <th style="border:1px solid #22c55e;text-align:center;padding:10px">Ø§Ù„Ù…Ø¨Ù„Øº</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.expenseDetails.forEach(exp => {
      html += `
        <tr>
          <td style="border:1px solid #22c55e;text-align:right;padding:8px">${exp.name}</td>
          <td style="border:1px solid #22c55e;text-align:center;padding:8px">${fmt(exp.amount)} Ø±.Ø³</td>
        </tr>
      `;
    });

    html += `
            <tr class="profit-loss-total">
              <td style="border:1px solid #22c55e;text-align:right;padding:10px;font-weight:bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
              <td style="border:1px solid #22c55e;text-align:center;padding:10px;font-weight:bold">${fmt(data.totalExpenses)} Ø±.Ø³</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸
    html += `
      <div class="report-footer">
        <div class="report-actions">
          <button class="btn" onclick="Reports.printReport()">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
          <button class="btn ghost" onclick="Reports.saveCurrentReport('${report.id}')">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
    `;

    return html;
  },
  
  saveCurrentReport(reportId) {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„ØµÙØ­Ø©
    const reportContent = q('#reportDisplayArea');
    if (!reportContent) {
      Notifications.add("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø­ÙØ¸", "error");
      return;
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    const titleElement = reportContent.querySelector('.title');
    const subtitleElement = reportContent.querySelector('.subtitle');

    if (!titleElement) {
      Notifications.add("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±", "error");
      return;
    }

    const title = titleElement.textContent.trim();
    const branchName = subtitleElement ? subtitleElement.textContent.trim() : '';

    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    let reportType = 'custom';
    if (title.includes('ÙŠÙˆÙ…ÙŠ')) {
      reportType = 'daily';
    } else if (title.includes('Ø´Ù‡Ø±ÙŠ')) {
      reportType = 'monthly';
    } else if (title.includes('Ø£Ø±Ø¨Ø§Ø­') || title.includes('Ø®Ø³Ø§Ø¦Ø±')) {
      reportType = 'profit-loss';
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    let date = new Date().toISOString().slice(0, 10);
    const dateMatch = title.match(/(\d{4}-\d{2}-\d{2})/);
    if (dateMatch) {
      date = dateMatch[1];
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸
    const savedReport = {
      id: uid(),
      type: reportType,
      branchId: State.currentBranch || '',
      branchName: branchName,
      date: date,
      title: title,
      content: reportContent.innerHTML,
      createdAt: new Date().toISOString(),
      createdBy: State.user ? State.user.name : 'System'
    };

    // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!State.db.savedReports) {
      State.db.savedReports = [];
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªÙ‚Ø±ÙŠØ± Ù…ÙƒØ±Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    const existingReport = State.db.savedReports.find(r =>
      r.title === savedReport.title &&
      r.date === savedReport.date &&
      r.branchId === savedReport.branchId
    );

    if (existingReport) {
      Notifications.add("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹", "warning");
      return;
    }

    State.db.savedReports.push(savedReport);
    DB.save();

    // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¬Ø§Ø­
    Notifications.add("Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", `ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± "${title}" Ø¨Ù†Ø¬Ø§Ø­`, "success");

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©
    if (q('#view-saved-reports') && !q('#view-saved-reports').classList.contains('hidden')) {
      this.showSavedReports();
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
    Security.logActivity('report_saved', {
      reportId: savedReport.id,
      reportType: reportType,
      title: title
    });
  },

  // Ø¯Ø§Ù„Ø© Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¨ØªØµÙ…ÙŠÙ… Ù…Ø­Ø³Ù†
  printReport() {
    const reportContent = q('#reportDisplayArea');
    if (!reportContent) {
      Notifications.add("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©", "error");
      return;
    }

    const printWindow = window.open('', '_blank');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
    const company = State.db.company || {};
    const now = new Date();
    const printDate = now.toLocaleDateString('ar-SA');
    const printTime = now.toLocaleTimeString('ar-SA');

    // ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ù„ÙÙŠØ§Øª
    const printStyles = `
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        * {
          box-sizing: border-box;
          font-family: 'Tajawal', system-ui, Segoe UI, Arial, sans-serif;
          margin: 0;
          padding: 0;
        }

        body {
          background: white !important;
          color: black !important;
          padding: 20px;
          direction: rtl;
          font-size: 14px;
          line-height: 1.6;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        /* Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‡ÙŠØ¨ Ø§Ù„Ù…Ø¯Ù…Ø¬ */
        .report-professional-header {
          text-align: center !important;
          margin-bottom: 40px !important;
          padding: 30px 20px !important;
          border-bottom: 3px solid #22c55e !important;
          background: linear-gradient(135deg, #f8fafc, #e2e8f0) !important;
          border-radius: 10px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .report-professional-header .main-title {
          font-size: 36px !important;
          font-weight: bold !important;
          color: #1f2937 !important;
          margin-bottom: 8px !important;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.1) !important;
        }

        .report-professional-header .print-date {
          font-size: 16px !important;
          color: #6b7280 !important;
          margin-bottom: 12px !important;
          font-weight: 500 !important;
        }

        .report-professional-header .company-info {
          font-size: 14px !important;
          color: #374151 !important;
          margin-bottom: 8px !important;
          font-weight: 500 !important;
        }

        .report-professional-header .report-info {
          font-size: 18px !important;
          color: #22c55e !important;
          margin-bottom: 5px !important;
          font-weight: 600 !important;
        }

        .report-content {
          margin-top: 20px !important;
        }

        .report-content .title,
        .report-content .subtitle {
          display: none !important;
        }

        .card {
          background: white !important;
          border: 2px solid #1f2937 !important;
          border-radius: 12px !important;
          padding: 20px !important;
          margin: 20px 0 !important;
          box-shadow: none !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .title {
          font-size: 24px !important;
          font-weight: bold !important;
          color: #1f2937 !important;
          margin-bottom: 10px !important;
          text-align: center !important;
        }

        .subtitle {
          font-size: 16px !important;
          color: #6b7280 !important;
          margin-bottom: 20px !important;
          text-align: center !important;
        }

        table {
          width: 100% !important;
          border-collapse: collapse !important;
          margin: 20px 0 !important;
          background: white !important;
          border: 2px solid #1f2937 !important;
          border-radius: 8px !important;
          overflow: hidden !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        th, td {
          border: 1px solid #d1d5db !important;
          padding: 10px 8px !important;
          text-align: right !important;
          background: white !important;
          color: black !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        th {
          background: #f3f4f6 !important;
          color: #1f2937 !important;
          font-weight: bold !important;
          font-size: 13px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        tr:nth-child(even) {
          background: #f9fafb !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        tr:nth-child(odd) {
          background: white !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .report-header {
          text-align: center !important;
          margin-bottom: 30px !important;
          padding: 20px !important;
          border-bottom: 2px solid #22c55e !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .report-separator {
          height: 2px !important;
          background: linear-gradient(90deg, transparent, #22c55e, transparent) !important;
          margin: 30px 0 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .report-section h3 {
          color: #22c55e !important;
          font-size: 20px !important;
          margin-bottom: 15px !important;
          text-align: center !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .financial-summary {
          display: grid !important;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
          gap: 16px !important;
          margin: 20px 0 !important;
        }

        .financial-summary .card {
          background: white !important;
          border: 2px solid #22c55e !important;
          padding: 20px !important;
          text-align: center !important;
          border-radius: 12px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .financial-summary .card h4 {
          color: #22c55e !important;
          font-size: 16px !important;
          margin-bottom: 8px !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .stat-value {
          font-size: 20px !important;
          font-weight: bold !important;
          color: #22c55e !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .profit-loss-table {
          width: 100% !important;
          border-collapse: collapse !important;
          margin: 20px 0 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .profit-loss-table th {
          background: #f3f4f6 !important;
          padding: 12px !important;
          text-align: center !important;
          border: 1px solid #d1d5db !important;
          color: #1f2937 !important;
          font-weight: bold !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .profit-loss-table td {
          padding: 10px !important;
          border: 1px solid #d1d5db !important;
          text-align: center !important;
          background: white !important;
          color: black !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .profit-loss-total {
          font-weight: bold !important;
          background: rgba(16, 185, 129, 0.1) !important;
          color: #059669 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .muted {
          color: #6b7280 !important;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹ */
        .no-print, .report-footer, .btn {
          display: none !important;
        }

        /* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
          body {
            background: white !important;
            color: black !important;
            font-size: 12px !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }

          .card {
            break-inside: avoid !important;
            page-break-inside: avoid !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }

          table {
            page-break-inside: avoid !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }

          th, td {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }

          .financial-summary .card {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
        }
      </style>
    `;

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
    let reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø³Ø¨ÙŠ';
    let reportSubtitle = '';

    try {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø£Ù…Ø§ÙƒÙ† Ù…Ø®ØªÙ„ÙØ©
      const titleElement = reportContent.querySelector('.title') ||
                          reportContent.querySelector('h1') ||
                          reportContent.querySelector('h2') ||
                          reportContent.querySelector('h3');

      if (titleElement) {
        reportTitle = titleElement.textContent.trim();
      }

      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØµÙ Ø§Ù„ÙØ±Ø¹ÙŠ
      const subtitleElement = reportContent.querySelector('.subtitle') ||
                             reportContent.querySelector('.muted') ||
                             reportContent.querySelector('p');

      if (subtitleElement) {
        reportSubtitle = subtitleElement.textContent.trim();
      }

      // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ù…
      if (reportTitle === 'ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø³Ø¨ÙŠ') {
        const textContent = reportContent.textContent || '';
        const lines = textContent.split('\n').filter(line => line.trim().length > 0);
        if (lines.length > 0) {
          reportTitle = lines[0].trim();
        }
      }

    } catch (error) {
      console.warn('Error extracting report info:', error);
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ø¹ Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ù…Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù‡ÙŠØ¨
    const reportHTML = `
      <div class="report-professional-header">
        <div class="main-title">ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø³Ø¨ÙŠ</div>
        <div class="print-date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${printDate} - ${printTime}</div>
        <div class="company-info">${company.name || 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©'}</div>
        <div class="company-info">Ù‡Ø§ØªÙ: ${company.phone || '-'} Â· Ø³.Øª: ${company.cr || '-'} Â· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${company.addr || '-'}</div>
        <div class="report-info">${reportTitle}</div>
        ${reportSubtitle ? `<div class="report-info">${reportSubtitle}</div>` : ''}
      </div>

      <div class="report-content">
        ${reportContent.innerHTML}
      </div>
    `;

    printWindow.document.write(`
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="utf-8">
        <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø³Ø¨ÙŠ</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        ${printStyles}
      </head>
      <body>
        ${reportHTML}
      </body>
      </html>
    `);

    printWindow.document.close();

    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    printWindow.onload = function() {
      setTimeout(() => {
        printWindow.print();
      }, 500);
    };
  },
  
  showSavedReports(type = 'all') {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
    qa("#view-saved-reports .tab").forEach(tab => tab.classList.remove("active"));

    // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ÙˆØªÙØ¹ÙŠÙ„Ù‡
    const tabs = qa("#view-saved-reports .tab");
    const tabText = {
      'all': 'Ø§Ù„ÙƒÙ„',
      'daily': 'ÙŠÙˆÙ…ÙŠØ©',
      'monthly': 'Ø´Ù‡Ø±ÙŠØ©',
      'custom': 'Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©',
      'profit-loss': 'Ø£Ø±Ø¨Ø§Ø­/Ø®Ø³Ø§Ø¦Ø±'
    };

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ
    for (let tab of tabs) {
      if (tab.textContent.trim() === tabText[type]) {
        tab.classList.add("active");
        break;
      }
    }

    // ØªØµÙÙŠØ© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    let reports = State.db.savedReports || [];
    if(type !== 'all'){
      reports = reports.filter(r => r.type === (type === 'profit-loss' ? 'profit-loss' : type));
    }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…
    reports.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));

    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    let html = "";

    if(reports.length === 0){
      html = `<div class="muted" style="text-align:center;padding:32px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹</div>`;
    } else {
      // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„
      reports.forEach(report => {
        const typeLabel = report.type === 'daily' ? 'ÙŠÙˆÙ…ÙŠ' :
                          report.type === 'monthly' ? 'Ø´Ù‡Ø±ÙŠ' :
                          report.type === 'custom' ? 'Ø¹Ø´ÙˆØ§Ø¦ÙŠ' :
                          report.type === 'profit-loss' ? 'Ø£Ø±Ø¨Ø§Ø­/Ø®Ø³Ø§Ø¦Ø±' : report.type;

        const dateStr = report.date || (report.createdAt ? report.createdAt.slice(0, 10) : '');
        const timeStr = report.createdAt ?
          new Date(report.createdAt).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) :
          '';

        const dateLabel = dateStr ? new Date(dateStr).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

        html += `
          <div class="card saved-report-item" onclick="Reports.viewSavedReport('${report.id}')" style="margin-bottom:10px;cursor:pointer;border-left:4px solid #22c55e;background:linear-gradient(135deg, rgba(34,197,94,0.05), rgba(34,197,94,0.02));transition:transform 0.2s">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
              <div style="flex:1">
                <h4 style="margin:0 0 8px 0;color:#22c55e;font-size:16px">${report.title}</h4>
                <div style="color:#666;font-size:13px">
                  <div>ğŸ“… ${dateLabel} ${timeStr ? ` Â· ğŸ• ${timeStr}` : ''}</div>
                  <div>ğŸ¢ ${report.branchName || 'ÙØ±Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Â· ğŸ“Š Ù†ÙˆØ¹: ${typeLabel}</div>
                  <div>ğŸ‘¤ Ø£Ù†Ø´Ø£Ù‡: ${report.createdBy || 'Ø§Ù„Ù†Ø¸Ø§Ù…'}</div>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:5px">
                <div style="color:#22c55e;font-size:20px">ğŸ“„</div>
                <button class="btn danger" style="font-size:11px;padding:4px 8px" onclick="event.stopPropagation(); Reports.deleteSavedReport('${report.id}')">Ø­Ø°Ù</button>
              </div>
            </div>
          </div>
        `;
      });
    }

    q("#savedReportsList").innerHTML = html;
  },
  
  viewSavedReport(reportId) {
    const report = State.db.savedReports.find(r => r.id === reportId);
    if(!report){
      Notifications.add("Ø®Ø·Ø£", "Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "error");
      return;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ content Ù…Ø­ÙÙˆØ¸ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
    if(report.content){
      q("#reportDisplayArea").innerHTML = report.content;
      Router.go('report-display');
      return;
    }

    // Ø¥Ù„Ø§ ÙØ§Ø³ØªØ®Ø¯Ù… displayReport Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    this.displayReport(report);
  },
  
  showSavedType(type) {
    this.showSavedReports(type);
  },

  // Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù ØªÙ‚Ø±ÙŠØ± Ù…Ø­ÙÙˆØ¸
  deleteSavedReport(reportId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ')) return;

    const reports = State.db.savedReports || [];
    const index = reports.findIndex(r => r.id === reportId);

    if (index !== -1) {
      const deletedReport = reports.splice(index, 1)[0];
      DB.save();

      Notifications.add("Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±", `ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± "${deletedReport.title}" Ø¨Ù†Ø¬Ø§Ø­`, "success");

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      this.showSavedReports();

      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
      Security.logActivity('report_deleted', {
        reportId: reportId,
        reportTitle: deletedReport.title
      });
    }
  }
};

/* ========= Movement (Daily Movements & Branch rankings) ========= */
const Movement = {
  populate() {
    const bSel = q("#mvBranch");
    if (!bSel) return;

    bSel.innerHTML = State.db.branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");

    const tSel = q("#mvType");
    const tSel2 = q("#mvAggType");
    if (!tSel || !tSel2) return;

    tSel.innerHTML = MODELS.reportTypes.map(t=>`<option value="${t.k}">${t.label}</option>`).join("");
    tSel2.innerHTML = tSel.innerHTML;

    q("#mvFrom").value = todayStr();
    q("#mvTo").value = todayStr();
    q("#mvAggFrom").value = firstOfMonthStr();
    q("#mvAggTo").value = todayStr();
    this.clear();
    this.clearAgg();
  },

  clear(){
    const area = q("#movementArea");
    if (area) area.innerHTML="";
  },

  clearAgg(){
    const area = q("#movementAggArea");
    if (area) area.innerHTML="";
  },

  generate() {
    const bid = q("#mvBranch").value;
    const type = q("#mvType").value;
    const from = q("#mvFrom").value || "0000-01-01";
    const to = q("#mvTo").value || "9999-12-31";
    ensureBranchContainers(bid);

    // Ù†Ø¬Ù…Ø¹ ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const rows = (State.db.records[bid][type]||[]).filter(r=>{
      const d = (r.date||"").slice(0,10);
      return (!from || d>=from) && (!to || d<=to);
    });

    const grouped = this.groupByDate(type, rows);
    const tableHtml = this.tableForMovement(type, grouped);

    const co = State.db.company||{};
    const branch = State.db.branches.find(b=>b.id===bid);
    const header = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px">
        <div>
          <div style="font-weight:700"> ${co.name||"Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©"} </div>
          <div class="muted">Ù‡Ø§ØªÙ: ${co.phone||"-"} Â· Ø³.Øª: ${co.cr||"-"} Â· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${co.addr||"-"}</div>
        </div>
        <div style="text-align:left">
          <div style="font-weight:700">Ø­Ø±ÙƒØ© Ø§Ù„ÙØ±ÙˆØ¹ - ${MODELS.reportTypes.find(t=>t.k===type).label}</div>
          <div class="muted">Ø§Ù„ÙØ±Ø¹: ${branch.name} Â· Ø§Ù„Ù…Ø¯Ø©: ${from} Ø¥Ù„Ù‰ ${to}</div>
        </div>
      </div>
    `;

    q("#movementArea").innerHTML = `<div class="card report-paper">${header}${tableHtml}</div>`;
  },

  // Ø¬Ø¯ÙˆÙ„ Ø®Ø§Øµ Ø¨Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (ØªØ¬Ù…ÙŠØ¹ ÙŠÙˆÙ…ÙŠ)
  tableForMovement(type, days) {
    // ØªØ¹Ø±ÙŠÙ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙƒÙ„ Ø­Ø±ÙƒØ©
    const colsMap = {
      dailyRevenue: ["date","network","cash","credit","cars","total"],
      bankRecon: ["date","mada","visa","master","other1","other2","total"],
      cashPurch: ["date","item","price"],
      creditPurch: ["date","item","price","supplier"],
      dailyMeals: ["date","who","amount"],
      empAdvance: ["date","emp","take","totalTaken","remain"],
      supMaintenance: ["date","maint","kind","amount","by"],
      marketPurch: ["date","item","qty","amount","buyer"],
      mgrMaintenance: ["date","type","desc","amount","party"],
      mgrPurch: ["date","item","qty","amount"]
    };
    const labels = {
      date:"Ø§Ù„ØªØ§Ø±ÙŠØ®",
      network:"Ø¥ÙŠØ±Ø§Ø¯ Ø´Ø¨ÙƒØ©",
      cash:"Ø¥ÙŠØ±Ø§Ø¯ ÙƒØ§Ø´",
      credit:"Ø¥ÙŠØ±Ø§Ø¯ Ø¢Ø¬Ù„",
      cars:"Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª",
      total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
      mada:"Ù…Ø¯Ù‰", visa:"ÙÙŠØ²Ø§", master:"Ù…Ø§Ø³ØªØ± ÙƒØ§Ø±Ø¯", other1:"Ø£Ø®Ø±Ù‰ 1", other2:"Ø£Ø®Ø±Ù‰ 2",
      item:"Ø§Ù„ØµÙ†Ù", price:"Ø§Ù„Ø³Ø¹Ø±", supplier:"Ø§Ù„Ù…ÙˆØ±Ø¯",
      who:"Ø§Ù„Ù…ØªØºØ°ÙŠ", amount:"Ø§Ù„Ù…Ø¨Ù„Øº",
      emp:"Ø§Ù„Ù…ÙˆØ¸Ù", take:"Ø³Ø­Ø¨ÙŠØ©", totalTaken:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨", remain:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ",
      maint:"Ø§Ù„ØµÙŠØ§Ù†Ø©", kind:"Ù†ÙˆØ¹Ù‡Ø§", by:"Ù…Ù†ÙØ° Ø§Ù„ØµÙŠØ§Ù†Ø©",
      qty:"Ø§Ù„ÙƒÙ…ÙŠØ©", buyer:"Ø§Ù„Ù…Ø´ØªØ±ÙŠ",
      type:"Ø§Ù„Ù†ÙˆØ¹", desc:"Ø§Ù„ÙˆØµÙ", party:"Ø§Ù„Ø¬Ù‡Ø©"
    };
    const cols = colsMap[type] || ["date"];
    // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const thead = `<thead><tr>${cols.map(c=>`<th>${labels[c]||c}</th>`).join("")}</tr></thead>`;
    // Ø¬Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const tbody = days.map(d=>{
      const tds = cols.map(c=>{
        let v = d[c];
        if(typeof v==="number") v = fmt(v);
        return `<td>${v==null?"":v}</td>`;
      }).join("");
      return `<tr>${tds}</tr>`;
    }).join("");
    return `<div style="overflow:auto"><table>${thead}<tbody>${tbody || "<tr><td colspan='99'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>"}</tbody></table></div>`;
  },

  // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙƒÙ„ Ø­Ø±ÙƒØ©
  groupByDate(type, rows) {
    const map = {};
    rows.forEach(r=>{
      const d = (r.date||"").slice(0,10);
      if(!map[d]) map[d] = {date:d};
      const m = map[d];
      switch(type){
        case "dailyRevenue":
          m.network = (m.network||0)+parseNum(r.network);
          m.cash = (m.cash||0)+parseNum(r.cash);
          m.credit = (m.credit||0)+parseNum(r.credit);
          m.cars = (m.cars||0)+parseNum(r.cars);
          m.total = (m.network||0)+(m.cash||0)+(m.credit||0);
          break;
        case "bankRecon":
          m.mada = (m.mada||0)+parseNum(r.mada);
          m.visa = (m.visa||0)+parseNum(r.visa);
          m.master = (m.master||0)+parseNum(r.master);
          m.other1 = (m.other1||0)+parseNum(r.other1);
          m.other2 = (m.other2||0)+parseNum(r.other2);
          m.total = (m.mada||0)+(m.visa||0)+(m.master||0)+(m.other1||0)+(m.other2||0);
          break;
        case "cashPurch":
          // Ù†Ø¹Ø±Ø¶ ÙƒÙ„ Ø³Ø¬Ù„ (ØªÙØµÙŠÙ„ÙŠ) Ù„ÙƒÙ† Ù…Ø·Ù„ÙˆØ¨ ØªØ±ØªÙŠØ¨ ÙŠÙˆÙ…ÙŠØ› Ø³Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø³Ø¹Ø± ÙˆÙ†ØªØ±Ùƒ ÙˆØµÙ Ø¢Ø®Ø± Ø³Ø¬Ù„ Ù„Ø°Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ…
          m.price = (m.price||0)+parseNum(r.price);
          m.item = (m.item? m.item+"ØŒ ":"") + (r.item||"");
          break;
        case "creditPurch":
          m.price = (m.price||0)+parseNum(r.price);
          m.item = (m.item? m.item+"ØŒ ":"") + (r.item||"");
          m.supplier = (m.supplier? m.supplier+"ØŒ ":"") + (r.supplier||"");
          break;
        case "dailyMeals":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.who = (m.who? m.who+"ØŒ ":"") + (r.who||"");
          break;
        case "empAdvance":
          m.take = (m.take||0)+parseNum(r.take);
          // Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ù„Ù„ÙŠÙˆÙ… Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
          m.totalTaken = (m.totalTaken||0)+parseNum(r.totalTaken||0);
          m.remain = (m.remain||0)+parseNum(r.remain||0);
          m.emp = (m.emp? m.emp+"ØŒ ":"") + (r.emp||"");
          break;
        case "supMaintenance":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.maint = (m.maint? m.maint+"ØŒ ":"") + (r.maint||"");
          m.kind = (m.kind? m.kind+"ØŒ ":"") + (r.kind||"");
          m.by = (m.by? m.by+"ØŒ ":"") + (r.by||"");
          break;
        case "marketPurch":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.qty = (m.qty||0)+parseNum(r.qty);
          m.item = (m.item? m.item+"ØŒ ":"") + (r.item||"");
          m.buyer = (m.buyer? m.buyer+"ØŒ ":"") + (r.buyer||"");
          break;
        case "mgrMaintenance":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.type = (m.type? m.type+"ØŒ ":"") + (r.type||"");
          m.desc = (m.desc? m.desc+"ØŒ ":"") + (r.desc||"");
          m.party = (m.party? m.party+"ØŒ ":"") + (r.party||"");
          break;
        case "mgrPurch":
          m.amount = (m.amount||0)+parseNum(r.amount);
          m.qty = (m.qty||0)+parseNum(r.qty);
          m.item = (m.item? m.item+"ØŒ ":"") + (r.item||"");
          break;
      }
    });
    return Object.values(map).sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  },

  // ØªØ¬Ù…ÙŠØ¹ Ù„ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø£ÙƒØ«Ø±/Ø§Ù„Ø£Ù‚Ù„
  calcAgg(type, from, to) {
    const res = [];
    State.db.branches.forEach(b=>{
      ensureBranchContainers(b.id);
      const rows = (State.db.records[b.id][type]||[]).filter(r=>{
        const d = (r.date||"").slice(0,10);
        return (!from || d>=from) && (!to || d<=to);
      });
      const sum = this.aggregateValue(type, rows);
      res.push({branch:b, value:sum});
    });
    return res;
  },
  
  aggregateValue(type, rows) {
    switch(type){
      case "dailyRevenue":
        return rows.reduce((s,r)=> s + parseNum(r.network) + parseNum(r.cash) + parseNum(r.credit), 0);
      case "bankRecon":
        return rows.reduce((s,r)=> s + parseNum(r.mada)+parseNum(r.visa)+parseNum(r.master)+parseNum(r.other1)+parseNum(r.other2), 0);
      case "cashPurch":
        return rows.reduce((s,r)=> s + parseNum(r.price), 0);
      case "creditPurch":
        return rows.reduce((s,r)=> s + parseNum(r.price), 0);
      case "dailyMeals":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      case "empAdvance":
        return rows.reduce((s,r)=> s + parseNum(r.take), 0);
      case "supMaintenance":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      case "marketPurch":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      case "mgrMaintenance":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      case "mgrPurch":
        return rows.reduce((s,r)=> s + parseNum(r.amount), 0);
      default: return 0;
    }
  },
  
  calcTop() {
    const type = q("#mvAggType").value;
    const from = q("#mvAggFrom").value || "0000-01-01";
    const to = q("#mvAggTo").value || "9999-12-31";
    const data = this.calcAgg(type, from, to).sort((a,b)=>b.value-a.value);
    const top = data[0], bottom = data[data.length-1];
    this.renderAggResult(type, from, to, top, bottom);
  },
  
  calcBottom() {
    const type = q("#mvAggType").value;
    const from = q("#mvAggFrom").value || "0000-01-01";
    const to = q("#mvAggTo").value || "9999-12-31";
    const data = this.calcAgg(type, from, to).sort((a,b)=>a.value-b.value);
    const bottom = data[0], top = data[data.length-1];
    this.renderAggResult(type, from, to, top, bottom);
  },
  
  renderAggResult(type, from, to, top, bottom) {
    const label = MODELS.reportTypes.find(t=>t.k===type).label;
    const co = State.db.company||{};
    const head = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px">
        <div>
          <div style="font-weight:700">${co.name||"Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©"}</div>
          <div class="muted">Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„ÙØ±ÙˆØ¹ Â· Ø§Ù„Ù…Ø¯Ø©: ${from} Ø¥Ù„Ù‰ ${to}</div>
        </div>
        <div class="muted">Ø§Ù„Ø­Ø±ÙƒØ©: ${label}</div>
      </div>
    `;
    const body = `
      <div class="grid cards">
        <div class="card">
          <h3>Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙƒØ«Ø±</h3>
          <div class="title" style="font-size:18px">${top?.branch?.name||"-"}</div>
          <div class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(top?.value||0)}</div>
        </div>
        <div class="card">
          <h3>Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£Ù‚Ù„</h3>
          <div class="title" style="font-size:18px">${bottom?.branch?.name||"-"}</div>
          <div class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(bottom?.value||0)}</div>
        </div>
      </div>
    `;
    q("#movementAggArea").innerHTML = `<div class="card report-paper">${head}${body}</div>`;
  }
};



/* ========= Settings ========= */
const Settings = {
  addUser() {
    const name = Security.sanitizeInput(q("#setUserName").value.trim());
    const pass = q("#setUserPass").value.trim();
    const role = q("#setUserRole").value;
    const branchId = q("#setUserBranch")?.value;

    if(!name || !pass){
      Notification.show("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "error");
      Security.logActivity('user_creation_failed', { reason: 'missing_credentials' });
      return;
    }

    if(!Security.validateInput(name) || !Security.validateInput(pass)){
      Notification.show("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©", "error");
      Security.logActivity('user_creation_failed', { reason: 'invalid_input' });
      return;
    }

    if (role === 'branch-manager' && !branchId) {
      Notification.show("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹", "error");
      return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
    const existingUser = State.db.users.find(u => u.name === name);
    if (existingUser) {
      Notification.show("ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹", "error");
      return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    const defaultPerms = this.getDefaultPermissions(role);

    const newUser = {
      id: uid(),
      name,
      pass: pass, // ØªØ®Ø²ÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±
      role,
      perms: defaultPerms,
      branchId: role === 'branch-manager' ? branchId : null
    };

    State.db.users.push(newUser);
    DB.save();

    Security.logActivity('user_created', { newUserId: newUser.id, newUserName: newUser.name, role: newUser.role });

    q("#setUserName").value = "";
    q("#setUserPass").value = "";
    q("#setUserRole").value = "admin";
    if (q("#setUserBranch")) q("#setUserBranch").value = "";
    q("#settingsBranchDiv").style.display = "none";

    this.render();
    Notification.show("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­", "success");

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡
    Notifications.notifyNewUser(newUser.name, newUser.role);
  },

  getDefaultPermissions(role) {
    const perms = {};

    switch(role) {
      case 'admin':
        PERMISSIONS.forEach(perm => {
          perms[perm.k] = true;
        });
        break;
      case 'manager':
        perms.branches = true;
        perms.reports = true;
        perms.editData = true;
        perms.dashboard = true;
        perms.movement = true;
        break;
      case 'branch-manager':
        perms.editData = true;
        perms.reports = true;
        break;
      case 'accountant':
        perms.reports = true;
        perms.financial = true;
        perms.accounts = true;
        perms.dashboard = true;
        break;
      case 'employee':
        perms.editData = true;
        break;
      case 'viewer':
        perms.reports = true;
        break;
    }

    return perms;
  },

  toggleBranchSelection() {
    const roleSelect = q('#setUserRole');
    const branchDiv = q('#settingsBranchDiv');

    if (roleSelect && branchDiv) {
      if (roleSelect.value === 'branch-manager') {
        branchDiv.style.display = 'block';
        this.populateBranchSelector();
      } else {
        branchDiv.style.display = 'none';
      }
    }
  },

  populateBranchSelector() {
    const branchSelect = q('#setUserBranch');
    if (!branchSelect) return;

    let html = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>';
    State.db.branches.forEach(branch => {
      html += `<option value="${branch.id}">${branch.name}</option>`;
    });
    branchSelect.innerHTML = html;
  },

  handleEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'addUserBtn') {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ù‡Ùˆ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©ØŒ Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        this.addUser();
      } else {
        // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ø®ÙÙŠ (Ù…Ø«Ù„ Ø­Ù‚Ù„ Ø§Ù„ÙØ±Ø¹)ØŒ ØªØ®Ø·Ø§Ù‡
          if (nextFieldId === 'setUserBranch' && q('#settingsBranchDiv').style.display === 'none') {
            // Ø§Ù†ØªÙ‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            this.addUser();
          } else {
            nextField.focus();
          }
        }
      }
    }
  },

  handleCompanyEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'saveCompany') {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ù‡Ùˆ Ø²Ø± Ø§Ù„Ø­ÙØ¸ØŒ Ù‚Ù… Ø¨Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        Company.save();
      } else {
        // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  },
  
  render() {
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    const usersList = q("#settingsUsersList");
    if (usersList) {
      usersList.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th>Ø§Ù„ÙØ±Ø¹</th>
              <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody>
            ${State.db.users.map(u=>{
              const roleLabel = this.getRoleLabel(u.role);
              let branchName = '-';
              if (u.role === 'branch-manager' && u.branchId) {
                const branch = State.db.branches.find(b => b.id === u.branchId);
                branchName = branch ? branch.name : 'ÙØ±Ø¹ Ù…Ø­Ø°ÙˆÙ';
              }

              return `
                <tr>
                  <td>${u.name}</td>
                  <td>${roleLabel}</td>
                  <td>${branchName}</td>
                  <td class="no-print">
                    <button class="btn danger" onclick="Settings.delUser('${u.id}')">Ø­Ø°Ù</button>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }
  },

  getRoleLabel(role) {
    const roles = {
      'admin': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
      'manager': 'Ù…Ø¯ÙŠØ±',
      'branch-manager': 'Ù…Ø¯ÙŠØ± ÙØ±Ø¹',
      'accountant': 'Ù…Ø­Ø§Ø³Ø¨',
      'employee': 'Ù…ÙˆØ¸Ù',
      'viewer': 'Ù…Ø´Ø§Ù‡Ø¯'
    };
    return roles[role] || 'Ù…ÙˆØ¸Ù';
  },

  updateUIBasedOnPermissions() {
    // ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    const buttons = [
      { id: 'btnHome', perm: 'dashboard' }, // Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙŠØ¸Ù‡Ø± Ù„Ù…Ù† Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      { id: 'btnBranchManagement', perm: 'branches' },
      { id: 'btnReports', perm: 'reports' },
      { id: 'btnFinancialReports', perm: 'financial' },
      { id: 'btnAccounts', perm: 'accounts' },
      { id: 'btnSettings', perm: 'settings' },
      { id: 'btnCompany', perm: 'company' },
      { id: 'btnMovement', perm: 'movement' },
      { id: 'btnDashboard', perm: 'dashboard' }
    ];

    buttons.forEach(btn => {
      const element = q(`#${btn.id}`);
      if (element) {
        if (State.user.role === 'admin' || (State.user.perms && State.user.perms[btn.perm])) {
          element.style.display = '';
        } else {
          element.style.display = 'none';
        }
      }
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù…Ø¹ÙŠÙ†Ø© Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹
    if (State.user.role === 'branch-manager') {
      // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      const dashboardBtn = q('#btnDashboard');
      if (dashboardBtn) dashboardBtn.style.display = 'none';

      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
      const reportsBtn = q('#btnReports');
      if (reportsBtn) reportsBtn.style.display = 'none';

      const financialReportsBtn = q('#btnFinancialReports');
      if (financialReportsBtn) financialReportsBtn.style.display = 'none';
    }
  },

  applyUserTheme(role) {
    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø«ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    document.body.classList.remove('theme-admin', 'theme-manager', 'theme-accountant', 'theme-employee', 'theme-viewer');

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    if (role) {
      document.body.classList.add(`theme-${role}`);
    }
  },

  init() {
    this.render();

    // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
    q("#coName").value = State.db.company.name||"";
    q("#coPhone").value = State.db.company.phone||"";
    q("#coCR").value = State.db.company.cr||"";
    q("#coAddr").value = State.db.company.addr||"";
    

  },
  
  delUser(id) {
    if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;
    
    // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±
    const adminUsers = State.db.users.filter(u => u.role === 'admin');
    const userToDelete = State.db.users.find(u => u.id === id);
    
    if (userToDelete?.role === 'admin' && adminUsers.length <= 1) {
      Notification.show("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±", "error");
      return;
    }
    
    State.db.users = State.db.users.filter(u=>u.id!==id);
    DB.save(); 
    this.render();
    Notification.show("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­", "success");
  }
};

/* ========= Company quick edit ========= */
const Company = {
  open() {
    q("#mcoName").value = State.db.company.name||"";
    q("#mcoPhone").value = State.db.company.phone||"";
    q("#mcoCR").value = State.db.company.cr||"";
    q("#mcoAddr").value = State.db.company.addr||"";
    q("#companyModal").classList.remove("hidden");
  },
  
  close() { 
    q("#companyModal").classList.add("hidden"); 
  },
  
  save() {
    State.db.company = {
      name:q("#coName").value.trim(),
      phone:q("#coPhone").value.trim(),
      cr:q("#coCR").value.trim(),
      addr:q("#coAddr").value.trim()
    };
    DB.save(); 
    Notification.show("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­", "success");
  },
  
  saveModal() {
    State.db.company = {
      name:q("#mcoName").value.trim(),
      phone:q("#mcoPhone").value.trim(),
      cr:q("#mcoCR").value.trim(),
      addr:q("#mcoAddr").value.trim()
    };
    DB.save();
    this.close();
    Notification.show("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­", "success");
  },

  handleCompanyModalEnterKey(event, nextFieldId) {
    if (event.key === 'Enter') {
      event.preventDefault();

      if (nextFieldId === 'saveModalBtn') {
        this.saveModal();
      } else {
        const nextField = q('#' + nextFieldId);
        if (nextField) {
          nextField.focus();
        }
      }
    }
  }
};

/* ========= Init ========= */
window.addEventListener("DOMContentLoaded", ()=>{
  try {
    const hash = location.hash.replace("#","") || 'login';
    if(State.user){
      Router.go(hash || 'home');
      q("header.top")?.classList.remove("hidden");
    } else {
      Router.go('login');
      q("header.top")?.classList.add("hidden");
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…
    if(!State.db.users || State.db.users.length === 0){
      const adminPerms = {};
      PERMISSIONS.forEach(perm => {
        adminPerms[perm.k] = true;
      });
      State.db.users = [{id:uid(),name:"admin",pass:"admin123",role:"admin",perms:adminPerms}];
      DB.save();
    }

    // ØªÙ‡ÙŠØ¦Ø© Dashboard
    Dashboard.populateBranchSelector();

    // Initialize notifications
    Notifications.init();
  } catch (error) {
    console.error("Initialization error:", error);
    Notification.show("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.", "error");
  }
});

/*
  ===========================================
  Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©
  ===========================================

  1. Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­ (MySQL/PostgreSQL):

  -- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('admin', 'manager', 'accountant', 'employee', 'viewer') NOT NULL,
    branch_id VARCHAR(36),
    permissions JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  );

  -- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ±ÙˆØ¹
  CREATE TABLE branches (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    manager VARCHAR(100),
    location VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );

  -- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
  CREATE TABLE financial_records (
    id VARCHAR(36) PRIMARY KEY,
    branch_id VARCHAR(36) NOT NULL,
    form_type VARCHAR(50) NOT NULL,
    data JSON NOT NULL,
    created_by VARCHAR(36),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (branch_id) REFERENCES branches(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
  );

  -- Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©
  CREATE TABLE audit_trail (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36),
    action VARCHAR(100) NOT NULL,
    details JSON,
    ip_address VARCHAR(45),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
  );

  2. Backend API Structure (Node.js/Express):

  // server.js
  const express = require('express');
  const mysql = require('mysql2');
  const jwt = require('jsonwebtoken');
  const bcrypt = require('bcrypt');

  const app = express();
  app.use(express.json());

  // Database connection
  const db = mysql.createConnection({
    host: 'localhost',
    user: 'username',
    password: 'password',
    database: 'aljaberni_db'
  });

  // Authentication middleware
  const authenticateToken = (req, res, next) => {
    const token = req.headers['authorization'];
    if (!token) return res.sendStatus(401);

    jwt.verify(token, 'your-secret-key', (err, user) => {
      if (err) return res.sendStatus(403);
      req.user = user;
      next();
    });
  };

  // API Routes
  app.post('/api/login', async (req, res) => {
    // Login logic with JWT
  });

  app.get('/api/branches', authenticateToken, (req, res) => {
    // Get branches with permissions check
  });

  app.post('/api/records', authenticateToken, (req, res) => {
    // Save financial records
  });

  3. Ø£Ø¯ÙˆØ§Øª Ù…ÙÙŠØ¯Ø© Ù„Ù„Ø¥Ù†ØªØ§Ø¬:
  - PM2 Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
  - Nginx ÙƒÙ€reverse proxy
  - SSL certificates
  - Database backups automation
  - Monitoring tools (PM2, Grafana)

  4. Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„:
  1. Ø¥Ù†Ø´Ø§Ø¡ backend API
  2. ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  3. Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
  4. ØªØ­Ø¯ÙŠØ« frontend Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… API
  5. Ø¥Ø¶Ø§ÙØ© authentication
  6. Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„
  7. Ù†Ø´Ø± Ø¹Ù„Ù‰ server

  Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† Ø£ØµØ¨Ø­ Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹ ÙˆÙ‚Ø§Ø¨Ù„ÙŠØ© Ù„Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„ØªÙˆØ³Ø¹!

  Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:
  - ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØªÙ…Ø§Ù…Ø§Ù‹
  - Ø³ØªØ¸Ù‡Ø± Ø¥Ø´Ø¹Ø§Ø± "Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙÙŠØ±" Ø¹Ù†Ø¯ ØªØ­ÙˆÙŠÙ„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´ÙØ±Ø©
  - ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: admin/admin123
  - Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ®Ø²Ù† ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ÙƒÙ†Øµ Ø¹Ø§Ø¯ÙŠ (ØºÙŠØ± Ù…Ø´ÙØ±)
*/
</script>

<!-- Notifications Container -->
<div class="notification-container" id="notificationContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<script src="upgrade_checker.js"></script>
</body>
</html>